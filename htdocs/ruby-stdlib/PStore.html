<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Class: PStore</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (P)</a> &raquo; 
    
    
    <span class="title">PStore</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: PStore
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next">PStore</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/pstore.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>
PStore implements a file based persistence mechanism based on a Hash.  User
code can store hierarchies of Ruby objects (values) into the data store
file by name (keys).  An object hierarchy may be just a single object. 
User code may later read values back from the data store or even update
data, as needed.
</p>
<p>
The transactional behavior ensures that any changes succeed or fail
together. This can be used to ensure that the data store is not left in a
transitory state, where some values were updated but others were not.
</p>
<p>
Behind the scenes, Ruby objects are stored to the data store file with
Marshal.  That carries the usual limitations.  Proc objects cannot be
marshalled, for example.
</p>
<h2>Usage example:</h2>
<pre class="code">
 <span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore</span><span class='tstring_end'>&quot;</span></span>

 <span class='comment'># a mock wiki object...
</span> <span class='kw'>class</span> <span class='const'>WikiPage</span>
   <span class='kw'>def</span> <span class='id initialize'>initialize</span><span class='lparen'>(</span> <span class='id page_name'>page_name</span><span class='comma'>,</span> <span class='id author'>author</span><span class='comma'>,</span> <span class='id contents'>contents</span> <span class='rparen'>)</span>
     <span class='ivar'>@page_name</span> <span class='op'>=</span> <span class='id page_name'>page_name</span>
     <span class='ivar'>@revisions</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id new'>new</span>

     <span class='id add_revision'>add_revision</span><span class='lparen'>(</span><span class='id author'>author</span><span class='comma'>,</span> <span class='id contents'>contents</span><span class='rparen'>)</span>
   <span class='kw'>end</span>

   <span class='id attr_reader'>attr_reader</span> <span class='symbol'>:page_name</span>

   <span class='kw'>def</span> <span class='id add_revision'>add_revision</span><span class='lparen'>(</span> <span class='id author'>author</span><span class='comma'>,</span> <span class='id contents'>contents</span> <span class='rparen'>)</span>
     <span class='ivar'>@revisions</span> <span class='op'>&lt;&lt;</span> <span class='lbrace'>{</span> <span class='symbol'>:created</span>  <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id now'>now</span><span class='comma'>,</span>
                     <span class='symbol'>:author</span>   <span class='op'>=&gt;</span> <span class='id author'>author</span><span class='comma'>,</span>
                     <span class='symbol'>:contents</span> <span class='op'>=&gt;</span> <span class='id contents'>contents</span> <span class='rbrace'>}</span>
   <span class='kw'>end</span>

   <span class='kw'>def</span> <span class='id wiki_page_references'>wiki_page_references</span>
     <span class='lbracket'>[</span><span class='ivar'>@page_name</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='ivar'>@revisions</span><span class='period'>.</span><span class='id last'>last</span><span class='lbracket'>[</span><span class='symbol'>:contents</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id scan'>scan</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\b(?:[A-Z]+[a-z]+){2,}</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span>
   <span class='kw'>end</span>

   <span class='comment'># ...
</span> <span class='kw'>end</span>

 <span class='comment'># create a new page...
</span> <span class='id home_page'>home_page</span> <span class='op'>=</span> <span class='const'>WikiPage</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HomePage</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>James Edward Gray II</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                           <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A page about the JoysOfDocumentation...</span><span class='tstring_end'>&quot;</span></span> <span class='rparen'>)</span>

 <span class='comment'># then we want to update page data and the index together, or not at all...
</span> <span class='id wiki'>wiki</span> <span class='op'>=</span> <span class='const'>PStore</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>wiki_pages.pstore</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
 <span class='id wiki'>wiki</span><span class='period'>.</span><span class='id transaction'>transaction</span> <span class='kw'>do</span>  <span class='comment'># begin transaction; do all of this or none of it
</span>   <span class='comment'># store page...
</span>   <span class='id wiki'>wiki</span><span class='lbracket'>[</span><span class='id home_page'>home_page</span><span class='period'>.</span><span class='id page_name'>page_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id home_page'>home_page</span>
   <span class='comment'># ensure that an index has been created...
</span>   <span class='id wiki'>wiki</span><span class='lbracket'>[</span><span class='symbol'>:wiki_index</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id new'>new</span>
   <span class='comment'># update wiki index...
</span>   <span class='id wiki'>wiki</span><span class='lbracket'>[</span><span class='symbol'>:wiki_index</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id push'>push</span><span class='lparen'>(</span><span class='op'>*</span><span class='id home_page'>home_page</span><span class='period'>.</span><span class='id wiki_page_references'>wiki_page_references</span><span class='rparen'>)</span>
 <span class='kw'>end</span>                   <span class='comment'># commit changes to wiki data store file
</span>
 <span class='comment'>### Some time later... ###
</span>
 <span class='comment'># read wiki data...
</span> <span class='id wiki'>wiki</span><span class='period'>.</span><span class='id transaction'>transaction</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>do</span>  <span class='comment'># begin read-only transaction, no changes allowed
</span>   <span class='id wiki'>wiki</span><span class='period'>.</span><span class='id roots'>roots</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id data_root_name'>data_root_name</span><span class='op'>|</span>
     <span class='id p'>p</span> <span class='id data_root_name'>data_root_name</span>
     <span class='id p'>p</span> <span class='id wiki'>wiki</span><span class='lbracket'>[</span><span class='id data_root_name'>data_root_name</span><span class='rbracket'>]</span>
   <span class='kw'>end</span>
 <span class='kw'>end</span>
</pre>
<h2>Transaction modes</h2>
<p>
By default, file integrity is only ensured as long as the operating system
(and the underlying hardware) doesn&#8217;t raise any unexpected I/O
errors. If an I/O error occurs while PStore is writing to its file, then
the file will become corrupted.
</p>
<p>
You can prevent this by setting <em>pstore.ultra_safe = true</em>. However,
this results in a minor performance loss, and only works on platforms that
support atomic file renames. Please consult the documentation for
<tt>ultra_safe</tt> for details.
</p>
<p>
Needless to say, if you&#8217;re storing valuable data with PStore, then
you should backup the PStore files from time to time.
</p>


  </div>
</div>
<div class="tags">
  
</div><div id="subclasses">
  <h2>Direct Known Subclasses</h2>
  <p class="children"><span class='object_link'><a href="YAML/Store.html" title="YAML::Store (class)">YAML::Store</a></span></p>
</div>
<h2>Defined Under Namespace</h2>
<p class="children">
   
    
   
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="PStore/DummyMutex.html" title="PStore::DummyMutex (class)">DummyMutex</a></span>, <span class='object_link'><a href="PStore/Error.html" title="PStore::Error (class)">Error</a></span>
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="RDWR_ACCESS-constant" class="">RDWR_ACCESS =
          
        </dt>
        <dd><pre class="code"><span class='const'>File</span><span class='op'>::</span><span class='const'>RDWR</span> <span class='op'>|</span> <span class='const'>File</span><span class='op'>::</span><span class='const'>CREAT</span> <span class='op'>|</span> <span class='id binmode'>binmode</span></pre></dd>
      
        <dt id="RD_ACCESS-constant" class="">RD_ACCESS =
          
        </dt>
        <dd><pre class="code"><span class='const'>File</span><span class='op'>::</span><span class='const'>RDONLY</span> <span class='op'>|</span> <span class='id binmode'>binmode</span></pre></dd>
      
        <dt id="WR_ACCESS-constant" class="">WR_ACCESS =
          
        </dt>
        <dd><pre class="code"><span class='const'>File</span><span class='op'>::</span><span class='const'>WRONLY</span> <span class='op'>|</span> <span class='const'>File</span><span class='op'>::</span><span class='const'>CREAT</span> <span class='op'>|</span> <span class='const'>File</span><span class='op'>::</span><span class='const'>TRUNC</span> <span class='op'>|</span> <span class='id binmode'>binmode</span></pre></dd>
      
        <dt id="EMPTY_STRING-constant" class="">EMPTY_STRING =
          <div class="docstring">
  <div class="discussion">
    <p>
Constant for relieving Ruby&#8217;s garbage collector.
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span></pre></dd>
      
        <dt id="EMPTY_MARSHAL_DATA-constant" class="">EMPTY_MARSHAL_DATA =
          
        </dt>
        <dd><pre class="code"><span class='const'>Marshal</span><span class='period'>.</span><span class='id dump'>dump</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span></pre></dd>
      
        <dt id="EMPTY_MARSHAL_CHECKSUM-constant" class="">EMPTY_MARSHAL_CHECKSUM =
          
        </dt>
        <dd><pre class="code"><span class='const'>Digest</span><span class='op'>::</span><span class='const'>MD5</span><span class='period'>.</span><span class='id digest'>digest</span><span class='lparen'>(</span><span class='const'>EMPTY_MARSHAL_DATA</span><span class='rparen'>)</span></pre></dd>
      
    </dl>
  


  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#ultra_safe-instance_method" title="#ultra_safe (instance method)">- (Object) <strong>ultra_safe</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Whether PStore should do its best to prevent file corruptions, even when
under unlikely-to-occur error conditions such as out-of-space conditions
and other unusual OS filesystem errors.
</p>
</div></span>
  
</li>

    
  </ul>


  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#%5B%5D-instance_method" title="#[] (instance method)">- (Object) <strong>[]</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Retrieves a value from the PStore file data, by <em>name</em>.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#%5B%5D%3D-instance_method" title="#[]= (instance method)">- (Object) <strong>[]=</strong>(name, value) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Stores an individual Ruby object or a hierarchy of Ruby objects in the data
store file under the root <em>name</em>.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#abort-instance_method" title="#abort (instance method)">- (Object) <strong>abort</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Ends the current PStore#transaction, discarding any changes to the data
store.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#commit-instance_method" title="#commit (instance method)">- (Object) <strong>commit</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Ends the current PStore#transaction, committing any changes to the data
store immediately.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete-instance_method" title="#delete (instance method)">- (Object) <strong>delete</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Removes an object hierarchy from the data store, by <em>name</em>.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#fetch-instance_method" title="#fetch (instance method)">- (Object) <strong>fetch</strong>(name, default = PStore::Error) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
This method is just like PStore#[], save that you may also provide a
<em>default</em> value for the object.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (PStore) <strong>initialize</strong>(file, thread_safe = false) </a>
    

    
  </span>
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
To construct a PStore object, pass in the <em>file</em> path where you
would like the data to be stored.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#path-instance_method" title="#path (instance method)">- (Object) <strong>path</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the path to the data store file.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#root%3F-instance_method" title="#root? (instance method)">- (Boolean) <strong>root?</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns true if the supplied <em>name</em> is currently in the data store.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#roots-instance_method" title="#roots (instance method)">- (Object) <strong>roots</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the names of all object hierarchies currently in the store.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#transaction-instance_method" title="#transaction (instance method)">- (Object) <strong>transaction</strong>(read_only = false, &amp;block) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Opens a new transaction for the data store.
</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="PStore (class)">PStore</a></span></tt>) <strong>initialize</strong>(file, thread_safe = false) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
To construct a PStore object, pass in the <em>file</em> path where you
would like the data to be stored.
</p>
<p>
PStore objects are always reentrant. But if <em>thread_safe</em> is set to
true, then it will become thread-safe at the cost of a minor performance
hit.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 122</span>

<span class='kw'>def</span> <span class='id initialize'>initialize</span><span class='lparen'>(</span><span class='id file'>file</span><span class='comma'>,</span> <span class='id thread_safe'>thread_safe</span> <span class='op'>=</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id dir'>dir</span> <span class='op'>=</span> <span class='const'>File</span><span class='op'>::</span><span class='id dirname'>dirname</span><span class='lparen'>(</span><span class='id file'>file</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='const'>File</span><span class='op'>::</span><span class='id directory?'>directory?</span> <span class='id dir'>dir</span>
    <span class='id raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='id format'>format</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>directory %s does not exist</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id dir'>dir</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='const'>File</span><span class='op'>::</span><span class='id exist?'>exist?</span> <span class='id file'>file</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='const'>File</span><span class='op'>::</span><span class='id readable?'>readable?</span> <span class='id file'>file</span>
    <span class='id raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='id format'>format</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>file %s not readable</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id file'>file</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='ivar'>@transaction</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@filename</span> <span class='op'>=</span> <span class='id file'>file</span>
  <span class='ivar'>@abort</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@ultra_safe</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@thread_safe</span> <span class='op'>=</span> <span class='id thread_safe'>thread_safe</span>
  <span class='kw'>if</span> <span class='ivar'>@thread_safe</span>
    <span class='ivar'>@lock</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id new'>new</span>
  <span class='kw'>else</span>
    <span class='ivar'>@lock</span> <span class='op'>=</span> <span class='const'>DummyMutex</span><span class='period'>.</span><span class='id new'>new</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="ultra_safe=-instance_method"></span>
      <span id="ultra_safe-instance_method"></span>
      <div class="method_details first">
  <p class="signature first" id="ultra_safe-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>ultra_safe</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Whether PStore should do its best to prevent file corruptions, even when
under unlikely-to-occur error conditions such as out-of-space conditions
and other unusual OS filesystem errors. Setting this flag comes at the
price in the form of a performance loss.
</p>
<p>
This flag only has effect on platforms on which file renames are atomic
(e.g. all POSIX platforms: Linux, MacOS X, FreeBSD, etc). The default value
is false.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


113
114
115</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 113</span>

<span class='kw'>def</span> <span class='id ultra_safe'>ultra_safe</span>
  <span class='ivar'>@ultra_safe</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="[]-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>[]</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Retrieves a value from the PStore file data, by <em>name</em>.  The
hierarchy of Ruby objects stored under that root <em>name</em> will be
returned.
</p>
<p>
<b>WARNING</b>:  This method is only valid in a PStore#transaction.  It
will raise PStore::Error if called at any other time.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


163
164
165
166</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 163</span>

<span class='kw'>def</span> <span class='op'>[]</span><span class='lparen'>(</span><span class='id name'>name</span><span class='rparen'>)</span>
  <span class='id in_transaction'>in_transaction</span>
  <span class='ivar'>@table</span><span class='lbracket'>[</span><span class='id name'>name</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="[]=-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>[]=</strong>(name, value) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Stores an individual Ruby object or a hierarchy of Ruby objects in the data
store file under the root <em>name</em>.  Assigning to a <em>name</em>
already in the data store clobbers the old data.
</p>
<h2>Example:</h2>
<pre class="code">
 <span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore</span><span class='tstring_end'>&quot;</span></span>

 <span class='id store'>store</span> <span class='op'>=</span> <span class='const'>PStore</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data_file.pstore</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
 <span class='id store'>store</span><span class='period'>.</span><span class='id transaction'>transaction</span> <span class='kw'>do</span>  <span class='comment'># begin transaction
</span>   <span class='comment'># load some data into the store...
</span>   <span class='id store'>store</span><span class='lbracket'>[</span><span class='symbol'>:single_object</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>My data...</span><span class='tstring_end'>&quot;</span></span>
   <span class='id store'>store</span><span class='lbracket'>[</span><span class='symbol'>:obj_heirarchy</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Kev Jackson</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rational.rb</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore.rb</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                             <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>James Gray</span><span class='tstring_end'>&quot;</span></span>  <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>erb.rb</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore.rb</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
 <span class='kw'>end</span>                   <span class='comment'># commit changes to data store file
</span></pre>
<p>
<b>WARNING</b>:  This method is only valid in a PStore#transaction and it
cannot be read-only.  It will raise PStore::Error if called at any other
time.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


208
209
210
211</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 208</span>

<span class='kw'>def</span> <span class='op'>[]=</span><span class='lparen'>(</span><span class='id name'>name</span><span class='comma'>,</span> <span class='id value'>value</span><span class='rparen'>)</span>
  <span class='id in_transaction_wr'>in_transaction_wr</span><span class='lparen'>(</span><span class='rparen'>)</span>
  <span class='ivar'>@table</span><span class='lbracket'>[</span><span class='id name'>name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id value'>value</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="abort-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>abort</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Ends the current PStore#transaction, discarding any changes to the data
store.
</p>
<h2>Example:</h2>
<pre class="code">
 <span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore</span><span class='tstring_end'>&quot;</span></span>

 <span class='id store'>store</span> <span class='op'>=</span> <span class='const'>PStore</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data_file.pstore</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
 <span class='id store'>store</span><span class='period'>.</span><span class='id transaction'>transaction</span> <span class='kw'>do</span>  <span class='comment'># begin transaction
</span>   <span class='id store'>store</span><span class='lbracket'>[</span><span class='symbol'>:one</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>1</span>     <span class='comment'># this change is not applied, see below...
</span>   <span class='id store'>store</span><span class='lbracket'>[</span><span class='symbol'>:two</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>2</span>     <span class='comment'># this change is not applied, see below...
</span>
   <span class='id store'>store</span><span class='period'>.</span><span class='id abort'>abort</span>         <span class='comment'># end transaction here, discard all changes
</span>
   <span class='id store'>store</span><span class='lbracket'>[</span><span class='symbol'>:three</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>3</span>   <span class='comment'># this change is never reached
</span> <span class='kw'>end</span>
</pre>
<p>
<b>WARNING</b>:  This method is only valid in a PStore#transaction.  It
will raise PStore::Error if called at any other time.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


296
297
298
299
300</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 296</span>

<span class='kw'>def</span> <span class='id abort'>abort</span>
  <span class='id in_transaction'>in_transaction</span>
  <span class='ivar'>@abort</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id throw'>throw</span> <span class='symbol'>:pstore_abort_transaction</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="commit-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>commit</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Ends the current PStore#transaction, committing any changes to the data
store immediately.
</p>
<h2>Example:</h2>
<pre class="code">
 <span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore</span><span class='tstring_end'>&quot;</span></span>

 <span class='id store'>store</span> <span class='op'>=</span> <span class='const'>PStore</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data_file.pstore</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
 <span class='id store'>store</span><span class='period'>.</span><span class='id transaction'>transaction</span> <span class='kw'>do</span>  <span class='comment'># begin transaction
</span>   <span class='comment'># load some data into the store...
</span>   <span class='id store'>store</span><span class='lbracket'>[</span><span class='symbol'>:one</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>1</span>
   <span class='id store'>store</span><span class='lbracket'>[</span><span class='symbol'>:two</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>2</span>

   <span class='id store'>store</span><span class='period'>.</span><span class='id commit'>commit</span>        <span class='comment'># end transaction here, committing changes
</span>
   <span class='id store'>store</span><span class='lbracket'>[</span><span class='symbol'>:three</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>3</span>   <span class='comment'># this change is never reached
</span> <span class='kw'>end</span>
</pre>
<p>
<b>WARNING</b>:  This method is only valid in a PStore#transaction.  It
will raise PStore::Error if called at any other time.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


270
271
272
273
274</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 270</span>

<span class='kw'>def</span> <span class='id commit'>commit</span>
  <span class='id in_transaction'>in_transaction</span>
  <span class='ivar'>@abort</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id throw'>throw</span> <span class='symbol'>:pstore_abort_transaction</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="delete-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>delete</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Removes an object hierarchy from the data store, by <em>name</em>.
</p>
<p>
<b>WARNING</b>:  This method is only valid in a PStore#transaction and it
cannot be read-only.  It will raise PStore::Error if called at any other
time.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


218
219
220
221</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 218</span>

<span class='kw'>def</span> <span class='id delete'>delete</span><span class='lparen'>(</span><span class='id name'>name</span><span class='rparen'>)</span>
  <span class='id in_transaction_wr'>in_transaction_wr</span><span class='lparen'>(</span><span class='rparen'>)</span>
  <span class='ivar'>@table</span><span class='period'>.</span><span class='id delete'>delete</span> <span class='id name'>name</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="fetch-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>fetch</strong>(name, default = PStore::Error) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
This method is just like PStore#[], save that you may also provide a
<em>default</em> value for the object.  In the event the specified
<em>name</em> is not found in the data store, your <em>default</em> will be
returned instead.  If you do not specify a default, PStore::Error will be
raised if the object is not found.
</p>
<p>
<b>WARNING</b>:  This method is only valid in a PStore#transaction.  It
will raise PStore::Error if called at any other time.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


177
178
179
180
181
182
183
184
185
186
187</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 177</span>

<span class='kw'>def</span> <span class='id fetch'>fetch</span><span class='lparen'>(</span><span class='id name'>name</span><span class='comma'>,</span> <span class='id default'>default</span><span class='op'>=</span><span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='rparen'>)</span>
  <span class='id in_transaction'>in_transaction</span>
  <span class='kw'>unless</span> <span class='ivar'>@table</span><span class='period'>.</span><span class='id key?'>key?</span> <span class='id name'>name</span>
    <span class='kw'>if</span> <span class='id default'>default</span> <span class='op'>==</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span>
      <span class='id raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='id format'>format</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>undefined root name `%s'</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id name'>name</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='kw'>return</span> <span class='id default'>default</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='ivar'>@table</span><span class='lbracket'>[</span><span class='id name'>name</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="path-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>path</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the path to the data store file.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


244
245
246</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 244</span>

<span class='kw'>def</span> <span class='id path'>path</span>
  <span class='ivar'>@filename</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="root?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>root?</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns true if the supplied <em>name</em> is currently in the data store.
</p>
<p>
<b>WARNING</b>:  This method is only valid in a PStore#transaction.  It
will raise PStore::Error if called at any other time.
</p>


  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 239</span>

<span class='kw'>def</span> <span class='id root?'>root?</span><span class='lparen'>(</span><span class='id name'>name</span><span class='rparen'>)</span>
  <span class='id in_transaction'>in_transaction</span>
  <span class='ivar'>@table</span><span class='period'>.</span><span class='id key?'>key?</span> <span class='id name'>name</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="roots-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>roots</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the names of all object hierarchies currently in the store.
</p>
<p>
<b>WARNING</b>:  This method is only valid in a PStore#transaction.  It
will raise PStore::Error if called at any other time.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


229
230
231
232</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 229</span>

<span class='kw'>def</span> <span class='id roots'>roots</span>
  <span class='id in_transaction'>in_transaction</span>
  <span class='ivar'>@table</span><span class='period'>.</span><span class='id keys'>keys</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="transaction-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>transaction</strong>(read_only = false, &amp;block) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Opens a new transaction for the data store.  Code executed inside a block
passed to this method may read and write data to and from the data store
file.
</p>
<p>
At the end of the block, changes are committed to the data store
automatically.  You may exit the transaction early with a call to either
PStore#commit or PStore#abort.  See those methods for details about how
changes are handled.  Raising an uncaught Exception in the block is
equivalent to calling PStore#abort.
</p>
<p>
If <em>read_only</em> is set to <tt>true</tt>, you will only be allowed to
read from the data store during the transaction and any attempts to change
the data will raise a PStore::Error.
</p>
<p>
Note that PStore does not support nested transactions.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/pstore.rb', line 319</span>

<span class='kw'>def</span> <span class='id transaction'>transaction</span><span class='lparen'>(</span><span class='id read_only'>read_only</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id block'>block</span><span class='rparen'>)</span>  <span class='comment'># :yields:  pstore
</span>  <span class='id value'>value</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>nested transaction</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@transaction</span>
  <span class='ivar'>@lock</span><span class='period'>.</span><span class='id synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@rdonly</span> <span class='op'>=</span> <span class='id read_only'>read_only</span>
    <span class='ivar'>@transaction</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='ivar'>@abort</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='id file'>file</span> <span class='op'>=</span> <span class='id open_and_lock_file'>open_and_lock_file</span><span class='lparen'>(</span><span class='ivar'>@filename</span><span class='comma'>,</span> <span class='id read_only'>read_only</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id file'>file</span>
      <span class='kw'>begin</span>
        <span class='ivar'>@table</span><span class='comma'>,</span> <span class='id checksum'>checksum</span><span class='comma'>,</span> <span class='id original_data_size'>original_data_size</span> <span class='op'>=</span> <span class='id load_data'>load_data</span><span class='lparen'>(</span><span class='id file'>file</span><span class='comma'>,</span> <span class='id read_only'>read_only</span><span class='rparen'>)</span>

        <span class='id catch'>catch</span><span class='lparen'>(</span><span class='symbol'>:pstore_abort_transaction</span><span class='rparen'>)</span> <span class='kw'>do</span>
          <span class='id value'>value</span> <span class='op'>=</span> <span class='kw'>yield</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
        <span class='kw'>end</span>

        <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@abort</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id read_only'>read_only</span>
          <span class='id save_data'>save_data</span><span class='lparen'>(</span><span class='id checksum'>checksum</span><span class='comma'>,</span> <span class='id original_data_size'>original_data_size</span><span class='comma'>,</span> <span class='id file'>file</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>ensure</span>
        <span class='id file'>file</span><span class='period'>.</span><span class='id close'>close</span> <span class='kw'>if</span> <span class='op'>!</span><span class='id file'>file</span><span class='period'>.</span><span class='id closed?'>closed?</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='comment'># This can only occur if read_only == true.
</span>      <span class='ivar'>@table</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='id catch'>catch</span><span class='lparen'>(</span><span class='symbol'>:pstore_abort_transaction</span><span class='rparen'>)</span> <span class='kw'>do</span>
        <span class='id value'>value</span> <span class='op'>=</span> <span class='kw'>yield</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id value'>value</span>
<span class='kw'>ensure</span>
  <span class='ivar'>@transaction</span> <span class='op'>=</span> <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Thu Oct 14 00:01:27 2010 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.1 (ruby-1.9.2).
</div>

  </body>
</html>