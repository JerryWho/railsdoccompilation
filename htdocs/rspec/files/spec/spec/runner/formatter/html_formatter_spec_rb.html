  <div id="fileHeader">
    <h1>html_formatter_spec.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>spec/spec/runner/formatter/html_formatter_spec.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Dec 29 13:11:11 +0100 2008</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require File.dirname(__FILE__) + '/../../../spec_helper'
begin
  require 'hpricot' # Needed to compare generated with wanted HTML
rescue LoadError
  warn &quot;hpricot not loaded -- skipping HtmlFormatter specs&quot;
  return
end
require 'spec/runner/formatter/html_formatter'

module Spec
  module Runner
    module Formatter
      describe HtmlFormatter do
        ['--diff', '--dry-run'].each do |opt|
          def jruby?
            PLATFORM == 'java'
          end
    
          it &quot;should produce HTML identical to the one we designed manually with #{opt}&quot; do
            root = File.expand_path(File.dirname(__FILE__) + '/../../../..')
            suffix = jruby? ? '-jruby' : ''
            expected_file = File.dirname(__FILE__) + &quot;/html_formatted-#{::VERSION}#{suffix}.html&quot;
            raise &quot;There is no HTML file with expected content for this platform: #{expected_file}&quot; unless File.file?(expected_file)
            expected_html = File.read(expected_file)

            Dir.chdir(root) do
              args = ['examples/failing/mocking_example.rb', 'examples/failing/diffing_spec.rb', 'examples/passing/stubbing_example.rb',  'examples/passing/pending_example.rb', '--format', 'html', opt]
              err = StringIO.new
              out = StringIO.new
              run_with OptionParser.parse(args, err, out)

              seconds = /\d+\.\d+ seconds/
              html = out.string.gsub seconds, 'x seconds'
              expected_html.gsub! seconds, 'x seconds'

              if opt == '--diff'
                # Uncomment this line temporarily in order to overwrite the expected with actual.
                # Use with care!!!
                # File.open(expected_file, 'w') {|io| io.write(html)}

                doc = Hpricot(html)
                backtraces = doc.search(&quot;div.backtrace&quot;).collect {|e| e.at(&quot;/pre&quot;).inner_html}
                doc.search(&quot;div.backtrace&quot;).remove

                expected_doc = Hpricot(expected_html)
                expected_backtraces = expected_doc.search(&quot;div.backtrace&quot;).collect {|e| e.at(&quot;/pre&quot;).inner_html}
                expected_doc.search(&quot;div.backtrace&quot;).remove

                doc.inner_html.should == expected_doc.inner_html

                expected_backtraces.each_with_index do |expected_line, i|
                  expected_path, expected_line_number, expected_suffix = expected_line.split(':')
                  actual_path, actual_line_number, actual_suffix = backtraces[i].split(':')
                  File.expand_path(actual_path).should == File.expand_path(expected_path)
                  actual_line_number.should == expected_line_number
                end
              else
                html.should =~ /This was a dry-run/m
              end
            end
          end
        end
      end
    end
  end
end
</pre>
    </div>