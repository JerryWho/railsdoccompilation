  <div id="fileHeader">
    <h1>verify_rcov.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>lib/spec/rake/verify_rcov.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 14:57:53 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>module RCov
  # A task that can verify that the RCov coverage doesn't
  # drop below a certain threshold. It should be run after
  # running Spec::Rake::SpecTask.
  class VerifyTask &lt; Rake::TaskLib
    # Name of the task. Defaults to :verify_rcov
    attr_accessor :name
    
    # Path to the index.html file generated by RCov, which
    # is the file containing the total coverage.
    # Defaults to 'coverage/index.html'
    attr_accessor :index_html
    
    # Whether or not to output details. Defaults to true.
    attr_accessor :verbose
    
    # The threshold value (in percent) for coverage. If the 
    # actual coverage is not equal to this value, the task will raise an 
    # exception. 
    attr_accessor :threshold
    
    # Require the threshold value be met exactly.  This is the default.
    attr_accessor :require_exact_threshold
    
    def initialize(name=:verify_rcov)
      @name = name
      @index_html = 'coverage/index.html'
      @verbose = true
      @require_exact_threshold = true
      yield self if block_given?
      raise &quot;Threshold must be set&quot; if @threshold.nil?
      define
    end
    
    def define
      desc &quot;Verify that rcov coverage is at least #{threshold}%&quot;
      task @name do
        total_coverage = 0

        File.open(index_html).each_line do |line|
          if line =~ /&lt;tt class='coverage_total'&gt;\s*(\d+\.\d+)%\s*&lt;\/tt&gt;/
            total_coverage = $1.to_f
            break
          end
        end
        puts &quot;Coverage: #{total_coverage}% (threshold: #{threshold}%)&quot; if verbose
        raise &quot;Coverage must be at least #{threshold}% but was #{total_coverage}%&quot; if total_coverage &lt; threshold
        raise &quot;Coverage has increased above the threshold of #{threshold}% to #{total_coverage}%. You should update your threshold value.&quot; if (total_coverage &gt; threshold) and require_exact_threshold
      end
    end
  end
end
</pre>
    </div>