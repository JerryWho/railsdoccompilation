  <div id="fileHeader">
    <h1>plain_text_formatter.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>lib/spec/runner/formatter/story/plain_text_formatter.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Dec 29 13:11:11 +0100 2008</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'spec/runner/formatter/base_text_formatter'

module Spec
  module Runner
    module Formatter
      module Story
        class PlainTextFormatter &lt; BaseTextFormatter
          def initialize(options, where)
            super
            @successful_scenario_count = 0
            @pending_scenario_count = 0
            
            @pre_story_pending_count = 0
            @pre_story_successful_count = 0
            
            @failed_scenarios = []
            @pending_steps = []
            @previous_type = nil 
            
            @scenario_body_text = &quot;&quot;
            @story_body_text = &quot;&quot;
            
            @scenario_head_text = &quot;&quot;
            @story_head_text = &quot;&quot;
                  
            @scenario_failed = false
            @story_failed = false
          end
        
          def run_started(count)
            @count = count
            @output.puts &quot;Running #@count scenarios\n\n&quot;
          end

          def story_started(title, narrative)
            @pre_story_pending_count = @pending_scenario_count
            @pre_story_successful_count = @successful_scenario_count
            
            @current_story_title = title
            @story_failed = false
            @story_body_text = &quot;&quot;
            @story_head_text = &quot;Story: #{title}\n\n&quot;

            narrative.each_line do |line|
              @story_head_text += &quot;  &quot;
              @story_head_text += line
            end
          end
        
          def story_ended(title, narrative)
            if @story_failed
              @output.print red(@story_head_text)
            elsif @pre_story_successful_count == @successful_scenario_count &amp;&amp; 
                  @pending_scenario_count &gt;= @pre_story_pending_count
              @output.print yellow(@story_head_text)
            else              
              @output.print green(@story_head_text)
            end
            @output.print @story_body_text
            @output.puts
            @output.puts
          end

          def scenario_started(story_title, scenario_name)
            @current_scenario_name = scenario_name
            @scenario_already_failed = false
            @scenario_head_text = &quot;\n\n  Scenario: #{scenario_name}&quot;
            @scenario_body_text = &quot;&quot;
            @scenario_ok = true
            @scenario_pending = false
            @scenario_failed = false
          end
        
          def scenario_succeeded(story_title, scenario_name)
            @successful_scenario_count += 1
            scenario_ended
          end
        
          def scenario_failed(story_title, scenario_name, err)
            @options.backtrace_tweaker.tweak_backtrace(err)
            @failed_scenarios &lt;&lt; [story_title, scenario_name, err] unless @scenario_already_failed
            @scenario_already_failed = true
            @story_failed = true
            @scenario_failed = true
            scenario_ended
          end
        
          def scenario_pending(story_title, scenario_name, msg)
            @pending_scenario_count += 1 unless @scenario_already_failed
            @scenario_pending = true
            @scenario_already_failed = true
            scenario_ended
          end
        
          def scenario_ended
            if @scenario_failed
              @story_body_text += red(@scenario_head_text)
            elsif @scenario_pending
              @story_body_text += yellow(@scenario_head_text)
            else
              @story_body_text += green(@scenario_head_text)
            end
            @story_body_text += @scenario_body_text
          end
          
          def run_ended
            summary_text = &quot;#@count scenarios: #@successful_scenario_count succeeded, #{@failed_scenarios.size} failed, #@pending_scenario_count pending&quot;
            if !@failed_scenarios.empty?
              @output.puts red(summary_text)
            elsif !@pending_steps.empty?
              @output.puts yellow(summary_text)
            else
              @output.puts green(summary_text)
            end
            unless @pending_steps.empty?
              @output.puts &quot;\nPending Steps:&quot;
              @pending_steps.each_with_index do |pending, i|
                story_name, scenario_name, msg = pending
                @output.puts &quot;#{i+1}) #{story_name} (#{scenario_name}): #{msg}&quot;
              end
            end
            unless @failed_scenarios.empty?
              @output.print &quot;\nFAILURES:&quot;
              @failed_scenarios.each_with_index do |failure, i|
                title, scenario_name, err = failure
                @output.print &quot;\n    #{i+1}) &quot;
                @output.print red(&quot;#{title} (#{scenario_name}) FAILED&quot;)
                @output.print red(&quot;\n    #{err.class}: #{err.message}&quot;)
                @output.print &quot;\n    #{err.backtrace.join(&quot;\n&quot;)}\n&quot;
              end
            end            
          end

          def step_upcoming(type, description, *args)
          end
                  
          def step_succeeded(type, description, *args)
            found_step(type, description, false, false, *args)
          end
        
          def step_pending(type, description, *args)
            found_step(type, description, false, true, *args)
            @pending_steps &lt;&lt; [@current_story_title, @current_scenario_name, description]
            @scenario_body_text +=  yellow(&quot; (PENDING)&quot;)
            @scenario_pending = true
            @scenario_ok = false
          end
        
          def step_failed(type, description, *args)
            found_step(type, description, true, @scenario_pending, *args)
            if @scenario_pending
              @scenario_body_text +=  yellow(&quot; (SKIPPED)&quot;)
            else
              @scenario_body_text +=  red(@scenario_ok ? &quot; (FAILED)&quot; : &quot; (SKIPPED)&quot;)
            end
            @scenario_ok = false
          end
          
          def collected_steps(steps)
          end
          
          def method_missing(sym, *args, &amp;block) #:nodoc:
            # noop - ignore unknown messages
          end

        private

          def found_step(type, description, failed, pending, *args)
            desc_string = description.step_name
            arg_regexp = description.arg_regexp
            text = if(type == @previous_type)
              &quot;\n    And &quot;
            else
              &quot;\n\n    #{type.to_s.capitalize} &quot;
            end
            i = -1
            text &lt;&lt; desc_string.gsub(arg_regexp) { |param| args[i+=1] }
            if pending
              @scenario_body_text += yellow(text)
            else
              @scenario_body_text += (failed ? red(text) : green(text))
            end

            if type == :'given scenario'
              @previous_type = :given
            else
              @previous_type = type
            end
          end
        end
      end
    end
  end
end
</pre>
    </div>