  <div id="fileHeader">
    <h1>snippet_extractor.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>lib/spec/runner/formatter/snippet_extractor.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 14:57:53 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>module Spec
  module Runner
    module Formatter
      # This class extracts code snippets by looking at the backtrace of the passed error
      class SnippetExtractor #:nodoc:
        class NullConverter; def convert(code, pre); code; end; end #:nodoc:
        begin; require 'syntax/convertors/html'; @@converter = Syntax::Convertors::HTML.for_syntax &quot;ruby&quot;; rescue LoadError =&gt; e; @@converter = NullConverter.new; end
        
        def snippet(error)
          raw_code, line = snippet_for(error.backtrace[0])
          highlighted = @@converter.convert(raw_code, false)
          highlighted &lt;&lt; &quot;\n&lt;span class=\&quot;comment\&quot;&gt;# gem install syntax to get syntax highlighting&lt;/span&gt;&quot; if @@converter.is_a?(NullConverter)
          post_process(highlighted, line)
        end
        
        def snippet_for(error_line)
          if error_line =~ /(.*):(\d+)/
            file = $1
            line = $2.to_i
            [lines_around(file, line), line]
          else
            [&quot;# Couldn't get snippet for #{error_line}&quot;, 1]
          end
        end
        
        def lines_around(file, line)
          if File.file?(file)
            lines = File.open(file).read.split(&quot;\n&quot;)
            min = [0, line-3].max
            max = [line+1, lines.length-1].min
            selected_lines = []
            selected_lines.join(&quot;\n&quot;)
            lines[min..max].join(&quot;\n&quot;)
          else
            &quot;# Couldn't get snippet for #{file}&quot;
          end
        end
        
        def post_process(highlighted, offending_line)
          new_lines = []
          highlighted.split(&quot;\n&quot;).each_with_index do |line, i|
            new_line = &quot;&lt;span class=\&quot;linenum\&quot;&gt;#{offending_line+i-2}&lt;/span&gt;#{line}&quot;
            new_line = &quot;&lt;span class=\&quot;offending\&quot;&gt;#{new_line}&lt;/span&gt;&quot; if i == 2
            new_lines &lt;&lt; new_line
          end
          new_lines.join(&quot;\n&quot;)
        end
        
      end
    end
  end
end
</pre>
    </div>