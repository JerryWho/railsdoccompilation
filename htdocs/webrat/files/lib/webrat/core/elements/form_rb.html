  <div id="fileHeader">
    <h1>form.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>lib/webrat/core/elements/form.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 19:44:05 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require &quot;webrat/core/elements/field&quot;
require &quot;webrat/core_extensions/blank&quot;

require &quot;webrat/core/elements/element&quot;
require &quot;webrat/core/locators/field_named_locator&quot;

module Webrat
  class Form &lt; Element #:nodoc:
    attr_reader :element

    def self.xpath_search
      [&quot;.//form&quot;]
    end

    def fields
      @fields ||= Field.load_all(@session, @element)
    end

    def submit
      @session.request_page(form_action, form_method, params)
    end

    def field_named(name, *field_types)
      Webrat::Locators::FieldNamedLocator.new(@session, dom, name, *field_types).locate
    end

  protected

    def dom
      @session.dom.xpath(path).first
    end

    def fields_by_type(field_types)
      if field_types.any?
        fields.select { |f| field_types.include?(f.class) }
      else
        fields
      end
    end

    def params
      all_params = {}

      fields.each do |field|
        next if field.to_param.nil?
        merge(all_params, field.to_param)
      end

      all_params
    end

    def form_method
      @element[&quot;method&quot;].blank? ? :get : @element[&quot;method&quot;].downcase
    end

    def form_action
      @element[&quot;action&quot;].blank? ? @session.current_url : @element[&quot;action&quot;]
    end

    def merge(all_params, new_param)
      new_param.each do |key, value|
        case all_params[key]
        when *hash_classes
          merge_hash_values(all_params[key], value)
        when Array
          all_params[key] += value
        else
          all_params[key] = value
        end
      end
    end

    def merge_hash_values(a, b) # :nodoc:
      a.keys.each do |k|
        if b.has_key?(k)
          case [a[k], b[k]].map{|value| value.class}
          when *hash_classes.zip(hash_classes)
            a[k] = merge_hash_values(a[k], b[k])
            b.delete(k)
          when [Array, Array]
            a[k] += b[k]
            b.delete(k)
          end
        end
      end
      a.merge!(b)
    end

    def hash_classes
      klasses = [Hash]

      case Webrat.configuration.mode
      when :rails
        klasses &lt;&lt; HashWithIndifferentAccess
      when :merb
        klasses &lt;&lt; Mash
      end

      klasses
    end

  end
end
</pre>
    </div>