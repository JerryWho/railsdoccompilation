  <div id="fileHeader">
    <h1>testWIN32OLE.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>ruby-1.8.7-p22/ext/win32ole/tests/testWIN32OLE.rb
      </td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Feb 12 17:01:19 -0600 2007</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre># You need RubyUnit and MS Excel and MSI to run this test script 

require 'runit/testcase'
require 'runit/cui/testrunner'

require 'win32ole'
require 'oleserver'

module EXCEL_CONST
end

module CONST1
end

module CONST2
end

module CONST3
end

class TestWin32OLE &lt; RUNIT::TestCase
  include OLESERVER
  def setup
    @excel = WIN32OLE.new(&quot;Excel.Application&quot;)
    @excel.visible = true
  end
  def test_s_new
    assert_instance_of(WIN32OLE, @excel)
  end
  def test_s_new_DCOM
    rexcel = WIN32OLE.new(&quot;Excel.Application&quot;, &quot;localhost&quot;)
    assert_instance_of(WIN32OLE, rexcel)
    rexcel.visible = true
    rexcel.quit
  end
  def test_s_new_from_clsid
    excel = WIN32OLE.new(&quot;{00024500-0000-0000-C000-000000000046}&quot;)
    assert_instance_of(WIN32OLE, excel)
    excel.quit
    exc = assert_exception(WIN32OLERuntimeError) {
      WIN32OLE.new(&quot;{000}&quot;)
    }
    assert_match(/unknown OLE server: `\{000\}'/, exc.message)
  end
  def test_s_connect
    excel2 = WIN32OLE.connect('Excel.Application')
    assert_instance_of(WIN32OLE, excel2)
  end

  def test_s_const_load
    assert(!defined?(EXCEL_CONST::XlTop))
    WIN32OLE.const_load(@excel, EXCEL_CONST)
    assert_equal(-4160, EXCEL_CONST::XlTop)

    assert(!defined?(CONST1::XlTop))
    WIN32OLE.const_load(MS_EXCEL_TYPELIB, CONST1)
    assert_equal(-4160, CONST1::XlTop)
  end

  def test_s_codepage
    assert_equal(WIN32OLE::CP_ACP, WIN32OLE.codepage)
  end

  def test_s_codepage_set
    WIN32OLE.codepage = WIN32OLE::CP_UTF8
    assert_equal(WIN32OLE::CP_UTF8, WIN32OLE.codepage)
    WIN32OLE.codepage = WIN32OLE::CP_ACP
  end

  def test_const_CP_ACP
    assert_equal(0, WIN32OLE::CP_ACP)
  end

  def test_const_CP_OEMCP
    assert_equal(1, WIN32OLE::CP_OEMCP)
  end

  def test_const_CP_MACCP
    assert_equal(2, WIN32OLE::CP_MACCP)
  end

  def test_const_CP_THREAD_ACP
    assert_equal(3, WIN32OLE::CP_THREAD_ACP)
  end

  def test_const_CP_SYMBOL
    assert_equal(42, WIN32OLE::CP_SYMBOL)
  end

  def test_const_CP_UTF7
    assert_equal(65000, WIN32OLE::CP_UTF7)
  end

  def test_const_CP_UTF8
    assert_equal(65001, WIN32OLE::CP_UTF8)
  end

  def test_s_codepage_changed
    book = @excel.workbooks.add
    sheet = book.worksheets(1)
    begin
      WIN32OLE.codepage = WIN32OLE::CP_UTF8
      sheet.range(&quot;A1&quot;).value = [0x3042].pack(&quot;U*&quot;)
      val = sheet.range(&quot;A1&quot;).value
      assert_equal(&quot;\343\201\202&quot;, val)
      WIN32OLE.codepage = WIN32OLE::CP_ACP
      val = sheet.range(&quot;A1&quot;).value
      assert_equal(&quot;\202\240&quot;, val)
    ensure
      book.saved = true
    end
  end

  def test_get_win32ole_object
    workbooks = @excel.Workbooks;
    assert_instance_of(WIN32OLE, workbooks)
  end
  def test_each
    workbooks = @excel.Workbooks
    assert_no_exception {
      i = 0;
      workbooks.each do |workbook|
        print i += 1
      end
    }
    workbooks.add
    workbooks.add
    i = 0
    workbooks.each do |workbook|
      i+=1
    end
    assert_equal(2, i)
    workbooks.each do |workbook|
      workbook.saved = true
    end
  end
  def test_setproperty_bracket
    book = @excel.workbooks.add
    sheet = book.worksheets(1)
    begin
      sheet.range(&quot;A1&quot;)['Value'] = 10
      assert_equal(10, sheet.range(&quot;A1&quot;).value)
      sheet['Cells', 1, 2] = 10
      assert_equal(10, sheet.range(&quot;B1&quot;).value)
      assert_equal(10, sheet['Cells', 1, 2].value)
    ensure
      book.saved = true
    end
  end
  def test_convert_bignum
    book = @excel.workbooks.add
    sheet = book.worksheets(1)
    begin
      sheet.range(&quot;A1&quot;).value = 999999999
      sheet.range(&quot;A2&quot;).value = 9999999999
      sheet.range(&quot;A3&quot;).value = &quot;=A1*10 + 9&quot;
      assert_equal(9999999999, sheet.range(&quot;A2&quot;).value)
      assert_equal(9999999999, sheet.range(&quot;A3&quot;).value)
     
    ensure
      book.saved = true
    end
  end

  def test_ole_invoke_with_named_arg
    book = @excel.workbooks.add
    sheets = book.worksheets
    sheet = book.worksheets(1)
    num = sheets.count
    begin
      sheets.add({'count' =&gt; 2, 'after'=&gt;sheet})
      assert_equal(2, sheets.count - num);
    ensure
      book.saved = true
    end
  end

  def test_ole_invoke_with_named_arg_last
    book = @excel.workbooks.add
    sheets = book.worksheets
    sheet = book.worksheets(1)
    num = sheets.count
    begin
      sheets.add(sheet, {'count' =&gt; 2})
      assert_equal(2, sheets.count - num);
    ensure
      book.saved = true
    end
  end

  def test_setproperty
    @excel.setproperty('Visible', false)
    assert_equal(false, @excel.Visible)
    @excel.setproperty('Visible', true)
    assert_equal(true, @excel.Visible)
    book = @excel.workbooks.add
    sheet = book.worksheets(1)
    begin
      sheet.setproperty('Cells', 1, 2, 10)
      assert_equal(10, sheet.range(&quot;B1&quot;).value)
    ensure
      book.saved = true
    end
  end
  def test_no_exist_property
    isok = false
    begin
      @excel.unknown_prop = 1
    rescue WIN32OLERuntimeError
      isok = true
    end
    assert(isok)

    isok = false
    begin
      @excel['unknown_prop'] = 2
    rescue WIN32OLERuntimeError
      isok = true
    end
    assert(isok)
  end

  def test_setproperty_with_equal
    book = @excel.workbooks.add
    sheet = book.worksheets(1)
    begin
      sheet.range(&quot;B1&quot;).value = 10
      assert_equal(10, sheet.range(&quot;B1&quot;).value)
      sheet.range(&quot;C1:D1&quot;).value = [11, 12]
      assert_equal(11, sheet.range(&quot;C1&quot;).value)
      assert_equal(12, sheet.range(&quot;D1&quot;).value)
    ensure
      book.saved = true
    end
  end
  def test_invoke
    workbooks = @excel.invoke( 'workbooks' )
    assert_instance_of(WIN32OLE, workbooks)
    book = workbooks.invoke( 'add' )
    assert_instance_of(WIN32OLE, book)
  end
  def test_ole_methods
    methods = @excel.ole_methods
    method_names = methods.collect{|m| m.name}
    assert(method_names.include?(&quot;Quit&quot;))
  end
  def test_ole_func_methods
    methods = @excel.ole_func_methods
    assert(methods.size &gt; 0)
    method_names = methods.collect{|m| m.name}
    assert(method_names.include?(&quot;Quit&quot;))
  end
  def test_ole_put_methods
    methods = @excel.ole_put_methods
    assert(methods.size &gt; 0)
    method_names = methods.collect{|m| m.name}
    assert(method_names.include?(&quot;Visible&quot;))
  end
  def test_ole_get_methods
    methods = @excel.ole_get_methods
    assert(methods.size &gt; 0)
    method_names = methods.collect{|m| m.name}
    assert(method_names.include?(&quot;Visible&quot;))
  end
  def test_ole_method_help
    quit_info = @excel.ole_method_help(&quot;Quit&quot;)
    assert_equal(0, quit_info.size_params)
    assert_equal(0, quit_info.size_opt_params)

    workbooks = @excel.Workbooks
    add_info = workbooks.ole_method_help(&quot;Add&quot;)
    assert_equal(1, add_info.size_params)
    assert_equal(1, add_info.size_opt_params)
    assert(add_info.params[0].input?)
    assert(add_info.params[0].optional?)
    assert_equal('VARIANT', add_info.params[0].ole_type)
  end
  def teardown
    @excel.quit
    @excel = nil
    GC.start
  end
end

class TestWin32OLE_WITH_MSI &lt; RUNIT::TestCase
  def setup
    installer = WIN32OLE.new(&quot;WindowsInstaller.Installer&quot;)
    @record = installer.CreateRecord(2)
  end

  # Sorry, this test fails. 
  # Win32OLE does not support this style to set property.
  # Use Win32OLE#setproperty or Win32OLE#[]= .
  # def test_invoke
  #   @record.invoke(&quot;StringData&quot;, 1, 'cccc')
  #   assert_equal('cccc', @record.StringData(1))
  # end

  def test_setproperty
    @record.setproperty( &quot;StringData&quot;, 1, 'dddd')
    assert_equal('dddd', @record.StringData(1))
  end
  def test_bracket_equal_with_arg
    @record[ &quot;StringData&quot;, 1 ] =  'ffff'
    assert_equal('ffff', @record.StringData(1))
  end

  def test__invoke
    shell=WIN32OLE.new('Shell.Application')
    assert_equal(shell.NameSpace(0).title, shell._invoke(0x60020002, [0], [WIN32OLE::VARIANT::VT_VARIANT]).title)
  end
end

# ---------------------
#
# a subclass of Win32OLE
# override new() and connect()
class MyExcel&lt;WIN32OLE
    def MyExcel.new 
        super &quot;Excel.Application&quot;
    end
    def MyExcel.connect
        super &quot;Excel.Application&quot;
    end
end

class TestMyExcel &lt; TestWin32OLE
#
# because we overrided new() and connect()
# we need to change the test.
# also, because the class will be different
# 
  def setup
    @excel = MyExcel.new
    @excel.visible = true
  end
  def test_s_new
    assert_instance_of(MyExcel, @excel)
  end
  def test_s_connect
    excel2 = MyExcel.connect
    assert_instance_of(MyExcel, excel2)
  end
#
# const_load didn't like to be called twice,
# and I don't know how to undefine something in Ruby yet 
# so, hide the test.
#
  private :test_s_const_load
end

if $0 == __FILE__
  puts &quot;Now Test Win32OLE version #{WIN32OLE::VERSION}&quot;
  if ARGV.size == 0
	suite = RUNIT::TestSuite.new
	suite.add_test(TestWin32OLE.suite)
	suite.add_test(TestMyExcel.suite)
    begin
      installer = WIN32OLE.new(&quot;WindowsInstaller.Installer&quot;)
      suite.add_test(TestWin32OLE_WITH_MSI.suite)
    rescue
      puts &quot;Skip some test with MSI&quot;
    end
  else
    suite = RUNIT::TestSuite.new
    ARGV.each do |testmethod|
      suite.add_test(TestWin32OLE.new(testmethod))
    end
  end
  RUNIT::CUI::TestRunner.quiet_mode = true
  RUNIT::CUI::TestRunner.run(suite)
end
</pre>
    </div>