  <div id="fileHeader">
    <h1>converter.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>ruby-1.8.7-p22/lib/rss/converter.rb
      </td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Oct 21 07:19:43 -0500 2007</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require &quot;rss/utils&quot;

module RSS

  class Converter
    
    include Utils

    def initialize(to_enc, from_enc=nil)
      normalized_to_enc = to_enc.downcase.gsub(/-/, '_')
      from_enc ||= 'utf-8'
      normalized_from_enc = from_enc.downcase.gsub(/-/, '_')
      if normalized_to_enc == normalized_from_enc
        def_same_enc()
      else
        def_diff_enc = &quot;def_to_#{normalized_to_enc}_from_#{normalized_from_enc}&quot;
        if respond_to?(def_diff_enc)
          __send__(def_diff_enc)
        else
          def_else_enc(to_enc, from_enc)
        end
      end
    end

    def convert(value)
      value
    end

    def def_convert(depth=0)
      instance_eval(&lt;&lt;-EOC, *get_file_and_line_from_caller(depth))
      def convert(value)
        if value.kind_of?(String)
          #{yield('value')}
        else
          value
        end
      end
      EOC
    end

    def def_iconv_convert(to_enc, from_enc, depth=0)
      begin
        require &quot;iconv&quot;
        @iconv = Iconv.new(to_enc, from_enc)
        def_convert(depth+1) do |value|
          &lt;&lt;-EOC
          begin
            @iconv.iconv(#{value})
          rescue Iconv::Failure
            raise ConversionError.new(#{value}, &quot;#{to_enc}&quot;, &quot;#{from_enc}&quot;)
          end
          EOC
        end
      rescue LoadError, ArgumentError, SystemCallError
        raise UnknownConversionMethodError.new(to_enc, from_enc)
      end
    end
    
    def def_else_enc(to_enc, from_enc)
      def_iconv_convert(to_enc, from_enc, 0)
    end
    
    def def_same_enc()
      def_convert do |value|
        value
      end
    end

    def def_uconv_convert_if_can(meth, to_enc, from_enc, nkf_arg)
      begin
        require &quot;uconv&quot;
        def_convert(1) do |value|
          &lt;&lt;-EOC
          begin
            Uconv.#{meth}(#{value})
          rescue Uconv::Error
            raise ConversionError.new(#{value}, &quot;#{to_enc}&quot;, &quot;#{from_enc}&quot;)
          end
          EOC
        end
      rescue LoadError
        require 'nkf'
        if NKF.const_defined?(:UTF8)
          def_convert(1) do |value|
            &quot;NKF.nkf(#{nkf_arg.dump}, #{value})&quot;
          end
        else
          def_iconv_convert(to_enc, from_enc, 1)
        end
      end
    end

    def def_to_euc_jp_from_utf_8
      def_uconv_convert_if_can('u8toeuc', 'EUC-JP', 'UTF-8', '-We')
    end
    
    def def_to_utf_8_from_euc_jp
      def_uconv_convert_if_can('euctou8', 'UTF-8', 'EUC-JP', '-Ew')
    end
    
    def def_to_shift_jis_from_utf_8
      def_uconv_convert_if_can('u8tosjis', 'Shift_JIS', 'UTF-8', '-Ws')
    end
    
    def def_to_utf_8_from_shift_jis
      def_uconv_convert_if_can('sjistou8', 'UTF-8', 'Shift_JIS', '-Sw')
    end
    
    def def_to_euc_jp_from_shift_jis
      require &quot;nkf&quot;
      def_convert do |value|
        &quot;NKF.nkf('-Se', #{value})&quot;
      end
    end
    
    def def_to_shift_jis_from_euc_jp
      require &quot;nkf&quot;
      def_convert do |value|
        &quot;NKF.nkf('-Es', #{value})&quot;
      end
    end
    
    def def_to_euc_jp_from_iso_2022_jp
      require &quot;nkf&quot;
      def_convert do |value|
        &quot;NKF.nkf('-Je', #{value})&quot;
      end
    end
    
    def def_to_iso_2022_jp_from_euc_jp
      require &quot;nkf&quot;
      def_convert do |value|
        &quot;NKF.nkf('-Ej', #{value})&quot;
      end
    end

    def def_to_utf_8_from_iso_8859_1
      def_convert do |value|
        &quot;#{value}.unpack('C*').pack('U*')&quot;
      end
    end
    
    def def_to_iso_8859_1_from_utf_8
      def_convert do |value|
        &lt;&lt;-EOC
        array_utf8 = #{value}.unpack('U*')
        array_enc = []
        array_utf8.each do |num|
          if num &lt;= 0xFF
            array_enc &lt;&lt; num
          else
            array_enc.concat &quot;&amp;\#\#{num};&quot;.unpack('C*')
          end
        end
        array_enc.pack('C*')
        EOC
      end
    end
    
  end
  
end
</pre>
    </div>