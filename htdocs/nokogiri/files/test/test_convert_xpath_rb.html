  <div id="fileHeader">
    <h1>test_convert_xpath.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>test/test_convert_xpath.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 19:40:25 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require &quot;helper&quot;

class TestConvertXPath &lt; Nokogiri::TestCase

  def setup
    super
    @N = Nokogiri(File.read(HTML_FILE))
  end

  def assert_syntactical_equivalence(hpath, xpath, match, &amp;blk)
    blk ||= lambda {|j| j.first}
    assert_equal match, blk.call(@N.search(xpath)), &quot;xpath result did not match&quot;
  end

  def test_child_tag
    assert_syntactical_equivalence(&quot;h1[a]&quot;, &quot;.//h1[child::a]&quot;, &quot;Tender Lovemaking&quot;) do |j|
      j.inner_text
    end
  end

  def test_child_tag_equals
    assert_syntactical_equivalence(&quot;h1[a='Tender Lovemaking']&quot;, &quot;.//h1[child::a = 'Tender Lovemaking']&quot;, &quot;Tender Lovemaking&quot;) do |j|
      j.inner_text
    end
  end

  def test_filter_contains
    assert_syntactical_equivalence(&quot;title:contains('Tender')&quot;, &quot;.//title[contains(., 'Tender')]&quot;,
                                   &quot;Tender Lovemaking  &quot;) do |j|
      j.inner_text
    end
  end

  def test_filter_comment
    assert_syntactical_equivalence(&quot;div comment()[2]&quot;, &quot;.//div//comment()[position() = 2]&quot;, &quot;&lt;!-- end of header --&gt;&quot;) do |j|
      j.first.to_s
    end
  end

  def test_filter_text
    assert_syntactical_equivalence(&quot;a[text()]&quot;, &quot;.//a[normalize-space(child::text())]&quot;, &quot;&lt;a href=\&quot;http://tenderlovemaking.com\&quot;&gt;Tender Lovemaking&lt;/a&gt;&quot;) do |j|
      j.first.to_s
    end
    assert_syntactical_equivalence(&quot;a[text()='Tender Lovemaking']&quot;, &quot;.//a[normalize-space(child::text()) = 'Tender Lovemaking']&quot;, &quot;&lt;a href=\&quot;http://tenderlovemaking.com\&quot;&gt;Tender Lovemaking&lt;/a&gt;&quot;) do |j|
      j.first.to_s
    end
    assert_syntactical_equivalence(&quot;a/text()&quot;, &quot;.//a/child::text()&quot;, &quot;Tender Lovemaking&quot;) do |j|
      j.first.to_s
    end
    assert_syntactical_equivalence(&quot;h2//a[text()!='Back Home!']&quot;, &quot;.//h2//a[normalize-space(child::text()) != 'Back Home!']&quot;, &quot;Meow meow meow meow meow&quot;) do |j|
      j.first.inner_text
    end
  end

  def test_filter_by_attr
    assert_syntactical_equivalence(&quot;a[@href='http://blog.geminigeek.com/wordpress-theme']&quot;,
                                   &quot;.//a[@href = 'http://blog.geminigeek.com/wordpress-theme']&quot;,
                                   &quot;http://blog.geminigeek.com/wordpress-theme&quot;) do |j|
      j.first[&quot;href&quot;]
    end
  end

  def test_css_id
    assert_syntactical_equivalence(&quot;#linkcat-7&quot;, &quot;.//*[@id = 'linkcat-7']&quot;, &quot;linkcat-7&quot;) do |j|
      j.first[&quot;id&quot;]
    end
    assert_syntactical_equivalence(&quot;li#linkcat-7&quot;, &quot;.//li[@id = 'linkcat-7']&quot;, &quot;linkcat-7&quot;) do |j|
      j.first[&quot;id&quot;]
    end
  end

  def test_css_class
    assert_syntactical_equivalence(&quot;.cat-item-15&quot;, &quot;.//*[contains(concat(' ', @class, ' '), ' cat-item-15 ')]&quot;,
                                   &quot;cat-item cat-item-15&quot;) do |j|
      j.first[&quot;class&quot;]
    end
    assert_syntactical_equivalence(&quot;li.cat-item-15&quot;, &quot;.//li[contains(concat(' ', @class, ' '), ' cat-item-15 ')]&quot;,
                                   &quot;cat-item cat-item-15&quot;) do |j|
      j.first[&quot;class&quot;]
    end
  end

  def test_css_tags
    assert_syntactical_equivalence(&quot;div li a&quot;, &quot;.//div//li//a&quot;, &quot;http://brobinius.org/&quot;) do |j|
      j.first.inner_text
    end
    assert_syntactical_equivalence(&quot;div li &gt; a&quot;, &quot;.//div//li/a&quot;, &quot;http://brobinius.org/&quot;) do |j|
      j.first.inner_text
    end
    assert_syntactical_equivalence(&quot;h1 ~ small&quot;, &quot;.//small[preceding-sibling::h1]&quot;, &quot;The act of making love, tenderly.&quot;) do |j|
      j.first.inner_text
    end
    assert_syntactical_equivalence(&quot;h1 ~ small&quot;, &quot;.//small[preceding-sibling::h1]&quot;, &quot;The act of making love, tenderly.&quot;) do |j|
      j.first.inner_text
    end
  end

  def test_positional
    assert_syntactical_equivalence(&quot;div/div:first()&quot;, &quot;.//div/div[position() = 1]&quot;, &quot;\r\nTender Lovemaking\r\nThe act of making love, tenderly.\r\n&quot;.gsub(/[\r\n]/, '')) do |j|
      j.first.inner_text.gsub(/[\r\n]/, '')
    end
    assert_syntactical_equivalence(&quot;div/div:first&quot;, &quot;.//div/div[position() = 1]&quot;, &quot;\r\nTender Lovemaking\r\nThe act of making love, tenderly.\r\n&quot;.gsub(/[\r\n]/, '')) do |j|
      j.first.inner_text.gsub(/[\r\n]/, '')
    end
    assert_syntactical_equivalence(&quot;div//a:last()&quot;, &quot;.//div//a[position() = last()]&quot;, &quot;Wordpress&quot;) do |j|
      j.last.inner_text
    end
    assert_syntactical_equivalence(&quot;div//a:last&quot;, &quot;.//div//a[position() = last()]&quot;, &quot;Wordpress&quot;) do |j|
      j.last.inner_text
    end
  end

  def test_multiple_filters
    assert_syntactical_equivalence(&quot;a[@rel='bookmark'][1]&quot;, &quot;.//a[@rel = 'bookmark' and position() = 1]&quot;, &quot;Back Home!&quot;) do |j|
      j.first.inner_text
    end
  end

# TODO:
#       doc/'title ~ link' -&gt; links that are siblings of title
#       doc/'p[@class~=&quot;final&quot;]' -&gt; class includes string (whitespacy)
#       doc/'p[text()*=&quot;final&quot;]' -&gt; class includes string (index) (broken: always returns true?)
#       doc/'p[text()$=&quot;final&quot;]' -&gt; /final$/
#       doc/'p[text()|=&quot;final&quot;]' -&gt; /^final$/
#       doc/'p[text()^=&quot;final&quot;]' -&gt; string starts with 'final
#       nth_first
#       nth_last
#       even
#       odd
#       first-child, nth-child, last-child, nth-last-child, nth-last-of-type
#       only-of-type, only-child
#       parent
#       empty
#       root
end
</pre>
    </div>