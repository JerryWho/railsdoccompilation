  <div id="fileHeader">
    <h1>test_document_encoding.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>test/html/test_document_encoding.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 19:40:25 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre># -*- coding: utf-8 -*-
require &quot;helper&quot;

module Nokogiri
  module HTML
    if RUBY_VERSION =~ /^1\.9/
      class TestDocumentEncoding &lt; Nokogiri::TestCase
        def test_encoding
          doc = Nokogiri::HTML File.open(SHIFT_JIS_HTML, 'rb')

          hello = &quot;こんにちは&quot;

          assert_match doc.encoding, doc.to_html
          assert_match hello.encode('Shift_JIS'), doc.to_html
          assert_equal 'Shift_JIS', doc.to_html.encoding.name

          assert_match hello, doc.to_html(:encoding =&gt; 'UTF-8')
          assert_match 'UTF-8', doc.to_html(:encoding =&gt; 'UTF-8')
          assert_match 'UTF-8', doc.to_html(:encoding =&gt; 'UTF-8').encoding.name
        end

        def test_default_to_encoding_from_string
          bad_charset = &lt;&lt;-eohtml
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;   &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=charset=UTF-8&quot;&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;a href=&quot;http://tenderlovemaking.com/&quot;&gt;blah!&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;
          eohtml
          doc = Nokogiri::HTML(bad_charset)
          assert_equal bad_charset.encoding.name, doc.encoding

          doc = Nokogiri.parse(bad_charset)
          assert_equal bad_charset.encoding.name, doc.encoding
        end

        def test_encoding_non_utf8
          orig = '日本語が上手です'
          bin = Encoding::ASCII_8BIT
          [Encoding::Shift_JIS, Encoding::EUC_JP].each do |enc|
            html = &lt;&lt;-eohtml.encode(enc)
&lt;html&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=#{enc.name}&quot;&gt;
&lt;title xml:lang=&quot;ja&quot;&gt;#{orig}&lt;/title&gt;&lt;/html&gt;
            eohtml
            text = Nokogiri::HTML.parse(html).at('title').inner_text
            assert_equal(
              orig.encode(enc).force_encoding(bin),
              text.encode(enc).force_encoding(bin)
            )
          end
        end

        def test_encoding_with_a_bad_name
          bad_charset = &lt;&lt;-eohtml
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;   &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=charset=UTF-8&quot;&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;a href=&quot;http://tenderlovemaking.com/&quot;&gt;blah!&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;
          eohtml
          doc = Nokogiri::HTML(bad_charset, nil, 'askldjfhalsdfjhlkasdfjh')
          assert_equal ['http://tenderlovemaking.com/'],
            doc.css('a').map { |a| a['href'] }
        end
      end
    end
  end
end
</pre>
    </div>