  <div id="fileHeader">
    <h1>test_preserved.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>test/hpricot/test_preserved.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 19:03:28 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require File.expand_path(File.join(File.dirname(__FILE__), '..', &quot;helper&quot;))
require File.join(File.dirname(__FILE__),&quot;load_files&quot;)

class TestPreserved &lt; Nokogiri::TestCase
  def assert_roundtrip str
    doc = Nokogiri.Hpricot(str)
    yield doc if block_given?
    str2 = doc.to_original_html
    [*str].zip([*str2]).each do |s1, s2|
      assert_equal s1, s2
    end
  end

  def assert_html str1, str2
    doc = Nokogiri.Hpricot(str2)
    yield doc if block_given?
    assert_equal str1, doc.to_original_html
  end

  ####
  # Not supporting to_original_html
  #def test_simple
  #  str = &quot;&lt;p&gt;Hpricot is a &lt;b&gt;you know &lt;i&gt;uh&lt;/b&gt; fine thing.&lt;/p&gt;&quot;
  #  assert_html str, str
  #  assert_html &quot;&lt;p class=\&quot;new\&quot;&gt;Hpricot is a &lt;b&gt;you know &lt;i&gt;uh&lt;/b&gt; fine thing.&lt;/p&gt;&quot;, str do |doc|
  #    (doc/:p).set('class', 'new')
  #  end
  #end

  ####
  # Not supporting to_original_html
  #def test_parent
  #  str = &quot;&lt;html&gt;&lt;base href='/'&gt;&lt;head&gt;&lt;title&gt;Test&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;div id='wrap'&gt;&lt;p&gt;Paragraph one.&lt;/p&gt;&lt;p&gt;Paragraph two.&lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;
  #  assert_html str, str
  #  assert_html &quot;&lt;html&gt;&lt;base href='/'&gt;&lt;body&gt;&lt;div id=\&quot;all\&quot;&gt;&lt;div&gt;&lt;p&gt;Paragraph one.&lt;/p&gt;&lt;/div&gt;&lt;div&gt;&lt;p&gt;Paragraph two.&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;, str do |doc|
  #    (doc/:head).remove
  #    (doc/:div).set('id', 'all')
  #    (doc/:p).wrap('&lt;div&gt;&lt;/div&gt;')
  #  end
  #end

  # Not really a valid test.  If libxml can figure out the encoding of the file,
  # it will use that encoding, otherwise it uses the &amp;#xwhatever so that no data
  # is lost.
  #
  # libxml on OSX can't figure out the encoding, so this tests passes.  linux
  # can figure out the encoding, so it fails.
  #def test_escaping_of_contents
  #  doc = Nokogiri.Hpricot(TestFiles::BOINGBOING)
  #  assert_equal &quot;Fukuda&amp;#x2019;s Automatic Door opens around your body as you pass through it. The idea is to save energy and keep the room clean.&quot;, doc.at(&quot;img[@alt='200606131240']&quot;).next.to_s.strip
  #end

  ####
  # Modified.  No.
  #def test_files
  #  assert_roundtrip TestFiles::BASIC
  #  assert_roundtrip TestFiles::BOINGBOING
  #  assert_roundtrip TestFiles::CY0
  #end

  ####
  # Modified..  When calling &quot;to_html&quot; on the document, proper html/doc tags
  # are produced too.
  def test_escaping_of_attrs
    # ampersands in URLs
    str = %{&lt;a href=&quot;http://google.com/search?q=nokogiri&amp;amp;l=en&quot;&gt;Google&lt;/a&gt;}
    link = (doc = Nokogiri(str)).at(:a)
    assert_equal &quot;http://google.com/search?q=nokogiri&amp;l=en&quot;, link['href']
    assert_equal &quot;http://google.com/search?q=nokogiri&amp;l=en&quot;, link.get_attribute('href')
    assert_equal &quot;http://google.com/search?q=nokogiri&amp;l=en&quot;, link['href']
    assert_equal str, link.to_html

    # alter the url
    link['href'] = &quot;javascript:alert(\&quot;AGGA-KA-BOO!\&quot;)&quot;
    assert_equal %{&lt;a href=&quot;javascript:alert(&amp;quot;AGGA-KA-BOO!&amp;quot;)&quot;&gt;Google&lt;/a&gt;}, link.to_html.gsub(/%22/, '&amp;quot;')
  end
end
</pre>
    </div>