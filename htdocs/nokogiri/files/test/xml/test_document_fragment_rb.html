  <div id="fileHeader">
    <h1>test_document_fragment.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>test/xml/test_document_fragment.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 20:15:09 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require &quot;helper&quot;

module Nokogiri
  module XML
    class TestDocumentFragment &lt; Nokogiri::TestCase
      def setup
        super
        @xml = Nokogiri::XML.parse(File.read(XML_FILE), XML_FILE)
      end

      def test_fragment_is_relative
        doc      = Nokogiri::XML('&lt;root&gt;&lt;a xmlns=&quot;blah&quot; /&gt;&lt;/root&gt;')
        ctx      = doc.root.child
        fragment = Nokogiri::XML::DocumentFragment.new(doc, '&lt;hello /&gt;', ctx)
        hello    = fragment.child

        assert_equal 'hello', hello.name
        assert_equal doc.root.child.namespace, hello.namespace
      end

      def test_node_fragment_is_relative
        doc      = Nokogiri::XML('&lt;root&gt;&lt;a xmlns=&quot;blah&quot; /&gt;&lt;/root&gt;')
        ctx      = doc.root.child
        fragment = doc.root.child.fragment('&lt;hello /&gt;')
        hello    = fragment.child

        assert_equal 'hello', hello.name
        assert_equal doc.root.child.namespace, hello.namespace
      end

      def test_new
        fragment = Nokogiri::XML::DocumentFragment.new(@xml)
      end

      def test_fragment_should_have_document
        fragment = Nokogiri::XML::DocumentFragment.new(@xml)
        assert_equal @xml, fragment.document
      end

      def test_name
        fragment = Nokogiri::XML::DocumentFragment.new(@xml)
        assert_equal '#document-fragment', fragment.name
      end

      def test_static_method
        fragment = Nokogiri::XML::DocumentFragment.parse(&quot;&lt;div&gt;a&lt;/div&gt;&quot;)
        assert_instance_of Nokogiri::XML::DocumentFragment, fragment
      end

      def test_static_method_with_namespaces
        # follows different path in FragmentHandler#start_element which blew up after 597195ff
        fragment = Nokogiri::XML::DocumentFragment.parse(&quot;&lt;o:div&gt;a&lt;/o:div&gt;&quot;)
        assert_instance_of Nokogiri::XML::DocumentFragment, fragment
      end

      def test_many_fragments
        100.times { Nokogiri::XML::DocumentFragment.new(@xml) }
      end

      def test_subclass
        klass = Class.new(Nokogiri::XML::DocumentFragment)
        fragment = klass.new(@xml, &quot;&lt;div&gt;a&lt;/div&gt;&quot;)
        assert_instance_of klass, fragment
      end

      def test_subclass_parse
        klass = Class.new(Nokogiri::XML::DocumentFragment)
        doc = klass.parse(&quot;&lt;div&gt;a&lt;/div&gt;&quot;)
        assert_instance_of klass, doc
      end

      def test_xml_fragment
        fragment = Nokogiri::XML.fragment(&quot;&lt;div&gt;a&lt;/div&gt;&quot;)
        assert_equal &quot;&lt;div&gt;a&lt;/div&gt;&quot;, fragment.to_s
      end

      def test_xml_fragment_has_multiple_toplevel_children
        doc = &quot;&lt;div&gt;b&lt;/div&gt;&lt;div&gt;e&lt;/div&gt;&quot;
        fragment = Nokogiri::XML::Document.new.fragment(doc)
        assert_equal &quot;&lt;div&gt;b&lt;/div&gt;&lt;div&gt;e&lt;/div&gt;&quot;, fragment.to_s
      end

      def test_xml_fragment_has_outer_text
        # this test is descriptive, not prescriptive.
        doc = &quot;a&lt;div&gt;b&lt;/div&gt;&quot;
        fragment = Nokogiri::XML::Document.new.fragment(doc)
        assert_equal &quot;a&lt;div&gt;b&lt;/div&gt;&quot;, fragment.to_s

        doc = &quot;&lt;div&gt;b&lt;/div&gt;c&quot;
        fragment = Nokogiri::XML::Document.new.fragment(doc)
        assert_equal &quot;&lt;div&gt;b&lt;/div&gt;c&quot;, fragment.to_s
      end

      def test_xml_fragment_case_sensitivity
        doc = &quot;&lt;crazyDiv&gt;b&lt;/crazyDiv&gt;&quot;
        fragment = Nokogiri::XML::Document.new.fragment(doc)
        assert_equal &quot;&lt;crazyDiv&gt;b&lt;/crazyDiv&gt;&quot;, fragment.to_s
      end

      def test_xml_fragment_with_leading_whitespace
        doc = &quot;     &lt;div&gt;b&lt;/div&gt;  &quot;
        fragment = Nokogiri::XML::Document.new.fragment(doc)
        assert_equal &quot;&lt;div&gt;b&lt;/div&gt;&quot;, fragment.to_s
      end

      def test_xml_fragment_with_leading_whitespace_and_newline
        doc = &quot;     \n&lt;div&gt;b&lt;/div&gt;  &quot;
        fragment = Nokogiri::XML::Document.new.fragment(doc)
        assert_equal &quot;&lt;div&gt;b&lt;/div&gt;&quot;, fragment.to_s
      end

      def test_fragment_children_search
        fragment = Nokogiri::XML::Document.new.fragment(
          '&lt;div&gt;&lt;p id=&quot;content&quot;&gt;hi&lt;/p&gt;&lt;/div&gt;'
        )
        css     = fragment.children.css('p')
        xpath   = fragment.children.xpath('.//p')
        assert_equal css, xpath
      end

      def test_fragment_search
        frag = Nokogiri::XML::Document.new.fragment '&lt;p id=&quot;content&quot;&gt;hi&lt;/p&gt;'

        p_tag = frag.css('#content').first
        assert_equal 'p', p_tag.name

        assert_equal p_tag, frag.xpath('./*[@id = \'content\']').first
      end

      def test_fragment_without_a_namespace_does_not_get_a_namespace
        doc = Nokogiri::XML &lt;&lt;-EOX
          &lt;root xmlns=&quot;http://tenderlovemaking.com/&quot; xmlns:foo=&quot;http://flavorjon.es/&quot; xmlns:bar=&quot;http://google.com/&quot;&gt;
            &lt;foo:existing&gt;&lt;/foo:existing&gt;
          &lt;/root&gt;
        EOX
        frag = doc.fragment &quot;&lt;newnode&gt;&lt;/newnode&gt;&quot;
        assert_nil frag.namespace
      end

      def test_fragment_namespace_resolves_against_document_root
        doc = Nokogiri::XML &lt;&lt;-EOX
          &lt;root xmlns:foo=&quot;http://flavorjon.es/&quot; xmlns:bar=&quot;http://google.com/&quot;&gt;
            &lt;foo:existing&gt;&lt;/foo:existing&gt;
          &lt;/root&gt;
        EOX
        ns = doc.root.namespace_definitions.detect { |x| x.prefix == &quot;bar&quot; }

        frag = doc.fragment &quot;&lt;bar:newnode&gt;&lt;/bar:newnode&gt;&quot;
        assert frag.children.first.namespace
        assert_equal ns, frag.children.first.namespace
      end

      def test_fragment_invalid_namespace_is_silently_ignored
        doc = Nokogiri::XML &lt;&lt;-EOX
          &lt;root xmlns:foo=&quot;http://flavorjon.es/&quot; xmlns:bar=&quot;http://google.com/&quot;&gt;
            &lt;foo:existing&gt;&lt;/foo:existing&gt;
          &lt;/root&gt;
        EOX
        frag = doc.fragment &quot;&lt;baz:newnode&gt;&lt;/baz:newnode&gt;&quot;
        assert_nil frag.children.first.namespace
      end

      def test_decorator_is_applied
        x = Module.new do
          def awesome!
          end
        end
        util_decorate(@xml, x)
        fragment = Nokogiri::XML::DocumentFragment.new(@xml, &quot;&lt;div&gt;a&lt;/div&gt;&lt;div&gt;b&lt;/div&gt;&quot;)

        assert node_set = fragment.css('div')
        assert node_set.respond_to?(:awesome!)
        node_set.each do |node|
          assert node.respond_to?(:awesome!), node.class
        end
        assert fragment.children.respond_to?(:awesome!), fragment.children.class
      end
    end
  end
end
</pre>
    </div>