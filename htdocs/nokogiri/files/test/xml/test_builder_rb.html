  <div id="fileHeader">
    <h1>test_builder.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>test/xml/test_builder.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 20:15:09 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require &quot;helper&quot;

module Nokogiri
  module XML
    class TestBuilder &lt; Nokogiri::TestCase
      def test_builder_namespace
        doc = Nokogiri::XML::Builder.new { |xml|
          xml.a(&quot;xmlns:a&quot; =&gt; &quot;x&quot;) do
            xml.b(&quot;xmlns:a&quot; =&gt; &quot;x&quot;, &quot;xmlns:b&quot; =&gt; &quot;y&quot;)
          end
        }.doc

        b = doc.at('b')
        assert b
        assert_equal({&quot;xmlns:a&quot;=&gt;&quot;x&quot;, &quot;xmlns:b&quot;=&gt;&quot;y&quot;}, b.namespaces)
        assert_equal({&quot;xmlns:b&quot;=&gt;&quot;y&quot;}, namespaces_defined_on(b))
      end

      def test_builder_namespace_part_deux
        doc = Nokogiri::XML::Builder.new { |xml|
          xml.a(&quot;xmlns:b&quot; =&gt; &quot;y&quot;) do
            xml.b(&quot;xmlns:a&quot; =&gt; &quot;x&quot;, &quot;xmlns:b&quot; =&gt; &quot;y&quot;, &quot;xmlns:c&quot; =&gt; &quot;z&quot;)
          end
        }.doc

        b = doc.at('b')
        assert b
        assert_equal({&quot;xmlns:a&quot;=&gt;&quot;x&quot;, &quot;xmlns:b&quot;=&gt;&quot;y&quot;, &quot;xmlns:c&quot;=&gt;&quot;z&quot;}, b.namespaces)
        assert_equal({&quot;xmlns:a&quot;=&gt;&quot;x&quot;, &quot;xmlns:c&quot;=&gt;&quot;z&quot;}, namespaces_defined_on(b))
      end

      def test_builder_with_unlink
        assert_nothing_raised do
          Nokogiri::XML::Builder.new do |xml|
            xml.foo do
              xml.bar { xml.parent.unlink }
              xml.bar2
            end
          end
        end
      end

      def test_with_root
        doc = Nokogiri::XML(File.read(XML_FILE))
        Nokogiri::XML::Builder.with(doc.at('employee')) do |xml|
          xml.foo
        end
        assert_equal 1, doc.xpath('//employee/foo').length
      end

      def test_root_namespace_default_decl
        b = Nokogiri::XML::Builder.new { |xml| xml.root(:xmlns =&gt; 'one:two') }
        doc = b.doc
        assert_equal 'one:two', doc.root.namespace.href
        assert_equal({ 'xmlns' =&gt; 'one:two' }, doc.root.namespaces)
      end

      def test_root_namespace_multi_decl
        b = Nokogiri::XML::Builder.new { |xml|
          xml.root(:xmlns =&gt; 'one:two', 'xmlns:foo' =&gt; 'bar') do
            xml.hello
          end
        }
        doc = b.doc
        assert_equal 'one:two', doc.root.namespace.href
        assert_equal({ 'xmlns' =&gt; 'one:two', 'xmlns:foo' =&gt; 'bar' }, doc.root.namespaces)

        assert_equal 'one:two', doc.at('hello').namespace.href
      end

      def test_non_root_namespace
        b = Nokogiri::XML::Builder.new { |xml|
          xml.root { xml.hello(:xmlns =&gt; 'one') }
        }
        assert_equal 'one', b.doc.at('hello', 'xmlns' =&gt; 'one').namespace.href
      end

      def test_specify_namespace
        b = Nokogiri::XML::Builder.new { |xml|
          xml.root('xmlns:foo' =&gt; 'bar') do
            xml[:foo].bar
            xml['foo'].baz
          end
        }
        doc = b.doc
        assert_equal 'bar', b.doc.at('foo|bar', 'foo' =&gt; 'bar').namespace.href
        assert_equal 'bar', b.doc.at('foo|baz', 'foo' =&gt; 'bar').namespace.href
      end

      def test_specify_namespace_nested
        b = Nokogiri::XML::Builder.new { |xml|
          xml.root('xmlns:foo' =&gt; 'bar') do
            xml.yay do
              xml[:foo].bar

              xml.yikes do
                xml['foo'].baz
              end
            end
          end
        }
        doc = b.doc
        assert_equal 'bar', b.doc.at('foo|bar', 'foo' =&gt; 'bar').namespace.href
        assert_equal 'bar', b.doc.at('foo|baz', 'foo' =&gt; 'bar').namespace.href
      end

      def test_specified_namespace_undeclared
        b = Nokogiri::XML::Builder.new { |xml|
          xml.root do
            assert_raises(ArgumentError) do
              xml[:foo]
            end
          end
        }
      end

      def test_set_encoding
        builder = Nokogiri::XML::Builder.new(:encoding =&gt; 'UTF-8') do |xml|
          xml.root do
            xml.bar 'blah'
          end
        end
        assert_match 'UTF-8', builder.to_xml
      end

      def test_bang_and_underscore_is_escaped
        builder = Nokogiri::XML::Builder.new do |xml|
          xml.root do
            xml.p_('adsfadsf')
            xml.p!('adsfadsf')
          end
        end
        assert_equal 2, builder.doc.xpath('//p').length
      end

      def test_square_brackets_set_attributes
        builder = Nokogiri::XML::Builder.new do |xml|
          xml.root do
            foo = xml.foo
            foo['id'] = 'hello'
            assert_equal 'hello', foo['id']
          end
        end
        assert_equal 1, builder.doc.xpath('//foo[@id = &quot;hello&quot;]').length
      end

      def test_nested_local_variable
        @ivar     = 'hello'
        local_var = 'hello world'
        builder = Nokogiri::XML::Builder.new do |xml|
          xml.root do
            xml.foo local_var
            xml.bar @ivar
            xml.baz {
              xml.text @ivar
            }
          end
        end

        assert_equal 'hello world', builder.doc.at('//root/foo').content
        assert_equal 'hello', builder.doc.at('//root/bar').content
        assert_equal 'hello', builder.doc.at('baz').content
      end

      def test_raw_append
        builder = Nokogiri::XML::Builder.new do |xml|
          xml.root do
            xml &lt;&lt; 'hello'
          end
        end

        assert_equal 'hello', builder.doc.at('/root').content
      end

      def test_raw_append_with_instance_eval
        builder = Nokogiri::XML::Builder.new do
          root do
            self &lt;&lt; 'hello'
          end
        end

        assert_equal 'hello', builder.doc.at('/root').content
      end

      def test_cdata
        builder = Nokogiri::XML::Builder.new do
          root {
            cdata &quot;hello world&quot;
          }
        end
        assert_equal(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&lt;root&gt;&lt;![CDATA[hello world]]&gt;&lt;/root&gt;&quot;, builder.to_xml.gsub(/\n/, ''))
      end

      def test_builder_no_block
        string = &quot;hello world&quot;
        builder = Nokogiri::XML::Builder.new
        builder.root {
          cdata string
        }
        assert_equal(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&lt;root&gt;&lt;![CDATA[hello world]]&gt;&lt;/root&gt;&quot;, builder.to_xml.gsub(/\n/, ''))
      end

    private

      def namespaces_defined_on(node)
        Hash[*node.namespace_definitions.collect{|n| [&quot;xmlns:&quot; + n.prefix, n.href]}.flatten]
      end
    end
  end
end
</pre>
    </div>