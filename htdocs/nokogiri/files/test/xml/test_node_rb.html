  <div id="fileHeader">
    <h1>test_node.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>test/xml/test_node.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Thu Nov 26 17:54:09 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require &quot;helper&quot;

require 'stringio'

module Nokogiri
  module XML
    class TestNode &lt; Nokogiri::TestCase
      def setup
        super
        @xml = Nokogiri::XML(File.read(XML_FILE), XML_FILE)
      end

      def test_element?
        assert @xml.root.element?, 'is an element'
      end

      def test_slash_search
        assert_equal 'EMP0001', (@xml/:staff/:employee/:employeeId).first.text
      end

      def test_append_with_document
        assert_raises(ArgumentError) do
          @xml.root &lt;&lt; Nokogiri::XML::Document.new
        end
      end

      def test_inspect_ns
        xml = Nokogiri::XML(&lt;&lt;-eoxml) { |c| c.noblanks }
          &lt;root xmlns=&quot;http://tenderlovemaking.com/&quot; xmlns:foo=&quot;bar&quot;&gt;
            &lt;awesome/&gt;
          &lt;/root&gt;
        eoxml
        ins = xml.inspect

        xml.traverse do |node|
          assert_match node.class.name, ins
          if node.respond_to? :attributes
            node.attributes.each do |k,v|
              assert_match k, ins
              assert_match v, ins
            end
          end

          if node.respond_to?(:namespace) &amp;&amp; node.namespace
            assert_match node.namespace.class.name, ins
            assert_match node.namespace.href, ins
          end
        end
      end

      def test_namespace_nodes
        xml = Nokogiri::XML &lt;&lt;-eoxml
          &lt;root xmlns=&quot;http://tenderlovemaking.com/&quot; xmlns:foo=&quot;bar&quot;&gt;
            &lt;awesome/&gt;
          &lt;/root&gt;
        eoxml
        awesome = xml.root
        namespaces = awesome.namespace_definitions
        assert_equal 2, namespaces.length
      end

      def test_no_definitions
        xml = Nokogiri::XML &lt;&lt;-eoxml
          &lt;root xmlns=&quot;http://tenderlovemaking.com/&quot; xmlns:foo=&quot;bar&quot;&gt;
            &lt;awesome/&gt;
          &lt;/root&gt;
        eoxml
        awesome = xml.at('//xmlns:awesome')
        namespaces = awesome.namespace_definitions
        assert_equal 0, namespaces.length
      end

      def test_subclass_dup
        subclass = Class.new(Nokogiri::XML::Node)
        node = subclass.new('foo', @xml).dup
        assert_instance_of subclass, node
      end

      def test_namespace_goes_to_children
        fruits = Nokogiri::XML(&lt;&lt;-eoxml)
        &lt;Fruit xmlns='www.fruits.org'&gt;
        &lt;/Fruit&gt;
        eoxml
        apple = Nokogiri::XML::Node.new('Apple', fruits)
        orange = Nokogiri::XML::Node.new('Orange', fruits)
        apple &lt;&lt; orange
        fruits.root &lt;&lt; apple
        assert fruits.at('//fruit:Orange',{'fruit'=&gt;'www.fruits.org'})
        assert fruits.at('//fruit:Apple',{'fruit'=&gt;'www.fruits.org'})
      end

      def test_description
        assert_nil @xml.at('employee').description
      end

      def test_add_namespace_add_child
        doc   = Nokogiri::XML::Document.new
        item  = Nokogiri::XML::Element.new('item', doc)
        doc.root = item

        entry = Nokogiri::XML::Element.new('entry', doc)
        entry.add_namespace('tlm', 'http://tenderlovemaking.com')
        assert_equal 'http://tenderlovemaking.com', entry.namespaces['xmlns:tlm']
        item.add_child(entry)
        assert_equal 'http://tenderlovemaking.com', entry.namespaces['xmlns:tlm']
      end

      def test_spaceship
        nodes = @xml.xpath('//employee')
        assert_equal(-1, (nodes.first &lt;=&gt; nodes.last))
        list = [nodes.first, nodes.last].sort
        assert_equal nodes.first, list.first
        assert_equal nodes.last, list.last
      end

      def test_incorrect_spaceship
        nodes = @xml.xpath('//employee')
        assert_nil(nodes.first &lt;=&gt; 'asdf')
      end

      def test_document_compare
        nodes = @xml.xpath('//employee')
        assert_equal(-1, (nodes.first &lt;=&gt; @xml))
      end

      def test_different_document_compare
        nodes = @xml.xpath('//employee')
        doc = Nokogiri::XML('&lt;a&gt;&lt;b/&gt;&lt;/a&gt;')
        b = doc.at('b')
        assert_nil(nodes.first &lt;=&gt; b)
      end

      def test_duplicate_node_removes_namespace
        fruits = Nokogiri::XML(&lt;&lt;-eoxml)
        &lt;Fruit xmlns='www.fruits.org'&gt;
        &lt;Apple&gt;&lt;/Apple&gt;
        &lt;/Fruit&gt;
        eoxml
        apple = fruits.root.xpath('fruit:Apple', {'fruit'=&gt;'www.fruits.org'})[0]
        new_apple = apple.dup
        fruits.root &lt;&lt; new_apple
        assert_equal 2, fruits.xpath('//xmlns:Apple').length
        assert_equal 1, fruits.to_xml.scan('www.fruits.org').length
      end

      [:clone, :dup].each do |symbol|
        define_method &quot;test_#{symbol}&quot; do
          node = @xml.at('//employee')
          other = node.send(symbol)
          assert_equal &quot;employee&quot;, other.name
          assert_nil other.parent
        end
      end

      def test_fragment_creates_elements
        apple = @xml.fragment('&lt;Apple/&gt;')
        apple.children.each do |child|
          assert_equal Nokogiri::XML::Node::ELEMENT_NODE, child.type
          assert_instance_of Nokogiri::XML::Element, child
        end
      end

      def test_node_added_to_root_should_get_namespace
        fruits = Nokogiri::XML(&lt;&lt;-eoxml)
          &lt;Fruit xmlns='http://www.fruits.org'&gt;
          &lt;/Fruit&gt;
        eoxml
        apple = fruits.fragment('&lt;Apple/&gt;')
        fruits.root &lt;&lt; apple
        assert_equal 1, fruits.xpath('//xmlns:Apple').length
      end

      def test_add_child_path_following_sequential_text_nodes
        xml = Nokogiri::XML('&lt;root&gt;text&lt;/root&gt;')
        xml.root.add_child(Nokogiri::XML::Text.new('text', xml))
        item = xml.root.add_child(Nokogiri::XML::Element.new('item', xml))
        assert_equal '/root/item', item.path
      end

      def test_new_node_can_have_ancestors
        xml = Nokogiri::XML('&lt;root&gt;text&lt;/root&gt;')
        item = Nokogiri::XML::Element.new('item', xml)
        assert_equal 0, item.ancestors.length
      end

      def test_children
        doc = Nokogiri::XML(&lt;&lt;-eoxml)
          &lt;root&gt;#{'&lt;a/&gt;' * 9 }&lt;/root&gt;
        eoxml
        assert_equal 9, doc.root.children.length
        assert_equal 9, doc.root.children.to_a.length

        doc = Nokogiri::XML(&lt;&lt;-eoxml)
          &lt;root&gt;#{'&lt;a/&gt;' * 15 }&lt;/root&gt;
        eoxml
        assert_equal 15, doc.root.children.length
        assert_equal 15, doc.root.children.to_a.length
      end

      def test_add_namespace
        node = @xml.at('address')
        node.add_namespace('foo', 'http://tenderlovemaking.com')
        assert_equal 'http://tenderlovemaking.com', node.namespaces['xmlns:foo']
      end

      def test_add_namespace_twice
        node = @xml.at('address')
        ns = node.add_namespace('foo', 'http://tenderlovemaking.com')
        ns2 = node.add_namespace('foo', 'http://tenderlovemaking.com')
        assert_equal ns, ns2
      end

      def test_add_default_ns
        node = @xml.at('address')
        node.add_namespace(nil, 'http://tenderlovemaking.com')
        assert_equal 'http://tenderlovemaking.com', node.namespaces['xmlns']
      end

      def test_add_multiple_namespaces
        node = @xml.at('address')

        node.add_namespace(nil, 'http://tenderlovemaking.com')
        assert_equal 'http://tenderlovemaking.com', node.namespaces['xmlns']

        node.add_namespace('foo', 'http://tenderlovemaking.com')
        assert_equal 'http://tenderlovemaking.com', node.namespaces['xmlns:foo']
      end

      def test_default_namespace=
        node = @xml.at('address')
        node.default_namespace = 'http://tenderlovemaking.com'
        assert_equal 'http://tenderlovemaking.com', node.namespaces['xmlns']
      end

      def test_namespace=
        node = @xml.at('address')
        assert_nil node.namespace
        definition = node.add_namespace_definition 'bar', 'http://tlm.com/'

        node.namespace = definition

        assert_equal definition, node.namespace

        assert_equal node, @xml.at('//foo:address', {
          'foo' =&gt; 'http://tlm.com/'
        })
      end

      def test_add_namespace_with_nil_associates_node
        node = @xml.at('address')
        assert_nil node.namespace
        definition = node.add_namespace_definition nil, 'http://tlm.com/'
        assert_equal definition, node.namespace
      end

      def test_add_namespace_does_not_associate_node
        node = @xml.at('address')
        assert_nil node.namespace
        definition = node.add_namespace_definition 'foo', 'http://tlm.com/'
        assert_nil node.namespace
      end

      def test_set_namespace_from_different_doc
        node = @xml.at('address')
        doc = Nokogiri::XML(File.read(XML_FILE), XML_FILE)
        decl = doc.root.add_namespace_definition 'foo', 'bar'

        assert_raises(ArgumentError) do
          node.namespace = decl
        end
      end

      def test_set_namespace_must_only_take_a_namespace
        node = @xml.at('address')
        assert_raises(TypeError) do
          node.namespace = node
        end
      end

      def test_at
        node = @xml.at('address')
        assert_equal node, @xml.xpath('//address').first
      end

      def test_at_xpath
        node = @xml.at_xpath('//address')
        nodes = @xml.xpath('//address')
        assert_equal 5, nodes.size
        assert_equal node, nodes.first
      end

      def test_at_css
        node = @xml.at_css('address')
        nodes = @xml.css('address')
        assert_equal 5, nodes.size
        assert_equal node, nodes.first
      end

      def test_percent
        node = @xml % ('address')
        assert_equal node, @xml.xpath('//address').first
      end

      def test_accept
        visitor = Class.new {
          attr_accessor :visited
          def accept target
            target.accept(self)
          end

          def visit node
            node.children.each { |c| c.accept(self) }
            @visited = true
          end
        }.new
        visitor.accept(@xml.root)
        assert visitor.visited
      end

      def test_replace_with_default_namespaces
        fruits = Nokogiri::XML(&lt;&lt;-eoxml)
          &lt;fruit xmlns=&quot;http://fruits.org&quot;&gt;
            &lt;apple /&gt;
          &lt;/fruit&gt;
        eoxml

        apple = fruits.css('apple').first

        orange = Nokogiri::XML::Node.new('orange', fruits)
        apple.replace(orange)

        assert_equal orange, fruits.css('orange').first
      end

      def test_add_child_should_inherit_namespace
        doc = Nokogiri::XML(&lt;&lt;-eoxml)
          &lt;root xmlns=&quot;http://tenderlovemaking.com/&quot;&gt;
            &lt;first&gt;
            &lt;/first&gt;
          &lt;/root&gt;
        eoxml
        assert node = doc.at('//xmlns:first')
        child = Nokogiri::XML::Node.new('second', doc)
        node.add_child(child)
        assert doc.at('//xmlns:second')
      end

      def test_add_child_should_not_inherit_namespace_if_it_has_one
        doc = Nokogiri::XML(&lt;&lt;-eoxml)
          &lt;root xmlns=&quot;http://tenderlovemaking.com/&quot; xmlns:foo=&quot;http://flavorjon.es/&quot;&gt;
            &lt;first&gt;
            &lt;/first&gt;
          &lt;/root&gt;
        eoxml
        assert node = doc.at('//xmlns:first')
        child = Nokogiri::XML::Node.new('second', doc)

        ns = doc.root.namespace_definitions.detect { |x| x.prefix == &quot;foo&quot; }
        child.namespace = ns

        node.add_child(child)
        assert doc.at('//foo:second', &quot;foo&quot; =&gt; &quot;http://flavorjon.es/&quot;)
      end

      def test_write_to
        io = StringIO.new
        @xml.write_to io
        io.rewind
        assert_equal @xml.to_xml, io.read
      end

      def test_attribute_with_symbol
        assert_equal 'Yes', @xml.css('address').first[:domestic]
      end

      def test_write_to_with_block
        called = false
        io = StringIO.new
        conf = nil
        @xml.write_to io do |config|
          called = true
          conf = config
          config.format.as_html.no_empty_tags
        end
        io.rewind
        assert called
        assert_equal @xml.serialize(nil, conf.options), io.read
      end

      %w{ xml html xhtml }.each do |type|
        define_method(:&quot;test_write_#{type}_to&quot;) do
          io = StringIO.new
          assert @xml.send(:&quot;write_#{type}_to&quot;, io)
          io.rewind
          assert_match @xml.send(:&quot;to_#{type}&quot;), io.read
        end
      end

      def test_serialize_with_block
        called = false
        conf = nil
        string = @xml.serialize do |config|
          called = true
          conf = config
          config.format.as_html.no_empty_tags
        end
        assert called
        assert_equal @xml.serialize(nil, conf.options), string
      end

      def test_hold_refence_to_subnode
        doc = Nokogiri::XML(&lt;&lt;-eoxml)
          &lt;root&gt;
            &lt;a&gt;
              &lt;b /&gt;
            &lt;/a&gt;
          &lt;/root&gt;
        eoxml
        assert node_a = doc.css('a').first
        assert node_b = node_a.css('b').first
        node_a.unlink
        assert_equal 'b', node_b.name
      end

      def test_values
        assert_equal %w{ Yes Yes }, @xml.xpath('//address')[1].values
      end

      def test_keys
        assert_equal %w{ domestic street }, @xml.xpath('//address')[1].keys
      end

      def test_each
        attributes = []
        @xml.xpath('//address')[1].each do |key, value|
          attributes &lt;&lt; [key, value]
        end
        assert_equal [['domestic', 'Yes'], ['street', 'Yes']], attributes
      end

      def test_new
        assert node = Nokogiri::XML::Node.new('input', @xml)
        assert_equal 1, node.node_type
        assert_instance_of Nokogiri::XML::Element, node
      end

      def test_to_str
        name = @xml.xpath('//name').first
        assert_match(/Margaret/, '' + name)
        assert_equal('Margaret Martin', '' + name.children.first)
      end

      def test_ancestors
        address = @xml.xpath('//address').first
        assert_equal 3, address.ancestors.length
        assert_equal ['employee', 'staff', 'document'],
          address.ancestors.map { |x| x.name }
      end

      def test_read_only?
        assert entity_decl = @xml.internal_subset.children.find { |x|
          x.type == Node::ENTITY_DECL
        }
        assert entity_decl.read_only?
      end

      def test_remove_attribute
        address = @xml.xpath('/staff/employee/address').first
        assert_equal 'Yes', address['domestic']
        address.remove_attribute 'domestic'
        assert_nil address['domestic']
      end

      def test_delete
        address = @xml.xpath('/staff/employee/address').first
        assert_equal 'Yes', address['domestic']
        address.delete 'domestic'
        assert_nil address['domestic']
      end

      def test_add_child_in_same_document
        child = @xml.css('employee').first

        assert previous_last_child = child.children.last
        assert new_child = child.children.first

        last = child.children.last

        child.add_child(new_child)
        assert_equal new_child, child.children.last
        assert_equal last, child.children.last
      end

      def test_add_child_from_other_document
        d1 = Nokogiri::XML(&quot;&lt;root&gt;&lt;item&gt;1&lt;/item&gt;&lt;item&gt;2&lt;/item&gt;&lt;/root&gt;&quot;)
        d2 = Nokogiri::XML(&quot;&lt;root&gt;&lt;item&gt;3&lt;/item&gt;&lt;item&gt;4&lt;/item&gt;&lt;/root&gt;&quot;)

        d2.at('root').search('item').each do |i|
          d1.at('root').add_child i
        end

        assert_equal 0, d2.search('item').size
        assert_equal 4, d1.search('item').size
      end

      def test_add_child
        xml = Nokogiri::XML(&lt;&lt;-eoxml)
        &lt;root&gt;
          &lt;a&gt;Hello world&lt;/a&gt;
        &lt;/root&gt;
        eoxml
        text_node = Nokogiri::XML::Text.new('hello', xml)
        assert_equal Nokogiri::XML::Node::TEXT_NODE, text_node.type
        xml.root.add_child text_node
        assert_match 'hello', xml.to_s
      end

      def test_chevron_works_as_add_child
        xml = Nokogiri::XML(&lt;&lt;-eoxml)
        &lt;root&gt;
          &lt;a&gt;Hello world&lt;/a&gt;
        &lt;/root&gt;
        eoxml
        text_node = Nokogiri::XML::Text.new('hello', xml)
        xml.root &lt;&lt; text_node
        assert_match 'hello', xml.to_s
      end

      def test_set_content_with_symbol
        node = @xml.at('//name')
        node.content = :foo
        assert_equal 'foo', node.content
      end

      def test_add_previous_sibling
        xml = Nokogiri::XML(&lt;&lt;-eoxml)
        &lt;root&gt;
          &lt;a&gt;Hello world&lt;/a&gt;
        &lt;/root&gt;
        eoxml
        b_node = Nokogiri::XML::Node.new('a', xml)
        assert_equal Nokogiri::XML::Node::ELEMENT_NODE, b_node.type
        b_node.content = 'first'
        a_node = xml.xpath('//a').first
        a_node.add_previous_sibling(b_node)
        assert_equal('first', xml.xpath('//a').first.text)
      end

      def test_add_previous_sibling_merge
        xml = Nokogiri::XML(&lt;&lt;-eoxml)
        &lt;root&gt;
          &lt;a&gt;Hello world&lt;/a&gt;
        &lt;/root&gt;
        eoxml

        assert a_tag = xml.css('a').first

        left_space = a_tag.previous
        right_space = a_tag.next
        assert left_space.text?
        assert right_space.text?

        left_space.add_previous_sibling(right_space)
        assert_equal left_space, right_space
      end

      def test_add_next_sibling_merge
        xml = Nokogiri::XML(&lt;&lt;-eoxml)
        &lt;root&gt;
          &lt;a&gt;Hello world&lt;/a&gt;
        &lt;/root&gt;
        eoxml

        assert a_tag = xml.css('a').first

        left_space = a_tag.previous
        right_space = a_tag.next
        assert left_space.text?
        assert right_space.text?

        right_space.add_next_sibling(left_space)
        assert_equal left_space, right_space
      end

      def test_find_by_css_with_tilde_eql
        xml = Nokogiri::XML.parse(&lt;&lt;-eoxml)
        &lt;root&gt;
          &lt;a&gt;Hello world&lt;/a&gt;
          &lt;a class='foo bar'&gt;Bar&lt;/a&gt;
          &lt;a class='bar foo'&gt;Bar&lt;/a&gt;
          &lt;a class='bar'&gt;Bar&lt;/a&gt;
          &lt;a class='baz bar foo'&gt;Bar&lt;/a&gt;
          &lt;a class='bazbarfoo'&gt;Awesome&lt;/a&gt;
          &lt;a class='bazbar'&gt;Awesome&lt;/a&gt;
        &lt;/root&gt;
        eoxml
        set = xml.css('a[@class~=&quot;bar&quot;]')
        assert_equal 4, set.length
        assert_equal ['Bar'], set.map { |node| node.content }.uniq
      end

      def test_unlink
        xml = Nokogiri::XML.parse(&lt;&lt;-eoxml)
        &lt;root&gt;
          &lt;a class='foo bar'&gt;Bar&lt;/a&gt;
          &lt;a class='bar foo'&gt;Bar&lt;/a&gt;
          &lt;a class='bar'&gt;Bar&lt;/a&gt;
          &lt;a&gt;Hello world&lt;/a&gt;
          &lt;a class='baz bar foo'&gt;Bar&lt;/a&gt;
          &lt;a class='bazbarfoo'&gt;Awesome&lt;/a&gt;
          &lt;a class='bazbar'&gt;Awesome&lt;/a&gt;
        &lt;/root&gt;
        eoxml
        node = xml.xpath('//a')[3]
        assert_equal('Hello world', node.text)
        assert_match(/Hello world/, xml.to_s)
        assert node.parent
        assert node.document
        assert node.previous_sibling
        assert node.next_sibling
        node.unlink
        assert !node.parent
        #assert !node.document
        assert !node.previous_sibling
        assert !node.next_sibling
        assert_no_match(/Hello world/, xml.to_s)
      end

      def test_next_sibling
        assert node = @xml.root
        assert sibling = node.child.next_sibling
        assert_equal('employee', sibling.name)
      end

      def test_previous_sibling
        assert node = @xml.root
        assert sibling = node.child.next_sibling
        assert_equal('employee', sibling.name)
        assert_equal(sibling.previous_sibling, node.child)
      end

      def test_name=
        assert node = @xml.root
        node.name = 'awesome'
        assert_equal('awesome', node.name)
      end

      def test_child
        assert node = @xml.root
        assert child = node.child
        assert_equal('text', child.name)
      end

      def test_key?
        assert node = @xml.search('//address').first
        assert(!node.key?('asdfasdf'))
      end

      def test_set_property
        assert node = @xml.search('//address').first
        node['foo'] = 'bar'
        assert_equal('bar', node['foo'])
      end

      def test_attributes
        assert node = @xml.search('//address').first
        assert_nil(node['asdfasdfasdf'])
        assert_equal('Yes', node['domestic'])

        assert node = @xml.search('//address')[2]
        attr = node.attributes
        assert_equal 2, attr.size
        assert_equal 'Yes', attr['domestic'].value
        assert_equal 'Yes', attr['domestic'].to_s
        assert_equal 'No', attr['street'].value
      end

      def test_path
        assert set = @xml.search('//employee')
        assert node = set.first
        assert_equal('/staff/employee[1]', node.path)
      end

      def test_search_by_symbol
        assert set = @xml.search(:employee)
        assert 5, set.length

        assert node = @xml.at(:employee)
        assert node.text =~ /EMP0001/
      end

      def test_new_node
        node = Nokogiri::XML::Node.new('form', @xml)
        assert_equal('form', node.name)
        assert(node.document)
      end

      def test_encode_special_chars
        foo = @xml.css('employee').first.encode_special_chars('&amp;')
        assert_equal '&amp;amp;', foo
      end

      def test_content
        node = Nokogiri::XML::Node.new('form', @xml)
        assert_equal('', node.content)

        node.content = 'hello world!'
        assert_equal('hello world!', node.content)
      end

      def test_whitespace_nodes
        doc = Nokogiri::XML.parse(&quot;&lt;root&gt;&lt;b&gt;Foo&lt;/b&gt;\n&lt;i&gt;Bar&lt;/i&gt; &lt;p&gt;Bazz&lt;/p&gt;&lt;/root&gt;&quot;)
        children = doc.at('//root').children.collect{|j| j.to_s}
        assert_equal &quot;\n&quot;, children[1]
        assert_equal &quot; &quot;, children[3]
      end

      def test_replace
        set = @xml.search('//employee')
        assert 5, set.length
        assert 0, @xml.search('//form').length

        first = set[0]
        second = set[1]

        node = Nokogiri::XML::Node.new('form', @xml)
        first.replace(node)

        assert set = @xml.search('//employee')
        assert_equal 4, set.length
        assert 1, @xml.search('//form').length

        assert_equal set[0].to_xml, second.to_xml
      end

      def test_illegal_replace_of_node_with_doc
        new_node = Nokogiri::XML.parse('&lt;foo&gt;bar&lt;/foo&gt;')
        old_node = @xml.at('//employee')
        assert_raises(ArgumentError){ old_node.replace new_node }
      end

      def test_node_equality
        doc1 = Nokogiri::XML.parse(File.read(XML_FILE), XML_FILE)
        doc2 = Nokogiri::XML.parse(File.read(XML_FILE), XML_FILE)

        address1_1 = doc1.xpath('//address').first
        address1_2 = doc1.xpath('//address').first

        address2 = doc2.xpath('//address').first

        assert_not_equal address1_1, address2 # two references to very, very similar nodes
        assert_equal address1_1, address1_2 # two references to the exact same node
      end

      def test_namespace_as_hash
        xml = Nokogiri::XML.parse(&lt;&lt;-eoxml)
&lt;root&gt;
 &lt;car xmlns:part=&quot;http://general-motors.com/&quot;&gt;
  &lt;part:tire&gt;Michelin Model XGV&lt;/part:tire&gt;
 &lt;/car&gt;
 &lt;bicycle xmlns:part=&quot;http://schwinn.com/&quot;&gt;
  &lt;part:tire&gt;I'm a bicycle tire!&lt;/part:tire&gt;
 &lt;/bicycle&gt;
&lt;/root&gt;
        eoxml

        tires = xml.xpath('//bike:tire', {'bike' =&gt; 'http://schwinn.com/'})
        assert_equal 1, tires.length
      end

      def test_namespace_search_with_css
        xml = Nokogiri::XML.parse(&lt;&lt;-eoxml)
&lt;root&gt;
 &lt;car xmlns:part=&quot;http://general-motors.com/&quot;&gt;
  &lt;part:tire&gt;Michelin Model XGV&lt;/part:tire&gt;
 &lt;/car&gt;
 &lt;bicycle xmlns:part=&quot;http://schwinn.com/&quot;&gt;
  &lt;part:tire&gt;I'm a bicycle tire!&lt;/part:tire&gt;
 &lt;/bicycle&gt;
&lt;/root&gt;
        eoxml

        tires = xml.css('bike|tire', 'bike' =&gt; 'http://schwinn.com/')
        assert_equal 1, tires.length
      end

      def test_namespaces
        xml = Nokogiri::XML.parse(&lt;&lt;-EOF)
&lt;x xmlns:a='http://foo.com/' xmlns:b='http://bar.com/'&gt;
  &lt;y xmlns:c='http://bazz.com/'&gt;
    &lt;a:div&gt;hello a&lt;/a:div&gt;
    &lt;b:div&gt;hello b&lt;/b:div&gt;
    &lt;c:div&gt;hello c&lt;/c:div&gt;
  &lt;/y&gt;  
&lt;/x&gt;
EOF
        assert namespaces = xml.root.namespaces
        assert namespaces.key?('xmlns:a')
        assert_equal 'http://foo.com/', namespaces['xmlns:a']
        assert namespaces.key?('xmlns:b')
        assert_equal 'http://bar.com/', namespaces['xmlns:b']
        assert ! namespaces.key?('xmlns:c')

        assert namespaces = xml.namespaces
        assert namespaces.key?('xmlns:a')
        assert_equal 'http://foo.com/', namespaces['xmlns:a']
        assert namespaces.key?('xmlns:b')
        assert_equal 'http://bar.com/', namespaces['xmlns:b']

        assert_equal &quot;hello a&quot;, xml.search(&quot;//a:div&quot;, xml.namespaces).first.inner_text
        assert_equal &quot;hello b&quot;, xml.search(&quot;//b:div&quot;, xml.namespaces).first.inner_text
      end

      def test_namespace
        xml = Nokogiri::XML.parse(&lt;&lt;-EOF)
&lt;x xmlns:a='http://foo.com/' xmlns:b='http://bar.com/'&gt;
  &lt;y xmlns:c='http://bazz.com/'&gt;
    &lt;a:div&gt;hello a&lt;/a:div&gt;
    &lt;b:div&gt;hello b&lt;/b:div&gt;
    &lt;c:div&gt;hello c&lt;/c:div&gt;
    &lt;div&gt;hello moon&lt;/div&gt;
  &lt;/y&gt;  
&lt;/x&gt;
EOF
        set = xml.search(&quot;//y/*&quot;)
        assert_equal &quot;a&quot;, set[0].namespace.prefix
        assert_equal &quot;b&quot;, set[1].namespace.prefix
        assert_equal &quot;c&quot;, set[2].namespace.prefix
        assert_equal nil, set[3].namespace
      end

      def test_namespace_without_an_href_on_html_node
        # because microsoft word's HTML formatting does this. ick.
        xml = Nokogiri::HTML.parse &lt;&lt;-EOF
&lt;div&gt;&lt;o:p&gt;foo&lt;/o:p&gt;&lt;/div&gt;
        EOF

        assert_not_nil(node = xml.at('p'))

        assert_equal 1, node.namespaces.keys.size
        assert       node.namespaces.has_key?('xmlns:o')
        assert_equal nil, node.namespaces['xmlns:o']
      end

      def test_line
        xml = Nokogiri::XML(&lt;&lt;-eoxml)
        &lt;root&gt;
          &lt;a&gt;
            Hello world
          &lt;/a&gt;
        &lt;/root&gt;
        eoxml

        set = xml.search(&quot;//a&quot;)
        node = set.first
        assert_equal 2, node.line
      end

      def test_unlink_then_reparent
        # see http://github.com/tenderlove/nokogiri/issues#issue/22
        10.times do
          STDOUT.putc &quot;.&quot;
          STDOUT.flush
          begin
            doc = Nokogiri::XML &lt;&lt;-EOHTML
              &lt;root&gt;
                &lt;a&gt;
                  &lt;b/&gt;
                  &lt;c/&gt;
                &lt;/a&gt;
              &lt;/root&gt;
            EOHTML

            root = doc.at(&quot;root&quot;)
            a = root.at(&quot;a&quot;)
            b = a.at(&quot;b&quot;)
            c = a.at(&quot;c&quot;)
            a.add_next_sibling(b.unlink)
            c.unlink
          end

          GC.start
        end

      end

    end
  end
end
</pre>
    </div>