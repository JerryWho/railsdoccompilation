  <div id="fileHeader">
    <h1>test_xslt_transforms.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>test/test_xslt_transforms.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 20:15:09 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require &quot;helper&quot;

class TestXsltTransforms &lt; Nokogiri::TestCase

  def setup
    @doc = Nokogiri::XML(File.open(XML_FILE))
  end

  if Nokogiri::VERSION_INFO['libxml']['loaded'] &gt; '2.6.16'

    def test_class_methods
      style = Nokogiri::XSLT(File.read(XSLT_FILE))

      assert result = style.apply_to(@doc, ['title', '&quot;Grandma&quot;'])
      assert_match %r{&lt;h1&gt;Grandma&lt;/h1&gt;}, result
    end

    def test_transform
      assert style = Nokogiri::XSLT.parse(File.read(XSLT_FILE))

      assert result = style.apply_to(@doc, ['title', '&quot;Booyah&quot;'])
      assert_match %r{&lt;h1&gt;Booyah&lt;/h1&gt;}, result
      assert_match %r{&lt;th.*Employee ID&lt;/th&gt;}, result
      assert_match %r{&lt;th.*Name&lt;/th&gt;}, result
      assert_match %r{&lt;th.*Position&lt;/th&gt;}, result
      assert_match %r{&lt;th.*Salary&lt;/th&gt;}, result
      assert_match %r{&lt;td&gt;EMP0003&lt;/td&gt;}, result
      assert_match %r{&lt;td&gt;Margaret Martin&lt;/td&gt;}, result
      assert_match %r{&lt;td&gt;Computer Specialist&lt;/td&gt;}, result
      assert_match %r{&lt;td&gt;100,000&lt;/td&gt;}, result
      assert_no_match %r{Dallas|Texas}, result
      assert_no_match %r{Female}, result

      assert result = style.apply_to(@doc, ['title', '&quot;Grandma&quot;'])
      assert_match %r{&lt;h1&gt;Grandma&lt;/h1&gt;}, result

      assert result = style.apply_to(@doc)
      assert_match %r{&lt;h1&gt;&lt;/h1&gt;}, result
    end

    def test_transform_with_output_style
      xslt = Nokogiri::XSLT(&lt;&lt;-eoxslt)
&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;

&lt;xsl:stylesheet version=&quot;1.0&quot;
xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt;
&lt;xsl:output method=&quot;text&quot; version=&quot;1.0&quot;
encoding=&quot;iso-8859-1&quot; indent=&quot;yes&quot;/&gt;

&lt;xsl:param name=&quot;title&quot;/&gt;

&lt;xsl:template match=&quot;/&quot;&gt;
  &lt;html&gt;
  &lt;body&gt;
    &lt;xsl:for-each select=&quot;staff/employee&quot;&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;xsl:value-of select=&quot;employeeId&quot;/&gt;&lt;/td&gt;
      &lt;td&gt;&lt;xsl:value-of select=&quot;name&quot;/&gt;&lt;/td&gt;
      &lt;td&gt;&lt;xsl:value-of select=&quot;position&quot;/&gt;&lt;/td&gt;
      &lt;td&gt;&lt;xsl:value-of select=&quot;salary&quot;/&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;/xsl:for-each&gt;
    &lt;/table&gt;
  &lt;/body&gt;
  &lt;/html&gt;
&lt;/xsl:template&gt;

&lt;/xsl:stylesheet&gt;
      eoxslt
      assert_no_match(/&lt;td&gt;/, xslt.apply_to(@doc, ['title', 'foo']))
    end

    def test_transform_arg_error
      assert style = Nokogiri::XSLT(File.read(XSLT_FILE))
      assert_raises(TypeError) do
        style.transform(@doc, :foo)
      end
    end

    def test_transform_with_hash
      assert style = Nokogiri::XSLT(File.read(XSLT_FILE))
      result = style.transform(@doc, {'title' =&gt; '&quot;Booyah&quot;'})
      assert result.html?
      assert_equal &quot;Booyah&quot;, result.at_css(&quot;h1&quot;).content
    end

    def test_transform2
      assert style = Nokogiri::XSLT(File.open(XSLT_FILE))
      assert result_doc = style.transform(@doc)
      assert result_doc.html?
      assert_equal &quot;&quot;, result_doc.at_css(&quot;h1&quot;).content

      assert style = Nokogiri::XSLT(File.read(XSLT_FILE))
      assert result_doc = style.transform(@doc, ['title', '&quot;Booyah&quot;'])
      assert result_doc.html?
      assert_equal &quot;Booyah&quot;, result_doc.at_css(&quot;h1&quot;).content

      assert result_string = style.apply_to(@doc, ['title', '&quot;Booyah&quot;'])
      assert_equal result_string, style.serialize(result_doc)
    end

    def test_transform_with_quote_params
      assert style = Nokogiri::XSLT(File.open(XSLT_FILE))
      assert result_doc = style.transform(@doc, Nokogiri::XSLT.quote_params(['title', 'Booyah']))
      assert result_doc.html?
      assert_equal &quot;Booyah&quot;, result_doc.at_css(&quot;h1&quot;).content

      assert style = Nokogiri::XSLT.parse(File.read(XSLT_FILE))
      assert result_doc = style.transform(@doc, Nokogiri::XSLT.quote_params({'title' =&gt; 'Booyah'}))
      assert result_doc.html?
      assert_equal &quot;Booyah&quot;, result_doc.at_css(&quot;h1&quot;).content
    end

    def test_quote_params
      h = {
        :sym   =&gt; %{xxx},
        'str'  =&gt; %{&quot;xxx&quot;},
        :sym2  =&gt; %{'xxx'},
        'str2' =&gt; %{x'x'x},
        :sym3  =&gt; %{x&quot;x&quot;x},
      }
      hh=h.dup
      result_hash = Nokogiri::XSLT.quote_params(h)
      assert_equal hh, h # non-destructive

      a=h.to_a.flatten
      result_array = Nokogiri::XSLT.quote_params(a)
      assert_equal h.to_a.flatten, a #non-destructive

      assert_equal  result_array, result_hash
    end

    def test_exslt
      assert doc = Nokogiri::XML.parse(File.read(EXML_FILE))
      assert doc.xml?

      assert style = Nokogiri::XSLT.parse(File.read(EXSLT_FILE))
      params = {
        :p1 =&gt; 'xxx',
        :p2 =&gt; &quot;x'x'x&quot;,
        :p3 =&gt; 'x&quot;x&quot;x',
        :p4 =&gt; '&quot;xxx&quot;'
      }
      result_doc = Nokogiri::XML.parse(style.apply_to(doc,
          Nokogiri::XSLT.quote_params(params)))

      assert_equal 'func-result', result_doc.at('/root/function').content
      assert_equal 3, result_doc.at('/root/max').content.to_i
      assert_match(
        /\d{4}-\d\d-\d\d([-|+]\d\d:\d\d)?/,
        result_doc.at('/root/date').content
        )
      result_doc.xpath('/root/params/*').each do  |p|
        assert_equal p.content, params[p.name.intern]
      end
      check_params result_doc, params
      result_doc = Nokogiri::XML.parse(style.apply_to(doc,
          Nokogiri::XSLT.quote_params(params.to_a.flatten)))
      check_params result_doc, params
    end

    def test_xslt_parse_error
      xslt_str = &lt;&lt;-EOX
&lt;xsl:stylesheet version=&quot;1.0&quot;
 xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt;
  &lt;!-- Not well-formed: --&gt;
  &lt;xsl:template match=&quot;/&quot;/&gt;
    &lt;values&gt;
      &lt;xsl:for-each select=&quot;//*&quot;&gt;
        &lt;value&gt;
          &lt;xsl:value-of select=&quot;@id&quot;/&gt;
        &lt;/value&gt;
      &lt;/xsl:for-each&gt;
    &lt;/values&gt;
  &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;}
      EOX
      assert_raises(RuntimeError) { Nokogiri::XSLT.parse(xslt_str) }
    end

    def check_params result_doc, params
      result_doc.xpath('/root/params/*').each do  |p|
        assert_equal p.content, params[p.name.intern]
      end
    end

  end
end
</pre>
    </div>