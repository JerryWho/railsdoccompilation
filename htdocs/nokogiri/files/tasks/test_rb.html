  <div id="fileHeader">
    <h1>test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>tasks/test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 14:56:40 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>def run_with_env(cmd)
  cmd = &quot;LD_LIBRARY_PATH='#{ENV['LD_LIBRARY_PATH']}' #{cmd}&quot;
  puts &quot;=&gt; #{cmd}&quot;
  system cmd
end

namespace :test do
  desc &quot;run test suite with aggressive GC&quot;
  task :gc =&gt; :build do
    ENV['NOKOGIRI_GC'] = &quot;true&quot;
    Rake::Task[&quot;test&quot;].invoke
  end

  desc &quot;find call-seq in the rdoc&quot;
  task :rdoc_call_seq =&gt; 'docs' do
    Dir['doc/**/*.html'].each { |docfile|
      next if docfile =~ /\.src/
      puts &quot;FAIL: #{docfile}&quot; if File.read(docfile) =~ /call-seq/
    }
  end

  desc &quot;find all undocumented things&quot;
  task :rdoc =&gt; 'docs' do
    base = File.expand_path(File.join(File.dirname(__FILE__), '..', 'doc'))
    require 'test/unit'
    test = Class.new(Test::Unit::TestCase)
    Dir[&quot;#{base}/**/*.html&quot;].each { |docfile|
      test.class_eval(&lt;&lt;-eotest)
        def test_#{docfile.sub(&quot;#{base}/&quot;, '').gsub(/[\/\.-]/, '_')}
          assert_no_match(
            /Not documented/,
            File.read('#{docfile}'),
            '#{docfile} has undocumented things'
          )
        end
      eotest
    }
  end

  desc &quot;Test against multiple versions of libxml2 (MULTIXML2_DIR=directory)&quot;
  task :multixml2 do
    MULTI_XML = File.join(ENV['HOME'], '.multixml2')
    unless File.exists?(MULTI_XML)
      %w{ versions install build }.each { |x|
        FileUtils.mkdir_p(File.join(MULTI_XML, x))
      }
      Dir.chdir File.join(MULTI_XML, 'versions') do
        require 'net/ftp'
        ftp = Net::FTP.new('xmlsoft.org')
        ftp.login('anonymous', 'anonymous')
        ftp.chdir('libxml2')
        ftp.list('libxml2-2.*.tar.gz').each do |x|
          file = x[/[^\s]*$/]
          puts &quot;Downloading #{file}&quot;
          ftp.getbinaryfile(file)
        end
      end
    end

    # Build any libxml2 versions in $HOME/.multixml2/versions that
    # haven't been built yet
    Dir[File.join(MULTI_XML, 'versions','*.tar.gz')].each do |f|
      filename = File.basename(f, '.tar.gz')

      install_dir = File.join(MULTI_XML, 'install', filename)
      next if File.exists?(install_dir)

      Dir.chdir File.join(MULTI_XML, 'versions') do
        system &quot;tar zxvf #{f} -C #{File.join(MULTI_XML, 'build')}&quot;
      end

      Dir.chdir File.join(MULTI_XML, 'build', filename) do
        system &quot;./configure --prefix=#{install_dir}&quot;
        system &quot;make &amp;&amp; make install&quot;
      end
    end

    test_results = {}
    libxslt = Dir[File.join(MULTI_XML, 'install', 'libxslt*')].first

    directories = ENV['MULTIXML2_DIR'] ? [ENV['MULTIXML2_DIR']] : Dir[File.join(MULTI_XML, 'install', '*')]
    directories.sort.reverse.each do |xml2_version|
      next unless xml2_version =~ /libxml2/
      extopts = &quot;--with-xml2-include=#{xml2_version}/include/libxml2 --with-xml2-lib=#{xml2_version}/lib --with-xslt-dir=#{libxslt} --with-iconv-dir=/usr&quot;
      cmd = &quot;#{$0} clean test EXTOPTS='#{extopts}' LD_LIBRARY_PATH='#{xml2_version}/lib'&quot;

      version = File.basename(xml2_version)
      result = system(cmd)
      test_results[version] = {
        :result =&gt; result,
        :cmd    =&gt; cmd
      }
    end
    test_results.sort_by { |k,v| k }.each do |k,v|
      passed = v[:result]
      puts &quot;#{k}: #{passed ? 'PASS' : 'FAIL'}&quot;
      puts &quot;repro: #{v[:cmd]}&quot; unless passed
    end
  end
end
</pre>
    </div>