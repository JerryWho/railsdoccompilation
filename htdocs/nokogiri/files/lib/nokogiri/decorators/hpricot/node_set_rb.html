  <div id="fileHeader">
    <h1>node_set.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>lib/nokogiri/decorators/hpricot/node_set.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 14:56:40 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>module Nokogiri
  module Decorators
    module Hpricot
      module NodeSet

        # Select nodes matching the supplied rule.
        # Note that positional rules (like &lt;tt&gt;:nth()&lt;/tt&gt;) aren't currently supported.
        #
        # example:
        #   node_set.filter('.ohmy')          # selects nodes from the set with class &quot;ohmy&quot;
        #   node_set.filter('a#link2')        # selects nodes from the set with child node &lt;a id='link2'&gt;
        #   node_set.filter('a[@id=&quot;link2&quot;]') # selects nodes from the set with child node &lt;a id='link2'&gt;
        def filter(rule)
          filter_transformer( lambda {|j| j}, rule ) # identity transformer
        end

        # The complement to filter, select nodes &lt;em&gt;not&lt;/em&gt; matching the supplied rule.
        # Note that positional rules (like &lt;tt&gt;:nth()&lt;/tt&gt;) aren't currently supported.
        #
        # See filter for examples.
        #
        # Also note that you can pass a XML::Node object instead of a
        # rule to remove that object from the node set (if it is
        # present):
        #    node_set.not(node_to_exclude) # selects all nodes EXCEPT node_to_exclude
        #
        def not(rule)
          filter_transformer( lambda {|j| !j}, rule ) # negation transformer
        end

      private
        def filter_transformer(transformer, rule) # :nodoc:
          sub_set = XML::NodeSet.new(document)
          document.decorate(sub_set)

          if rule.is_a?(XML::Node)
            each { |node| sub_set &lt;&lt; node if transformer.call(node == rule) }
            return sub_set
          end

          ctx = CSS.parse(rule.to_s)
          visitor = CSS::XPathVisitor.new
          visitor.extend(Hpricot::XPathVisitor)
          each do |node|
            if transformer.call(node.at(&quot;.//self::&quot; + visitor.accept(ctx.first)))
              sub_set &lt;&lt; node
            end
          end
          sub_set
        end
      end
    end
  end
end
</pre>
    </div>