  <div id="fileHeader">
    <h1>fragment_handler.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>lib/nokogiri/xml/fragment_handler.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Dec 11 22:21:01 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>module Nokogiri
  module XML
    class FragmentHandler &lt; Nokogiri::XML::SAX::Document # :nodoc:
      QNAME_REGEX = /(.*):(.*)/

      def initialize node, original_html
        @doc_started    = false
        @document       = node.document
        @stack          = [node]
        @html_eh        = node.kind_of? HTML::DocumentFragment
        @original_html  = prepare_for_regex(original_html.strip)
      end

      def start_element name, attrs = []
        regex = @html_eh ? %r{^\s*&lt;#{Regexp.escape(name)}}i :
                           %r{^\s*&lt;#{Regexp.escape(name)}}

        if ! @doc_started &amp;&amp; @original_html =~ regex
          @doc_started = true
        end
        return unless @doc_started

        ns = nil
        if @document.root
          match = name.match(QNAME_REGEX)
          if match
            prefix, name = match[1], match[2]
            ns = @document.root.namespace_definitions.detect { |x|
              x.prefix == prefix
            }
          end
        end

        node = Element.new(name, @document)
        attrs &lt;&lt; &quot;&quot; unless (attrs.length % 2) == 0
        Hash[*attrs].each do |k,v|
          node[k] = v
        end

        node.namespace = ns if ns

        @stack.last &lt;&lt; node
        @stack &lt;&lt; node
      end

      def characters string
        @doc_started = true
        @stack.last &lt;&lt; Text.new(string, @document)
      end

      def comment string
        @stack.last &lt;&lt; Comment.new(@document, string)
      end

      def cdata_block string
        @stack.last &lt;&lt; CDATA.new(@document, string)
      end

      def end_element name
        return unless @stack.last.name == name
        @stack.pop
      end

      private

      #
      # the regexes used in start_element() and characters() anchor at
      # start-of-line, but we really only want them to anchor at
      # start-of-doc. so let's only save up to the first newline.
      #
      # this implementation choice was the result of some benchmarks, if
      # you're curious: http://gist.github.com/115936
      #
      def prepare_for_regex(string)
        (newline_index = string.index(&quot;\n&quot;)) ? string.slice(0,newline_index) : string
      end
    end
  end
end
</pre>
    </div>