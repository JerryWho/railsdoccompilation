  <div id="fileHeader">
    <h1>fallbacks.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activesupport/lib/active_support/vendor/i18n-0.3.7/i18n/locale/fallbacks.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:53 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre># encoding: utf-8

# Locale Fallbacks
#
# Extends the I18n module to hold a fallbacks instance which is set to an
# instance of I18n::Locale::Fallbacks by default but can be swapped with a
# different implementation.
#
# Locale fallbacks will compute a number of fallback locales for a given locale.
# For example:
#
# &lt;pre&gt;&lt;code&gt;
# I18n.fallbacks[:&quot;es-MX&quot;] # =&gt; [:&quot;es-MX&quot;, :es, :en] &lt;/code&gt;&lt;/pre&gt;
#
# Locale fallbacks always fall back to
#
#   * all parent locales of a given locale (e.g. :es for :&quot;es-MX&quot;) first,
#   * the current default locales and all of their parents second
#
# The default locales are set to [I18n.default_locale] by default but can be
# set to something else.
#
# One can additionally add any number of additional fallback locales manually.
# These will be added before the default locales to the fallback chain. For
# example:
#
#   # using the default locale as default fallback locale
#
#   I18n.default_locale = :&quot;en-US&quot;
#   I18n.fallbacks = I18n::Fallbacks.new(:&quot;de-AT&quot; =&gt; :&quot;de-DE&quot;)
#   I18n.fallbacks[:&quot;de-AT&quot;] # =&gt; [:&quot;de-AT&quot;, :&quot;de-DE&quot;, :de, :&quot;en-US&quot;, :en]
#
#   # using a custom locale as default fallback locale
#
#   I18n.fallbacks = I18n::Fallbacks.new(:&quot;en-GB&quot;, :&quot;de-AT&quot; =&gt; :de, :&quot;de-CH&quot; =&gt; :de)
#   I18n.fallbacks[:&quot;de-AT&quot;] # =&gt; [:&quot;de-AT&quot;, :de, :&quot;en-GB&quot;, :en]
#   I18n.fallbacks[:&quot;de-CH&quot;] # =&gt; [:&quot;de-CH&quot;, :de, :&quot;en-GB&quot;, :en]
#
#   # mapping fallbacks to an existing instance
#
#   # people speaking Catalan also speak Spanish as spoken in Spain
#   fallbacks = I18n.fallbacks
#   fallbacks.map(:ca =&gt; :&quot;es-ES&quot;)
#   fallbacks[:ca] # =&gt; [:ca, :&quot;es-ES&quot;, :es, :&quot;en-US&quot;, :en]
#
#   # people speaking Arabian as spoken in Palestine also speak Hebrew as spoken in Israel
#   fallbacks.map(:&quot;ar-PS&quot; =&gt; :&quot;he-IL&quot;)
#   fallbacks[:&quot;ar-PS&quot;] # =&gt; [:&quot;ar-PS&quot;, :ar, :&quot;he-IL&quot;, :he, :&quot;en-US&quot;, :en]
#   fallbacks[:&quot;ar-EG&quot;] # =&gt; [:&quot;ar-EG&quot;, :ar, :&quot;en-US&quot;, :en]
#
#   # people speaking Sami as spoken in Finnland also speak Swedish and Finnish as spoken in Finnland
#   fallbacks.map(:sms =&gt; [:&quot;se-FI&quot;, :&quot;fi-FI&quot;])
#   fallbacks[:sms] # =&gt; [:sms, :&quot;se-FI&quot;, :se, :&quot;fi-FI&quot;, :fi, :&quot;en-US&quot;, :en]

module I18n
  module Locale
    class Fallbacks &lt; Hash
      def initialize(*mappings)
        @map = {}
        map(mappings.pop) if mappings.last.is_a?(Hash)
        self.defaults = mappings.empty? ? [I18n.default_locale.to_sym] : mappings
      end

      def defaults=(defaults)
        @defaults = defaults.map { |default| compute(default, false) }.flatten
      end
      attr_reader :defaults

      def [](locale)
        raise InvalidLocale.new(locale) if locale.nil?
        locale = locale.to_sym
        super || store(locale, compute(locale))
      end

      def map(mappings)
        mappings.each do |from, to|
          from, to = from.to_sym, Array(to)
          to.each do |to|
            @map[from] ||= []
            @map[from] &lt;&lt; to.to_sym
          end
        end
      end

      protected

      def compute(tags, include_defaults = true)
        result = Array(tags).collect do |tag|
          tags = I18n::Locale::Tag.tag(tag).self_and_parents.map! { |t| t.to_sym }
          tags.each { |tag| tags += compute(@map[tag]) if @map[tag] }
          tags
        end.flatten
        result.push(*defaults) if include_defaults
        result.uniq
      end
    end
  end
end
</pre>
    </div>