  <div id="fileHeader">
    <h1>message_encryptor_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activesupport/test/message_encryptor_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:54 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

begin
  require 'openssl'
  OpenSSL::Digest::SHA1
rescue LoadError, NameError
  $stderr.puts &quot;Skipping MessageEncryptor test: broken OpenSSL install&quot;
else

class MessageEncryptorTest &lt; Test::Unit::TestCase
  def setup
    @encryptor = ActiveSupport::MessageEncryptor.new(ActiveSupport::SecureRandom.hex(64))
    @data = {:some=&gt;&quot;data&quot;, :now=&gt;Time.now}
  end
  
  def test_simple_round_tripping
    message = @encryptor.encrypt(@data)
    assert_equal @data, @encryptor.decrypt(message)
  end
  
  def test_encrypting_twice_yields_differing_cipher_text
    first_messqage = @encryptor.encrypt(@data)
    second_message = @encryptor.encrypt(@data)
    assert_not_equal first_messqage, second_message
  end
  
  def test_messing_with_either_value_causes_failure
    text, iv = @encryptor.encrypt(@data).split(&quot;--&quot;)
    assert_not_decrypted([iv, text] * &quot;--&quot;)
    assert_not_decrypted([text, munge(iv)] * &quot;--&quot;)
    assert_not_decrypted([munge(text), iv] * &quot;--&quot;)
    assert_not_decrypted([munge(text), munge(iv)] * &quot;--&quot;)
  end
  
  def test_signed_round_tripping
    message = @encryptor.encrypt_and_sign(@data)
    assert_equal @data, @encryptor.decrypt_and_verify(message)
  end
  
  
  private
    def assert_not_decrypted(value)
      assert_raise(ActiveSupport::MessageEncryptor::InvalidMessage) do
        @encryptor.decrypt(value)
      end
    end
    
    def munge(base64_string)
      bits = ActiveSupport::Base64.decode64(base64_string)
      bits.reverse!
      ActiveSupport::Base64.encode64s(bits)
    end
end

end
</pre>
    </div>