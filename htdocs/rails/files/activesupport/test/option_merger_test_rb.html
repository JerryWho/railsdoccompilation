  <div id="fileHeader">
    <h1>option_merger_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activesupport/test/option_merger_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:54 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

class OptionMergerTest &lt; Test::Unit::TestCase
  def setup
    @options = {:hello =&gt; 'world'}
  end

  def test_method_with_options_merges_options_when_options_are_present
    local_options = {:cool =&gt; true}

    with_options(@options) do |o|
      assert_equal local_options, method_with_options(local_options)
      assert_equal @options.merge(local_options),
        o.method_with_options(local_options)
    end
  end

  def test_method_with_options_appends_options_when_options_are_missing
    with_options(@options) do |o|
      assert_equal Hash.new, method_with_options
      assert_equal @options, o.method_with_options
    end
  end

  def test_method_with_options_allows_to_overwrite_options
    local_options = {:hello =&gt; 'moon'}
    assert_equal @options.keys, local_options.keys

    with_options(@options) do |o|
      assert_equal local_options, method_with_options(local_options)
      assert_equal @options.merge(local_options),
        o.method_with_options(local_options)
      assert_equal local_options, o.method_with_options(local_options)
    end
    with_options(local_options) do |o|
      assert_equal local_options.merge(@options),
        o.method_with_options(@options)
    end
  end

  def test_nested_method_with_options_containing_hashes_merge
    with_options :conditions =&gt; { :method =&gt; :get } do |outer|
      outer.with_options :conditions =&gt; { :domain =&gt; &quot;www&quot; } do |inner|
        expected = { :conditions =&gt; { :method =&gt; :get, :domain =&gt; &quot;www&quot; } }
        assert_equal expected, inner.method_with_options
      end
    end
  end

  def test_nested_method_with_options_containing_hashes_overwrite
    with_options :conditions =&gt; { :method =&gt; :get, :domain =&gt; &quot;www&quot; } do |outer|
      outer.with_options :conditions =&gt; { :method =&gt; :post } do |inner|
        expected = { :conditions =&gt; { :method =&gt; :post, :domain =&gt; &quot;www&quot; } }
        assert_equal expected, inner.method_with_options
      end
    end
  end

  def test_nested_method_with_options_containing_hashes_going_deep
    with_options :html =&gt; { :class =&gt; &quot;foo&quot;, :style =&gt; { :margin =&gt; 0, :display =&gt; &quot;block&quot; } } do |outer|
      outer.with_options :html =&gt; { :title =&gt; &quot;bar&quot;, :style =&gt; { :margin =&gt; &quot;1em&quot;, :color =&gt; &quot;#fff&quot; } } do |inner|
        expected = { :html =&gt; { :class =&gt; &quot;foo&quot;, :title =&gt; &quot;bar&quot;, :style =&gt; { :margin =&gt; &quot;1em&quot;, :display =&gt; &quot;block&quot;, :color =&gt; &quot;#fff&quot; } } }
        assert_equal expected, inner.method_with_options
      end
    end
  end
  
  def test_nested_method_with_options_using_lamdba
    local_lamdba = lambda { { :lambda =&gt; true } }
    with_options(@options) do |o|
      assert_equal @options.merge(local_lamdba.call),
        o.method_with_options(local_lamdba).call
    end
  end

  # Needed when counting objects with the ObjectSpace
  def test_option_merger_class_method
    assert_equal ActiveSupport::OptionMerger, ActiveSupport::OptionMerger.new('', '').class
  end

  private
    def method_with_options(options = {})
      options
    end
end
</pre>
    </div>