  <div id="fileHeader">
    <h1>synchronization_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activesupport/test/core_ext/module/synchronization_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 19:55:10 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

class SynchronizationTest &lt; Test::Unit::TestCase
  def setup
    @target = Class.new
    @target.cattr_accessor :mutex, :instance_writer =&gt; false
    @target.mutex = Mutex.new
    @instance = @target.new
  end

  def test_synchronize_aliases_method_chain_with_synchronize
    @target.module_eval do
      attr_accessor :value
      synchronize :value, :with =&gt; :mutex
    end
    assert @instance.respond_to?(:value_with_synchronization)
    assert @instance.respond_to?(:value_without_synchronization)
  end

  def test_synchronize_does_not_change_behavior
    @target.module_eval do
      attr_accessor :value
      synchronize :value, :with =&gt; :mutex
    end
    expected = &quot;some state&quot;
    @instance.value = expected
    assert_equal expected, @instance.value
  end

  def test_synchronize_with_no_mutex_raises_an_argument_error
    assert_raise(ArgumentError) do
      @target.synchronize :to_s
    end
  end

  def test_double_synchronize_raises_an_argument_error
    @target.synchronize :to_s, :with =&gt; :mutex
    assert_raise(ArgumentError) do
      @target.synchronize :to_s, :with =&gt; :mutex
    end
  end

  def dummy_sync
    dummy = Object.new
    def dummy.synchronize
      @sync_count ||= 0
      @sync_count += 1
      yield
    end
    def dummy.sync_count; @sync_count; end
    dummy
  end

  def test_mutex_is_entered_during_method_call
    @target.mutex = dummy_sync
    @target.synchronize :to_s, :with =&gt; :mutex
    @instance.to_s
    @instance.to_s
    assert_equal 2, @target.mutex.sync_count
  end

  def test_can_synchronize_method_with_punctuation
    @target.module_eval do
      def dangerous?
        @dangerous
      end
      def dangerous!
        @dangerous = true
      end
    end
    @target.synchronize :dangerous?, :dangerous!, :with =&gt; :mutex
    @instance.dangerous!
    assert @instance.dangerous?
  end

  def test_can_synchronize_singleton_methods
    @target.mutex = dummy_sync
    class &lt;&lt; @target
      synchronize :to_s, :with =&gt; :mutex
    end
    assert @target.respond_to?(:to_s_without_synchronization)
    assert_nothing_raised { @target.to_s; @target.to_s }
    assert_equal 2, @target.mutex.sync_count
  end
end</pre>
    </div>