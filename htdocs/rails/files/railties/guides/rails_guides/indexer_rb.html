  <div id="fileHeader">
    <h1>indexer.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>railties/guides/rails_guides/indexer.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:54 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>module RailsGuides
  class Indexer
    attr_reader :body, :result, :level_hash

    def initialize(body)
      @body = body
      @result = @body.dup
    end

    def index
      @level_hash = process(body)
    end

    private

    def process(string, current_level= 3, counters = [1])
      s = StringScanner.new(string)

      level_hash = ActiveSupport::OrderedHash.new

      while !s.eos?
        s.match?(/\h[0-9]\..*$/)
        if matched = s.matched
          matched =~ /\h([0-9])\.(.*)$/
          level, title = $1.to_i, $2

          if level &lt; current_level
            # This is needed. Go figure.
            return level_hash
          elsif level == current_level
            index = counters.join(&quot;.&quot;)
            bookmark = '#' + title.strip.downcase.gsub(/\s+|_/, '-').delete('^a-z0-9-')

            raise &quot;Parsing Fail&quot; unless @result.sub!(matched, &quot;h#{level}(#{bookmark}). #{index}#{title}&quot;)

            key = {
              :title =&gt; title,
              :id =&gt; bookmark
            }
            # Recurse
            counters &lt;&lt; 1
            level_hash[key] = process(s.post_match, current_level + 1, counters)
            counters.pop

            # Increment the current level
            last = counters.pop
            counters &lt;&lt; last + 1
          end
        end
        s.getch
      end
      level_hash
    end
  end
end
</pre>
    </div>