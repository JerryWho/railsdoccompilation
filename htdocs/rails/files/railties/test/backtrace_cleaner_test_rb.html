  <div id="fileHeader">
    <h1>backtrace_cleaner_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>railties/test/backtrace_cleaner_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:54 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

require 'initializer'
require 'rails/backtrace_cleaner'

if defined? Test::Unit::Util::BacktraceFilter
  class TestWithBacktrace
    include Test::Unit::Util::BacktraceFilter
    include Rails::BacktraceFilterForTestUnit
  end

  class BacktraceCleanerFilterTest &lt; ActiveSupport::TestCase
    def setup
      @test = TestWithBacktrace.new
      @backtrace = [ './test/rails/benchmark_test.rb', './test/rails/dependencies.rb', '/opt/local/lib/ruby/kernel.rb' ]
    end
    
    test &quot;test with backtrace should use the rails backtrace cleaner to clean&quot; do
      Rails.stubs(:backtrace_cleaner).returns(stub(:clean))
      Rails.backtrace_cleaner.expects(:clean).with(@backtrace, nil)
      @test.send(:filter_backtrace, @backtrace)
    end
    
    test &quot;filter backtrace should have the same arity as Test::Unit::Util::BacktraceFilter&quot; do
      assert_nothing_raised do
        @test.send(:filter_backtrace, @backtrace, '/opt/local/lib')
      end
    end
  end
else
  $stderr.puts 'No BacktraceFilter for minitest'
end

class BacktraceCleanerVendorGemTest &lt; ActiveSupport::TestCase
  def setup
    @cleaner = Rails::BacktraceCleaner.new
  end

  test &quot;should format installed gems correctly&quot; do
    @backtrace = [ &quot;#{Gem.path[0]}/gems/nosuchgem-1.2.3/lib/foo.rb&quot; ]
    @result = @cleaner.clean(@backtrace)
    assert_equal &quot;nosuchgem (1.2.3) lib/foo.rb&quot;, @result[0]
  end

  test &quot;should format installed gems not in Gem.default_dir correctly&quot; do
    @target_dir = Gem.path.detect { |p| p != Gem.default_dir }
    # skip this test if default_dir is the only directory on Gem.path
    if @target_dir
      @backtrace = [ &quot;#{@target_dir}/gems/nosuchgem-1.2.3/lib/foo.rb&quot; ]
      @result = @cleaner.clean(@backtrace)
      assert_equal &quot;nosuchgem (1.2.3) lib/foo.rb&quot;, @result[0]
    end
  end

  test &quot;should format vendor gems correctly&quot; do
    @backtrace = [ &quot;#{Rails::GemDependency.unpacked_path}/nosuchgem-1.2.3/lib/foo.rb&quot; ]
    @result = @cleaner.clean(@backtrace)
    assert_equal &quot;nosuchgem (1.2.3) [v] lib/foo.rb&quot;, @result[0]
  end

end
</pre>
    </div>