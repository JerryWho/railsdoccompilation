  <div id="fileHeader">
    <h1>app_generator.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>railties/lib/rails_generator/generators/applications/app/app_generator.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:54 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'rbconfig'
require File.dirname(__FILE__) + '/template_runner'
require 'digest/md5' 
require 'active_support/secure_random'

class AppGenerator &lt; Rails::Generator::Base
  DEFAULT_SHEBANG = File.join(Config::CONFIG['bindir'], Config::CONFIG['ruby_install_name'])

  DATABASES        = %w( mysql oracle postgresql sqlite2 sqlite3 frontbase ibm_db )
  DEFAULT_DATABASE = 'sqlite3'

  mandatory_options :source =&gt; &quot;#{File.dirname(__FILE__)}/../../../../..&quot;
  default_options   :db =&gt; (ENV[&quot;RAILS_DEFAULT_DATABASE&quot;] || DEFAULT_DATABASE),
    :shebang =&gt; DEFAULT_SHEBANG, :with_dispatchers =&gt; false, :freeze =&gt; false


  def initialize(runtime_args, runtime_options = {})
    super

    usage if args.empty?
    usage(&quot;Databases supported for preconfiguration are: #{DATABASES.join(&quot;, &quot;)}&quot;) if (options[:db] &amp;&amp; !DATABASES.include?(options[:db]))

    @destination_root = args.shift
    @app_name = File.basename(File.expand_path(@destination_root))
  end

  def manifest
    record do |m|
      create_directories(m)
      create_root_files(m)
      create_app_files(m)
      create_config_files(m)
      create_script_files(m)
      create_test_files(m)
      create_public_files(m)
      create_documentation_file(m)
      create_log_files(m)
    end
  end

  def after_generate
    if options[:template]
      Rails::TemplateRunner.new(options[:template], @destination_root)
    end
  end

  protected
    def banner
      &quot;Usage: #{$0} /path/to/your/app [options]&quot;
    end

    def add_options!(opt)
      opt.separator ''
      opt.separator 'Options:'
      opt.on(&quot;-r&quot;, &quot;--ruby=path&quot;, String,
             &quot;Path to the Ruby binary of your choice (otherwise scripts use env, dispatchers current path).&quot;,
             &quot;Default: #{DEFAULT_SHEBANG}&quot;) { |v| options[:shebang] = v }

      opt.on(&quot;-d&quot;, &quot;--database=name&quot;, String,
            &quot;Preconfigure for selected database (options: #{DATABASES.join('/')}).&quot;,
            &quot;Default: #{DEFAULT_DATABASE}&quot;) { |v| options[:db] = v }

      opt.on(&quot;-D&quot;, &quot;--with-dispatchers&quot;,
            &quot;Add CGI/FastCGI/mod_ruby dispatches code to generated application skeleton&quot;,
            &quot;Default: false&quot;) { |v| options[:with_dispatchers] = v }

      opt.on(&quot;-f&quot;, &quot;--freeze&quot;,
            &quot;Freeze Rails in vendor/rails from the gems generating the skeleton&quot;,
            &quot;Default: false&quot;) { |v| options[:freeze] = v }

      opt.on(&quot;-m&quot;, &quot;--template=path&quot;, String,
            &quot;Use an application template that lives at path (can be a filesystem path or URL).&quot;,
            &quot;Default: (none)&quot;) { |v| options[:template] = v }

    end


  private
    def create_directories(m)
      m.directory ''

      # Intermediate directories are automatically created so don't sweat their absence here.
      %w(
        app/controllers
        app/helpers
        app/models
        app/views/layouts
        config/environments
        config/initializers
        config/locales
        db
        doc
        lib
        lib/tasks
        log
        public/images
        public/javascripts
        public/stylesheets
        script/performance
        test/fixtures
        test/functional
        test/integration
        test/performance
        test/unit
        vendor
        vendor/plugins
        tmp/sessions
        tmp/sockets
        tmp/cache
        tmp/pids
      ).each { |path| m.directory(path) }
    end
    
    def create_root_files(m)
      m.file &quot;fresh_rakefile&quot;, &quot;Rakefile&quot;
      m.file &quot;README&quot;,         &quot;README&quot;
    end
    
    def create_app_files(m)
      m.file &quot;helpers/application_controller.rb&quot;, &quot;app/controllers/application_controller.rb&quot;
      m.file &quot;helpers/application_helper.rb&quot;,     &quot;app/helpers/application_helper.rb&quot;
    end

    def create_config_files(m)
      create_database_configuration_file(m)
      create_routes_file(m)
      create_locale_file(m)
      create_seeds_file(m)
      create_initializer_files(m)
      create_environment_files(m)
    end

    def create_documentation_file(m)
      m.file &quot;doc/README_FOR_APP&quot;, &quot;doc/README_FOR_APP&quot;
    end

    def create_log_files(m)
      %w( server production development test ).each do |file|
        m.file &quot;configs/empty.log&quot;, &quot;log/#{file}.log&quot;, :chmod =&gt; 0666
      end
    end    

    def create_public_files(m)
      create_dispatch_files(m)
      create_error_files(m)
      create_welcome_file(m)
      create_browser_convention_files(m)
      create_rails_image(m)
      create_javascript_files(m)
    end
    
    def create_script_files(m)
      %w( 
        about console dbconsole destroy generate runner server plugin
        performance/benchmarker performance/profiler
      ).each do |file|
        m.file &quot;bin/#{file}&quot;, &quot;script/#{file}&quot;, { 
          :chmod =&gt; 0755, 
          :shebang =&gt; options[:shebang] == DEFAULT_SHEBANG ? nil : options[:shebang]
        }
      end
    end

    def create_test_files(m)
      m.file &quot;helpers/test_helper.rb&quot;,      &quot;test/test_helper.rb&quot;
      m.file &quot;helpers/performance_test.rb&quot;, &quot;test/performance/browsing_test.rb&quot;
    end


    def create_database_configuration_file(m)
      m.template &quot;configs/databases/#{options[:db]}.yml&quot;, &quot;config/database.yml&quot;, :assigns =&gt; {
        :app_name =&gt; @app_name,
        :socket   =&gt; options[:db] == &quot;mysql&quot; ? mysql_socket_location : nil }
    end
    
    def create_routes_file(m)
      m.file &quot;configs/routes.rb&quot;, &quot;config/routes.rb&quot;
    end

    def create_seeds_file(m)
      m.file &quot;configs/seeds.rb&quot;, &quot;db/seeds.rb&quot;
    end

    def create_initializer_files(m)
      %w( 
        backtrace_silencers 
        inflections 
        mime_types 
        new_rails_defaults
      ).each do |initializer|
        m.file &quot;configs/initializers/#{initializer}.rb&quot;, &quot;config/initializers/#{initializer}.rb&quot;
      end

      m.template &quot;configs/initializers/session_store.rb&quot;, &quot;config/initializers/session_store.rb&quot;, 
        :assigns =&gt; { :app_name =&gt; @app_name, :app_secret =&gt; ActiveSupport::SecureRandom.hex(64) }

      m.template &quot;configs/initializers/cookie_verification_secret.rb&quot;, &quot;config/initializers/cookie_verification_secret.rb&quot;, 
        :assigns =&gt; { :app_secret =&gt; ActiveSupport::SecureRandom.hex(64) }
    end

    def create_locale_file(m)
      m.file &quot;configs/locales/en.yml&quot;, &quot;config/locales/en.yml&quot;
    end

    def create_environment_files(m)
      m.template &quot;environments/environment.rb&quot;, &quot;config/environment.rb&quot;, 
        :assigns =&gt; { :freeze =&gt; options[:freeze] }

      m.file &quot;environments/boot.rb&quot;,        &quot;config/boot.rb&quot;
      m.file &quot;environments/production.rb&quot;,  &quot;config/environments/production.rb&quot;
      m.file &quot;environments/development.rb&quot;, &quot;config/environments/development.rb&quot;
      m.file &quot;environments/test.rb&quot;,        &quot;config/environments/test.rb&quot;
    end


    def create_dispatch_files(m)
      if options[:with_dispatchers]
        dispatcher_options = { :chmod =&gt; 0755, :shebang =&gt; options[:shebang] }

        m.file &quot;dispatches/config.ru&quot;,     &quot;config.ru&quot;
        m.file &quot;dispatches/dispatch.rb&quot;,   &quot;public/dispatch.rb&quot;,   dispatcher_options
        m.file &quot;dispatches/dispatch.rb&quot;,   &quot;public/dispatch.cgi&quot;,  dispatcher_options
        m.file &quot;dispatches/dispatch.fcgi&quot;, &quot;public/dispatch.fcgi&quot;, dispatcher_options
      end
    end

    def create_error_files(m)
      %w( 404 422 500  ).each do |file|
        m.file &quot;html/#{file}.html&quot;, &quot;public/#{file}.html&quot;
      end
    end

    def create_welcome_file(m)
      m.file 'html/index.html', 'public/index.html'
    end

    def create_browser_convention_files(m)
      m.file &quot;html/favicon.ico&quot;, &quot;public/favicon.ico&quot;
      m.file &quot;html/robots.txt&quot;,  &quot;public/robots.txt&quot;
    end

    def create_rails_image(m)
      m.file &quot;html/images/rails.png&quot;, &quot;public/images/rails.png&quot;
    end

    def create_javascript_files(m)
      %w( prototype effects dragdrop controls application ).each do |javascript|
        m.file &quot;html/javascripts/#{javascript}.js&quot;, &quot;public/javascripts/#{javascript}.js&quot;
      end
    end


    def mysql_socket_location
      [
        &quot;/tmp/mysql.sock&quot;,                        # default
        &quot;/var/run/mysqld/mysqld.sock&quot;,            # debian/gentoo
        &quot;/var/tmp/mysql.sock&quot;,                    # freebsd
        &quot;/var/lib/mysql/mysql.sock&quot;,              # fedora
        &quot;/opt/local/lib/mysql/mysql.sock&quot;,        # fedora
        &quot;/opt/local/var/run/mysqld/mysqld.sock&quot;,  # mac + darwinports + mysql
        &quot;/opt/local/var/run/mysql4/mysqld.sock&quot;,  # mac + darwinports + mysql4
        &quot;/opt/local/var/run/mysql5/mysqld.sock&quot;,  # mac + darwinports + mysql5
        &quot;/opt/lampp/var/mysql/mysql.sock&quot;         # xampp for linux
      ].find { |f| File.exist?(f) } unless RUBY_PLATFORM =~ /(:?mswin|mingw)/
    end
end</pre>
    </div>