  <div id="fileHeader">
    <h1>observing_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activemodel/test/observing_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Nov 27 16:38:16 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'test_helper'

class ObservedModel &lt; ActiveModel::Base
  class Observer
  end
end

class FooObserver &lt; ActiveModel::Observer
  class &lt;&lt; self
    public :new
  end
  
  attr_accessor :stub

  def on_spec(record)
    stub.event_with(record) if stub
  end
end

class Foo &lt; ActiveModel::Base
end

class ObservingTest &lt; ActiveModel::TestCase
  def setup
    ObservedModel.observers.clear
  end

  test &quot;initializes model with no cached observers&quot; do
    assert ObservedModel.observers.empty?, &quot;Not empty: #{ObservedModel.observers.inspect}&quot;
  end
  
  test &quot;stores cached observers in an array&quot; do
    ObservedModel.observers &lt;&lt; :foo
    assert ObservedModel.observers.include?(:foo), &quot;:foo not in #{ObservedModel.observers.inspect}&quot;
  end
  
  test &quot;flattens array of assigned cached observers&quot; do
    ObservedModel.observers = [[:foo], :bar]
    assert ObservedModel.observers.include?(:foo), &quot;:foo not in #{ObservedModel.observers.inspect}&quot;
    assert ObservedModel.observers.include?(:bar), &quot;:bar not in #{ObservedModel.observers.inspect}&quot;
  end

  test &quot;instantiates observer names passed as strings&quot; do
    ObservedModel.observers &lt;&lt; 'foo_observer'
    FooObserver.expects(:instance)
    ObservedModel.instantiate_observers
  end

  test &quot;instantiates observer names passed as symbols&quot; do
    ObservedModel.observers &lt;&lt; :foo_observer
    FooObserver.expects(:instance)
    ObservedModel.instantiate_observers
  end

  test &quot;instantiates observer classes&quot; do
    ObservedModel.observers &lt;&lt; ObservedModel::Observer
    ObservedModel::Observer.expects(:instance)
    ObservedModel.instantiate_observers
  end
  
  test &quot;passes observers to subclasses&quot; do
    FooObserver.instance
    bar = Class.new(Foo)
    assert_equal Foo.count_observers, bar.count_observers
  end
end
  
class ObserverTest &lt; ActiveModel::TestCase
  def setup
    ObservedModel.observers = :foo_observer
    FooObserver.models = nil
  end

  test &quot;guesses implicit observable model name&quot; do
    assert_equal 'Foo', FooObserver.observed_class_name
  end

  test &quot;tracks implicit observable models&quot; do
    instance = FooObserver.new
    assert  instance.send(:observed_classes).include?(Foo), &quot;Foo not in #{instance.send(:observed_classes).inspect}&quot;
    assert !instance.send(:observed_classes).include?(ObservedModel), &quot;ObservedModel in #{instance.send(:observed_classes).inspect}&quot;
  end
  
  test &quot;tracks explicit observed model class&quot; do
    old_instance = FooObserver.new
    assert !old_instance.send(:observed_classes).include?(ObservedModel), &quot;ObservedModel in #{old_instance.send(:observed_classes).inspect}&quot;
    FooObserver.observe ObservedModel
    instance = FooObserver.new
    assert instance.send(:observed_classes).include?(ObservedModel), &quot;ObservedModel not in #{instance.send(:observed_classes).inspect}&quot;
  end
  
  test &quot;tracks explicit observed model as string&quot; do
    old_instance = FooObserver.new
    assert !old_instance.send(:observed_classes).include?(ObservedModel), &quot;ObservedModel in #{old_instance.send(:observed_classes).inspect}&quot;
    FooObserver.observe 'observed_model'
    instance = FooObserver.new
    assert instance.send(:observed_classes).include?(ObservedModel), &quot;ObservedModel not in #{instance.send(:observed_classes).inspect}&quot;
  end
  
  test &quot;tracks explicit observed model as symbol&quot; do
    old_instance = FooObserver.new
    assert !old_instance.send(:observed_classes).include?(ObservedModel), &quot;ObservedModel in #{old_instance.send(:observed_classes).inspect}&quot;
    FooObserver.observe :observed_model
    instance = FooObserver.new
    assert instance.send(:observed_classes).include?(ObservedModel), &quot;ObservedModel not in #{instance.send(:observed_classes).inspect}&quot;
  end
  
  test &quot;calls existing observer event&quot; do
    foo = Foo.new
    FooObserver.instance.stub = stub
    FooObserver.instance.stub.expects(:event_with).with(foo)
    Foo.send(:changed)
    Foo.send(:notify_observers, :on_spec, foo)
  end
  
  test &quot;skips nonexistent observer event&quot; do
    foo = Foo.new
    Foo.send(:changed)
    Foo.send(:notify_observers, :whatever, foo)
  end
end
</pre>
    </div>