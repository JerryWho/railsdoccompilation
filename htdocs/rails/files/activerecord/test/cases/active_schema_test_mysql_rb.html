  <div id="fileHeader">
    <h1>active_schema_test_mysql.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activerecord/test/cases/active_schema_test_mysql.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:53 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require &quot;cases/helper&quot;

class ActiveSchemaTest &lt; ActiveRecord::TestCase
  def setup
    ActiveRecord::ConnectionAdapters::MysqlAdapter.class_eval do
      alias_method :execute_without_stub, :execute
      def execute(sql, name = nil) return sql end
    end
  end

  def teardown
    ActiveRecord::ConnectionAdapters::MysqlAdapter.class_eval do
      remove_method :execute
      alias_method :execute, :execute_without_stub
    end
  end

  def test_add_index
    # add_index calls index_exists? which can't work since execute is stubbed
    ActiveRecord::ConnectionAdapters::MysqlAdapter.send(:define_method, :index_exists?) do |*|
      false
    end
    expected = &quot;CREATE  INDEX `index_people_on_last_name` ON `people` (`last_name`)&quot;
    assert_equal expected, add_index(:people, :last_name, :length =&gt; nil)

    expected = &quot;CREATE  INDEX `index_people_on_last_name` ON `people` (`last_name`(10))&quot;
    assert_equal expected, add_index(:people, :last_name, :length =&gt; 10)

    expected = &quot;CREATE  INDEX `index_people_on_last_name_and_first_name` ON `people` (`last_name`(15), `first_name`(15))&quot;
    assert_equal expected, add_index(:people, [:last_name, :first_name], :length =&gt; 15)

    expected = &quot;CREATE  INDEX `index_people_on_last_name_and_first_name` ON `people` (`last_name`(15), `first_name`)&quot;
    assert_equal expected, add_index(:people, [:last_name, :first_name], :length =&gt; {:last_name =&gt; 15})

    expected = &quot;CREATE  INDEX `index_people_on_last_name_and_first_name` ON `people` (`last_name`(15), `first_name`(10))&quot;
    assert_equal expected, add_index(:people, [:last_name, :first_name], :length =&gt; {:last_name =&gt; 15, :first_name =&gt; 10})
    ActiveRecord::ConnectionAdapters::MysqlAdapter.send(:remove_method, :index_exists?)
  end

  def test_drop_table
    assert_equal &quot;DROP TABLE `people`&quot;, drop_table(:people)
  end

  if current_adapter?(:MysqlAdapter)
    def test_create_mysql_database_with_encoding
      assert_equal &quot;CREATE DATABASE `matt` DEFAULT CHARACTER SET `utf8`&quot;, create_database(:matt)
      assert_equal &quot;CREATE DATABASE `aimonetti` DEFAULT CHARACTER SET `latin1`&quot;, create_database(:aimonetti, {:charset =&gt; 'latin1'})
      assert_equal &quot;CREATE DATABASE `matt_aimonetti` DEFAULT CHARACTER SET `big5` COLLATE `big5_chinese_ci`&quot;, create_database(:matt_aimonetti, {:charset =&gt; :big5, :collation =&gt; :big5_chinese_ci})
    end

    def test_recreate_mysql_database_with_encoding
      create_database(:luca, {:charset =&gt; 'latin1'})
      assert_equal &quot;CREATE DATABASE `luca` DEFAULT CHARACTER SET `latin1`&quot;, recreate_database(:luca, {:charset =&gt; 'latin1'})
    end
  end

  def test_add_column
    assert_equal &quot;ALTER TABLE `people` ADD `last_name` varchar(255)&quot;, add_column(:people, :last_name, :string)
  end

  def test_add_column_with_limit
    assert_equal &quot;ALTER TABLE `people` ADD `key` varchar(32)&quot;, add_column(:people, :key, :string, :limit =&gt; 32)
  end

  def test_drop_table_with_specific_database
    assert_equal &quot;DROP TABLE `otherdb`.`people`&quot;, drop_table('otherdb.people')
  end

  def test_add_timestamps 
    with_real_execute do
      begin
        ActiveRecord::Base.connection.create_table :delete_me do |t|
        end
        ActiveRecord::Base.connection.add_timestamps :delete_me
        assert column_present?('delete_me', 'updated_at', 'datetime')
        assert column_present?('delete_me', 'created_at', 'datetime')
      ensure
        ActiveRecord::Base.connection.drop_table :delete_me rescue nil
      end
    end
  end
  
  def test_remove_timestamps 
    with_real_execute do
      begin
        ActiveRecord::Base.connection.create_table :delete_me do |t|
          t.timestamps
        end
        ActiveRecord::Base.connection.remove_timestamps :delete_me
        assert !column_present?('delete_me', 'updated_at', 'datetime')
        assert !column_present?('delete_me', 'created_at', 'datetime')
      ensure
        ActiveRecord::Base.connection.drop_table :delete_me rescue nil
      end
    end
  end

  private
    def with_real_execute
      #we need to actually modify some data, so we make execute point to the original method
      ActiveRecord::ConnectionAdapters::MysqlAdapter.class_eval do
        alias_method :execute_with_stub, :execute
        alias_method :execute, :execute_without_stub
      end
      yield
    ensure
      #before finishing, we restore the alias to the mock-up method
      ActiveRecord::ConnectionAdapters::MysqlAdapter.class_eval do
        alias_method :execute, :execute_with_stub
      end
    end


    def method_missing(method_symbol, *arguments)
      ActiveRecord::Base.connection.send(method_symbol, *arguments)
    end

    def column_present?(table_name, column_name, type)
      results = ActiveRecord::Base.connection.select_all(&quot;SHOW FIELDS FROM #{table_name} LIKE '#{column_name}'&quot;)
      results.first &amp;&amp; results.first['Type'] == type
    end
end
</pre>
    </div>