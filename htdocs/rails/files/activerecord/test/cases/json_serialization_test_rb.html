  <div id="fileHeader">
    <h1>json_serialization_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activerecord/test/cases/json_serialization_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:53 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require &quot;cases/helper&quot;
require 'models/contact'
require 'models/post'
require 'models/author'
require 'models/tagging'
require 'models/tag'
require 'models/comment'

class JsonSerializationTest &lt; ActiveRecord::TestCase
  class NamespacedContact &lt; Contact
    column :name,        :string
  end

  def setup
    @contact = Contact.new(
      :name        =&gt; 'Konata Izumi',
      :age         =&gt; 16,
      :avatar      =&gt; 'binarydata',
      :created_at  =&gt; Time.utc(2006, 8, 1),
      :awesome     =&gt; true,
      :preferences =&gt; { :shows =&gt; 'anime' }
    )
  end

  def test_should_demodulize_root_in_json
    NamespacedContact.include_root_in_json = true
    @contact = NamespacedContact.new :name =&gt; 'whatever'
    json = @contact.to_json
    assert_match %r{^\{&quot;namespaced_contact&quot;:\{}, json
  end

  def test_should_include_root_in_json
    Contact.include_root_in_json = true
    json = @contact.to_json

    assert_match %r{^\{&quot;contact&quot;:\{}, json
    assert_match %r{&quot;name&quot;:&quot;Konata Izumi&quot;}, json
    assert_match %r{&quot;age&quot;:16}, json
    assert json.include?(%(&quot;created_at&quot;:#{ActiveSupport::JSON.encode(Time.utc(2006, 8, 1))}))
    assert_match %r{&quot;awesome&quot;:true}, json
    assert_match %r{&quot;preferences&quot;:\{&quot;shows&quot;:&quot;anime&quot;\}}, json
  ensure
    Contact.include_root_in_json = false
  end

  def test_should_include_root_in_json
    Contact.include_root_in_json = true
    json = @contact.to_json(:root =&gt; 'json_contact')

    assert_match %r{^\{&quot;json_contact&quot;:\{}, json
    assert_match %r{&quot;name&quot;:&quot;Konata Izumi&quot;}, json
    assert_match %r{&quot;age&quot;:16}, json
    assert json.include?(%(&quot;created_at&quot;:#{ActiveSupport::JSON.encode(Time.utc(2006, 8, 1))}))
    assert_match %r{&quot;awesome&quot;:true}, json
    assert_match %r{&quot;preferences&quot;:\{&quot;shows&quot;:&quot;anime&quot;\}}, json
  ensure
    Contact.include_root_in_json = false
  end

  def test_should_encode_all_encodable_attributes
    json = @contact.to_json

    assert_match %r{&quot;name&quot;:&quot;Konata Izumi&quot;}, json
    assert_match %r{&quot;age&quot;:16}, json
    assert json.include?(%(&quot;created_at&quot;:#{ActiveSupport::JSON.encode(Time.utc(2006, 8, 1))}))
    assert_match %r{&quot;awesome&quot;:true}, json
    assert_match %r{&quot;preferences&quot;:\{&quot;shows&quot;:&quot;anime&quot;\}}, json
  end

  def test_should_allow_attribute_filtering_with_only
    json = @contact.to_json(:only =&gt; [:name, :age])

    assert_match %r{&quot;name&quot;:&quot;Konata Izumi&quot;}, json
    assert_match %r{&quot;age&quot;:16}, json
    assert_no_match %r{&quot;awesome&quot;:true}, json
    assert !json.include?(%(&quot;created_at&quot;:#{ActiveSupport::JSON.encode(Time.utc(2006, 8, 1))}))
    assert_no_match %r{&quot;preferences&quot;:\{&quot;shows&quot;:&quot;anime&quot;\}}, json
  end

  def test_should_allow_attribute_filtering_with_except
    json = @contact.to_json(:except =&gt; [:name, :age])

    assert_no_match %r{&quot;name&quot;:&quot;Konata Izumi&quot;}, json
    assert_no_match %r{&quot;age&quot;:16}, json
    assert_match %r{&quot;awesome&quot;:true}, json
    assert json.include?(%(&quot;created_at&quot;:#{ActiveSupport::JSON.encode(Time.utc(2006, 8, 1))}))
    assert_match %r{&quot;preferences&quot;:\{&quot;shows&quot;:&quot;anime&quot;\}}, json
  end

  def test_methods_are_called_on_object
    # Define methods on fixture.
    def @contact.label; &quot;Has cheezburger&quot;; end
    def @contact.favorite_quote; &quot;Constraints are liberating&quot;; end

    # Single method.
    assert_match %r{&quot;label&quot;:&quot;Has cheezburger&quot;}, @contact.to_json(:only =&gt; :name, :methods =&gt; :label)

    # Both methods.
    methods_json = @contact.to_json(:only =&gt; :name, :methods =&gt; [:label, :favorite_quote])
    assert_match %r{&quot;label&quot;:&quot;Has cheezburger&quot;}, methods_json
    assert_match %r{&quot;favorite_quote&quot;:&quot;Constraints are liberating&quot;}, methods_json
  end
end

class DatabaseConnectedJsonEncodingTest &lt; ActiveRecord::TestCase
  fixtures :authors, :posts, :comments, :tags, :taggings

  def setup
    @david = authors(:david)
    @mary = authors(:mary)
  end

  def test_includes_uses_association_name
    json = @david.to_json(:include =&gt; :posts)

    assert_match %r{&quot;posts&quot;:\[}, json

    assert_match %r{&quot;id&quot;:1}, json
    assert_match %r{&quot;name&quot;:&quot;David&quot;}, json

    assert_match %r{&quot;author_id&quot;:1}, json
    assert_match %r{&quot;title&quot;:&quot;Welcome to the weblog&quot;}, json
    assert_match %r{&quot;body&quot;:&quot;Such a lovely day&quot;}, json

    assert_match %r{&quot;title&quot;:&quot;So I was thinking&quot;}, json
    assert_match %r{&quot;body&quot;:&quot;Like I hopefully always am&quot;}, json
  end

  def test_includes_uses_association_name_and_applies_attribute_filters
    json = @david.to_json(:include =&gt; { :posts =&gt; { :only =&gt; :title } })

    assert_match %r{&quot;name&quot;:&quot;David&quot;}, json
    assert_match %r{&quot;posts&quot;:\[}, json

    assert_match %r{&quot;title&quot;:&quot;Welcome to the weblog&quot;}, json
    assert_no_match %r{&quot;body&quot;:&quot;Such a lovely day&quot;}, json

    assert_match %r{&quot;title&quot;:&quot;So I was thinking&quot;}, json
    assert_no_match %r{&quot;body&quot;:&quot;Like I hopefully always am&quot;}, json
  end

  def test_includes_fetches_second_level_associations
    json = @david.to_json(:include =&gt; { :posts =&gt; { :include =&gt; { :comments =&gt; { :only =&gt; :body } } } })

    assert_match %r{&quot;name&quot;:&quot;David&quot;}, json
    assert_match %r{&quot;posts&quot;:\[}, json

    assert_match %r{&quot;comments&quot;:\[}, json
    assert_match %r{\{&quot;body&quot;:&quot;Thank you again for the welcome&quot;\}}, json
    assert_match %r{\{&quot;body&quot;:&quot;Don't think too hard&quot;\}}, json
    assert_no_match %r{&quot;post_id&quot;:}, json
  end

  def test_includes_fetches_nth_level_associations
    json = @david.to_json(
      :include =&gt; {
        :posts =&gt; {
          :include =&gt; {
            :taggings =&gt; {
              :include =&gt; {
                :tag =&gt; { :only =&gt; :name }
              }
            }
          }
        }
    })

    assert_match %r{&quot;name&quot;:&quot;David&quot;}, json
    assert_match %r{&quot;posts&quot;:\[}, json

    assert_match %r{&quot;taggings&quot;:\[}, json
    assert_match %r{&quot;tag&quot;:\{&quot;name&quot;:&quot;General&quot;\}}, json
  end

  def test_should_not_call_methods_on_associations_that_dont_respond
    def @david.favorite_quote; &quot;Constraints are liberating&quot;; end
    json = @david.to_json(:include =&gt; :posts, :methods =&gt; :favorite_quote)

    assert !@david.posts.first.respond_to?(:favorite_quote)
    assert_match %r{&quot;favorite_quote&quot;:&quot;Constraints are liberating&quot;}, json
    assert_equal %r{&quot;favorite_quote&quot;:}.match(json).size, 1
  end

  def test_should_allow_only_option_for_list_of_authors
    authors = [@david, @mary]

    assert_equal %([{&quot;name&quot;:&quot;David&quot;},{&quot;name&quot;:&quot;Mary&quot;}]), ActiveSupport::JSON.encode(authors, :only =&gt; :name)
  end

  def test_should_allow_except_option_for_list_of_authors
    authors = [@david, @mary]

    assert_equal %([{&quot;id&quot;:1},{&quot;id&quot;:2}]), ActiveSupport::JSON.encode(authors, :except =&gt; [:name, :author_address_id, :author_address_extra_id])
  end

  def test_should_allow_includes_for_list_of_authors
    authors = [@david, @mary]
    json = ActiveSupport::JSON.encode(authors,
      :only =&gt; :name,
      :include =&gt; {
        :posts =&gt; { :only =&gt; :id }
      }
    )

    ['&quot;name&quot;:&quot;David&quot;', '&quot;posts&quot;:[', '{&quot;id&quot;:1}', '{&quot;id&quot;:2}', '{&quot;id&quot;:4}',
     '{&quot;id&quot;:5}', '{&quot;id&quot;:6}', '&quot;name&quot;:&quot;Mary&quot;', '&quot;posts&quot;:[{&quot;id&quot;:7}]'].each do |fragment|
      assert json.include?(fragment), json
     end
  end

  def test_should_allow_options_for_hash_of_authors
    authors_hash = {
      1 =&gt; @david,
      2 =&gt; @mary
    }

    assert_equal %({&quot;1&quot;:{&quot;name&quot;:&quot;David&quot;}}), ActiveSupport::JSON.encode(authors_hash, :only =&gt; [1, :name])
  end
end
</pre>
    </div>