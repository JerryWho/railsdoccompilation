  <div id="fileHeader">
    <h1>callbacks_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activerecord/test/cases/associations/callbacks_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:53 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require &quot;cases/helper&quot;
require 'models/post'
require 'models/comment'
require 'models/author'
require 'models/category'
require 'models/project'
require 'models/developer'

class AssociationCallbacksTest &lt; ActiveRecord::TestCase
  fixtures :posts, :authors, :projects, :developers

  def setup
    @david = authors(:david)
    @thinking = posts(:thinking)
    @authorless = posts(:authorless)
    assert @david.post_log.empty?
  end

  def test_adding_macro_callbacks
    @david.posts_with_callbacks &lt;&lt; @thinking
    assert_equal [&quot;before_adding#{@thinking.id}&quot;, &quot;after_adding#{@thinking.id}&quot;], @david.post_log
    @david.posts_with_callbacks &lt;&lt; @thinking
    assert_equal [&quot;before_adding#{@thinking.id}&quot;, &quot;after_adding#{@thinking.id}&quot;, &quot;before_adding#{@thinking.id}&quot;,
                  &quot;after_adding#{@thinking.id}&quot;], @david.post_log
  end

  def test_adding_with_proc_callbacks
    @david.posts_with_proc_callbacks &lt;&lt; @thinking
    assert_equal [&quot;before_adding#{@thinking.id}&quot;, &quot;after_adding#{@thinking.id}&quot;], @david.post_log
    @david.posts_with_proc_callbacks &lt;&lt; @thinking
    assert_equal [&quot;before_adding#{@thinking.id}&quot;, &quot;after_adding#{@thinking.id}&quot;, &quot;before_adding#{@thinking.id}&quot;,
                  &quot;after_adding#{@thinking.id}&quot;], @david.post_log
  end

  def test_removing_with_macro_callbacks
    first_post, second_post = @david.posts_with_callbacks[0, 2]
    @david.posts_with_callbacks.delete(first_post)
    assert_equal [&quot;before_removing#{first_post.id}&quot;, &quot;after_removing#{first_post.id}&quot;], @david.post_log
    @david.posts_with_callbacks.delete(second_post)
    assert_equal [&quot;before_removing#{first_post.id}&quot;, &quot;after_removing#{first_post.id}&quot;, &quot;before_removing#{second_post.id}&quot;,
                  &quot;after_removing#{second_post.id}&quot;], @david.post_log
  end

  def test_removing_with_proc_callbacks
    first_post, second_post = @david.posts_with_callbacks[0, 2]
    @david.posts_with_proc_callbacks.delete(first_post)
    assert_equal [&quot;before_removing#{first_post.id}&quot;, &quot;after_removing#{first_post.id}&quot;], @david.post_log
    @david.posts_with_proc_callbacks.delete(second_post)
    assert_equal [&quot;before_removing#{first_post.id}&quot;, &quot;after_removing#{first_post.id}&quot;, &quot;before_removing#{second_post.id}&quot;,
                  &quot;after_removing#{second_post.id}&quot;], @david.post_log
  end

  def test_multiple_callbacks
    @david.posts_with_multiple_callbacks &lt;&lt; @thinking
    assert_equal [&quot;before_adding#{@thinking.id}&quot;, &quot;before_adding_proc#{@thinking.id}&quot;, &quot;after_adding#{@thinking.id}&quot;,
                  &quot;after_adding_proc#{@thinking.id}&quot;], @david.post_log
    @david.posts_with_multiple_callbacks &lt;&lt; @thinking
    assert_equal [&quot;before_adding#{@thinking.id}&quot;, &quot;before_adding_proc#{@thinking.id}&quot;, &quot;after_adding#{@thinking.id}&quot;,
                  &quot;after_adding_proc#{@thinking.id}&quot;, &quot;before_adding#{@thinking.id}&quot;, &quot;before_adding_proc#{@thinking.id}&quot;,
                  &quot;after_adding#{@thinking.id}&quot;, &quot;after_adding_proc#{@thinking.id}&quot;], @david.post_log
  end

  def test_has_many_callbacks_with_create
    morten = Author.create :name =&gt; &quot;Morten&quot;
    post = morten.posts_with_proc_callbacks.create! :title =&gt; &quot;Hello&quot;, :body =&gt; &quot;How are you doing?&quot;
    assert_equal [&quot;before_adding&lt;new&gt;&quot;, &quot;after_adding#{post.id}&quot;], morten.post_log
  end

  def test_has_many_callbacks_with_create!
    morten = Author.create! :name =&gt; &quot;Morten&quot;
    post = morten.posts_with_proc_callbacks.create :title =&gt; &quot;Hello&quot;, :body =&gt; &quot;How are you doing?&quot;
    assert_equal [&quot;before_adding&lt;new&gt;&quot;, &quot;after_adding#{post.id}&quot;], morten.post_log
  end

  def test_has_many_callbacks_for_save_on_parent
    jack = Author.new :name =&gt; &quot;Jack&quot;
    post = jack.posts_with_callbacks.build :title =&gt; &quot;Call me back!&quot;, :body =&gt; &quot;Before you wake up and after you sleep&quot;

    callback_log = [&quot;before_adding&lt;new&gt;&quot;, &quot;after_adding#{jack.posts_with_callbacks.first.id}&quot;]
    assert_equal callback_log, jack.post_log
    assert jack.save
    assert_equal 1, jack.posts_with_callbacks.count
    assert_equal callback_log, jack.post_log
  end

  def test_has_and_belongs_to_many_add_callback
    david = developers(:david)
    ar = projects(:active_record)
    assert ar.developers_log.empty?
    ar.developers_with_callbacks &lt;&lt; david
    assert_equal [&quot;before_adding#{david.id}&quot;, &quot;after_adding#{david.id}&quot;], ar.developers_log
    ar.developers_with_callbacks &lt;&lt; david
    assert_equal [&quot;before_adding#{david.id}&quot;, &quot;after_adding#{david.id}&quot;, &quot;before_adding#{david.id}&quot;,
                  &quot;after_adding#{david.id}&quot;], ar.developers_log
  end

  def test_has_and_belongs_to_many_after_add_called_after_save
    ar = projects(:active_record)
    assert ar.developers_log.empty?
    alice = Developer.new(:name =&gt; 'alice')
    ar.developers_with_callbacks &lt;&lt; alice
    assert_equal&quot;after_adding#{alice.id}&quot;, ar.developers_log.last

    bob = ar.developers_with_callbacks.create(:name =&gt; 'bob')
    assert_equal &quot;after_adding#{bob.id}&quot;, ar.developers_log.last

    ar.developers_with_callbacks.build(:name =&gt; 'charlie')
    assert_equal &quot;after_adding&lt;new&gt;&quot;, ar.developers_log.last
  end


  def test_has_and_belongs_to_many_remove_callback
    david = developers(:david)
    jamis = developers(:jamis)
    activerecord = projects(:active_record)
    assert activerecord.developers_log.empty?
    activerecord.developers_with_callbacks.delete(david)
    assert_equal [&quot;before_removing#{david.id}&quot;, &quot;after_removing#{david.id}&quot;], activerecord.developers_log

    activerecord.developers_with_callbacks.delete(jamis)
    assert_equal [&quot;before_removing#{david.id}&quot;, &quot;after_removing#{david.id}&quot;, &quot;before_removing#{jamis.id}&quot;,
                  &quot;after_removing#{jamis.id}&quot;], activerecord.developers_log
  end

  def test_has_and_belongs_to_many_remove_callback_on_clear
    activerecord = projects(:active_record)
    assert activerecord.developers_log.empty?
    if activerecord.developers_with_callbacks.size == 0
      activerecord.developers &lt;&lt; developers(:david)
      activerecord.developers &lt;&lt; developers(:jamis)
      activerecord.reload
      assert activerecord.developers_with_callbacks.size == 2
    end
    log_array = activerecord.developers_with_callbacks.collect {|d| [&quot;before_removing#{d.id}&quot;,&quot;after_removing#{d.id}&quot;]}.flatten.sort
    assert activerecord.developers_with_callbacks.clear
    assert_equal log_array, activerecord.developers_log.sort
  end

  def test_has_many_and_belongs_to_many_callbacks_for_save_on_parent
    project = Project.new :name =&gt; &quot;Callbacks&quot;
    project.developers_with_callbacks.build :name =&gt; &quot;Jack&quot;, :salary =&gt; 95000

    callback_log = [&quot;before_adding&lt;new&gt;&quot;, &quot;after_adding&lt;new&gt;&quot;]
    assert_equal callback_log, project.developers_log
    assert project.save
    assert_equal 1, project.developers_with_callbacks.size
    assert_equal callback_log, project.developers_log
  end

  def test_dont_add_if_before_callback_raises_exception
    assert !@david.unchangable_posts.include?(@authorless)
    begin
      @david.unchangable_posts &lt;&lt; @authorless
    rescue Exception =&gt; e
    end
    assert @david.post_log.empty?
    assert !@david.unchangable_posts.include?(@authorless)
    @david.reload
    assert !@david.unchangable_posts.include?(@authorless)
  end
end
</pre>
    </div>