  <div id="fileHeader">
    <h1>habtm_join_table_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activerecord/test/cases/associations/habtm_join_table_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 14:59:08 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'cases/helper'

class MyReader &lt; ActiveRecord::Base
  has_and_belongs_to_many :my_books
end

class MyBook &lt; ActiveRecord::Base
  has_and_belongs_to_many :my_readers
end

class HabtmJoinTableTest &lt; ActiveRecord::TestCase
  def setup
    ActiveRecord::Base.connection.create_table :my_books, :force =&gt; true do |t|
      t.string :name
    end
    assert ActiveRecord::Base.connection.table_exists?(:my_books)

    ActiveRecord::Base.connection.create_table :my_readers, :force =&gt; true do |t|
      t.string :name
    end
    assert ActiveRecord::Base.connection.table_exists?(:my_readers)

    ActiveRecord::Base.connection.create_table :my_books_my_readers, :force =&gt; true do |t|
      t.integer :my_book_id
      t.integer :my_reader_id
    end
    assert ActiveRecord::Base.connection.table_exists?(:my_books_my_readers)
  end

  def teardown
    ActiveRecord::Base.connection.drop_table :my_books
    ActiveRecord::Base.connection.drop_table :my_readers
    ActiveRecord::Base.connection.drop_table :my_books_my_readers
  end

  uses_transaction :test_should_raise_exception_when_join_table_has_a_primary_key
  def test_should_raise_exception_when_join_table_has_a_primary_key
    if ActiveRecord::Base.connection.supports_primary_key?
      assert_raise ActiveRecord::ConfigurationError do
        jaime = MyReader.create(:name=&gt;&quot;Jaime&quot;)
        jaime.my_books &lt;&lt; MyBook.create(:name=&gt;'Great Expectations')
      end
    end
  end

  uses_transaction :test_should_cache_result_of_primary_key_check
  def test_should_cache_result_of_primary_key_check
    if ActiveRecord::Base.connection.supports_primary_key?
      ActiveRecord::Base.connection.stubs(:primary_key).with('my_books_my_readers').returns(false).once
      weaz = MyReader.create(:name=&gt;'Weaz')

      weaz.my_books &lt;&lt; MyBook.create(:name=&gt;'Great Expectations')
      weaz.my_books &lt;&lt; MyBook.create(:name=&gt;'Greater Expectations')
    end
  end
end
</pre>
    </div>