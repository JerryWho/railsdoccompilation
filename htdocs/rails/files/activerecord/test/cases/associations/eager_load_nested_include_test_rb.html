  <div id="fileHeader">
    <h1>eager_load_nested_include_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activerecord/test/cases/associations/eager_load_nested_include_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Nov 27 16:38:16 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'cases/helper'
require 'models/post'
require 'models/author'
require 'models/comment'
require 'models/category'
require 'models/categorization'

module Remembered
  def self.included(base)
    base.extend ClassMethods
    base.class_eval do
      after_create :remember
    protected
      def remember; self.class.remembered &lt;&lt; self; end
    end
  end

  module ClassMethods
    def remembered; @@remembered ||= []; end
    def rand; @@remembered.rand; end
  end
end

class ShapeExpression &lt; ActiveRecord::Base
  belongs_to :shape, :polymorphic =&gt; true
  belongs_to :paint, :polymorphic =&gt; true
end

class Circle &lt; ActiveRecord::Base
  has_many :shape_expressions, :as =&gt; :shape
  include Remembered
end
class Square &lt; ActiveRecord::Base
  has_many :shape_expressions, :as =&gt; :shape
  include Remembered
end
class Triangle &lt; ActiveRecord::Base
  has_many :shape_expressions, :as =&gt; :shape
  include Remembered
end
class PaintColor  &lt; ActiveRecord::Base
  has_many   :shape_expressions, :as =&gt; :paint
  belongs_to :non_poly, :foreign_key =&gt; &quot;non_poly_one_id&quot;, :class_name =&gt; &quot;NonPolyOne&quot;
  include Remembered
end
class PaintTexture &lt; ActiveRecord::Base
  has_many   :shape_expressions, :as =&gt; :paint
  belongs_to :non_poly, :foreign_key =&gt; &quot;non_poly_two_id&quot;, :class_name =&gt; &quot;NonPolyTwo&quot;
  include Remembered
end
class NonPolyOne &lt; ActiveRecord::Base
  has_many :paint_colors
  include Remembered
end
class NonPolyTwo &lt; ActiveRecord::Base
  has_many :paint_textures
  include Remembered
end



class EagerLoadPolyAssocsTest &lt; ActiveRecord::TestCase
  NUM_SIMPLE_OBJS = 50
  NUM_SHAPE_EXPRESSIONS = 100

  def setup
    generate_test_object_graphs
  end

  def teardown
    [Circle, Square, Triangle, PaintColor, PaintTexture,
     ShapeExpression, NonPolyOne, NonPolyTwo].each do |c|
      c.delete_all
    end

  end


  def generate_test_object_graphs
    1.upto(NUM_SIMPLE_OBJS) do
      [Circle, Square, Triangle, NonPolyOne, NonPolyTwo].map(&amp;:create!)
    end
    1.upto(NUM_SIMPLE_OBJS) do
      PaintColor.create!(:non_poly_one_id =&gt; NonPolyOne.rand.id)
      PaintTexture.create!(:non_poly_two_id =&gt; NonPolyTwo.rand.id)
    end
    1.upto(NUM_SHAPE_EXPRESSIONS) do
      shape_type = [Circle, Square, Triangle].rand
      paint_type = [PaintColor, PaintTexture].rand
      ShapeExpression.create!(:shape_type =&gt; shape_type.to_s, :shape_id =&gt; shape_type.rand.id,
                              :paint_type =&gt; paint_type.to_s, :paint_id =&gt; paint_type.rand.id)
    end
  end

  def test_include_query
    res = 0
    res = ShapeExpression.find :all, :include =&gt; [ :shape, { :paint =&gt; :non_poly } ]
    assert_equal NUM_SHAPE_EXPRESSIONS, res.size
    assert_queries(0) do
      res.each do |se|
        assert_not_nil se.paint.non_poly, &quot;this is the association that was loading incorrectly before the change&quot;
        assert_not_nil se.shape, &quot;just making sure other associations still work&quot;
      end
    end
  end
end

class EagerLoadNestedIncludeWithMissingDataTest &lt; ActiveRecord::TestCase
  def setup
    @davey_mcdave = Author.create(:name =&gt; 'Davey McDave')
    @first_post = @davey_mcdave.posts.create(:title =&gt; 'Davey Speaks', :body =&gt; 'Expressive wordage')
    @first_comment = @first_post.comments.create(:body =&gt; 'Inflamatory doublespeak')
    @first_categorization = @davey_mcdave.categorizations.create(:category =&gt; Category.first, :post =&gt; @first_post)
  end

  def teardown
    @davey_mcdave.destroy
    @first_post.destroy
    @first_comment.destroy
    @first_categorization.destroy
  end

  def test_missing_data_in_a_nested_include_should_not_cause_errors_when_constructing_objects
    assert_nothing_raised do
      # @davey_mcdave doesn't have any author_favorites
      includes = {:posts =&gt; :comments, :categorizations =&gt; :category, :author_favorites =&gt; :favorite_author }
      Author.all :include =&gt; includes, :conditions =&gt; {:authors =&gt; {:name =&gt; @davey_mcdave.name}}, :order =&gt; 'categories.name'
    end
  end
end
</pre>
    </div>