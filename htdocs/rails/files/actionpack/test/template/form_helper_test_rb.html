  <div id="fileHeader">
    <h1>form_helper_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/template/form_helper_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Nov 27 16:38:16 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

silence_warnings do
  Post = Struct.new(:title, :author_name, :body, :secret, :written_on, :cost)
  Post.class_eval do
    alias_method :title_before_type_cast, :title unless respond_to?(:title_before_type_cast)
    alias_method :body_before_type_cast, :body unless respond_to?(:body_before_type_cast)
    alias_method :author_name_before_type_cast, :author_name unless respond_to?(:author_name_before_type_cast)
    alias_method :secret?, :secret

    def new_record=(boolean)
      @new_record = boolean
    end

    def new_record?
      @new_record
    end

    attr_accessor :author
    def author_attributes=(attributes); end

    attr_accessor :comments
    def comments_attributes=(attributes); end

    attr_accessor :tags
    def tags_attributes=(attributes); end
  end

  class Comment
    attr_reader :id
    attr_reader :post_id
    def initialize(id = nil, post_id = nil); @id, @post_id = id, post_id end
    def save; @id = 1; @post_id = 1 end
    def new_record?; @id.nil? end
    def to_param; @id; end
    def name
      @id.nil? ? &quot;new #{self.class.name.downcase}&quot; : &quot;#{self.class.name.downcase} ##{@id}&quot;
    end

    attr_accessor :relevances
    def relevances_attributes=(attributes); end

  end

  class Tag
    attr_reader :id
    attr_reader :post_id
    def initialize(id = nil, post_id = nil); @id, @post_id = id, post_id end
    def save; @id = 1; @post_id = 1 end
    def new_record?; @id.nil? end
    def to_param; @id; end
    def value
      @id.nil? ? &quot;new #{self.class.name.downcase}&quot; : &quot;#{self.class.name.downcase} ##{@id}&quot;
    end

    attr_accessor :relevances
    def relevances_attributes=(attributes); end

  end

  class CommentRelevance
    attr_reader :id
    attr_reader :comment_id
    def initialize(id = nil, comment_id = nil); @id, @comment_id = id, comment_id end
    def save; @id = 1; @comment_id = 1 end
    def new_record?; @id.nil? end
    def to_param; @id; end
    def value
      @id.nil? ? &quot;new #{self.class.name.downcase}&quot; : &quot;#{self.class.name.downcase} ##{@id}&quot;
    end
  end

  class TagRelevance
    attr_reader :id
    attr_reader :tag_id
    def initialize(id = nil, tag_id = nil); @id, @tag_id = id, tag_id end
    def save; @id = 1; @tag_id = 1 end
    def new_record?; @id.nil? end
    def to_param; @id; end
    def value
      @id.nil? ? &quot;new #{self.class.name.downcase}&quot; : &quot;#{self.class.name.downcase} ##{@id}&quot;
    end
  end

  class Author &lt; Comment
    attr_accessor :post
    def post_attributes=(attributes); end
  end
end

class FormHelperTest &lt; ActionView::TestCase
  tests ActionView::Helpers::FormHelper

  def setup
    @post = Post.new
    @comment = Comment.new
    def @post.errors()
      Class.new{
        def on(field); &quot;can't be empty&quot; if field == &quot;author_name&quot;; end
        def empty?() false end
        def count() 1 end
        def full_messages() [ &quot;Author name can't be empty&quot; ] end
      }.new
    end
    def @post.id; 123; end
    def @post.id_before_type_cast; 123; end
    def @post.to_param; '123'; end

    @post.title       = &quot;Hello World&quot;
    @post.author_name = &quot;&quot;
    @post.body        = &quot;Back to the hill and over it again!&quot;
    @post.secret      = 1
    @post.written_on  = Date.new(2004, 6, 15)

    @controller = Class.new do
      attr_reader :url_for_options
      def url_for(options)
        @url_for_options = options
        &quot;http://www.example.com&quot;
      end
    end
    @controller = @controller.new
  end

  def test_label
    assert_dom_equal('&lt;label for=&quot;post_title&quot;&gt;Title&lt;/label&gt;', label(&quot;post&quot;, &quot;title&quot;))
    assert_dom_equal('&lt;label for=&quot;post_title&quot;&gt;The title goes here&lt;/label&gt;', label(&quot;post&quot;, &quot;title&quot;, &quot;The title goes here&quot;))
    assert_dom_equal(
      '&lt;label class=&quot;title_label&quot; for=&quot;post_title&quot;&gt;Title&lt;/label&gt;',
      label(&quot;post&quot;, &quot;title&quot;, nil, :class =&gt; 'title_label')
    )
    assert_dom_equal('&lt;label for=&quot;post_secret&quot;&gt;Secret?&lt;/label&gt;', label(&quot;post&quot;, &quot;secret?&quot;))
  end

  def test_label_with_symbols
    assert_dom_equal('&lt;label for=&quot;post_title&quot;&gt;Title&lt;/label&gt;', label(:post, :title))
    assert_dom_equal('&lt;label for=&quot;post_secret&quot;&gt;Secret?&lt;/label&gt;', label(:post, :secret?))
  end

  def test_label_with_for_attribute_as_symbol
    assert_dom_equal('&lt;label for=&quot;my_for&quot;&gt;Title&lt;/label&gt;', label(:post, :title, nil, :for =&gt; &quot;my_for&quot;))
  end

  def test_label_with_for_attribute_as_string
    assert_dom_equal('&lt;label for=&quot;my_for&quot;&gt;Title&lt;/label&gt;', label(:post, :title, nil, &quot;for&quot; =&gt; &quot;my_for&quot;))
  end

  def test_label_with_id_attribute_as_symbol
    assert_dom_equal('&lt;label for=&quot;post_title&quot; id=&quot;my_id&quot;&gt;Title&lt;/label&gt;', label(:post, :title, nil, :id =&gt; &quot;my_id&quot;))
  end

  def test_label_with_id_attribute_as_string
    assert_dom_equal('&lt;label for=&quot;post_title&quot; id=&quot;my_id&quot;&gt;Title&lt;/label&gt;', label(:post, :title, nil, &quot;id&quot; =&gt; &quot;my_id&quot;))
  end

  def test_label_with_for_and_id_attributes_as_symbol
    assert_dom_equal('&lt;label for=&quot;my_for&quot; id=&quot;my_id&quot;&gt;Title&lt;/label&gt;', label(:post, :title, nil, :for =&gt; &quot;my_for&quot;, :id =&gt; &quot;my_id&quot;))
  end

  def test_label_with_for_and_id_attributes_as_string
    assert_dom_equal('&lt;label for=&quot;my_for&quot; id=&quot;my_id&quot;&gt;Title&lt;/label&gt;', label(:post, :title, nil, &quot;for&quot; =&gt; &quot;my_for&quot;, &quot;id&quot; =&gt; &quot;my_id&quot;))
  end

  def test_label_for_radio_buttons_with_value
    assert_dom_equal('&lt;label for=&quot;post_title_great_title&quot;&gt;The title goes here&lt;/label&gt;', label(&quot;post&quot;, &quot;title&quot;, &quot;The title goes here&quot;, :value =&gt; &quot;great_title&quot;))
    assert_dom_equal('&lt;label for=&quot;post_title_great_title&quot;&gt;The title goes here&lt;/label&gt;', label(&quot;post&quot;, &quot;title&quot;, &quot;The title goes here&quot;, :value =&gt; &quot;great title&quot;))
  end

  def test_text_field
    assert_dom_equal(
      '&lt;input id=&quot;post_title&quot; name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;Hello World&quot; /&gt;', text_field(&quot;post&quot;, &quot;title&quot;)
    )
    assert_dom_equal(
      '&lt;input id=&quot;post_title&quot; name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;password&quot; value=&quot;Hello World&quot; /&gt;', password_field(&quot;post&quot;, &quot;title&quot;)
    )
    assert_dom_equal(
      '&lt;input id=&quot;person_name&quot; name=&quot;person[name]&quot; size=&quot;30&quot; type=&quot;password&quot; /&gt;', password_field(&quot;person&quot;, &quot;name&quot;)
    )
  end

  def test_text_field_with_escapes
    @post.title = &quot;&lt;b&gt;Hello World&lt;/b&gt;&quot;
    assert_dom_equal(
      '&lt;input id=&quot;post_title&quot; name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;&amp;lt;b&amp;gt;Hello World&amp;lt;/b&amp;gt;&quot; /&gt;', text_field(&quot;post&quot;, &quot;title&quot;)
    )
  end

  def test_text_field_with_html_entities
    @post.title = &quot;The HTML Entity for &amp; is &amp;amp;&quot;
    assert_dom_equal(
      '&lt;input id=&quot;post_title&quot; name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;The HTML Entity for &amp;amp; is &amp;amp;amp;&quot; /&gt;',
      text_field(&quot;post&quot;, &quot;title&quot;)
    )
  end

  def test_text_field_with_options
    expected = '&lt;input id=&quot;post_title&quot; name=&quot;post[title]&quot; size=&quot;35&quot; type=&quot;text&quot; value=&quot;Hello World&quot; /&gt;'
    assert_dom_equal expected, text_field(&quot;post&quot;, &quot;title&quot;, &quot;size&quot; =&gt; 35)
    assert_dom_equal expected, text_field(&quot;post&quot;, &quot;title&quot;, :size =&gt; 35)
  end

  def test_text_field_assuming_size
    expected = '&lt;input id=&quot;post_title&quot; maxlength=&quot;35&quot; name=&quot;post[title]&quot; size=&quot;35&quot; type=&quot;text&quot; value=&quot;Hello World&quot; /&gt;'
    assert_dom_equal expected, text_field(&quot;post&quot;, &quot;title&quot;, &quot;maxlength&quot; =&gt; 35)
    assert_dom_equal expected, text_field(&quot;post&quot;, &quot;title&quot;, :maxlength =&gt; 35)
  end

  def test_text_field_removing_size
    expected = '&lt;input id=&quot;post_title&quot; maxlength=&quot;35&quot; name=&quot;post[title]&quot; type=&quot;text&quot; value=&quot;Hello World&quot; /&gt;'
    assert_dom_equal expected, text_field(&quot;post&quot;, &quot;title&quot;, &quot;maxlength&quot; =&gt; 35, &quot;size&quot; =&gt; nil)
    assert_dom_equal expected, text_field(&quot;post&quot;, &quot;title&quot;, :maxlength =&gt; 35, :size =&gt; nil)
  end

  def test_text_field_doesnt_change_param_values
    object_name = 'post[]'
    expected = '&lt;input id=&quot;post_123_title&quot; name=&quot;post[123][title]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;Hello World&quot; /&gt;'
    assert_equal expected, text_field(object_name, &quot;title&quot;)
    assert_equal object_name, &quot;post[]&quot;
  end

  def test_hidden_field
    assert_dom_equal '&lt;input id=&quot;post_title&quot; name=&quot;post[title]&quot; type=&quot;hidden&quot; value=&quot;Hello World&quot; /&gt;',
      hidden_field(&quot;post&quot;, &quot;title&quot;)
      assert_dom_equal '&lt;input id=&quot;post_secret&quot; name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;1&quot; /&gt;',
        hidden_field(&quot;post&quot;, &quot;secret?&quot;)
  end

  def test_hidden_field_with_escapes
    @post.title = &quot;&lt;b&gt;Hello World&lt;/b&gt;&quot;
    assert_dom_equal '&lt;input id=&quot;post_title&quot; name=&quot;post[title]&quot; type=&quot;hidden&quot; value=&quot;&amp;lt;b&amp;gt;Hello World&amp;lt;/b&amp;gt;&quot; /&gt;',
      hidden_field(&quot;post&quot;, &quot;title&quot;)
  end

  def test_text_field_with_options
    assert_dom_equal '&lt;input id=&quot;post_title&quot; name=&quot;post[title]&quot; type=&quot;hidden&quot; value=&quot;Something Else&quot; /&gt;',
      hidden_field(&quot;post&quot;, &quot;title&quot;, :value =&gt; &quot;Something Else&quot;)
  end

  def test_check_box
    assert_dom_equal(
      '&lt;input name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;0&quot; /&gt;&lt;input checked=&quot;checked&quot; id=&quot;post_secret&quot; name=&quot;post[secret]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret&quot;)
    )
    @post.secret = 0
    assert_dom_equal(
      '&lt;input name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;0&quot; /&gt;&lt;input id=&quot;post_secret&quot; name=&quot;post[secret]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret&quot;)
    )
    assert_dom_equal(
      '&lt;input name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;0&quot; /&gt;&lt;input checked=&quot;checked&quot; id=&quot;post_secret&quot; name=&quot;post[secret]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret&quot; ,{&quot;checked&quot;=&gt;&quot;checked&quot;})
    )
    @post.secret = true
    assert_dom_equal(
      '&lt;input name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;0&quot; /&gt;&lt;input checked=&quot;checked&quot; id=&quot;post_secret&quot; name=&quot;post[secret]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret&quot;)
    )
    assert_dom_equal(
      '&lt;input name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;0&quot; /&gt;&lt;input checked=&quot;checked&quot; id=&quot;post_secret&quot; name=&quot;post[secret]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret?&quot;)
    )

    @post.secret = ['0']
    assert_dom_equal(
      '&lt;input name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;0&quot; /&gt;&lt;input id=&quot;post_secret&quot; name=&quot;post[secret]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret&quot;)
    )
    @post.secret = ['1']
    assert_dom_equal(
      '&lt;input name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;0&quot; /&gt;&lt;input checked=&quot;checked&quot; id=&quot;post_secret&quot; name=&quot;post[secret]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret&quot;)
    )
  end

  def test_check_box_with_explicit_checked_and_unchecked_values
    @post.secret = &quot;on&quot;
    assert_dom_equal(
      '&lt;input name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;off&quot; /&gt;&lt;input checked=&quot;checked&quot; id=&quot;post_secret&quot; name=&quot;post[secret]&quot; type=&quot;checkbox&quot; value=&quot;on&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret&quot;, {}, &quot;on&quot;, &quot;off&quot;)
    )
  end

  def test_checkbox_disabled_still_submits_checked_value
    assert_dom_equal(
      '&lt;input name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;1&quot; /&gt;&lt;input checked=&quot;checked&quot; disabled=&quot;disabled&quot; id=&quot;post_secret&quot; name=&quot;post[secret]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret&quot;, { :disabled =&gt; :true })
    )
  end

  def test_radio_button
    assert_dom_equal('&lt;input checked=&quot;checked&quot; id=&quot;post_title_hello_world&quot; name=&quot;post[title]&quot; type=&quot;radio&quot; value=&quot;Hello World&quot; /&gt;',
      radio_button(&quot;post&quot;, &quot;title&quot;, &quot;Hello World&quot;)
    )
    assert_dom_equal('&lt;input id=&quot;post_title_goodbye_world&quot; name=&quot;post[title]&quot; type=&quot;radio&quot; value=&quot;Goodbye World&quot; /&gt;',
      radio_button(&quot;post&quot;, &quot;title&quot;, &quot;Goodbye World&quot;)
    )
    assert_dom_equal('&lt;input id=&quot;item_subobject_title_inside_world&quot; name=&quot;item[subobject][title]&quot; type=&quot;radio&quot; value=&quot;inside world&quot;/&gt;',
      radio_button(&quot;item[subobject]&quot;, &quot;title&quot;, &quot;inside world&quot;)
    )
  end

  def test_radio_button_is_checked_with_integers
    assert_dom_equal('&lt;input checked=&quot;checked&quot; id=&quot;post_secret_1&quot; name=&quot;post[secret]&quot; type=&quot;radio&quot; value=&quot;1&quot; /&gt;',
      radio_button(&quot;post&quot;, &quot;secret&quot;, &quot;1&quot;)
   )
  end

  def test_radio_button_respects_passed_in_id
     assert_dom_equal('&lt;input checked=&quot;checked&quot; id=&quot;foo&quot; name=&quot;post[secret]&quot; type=&quot;radio&quot; value=&quot;1&quot; /&gt;',
       radio_button(&quot;post&quot;, &quot;secret&quot;, &quot;1&quot;, :id=&gt;&quot;foo&quot;)
    )
  end

  def test_radio_button_with_booleans
    assert_dom_equal('&lt;input id=&quot;post_secret_true&quot; name=&quot;post[secret]&quot; type=&quot;radio&quot; value=&quot;true&quot; /&gt;',
      radio_button(&quot;post&quot;, &quot;secret&quot;, true)
    )

    assert_dom_equal('&lt;input id=&quot;post_secret_false&quot; name=&quot;post[secret]&quot; type=&quot;radio&quot; value=&quot;false&quot; /&gt;',
      radio_button(&quot;post&quot;, &quot;secret&quot;, false)
    )
  end

  def test_text_area
    assert_dom_equal(
      '&lt;textarea cols=&quot;40&quot; id=&quot;post_body&quot; name=&quot;post[body]&quot; rows=&quot;20&quot;&gt;Back to the hill and over it again!&lt;/textarea&gt;',
      text_area(&quot;post&quot;, &quot;body&quot;)
    )
  end

  def test_text_area_with_escapes
    @post.body        = &quot;Back to &lt;i&gt;the&lt;/i&gt; hill and over it again!&quot;
    assert_dom_equal(
      '&lt;textarea cols=&quot;40&quot; id=&quot;post_body&quot; name=&quot;post[body]&quot; rows=&quot;20&quot;&gt;Back to &amp;lt;i&amp;gt;the&amp;lt;/i&amp;gt; hill and over it again!&lt;/textarea&gt;',
      text_area(&quot;post&quot;, &quot;body&quot;)
    )
  end

  def test_text_area_with_alternate_value
    assert_dom_equal(
      '&lt;textarea cols=&quot;40&quot; id=&quot;post_body&quot; name=&quot;post[body]&quot; rows=&quot;20&quot;&gt;Testing alternate values.&lt;/textarea&gt;',
      text_area(&quot;post&quot;, &quot;body&quot;, :value =&gt; 'Testing alternate values.')
    )
  end

  def test_text_area_with_html_entities
    @post.body        = &quot;The HTML Entity for &amp; is &amp;amp;&quot;
    assert_dom_equal(
      '&lt;textarea cols=&quot;40&quot; id=&quot;post_body&quot; name=&quot;post[body]&quot; rows=&quot;20&quot;&gt;The HTML Entity for &amp;amp; is &amp;amp;amp;&lt;/textarea&gt;',
      text_area(&quot;post&quot;, &quot;body&quot;)
    )
  end

  def test_text_area_with_size_option
    assert_dom_equal(
      '&lt;textarea cols=&quot;183&quot; id=&quot;post_body&quot; name=&quot;post[body]&quot; rows=&quot;820&quot;&gt;Back to the hill and over it again!&lt;/textarea&gt;',
      text_area(&quot;post&quot;, &quot;body&quot;, :size =&gt; &quot;183x820&quot;)
    )
  end

  def test_explicit_name
    assert_dom_equal(
      '&lt;input id=&quot;post_title&quot; name=&quot;dont guess&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;Hello World&quot; /&gt;', text_field(&quot;post&quot;, &quot;title&quot;, &quot;name&quot; =&gt; &quot;dont guess&quot;)
    )
    assert_dom_equal(
      '&lt;textarea cols=&quot;40&quot; id=&quot;post_body&quot; name=&quot;really!&quot; rows=&quot;20&quot;&gt;Back to the hill and over it again!&lt;/textarea&gt;',
      text_area(&quot;post&quot;, &quot;body&quot;, &quot;name&quot; =&gt; &quot;really!&quot;)
    )
    assert_dom_equal(
      '&lt;input name=&quot;i mean it&quot; type=&quot;hidden&quot; value=&quot;0&quot; /&gt;&lt;input checked=&quot;checked&quot; id=&quot;post_secret&quot; name=&quot;i mean it&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret&quot;, &quot;name&quot; =&gt; &quot;i mean it&quot;)
    )
    assert_dom_equal text_field(&quot;post&quot;, &quot;title&quot;, &quot;name&quot; =&gt; &quot;dont guess&quot;),
                 text_field(&quot;post&quot;, &quot;title&quot;, :name =&gt; &quot;dont guess&quot;)
    assert_dom_equal text_area(&quot;post&quot;, &quot;body&quot;, &quot;name&quot; =&gt; &quot;really!&quot;),
                 text_area(&quot;post&quot;, &quot;body&quot;, :name =&gt; &quot;really!&quot;)
    assert_dom_equal check_box(&quot;post&quot;, &quot;secret&quot;, &quot;name&quot; =&gt; &quot;i mean it&quot;),
                 check_box(&quot;post&quot;, &quot;secret&quot;, :name =&gt; &quot;i mean it&quot;)
  end

  def test_explicit_id
    assert_dom_equal(
      '&lt;input id=&quot;dont guess&quot; name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;Hello World&quot; /&gt;', text_field(&quot;post&quot;, &quot;title&quot;, &quot;id&quot; =&gt; &quot;dont guess&quot;)
    )
    assert_dom_equal(
      '&lt;textarea cols=&quot;40&quot; id=&quot;really!&quot; name=&quot;post[body]&quot; rows=&quot;20&quot;&gt;Back to the hill and over it again!&lt;/textarea&gt;',
      text_area(&quot;post&quot;, &quot;body&quot;, &quot;id&quot; =&gt; &quot;really!&quot;)
    )
    assert_dom_equal(
      '&lt;input name=&quot;post[secret]&quot; type=&quot;hidden&quot; value=&quot;0&quot; /&gt;&lt;input checked=&quot;checked&quot; id=&quot;i mean it&quot; name=&quot;post[secret]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;',
      check_box(&quot;post&quot;, &quot;secret&quot;, &quot;id&quot; =&gt; &quot;i mean it&quot;)
    )
    assert_dom_equal text_field(&quot;post&quot;, &quot;title&quot;, &quot;id&quot; =&gt; &quot;dont guess&quot;),
                 text_field(&quot;post&quot;, &quot;title&quot;, :id =&gt; &quot;dont guess&quot;)
    assert_dom_equal text_area(&quot;post&quot;, &quot;body&quot;, &quot;id&quot; =&gt; &quot;really!&quot;),
                 text_area(&quot;post&quot;, &quot;body&quot;, :id =&gt; &quot;really!&quot;)
    assert_dom_equal check_box(&quot;post&quot;, &quot;secret&quot;, &quot;id&quot; =&gt; &quot;i mean it&quot;),
                 check_box(&quot;post&quot;, &quot;secret&quot;, :id =&gt; &quot;i mean it&quot;)
  end

  def test_auto_index
    pid = @post.id
    assert_dom_equal(
      &quot;&lt;label for=\&quot;post_#{pid}_title\&quot;&gt;Title&lt;/label&gt;&quot;,
      label(&quot;post[]&quot;, &quot;title&quot;)
    )
    assert_dom_equal(
      &quot;&lt;input id=\&quot;post_#{pid}_title\&quot; name=\&quot;post[#{pid}][title]\&quot; size=\&quot;30\&quot; type=\&quot;text\&quot; value=\&quot;Hello World\&quot; /&gt;&quot;, text_field(&quot;post[]&quot;,&quot;title&quot;)
    )
    assert_dom_equal(
      &quot;&lt;textarea cols=\&quot;40\&quot; id=\&quot;post_#{pid}_body\&quot; name=\&quot;post[#{pid}][body]\&quot; rows=\&quot;20\&quot;&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot;,
      text_area(&quot;post[]&quot;, &quot;body&quot;)
    )
    assert_dom_equal(
      &quot;&lt;input name=\&quot;post[#{pid}][secret]\&quot; type=\&quot;hidden\&quot; value=\&quot;0\&quot; /&gt;&lt;input checked=\&quot;checked\&quot; id=\&quot;post_#{pid}_secret\&quot; name=\&quot;post[#{pid}][secret]\&quot; type=\&quot;checkbox\&quot; value=\&quot;1\&quot; /&gt;&quot;,
      check_box(&quot;post[]&quot;, &quot;secret&quot;)
    )
   assert_dom_equal(
&quot;&lt;input checked=\&quot;checked\&quot; id=\&quot;post_#{pid}_title_hello_world\&quot; name=\&quot;post[#{pid}][title]\&quot; type=\&quot;radio\&quot; value=\&quot;Hello World\&quot; /&gt;&quot;,
      radio_button(&quot;post[]&quot;, &quot;title&quot;, &quot;Hello World&quot;)
    )
    assert_dom_equal(&quot;&lt;input id=\&quot;post_#{pid}_title_goodbye_world\&quot; name=\&quot;post[#{pid}][title]\&quot; type=\&quot;radio\&quot; value=\&quot;Goodbye World\&quot; /&gt;&quot;,
      radio_button(&quot;post[]&quot;, &quot;title&quot;, &quot;Goodbye World&quot;)
    )
  end

  def test_form_for
    form_for(:post, @post, :html =&gt; { :id =&gt; 'create-post' }) do |f|
      concat f.label(:title)
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
      concat f.submit('Create post')
    end

    expected =
      &quot;&lt;form action='http://www.example.com' id='create-post' method='post'&gt;&quot; +
      &quot;&lt;label for='post_title'&gt;Title&lt;/label&gt;&quot; +
      &quot;&lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[secret]' checked='checked' type='checkbox' id='post_secret' value='1' /&gt;&quot; +
      &quot;&lt;input name='commit' id='post_submit' type='submit' value='Create post' /&gt;&quot; +
      &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_form_for_with_method
    form_for(:post, @post, :html =&gt; { :id =&gt; 'create-post', :method =&gt; :put }) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;form action='http://www.example.com' id='create-post' method='post'&gt;&quot; +
      &quot;&lt;div style='margin:0;padding:0;display:inline'&gt;&lt;input name='_method' type='hidden' value='put' /&gt;&lt;/div&gt;&quot; +
      &quot;&lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[secret]' checked='checked' type='checkbox' id='post_secret' value='1' /&gt;&quot; +
      &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_form_for_without_object
    form_for(:post, :html =&gt; { :id =&gt; 'create-post' }) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;form action='http://www.example.com' id='create-post' method='post'&gt;&quot; +
      &quot;&lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[secret]' checked='checked' type='checkbox' id='post_secret' value='1' /&gt;&quot; +
      &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_form_for_with_index
    form_for(&quot;post[]&quot;, @post) do |f|
      concat f.label(:title)
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
      &quot;&lt;label for=\&quot;post_123_title\&quot;&gt;Title&lt;/label&gt;&quot; +
      &quot;&lt;input name='post[123][title]' size='30' type='text' id='post_123_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[123][body]' id='post_123_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[123][secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[123][secret]' checked='checked' type='checkbox' id='post_123_secret' value='1' /&gt;&quot; +
      &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_form_for_with_nil_index_option_override
    form_for(&quot;post[]&quot;, @post, :index =&gt; nil) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
      &quot;&lt;input name='post[][title]' size='30' type='text' id='post__title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[][body]' id='post__body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[][secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[][secret]' checked='checked' type='checkbox' id='post__secret' value='1' /&gt;&quot; +
      &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for
    form_for(:post, @post) do |f|
      f.fields_for(:comment, @post) do |c|
        concat c.text_field(:title)
      end
    end

    expected = &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
               &quot;&lt;input name='post[comment][title]' size='30' type='text' id='post_comment_title' value='Hello World' /&gt;&quot; +
               &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_nested_collections
    form_for('post[]', @post) do |f|
      concat f.text_field(:title)
      f.fields_for('comment[]', @comment) do |c|
        concat c.text_field(:name)
      end
    end

    expected = &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
               &quot;&lt;input name='post[123][title]' size='30' type='text' id='post_123_title' value='Hello World' /&gt;&quot; +
               &quot;&lt;input name='post[123][comment][][name]' size='30' type='text' id='post_123_comment__name' value='new comment' /&gt;&quot; +
               &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_index_and_parent_fields
    form_for('post', @post, :index =&gt; 1) do |c|
      concat c.text_field(:title)
      c.fields_for('comment', @comment, :index =&gt; 1) do |r|
        concat r.text_field(:name)
      end
    end

    expected = &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
               &quot;&lt;input name='post[1][title]' size='30' type='text' id='post_1_title' value='Hello World' /&gt;&quot; +
               &quot;&lt;input name='post[1][comment][1][name]' size='30' type='text' id='post_1_comment_1_name' value='new comment' /&gt;&quot; +
               &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_form_for_with_index_and_nested_fields_for
    form_for(:post, @post, :index =&gt; 1) do |f|
      f.fields_for(:comment, @post) do |c|
        concat c.text_field(:title)
      end
    end

    expected = &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
               &quot;&lt;input name='post[1][comment][title]' size='30' type='text' id='post_1_comment_title' value='Hello World' /&gt;&quot; +
               &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_index_on_both
    form_for(:post, @post, :index =&gt; 1) do |f|
      f.fields_for(:comment, @post, :index =&gt; 5) do |c|
        concat c.text_field(:title)
      end
    end

    expected = &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
               &quot;&lt;input name='post[1][comment][5][title]' size='30' type='text' id='post_1_comment_5_title' value='Hello World' /&gt;&quot; +
               &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_auto_index
    form_for(&quot;post[]&quot;, @post) do |f|
      f.fields_for(:comment, @post) do |c|
        concat c.text_field(:title)
      end
    end

    expected = &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
               &quot;&lt;input name='post[123][comment][title]' size='30' type='text' id='post_123_comment_title' value='Hello World' /&gt;&quot; +
               &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_index_radio_button
    form_for(:post, @post) do |f|
      f.fields_for(:comment, @post, :index =&gt; 5) do |c|
        concat c.radio_button(:title, &quot;hello&quot;)
      end
    end

    expected = &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
               &quot;&lt;input name='post[comment][5][title]' type='radio' id='post_comment_5_title_hello' value='hello' /&gt;&quot; +
               &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_auto_index_on_both
    form_for(&quot;post[]&quot;, @post) do |f|
      f.fields_for(&quot;comment[]&quot;, @post) do |c|
        concat c.text_field(:title)
      end
    end

    expected = &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
               &quot;&lt;input name='post[123][comment][123][title]' size='30' type='text' id='post_123_comment_123_title' value='Hello World' /&gt;&quot; +
               &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_index_and_auto_index
    form_for(&quot;post[]&quot;, @post) do |f|
      f.fields_for(:comment, @post, :index =&gt; 5) do |c|
        concat c.text_field(:title)
      end
    end

    form_for(:post, @post, :index =&gt; 1) do |f|
      f.fields_for(&quot;comment[]&quot;, @post) do |c|
        concat c.text_field(:title)
      end
    end

    expected = &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
               &quot;&lt;input name='post[123][comment][5][title]' size='30' type='text' id='post_123_comment_5_title' value='Hello World' /&gt;&quot; +
               &quot;&lt;/form&gt;&quot; +
               &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
               &quot;&lt;input name='post[1][comment][123][title]' size='30' type='text' id='post_1_comment_123_title' value='Hello World' /&gt;&quot; +
               &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_a_new_record_on_a_nested_attributes_one_to_one_association
    @post.author = Author.new

    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      f.fields_for(:author) do |af|
        concat af.text_field(:name)
      end
    end

    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; id=&quot;post_title&quot; value=&quot;Hello World&quot; /&gt;' +
               '&lt;input id=&quot;post_author_attributes_name&quot; name=&quot;post[author_attributes][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;new author&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_explicitly_passed_object_on_a_nested_attributes_one_to_one_association
    form_for(:post, @post) do |f|
      f.fields_for(:author, Author.new(123)) do |af|
        assert_not_nil af.object
        assert_equal 123, af.object.id
      end
    end
  end

  def test_nested_fields_for_with_an_existing_record_on_a_nested_attributes_one_to_one_association
    @post.author = Author.new(321)

    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      f.fields_for(:author) do |af|
        concat af.text_field(:name)
      end
    end

    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; id=&quot;post_title&quot; value=&quot;Hello World&quot; /&gt;' +
               '&lt;input id=&quot;post_author_attributes_name&quot; name=&quot;post[author_attributes][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;author #321&quot; /&gt;' +
               '&lt;input id=&quot;post_author_attributes_id&quot; name=&quot;post[author_attributes][id]&quot; type=&quot;hidden&quot; value=&quot;321&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end
  
  def test_nested_fields_for_with_existing_records_on_a_nested_attributes_one_to_one_association_with_explicit_hidden_field_placement
    @post.author = Author.new(321)

    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      f.fields_for(:author) do |af|
        concat af.hidden_field(:id)
        concat af.text_field(:name)
      end
    end
    
    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; id=&quot;post_title&quot; value=&quot;Hello World&quot; /&gt;' +
               '&lt;input id=&quot;post_author_attributes_id&quot; name=&quot;post[author_attributes][id]&quot; type=&quot;hidden&quot; value=&quot;321&quot; /&gt;' +
               '&lt;input id=&quot;post_author_attributes_name&quot; name=&quot;post[author_attributes][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;author #321&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_existing_records_on_a_nested_attributes_collection_association
    @post.comments = Array.new(2) { |id| Comment.new(id + 1) }

    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      @post.comments.each do |comment|
        f.fields_for(:comments, comment) do |cf|
          concat cf.text_field(:name)
        end
      end
    end

    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; id=&quot;post_title&quot; value=&quot;Hello World&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_name&quot; name=&quot;post[comments_attributes][0][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;comment #1&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_id&quot; name=&quot;post[comments_attributes][0][id]&quot; type=&quot;hidden&quot; value=&quot;1&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_1_name&quot; name=&quot;post[comments_attributes][1][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;comment #2&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_1_id&quot; name=&quot;post[comments_attributes][1][id]&quot; type=&quot;hidden&quot; value=&quot;2&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_existing_records_on_a_nested_attributes_collection_association_with_explicit_hidden_field_placement
    @post.comments = Array.new(2) { |id| Comment.new(id + 1) }

    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      @post.comments.each do |comment|
        f.fields_for(:comments, comment) do |cf|
          concat cf.hidden_field(:id)
          concat cf.text_field(:name)
        end
      end
    end
    
    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; id=&quot;post_title&quot; value=&quot;Hello World&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_id&quot; name=&quot;post[comments_attributes][0][id]&quot; type=&quot;hidden&quot; value=&quot;1&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_name&quot; name=&quot;post[comments_attributes][0][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;comment #1&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_1_id&quot; name=&quot;post[comments_attributes][1][id]&quot; type=&quot;hidden&quot; value=&quot;2&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_1_name&quot; name=&quot;post[comments_attributes][1][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;comment #2&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_new_records_on_a_nested_attributes_collection_association
    @post.comments = [Comment.new, Comment.new]

    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      @post.comments.each do |comment|
        f.fields_for(:comments, comment) do |cf|
          concat cf.text_field(:name)
        end
      end
    end

    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; id=&quot;post_title&quot; value=&quot;Hello World&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_name&quot; name=&quot;post[comments_attributes][0][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;new comment&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_1_name&quot; name=&quot;post[comments_attributes][1][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;new comment&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_existing_and_new_records_on_a_nested_attributes_collection_association
    @post.comments = [Comment.new(321), Comment.new]

    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      @post.comments.each do |comment|
        f.fields_for(:comments, comment) do |cf|
          concat cf.text_field(:name)
        end
      end
    end

    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; id=&quot;post_title&quot; value=&quot;Hello World&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_name&quot; name=&quot;post[comments_attributes][0][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;comment #321&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_id&quot; name=&quot;post[comments_attributes][0][id]&quot; type=&quot;hidden&quot; value=&quot;321&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_1_name&quot; name=&quot;post[comments_attributes][1][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;new comment&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_an_empty_supplied_attributes_collection
    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      f.fields_for(:comments, []) do |cf|
        concat cf.text_field(:name)
      end
    end

    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; id=&quot;post_title&quot; value=&quot;Hello World&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_with_existing_records_on_a_supplied_nested_attributes_collection
    @post.comments = Array.new(2) { |id| Comment.new(id + 1) }

    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      f.fields_for(:comments, @post.comments) do |cf|
        concat cf.text_field(:name)
      end
    end

    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; id=&quot;post_title&quot; value=&quot;Hello World&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_name&quot; name=&quot;post[comments_attributes][0][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;comment #1&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_id&quot; name=&quot;post[comments_attributes][0][id]&quot; type=&quot;hidden&quot; value=&quot;1&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_1_name&quot; name=&quot;post[comments_attributes][1][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;comment #2&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_1_id&quot; name=&quot;post[comments_attributes][1][id]&quot; type=&quot;hidden&quot; value=&quot;2&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_for_on_a_nested_attributes_collection_association_yields_only_builder
    @post.comments = [Comment.new(321), Comment.new]
    yielded_comments = []

    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      f.fields_for(:comments) do |cf|
        concat cf.text_field(:name)
        yielded_comments &lt;&lt; cf.object
      end
    end

    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input name=&quot;post[title]&quot; size=&quot;30&quot; type=&quot;text&quot; id=&quot;post_title&quot; value=&quot;Hello World&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_name&quot; name=&quot;post[comments_attributes][0][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;comment #321&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_id&quot; name=&quot;post[comments_attributes][0][id]&quot; type=&quot;hidden&quot; value=&quot;321&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_1_name&quot; name=&quot;post[comments_attributes][1][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;new comment&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
    assert_equal yielded_comments, @post.comments
  end

  def test_nested_fields_for_with_child_index_option_override_on_a_nested_attributes_collection_association
    @post.comments = []

    form_for(:post, @post) do |f|
      f.fields_for(:comments, Comment.new(321), :child_index =&gt; 'abc') do |cf|
        concat cf.text_field(:name)
      end
    end

    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input id=&quot;post_comments_attributes_abc_name&quot; name=&quot;post[comments_attributes][abc][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;comment #321&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_abc_id&quot; name=&quot;post[comments_attributes][abc][id]&quot; type=&quot;hidden&quot; value=&quot;321&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end

  def test_nested_fields_uses_unique_indices_for_different_collection_associations
    @post.comments = [Comment.new(321)]
    @post.tags = [Tag.new(123), Tag.new(456)]
    @post.comments[0].relevances = []
    @post.tags[0].relevances = []
    @post.tags[1].relevances = []
    form_for(:post, @post) do |f|
      f.fields_for(:comments, @post.comments[0]) do |cf|
        concat cf.text_field(:name)
        cf.fields_for(:relevances, CommentRelevance.new(314)) do |crf|
          concat crf.text_field(:value)
        end
      end
      f.fields_for(:tags, @post.tags[0]) do |tf|
        concat tf.text_field(:value)
        tf.fields_for(:relevances, TagRelevance.new(3141)) do |trf|
          concat trf.text_field(:value)
        end
      end
      f.fields_for('tags', @post.tags[1]) do |tf|
        concat tf.text_field(:value)
        tf.fields_for(:relevances, TagRelevance.new(31415)) do |trf|
          concat trf.text_field(:value)
        end
      end
    end

    expected = '&lt;form action=&quot;http://www.example.com&quot; method=&quot;post&quot;&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_name&quot; name=&quot;post[comments_attributes][0][name]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;comment #321&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_relevances_attributes_0_value&quot; name=&quot;post[comments_attributes][0][relevances_attributes][0][value]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;commentrelevance #314&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_relevances_attributes_0_id&quot; name=&quot;post[comments_attributes][0][relevances_attributes][0][id]&quot; type=&quot;hidden&quot; value=&quot;314&quot; /&gt;' +
               '&lt;input id=&quot;post_comments_attributes_0_id&quot; name=&quot;post[comments_attributes][0][id]&quot; type=&quot;hidden&quot; value=&quot;321&quot; /&gt;' +
               '&lt;input id=&quot;post_tags_attributes_0_value&quot; name=&quot;post[tags_attributes][0][value]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;tag #123&quot; /&gt;' +
               '&lt;input id=&quot;post_tags_attributes_0_relevances_attributes_0_value&quot; name=&quot;post[tags_attributes][0][relevances_attributes][0][value]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;tagrelevance #3141&quot; /&gt;' +
               '&lt;input id=&quot;post_tags_attributes_0_relevances_attributes_0_id&quot; name=&quot;post[tags_attributes][0][relevances_attributes][0][id]&quot; type=&quot;hidden&quot; value=&quot;3141&quot; /&gt;' +
               '&lt;input id=&quot;post_tags_attributes_0_id&quot; name=&quot;post[tags_attributes][0][id]&quot; type=&quot;hidden&quot; value=&quot;123&quot; /&gt;' +
               '&lt;input id=&quot;post_tags_attributes_1_value&quot; name=&quot;post[tags_attributes][1][value]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;tag #456&quot; /&gt;' +
               '&lt;input id=&quot;post_tags_attributes_1_relevances_attributes_0_value&quot; name=&quot;post[tags_attributes][1][relevances_attributes][0][value]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;tagrelevance #31415&quot; /&gt;' +
               '&lt;input id=&quot;post_tags_attributes_1_relevances_attributes_0_id&quot; name=&quot;post[tags_attributes][1][relevances_attributes][0][id]&quot; type=&quot;hidden&quot; value=&quot;31415&quot; /&gt;' +
               '&lt;input id=&quot;post_tags_attributes_1_id&quot; name=&quot;post[tags_attributes][1][id]&quot; type=&quot;hidden&quot; value=&quot;456&quot; /&gt;' +
               '&lt;/form&gt;'

    assert_dom_equal expected, output_buffer
  end

  def test_fields_for
    fields_for(:post, @post) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[secret]' checked='checked' type='checkbox' id='post_secret' value='1' /&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_fields_for_with_index
    fields_for(&quot;post[]&quot;, @post) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;input name='post[123][title]' size='30' type='text' id='post_123_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[123][body]' id='post_123_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[123][secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[123][secret]' checked='checked' type='checkbox' id='post_123_secret' value='1' /&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_fields_for_with_nil_index_option_override
    fields_for(&quot;post[]&quot;, @post, :index =&gt; nil) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;input name='post[][title]' size='30' type='text' id='post__title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[][body]' id='post__body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[][secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[][secret]' checked='checked' type='checkbox' id='post__secret' value='1' /&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_fields_for_with_index_option_override
    fields_for(&quot;post[]&quot;, @post, :index =&gt; &quot;abc&quot;) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;input name='post[abc][title]' size='30' type='text' id='post_abc_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[abc][body]' id='post_abc_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[abc][secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[abc][secret]' checked='checked' type='checkbox' id='post_abc_secret' value='1' /&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_fields_for_without_object
    fields_for(:post) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[secret]' checked='checked' type='checkbox' id='post_secret' value='1' /&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_fields_for_with_only_object
    fields_for(@post) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='post[secret]' checked='checked' type='checkbox' id='post_secret' value='1' /&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_fields_for_object_with_bracketed_name
    fields_for(&quot;author[post]&quot;, @post) do |f|
      concat f.label(:title)
      concat f.text_field(:title)
    end

    assert_dom_equal &quot;&lt;label for=\&quot;author_post_title\&quot;&gt;Title&lt;/label&gt;&quot; +
    &quot;&lt;input name='author[post][title]' size='30' type='text' id='author_post_title' value='Hello World' /&gt;&quot;,
      output_buffer
  end

  def test_fields_for_object_with_bracketed_name_and_index
    fields_for(&quot;author[post]&quot;, @post, :index =&gt; 1) do |f|
      concat f.label(:title)
      concat f.text_field(:title)
    end

    assert_dom_equal &quot;&lt;label for=\&quot;author_post_1_title\&quot;&gt;Title&lt;/label&gt;&quot; +
      &quot;&lt;input name='author[post][1][title]' size='30' type='text' id='author_post_1_title' value='Hello World' /&gt;&quot;,
      output_buffer
  end

  def test_form_builder_does_not_have_form_for_method
    assert ! ActionView::Helpers::FormBuilder.instance_methods.include?('form_for')
  end

  def test_form_for_and_fields_for
    form_for(:post, @post, :html =&gt; { :id =&gt; 'create-post' }) do |post_form|
      concat post_form.text_field(:title)
      concat post_form.text_area(:body)

      fields_for(:parent_post, @post) do |parent_fields|
        concat parent_fields.check_box(:secret)
      end
    end

    expected =
      &quot;&lt;form action='http://www.example.com' id='create-post' method='post'&gt;&quot; +
      &quot;&lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='parent_post[secret]' type='hidden' value='0' /&gt;&quot; +
      &quot;&lt;input name='parent_post[secret]' checked='checked' type='checkbox' id='parent_post_secret' value='1' /&gt;&quot; +
      &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_form_for_and_fields_for_with_object
    form_for(:post, @post, :html =&gt; { :id =&gt; 'create-post' }) do |post_form|
      concat post_form.text_field(:title)
      concat post_form.text_area(:body)

      post_form.fields_for(@comment) do |comment_fields|
        concat comment_fields.text_field(:name)
      end
    end

    expected =
      &quot;&lt;form action='http://www.example.com' id='create-post' method='post'&gt;&quot; +
      &quot;&lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&quot; +
      &quot;&lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&quot; +
      &quot;&lt;input name='post[comment][name]' type='text' id='post_comment_name' value='new comment' size='30' /&gt;&quot; +
      &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  class LabelledFormBuilder &lt; ActionView::Helpers::FormBuilder
    (field_helpers - %w(hidden_field)).each do |selector|
      src = &lt;&lt;-END_SRC
        def #{selector}(field, *args, &amp;proc)
          (&quot;&lt;label for='\#{field}'&gt;\#{field.to_s.humanize}:&lt;/label&gt; &quot; + super + &quot;&lt;br/&gt;&quot;).html_safe!
        end
      END_SRC
      class_eval src, __FILE__, __LINE__
    end
  end

  def test_form_for_with_labelled_builder
    form_for(:post, @post, :builder =&gt; LabelledFormBuilder) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
      &quot;&lt;label for='title'&gt;Title:&lt;/label&gt; &lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&lt;br/&gt;&quot; +
      &quot;&lt;label for='body'&gt;Body:&lt;/label&gt; &lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&lt;br/&gt;&quot; +
      &quot;&lt;label for='secret'&gt;Secret:&lt;/label&gt; &lt;input name='post[secret]' type='hidden' value='0' /&gt;&lt;input name='post[secret]' checked='checked' type='checkbox' id='post_secret' value='1' /&gt;&lt;br/&gt;&quot; +
      &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_default_form_builder
    old_default_form_builder, ActionView::Base.default_form_builder =
      ActionView::Base.default_form_builder, LabelledFormBuilder

    form_for(:post, @post) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;form action='http://www.example.com' method='post'&gt;&quot; +
      &quot;&lt;label for='title'&gt;Title:&lt;/label&gt; &lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&lt;br/&gt;&quot; +
      &quot;&lt;label for='body'&gt;Body:&lt;/label&gt; &lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&lt;br/&gt;&quot; +
      &quot;&lt;label for='secret'&gt;Secret:&lt;/label&gt; &lt;input name='post[secret]' type='hidden' value='0' /&gt;&lt;input name='post[secret]' checked='checked' type='checkbox' id='post_secret' value='1' /&gt;&lt;br/&gt;&quot; +
      &quot;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  ensure
    ActionView::Base.default_form_builder = old_default_form_builder
  end

  def test_default_form_builder_with_active_record_helpers
    form_for(:post, @post) do |f|
       concat f.error_message_on('author_name')
       concat f.error_messages
    end

    expected = %(&lt;form action='http://www.example.com' method='post'&gt;) +
               %(&lt;div class='formError'&gt;can't be empty&lt;/div&gt;) +
               %(&lt;div class=&quot;errorExplanation&quot; id=&quot;errorExplanation&quot;&gt;&lt;h2&gt;1 error prohibited this post from being saved&lt;/h2&gt;&lt;p&gt;There were problems with the following fields:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Author name can't be empty&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;) +
               %(&lt;/form&gt;)

    assert_dom_equal expected, output_buffer

  end

  def test_default_form_builder_no_instance_variable
    post = @post
    @post = nil

    form_for(:post, post) do |f|
       concat f.error_message_on('author_name')
       concat f.error_messages
    end

    expected = %(&lt;form action='http://www.example.com' method='post'&gt;) +
               %(&lt;div class='formError'&gt;can't be empty&lt;/div&gt;) +
               %(&lt;div class=&quot;errorExplanation&quot; id=&quot;errorExplanation&quot;&gt;&lt;h2&gt;1 error prohibited this post from being saved&lt;/h2&gt;&lt;p&gt;There were problems with the following fields:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Author name can't be empty&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;) +
               %(&lt;/form&gt;)

    assert_dom_equal expected, output_buffer

  end

  # Perhaps this test should be moved to prototype helper tests.
  def test_remote_form_for_with_labelled_builder
    self.extend ActionView::Helpers::PrototypeHelper

     remote_form_for(:post, @post, :builder =&gt; LabelledFormBuilder) do |f|
       concat f.text_field(:title)
       concat f.text_area(:body)
       concat f.check_box(:secret)
     end

     expected =
       %(&lt;form action=&quot;http://www.example.com&quot; onsubmit=&quot;new Ajax.Request('http://www.example.com', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;&quot; method=&quot;post&quot;&gt;) +
       &quot;&lt;label for='title'&gt;Title:&lt;/label&gt; &lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&lt;br/&gt;&quot; +
       &quot;&lt;label for='body'&gt;Body:&lt;/label&gt; &lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&lt;br/&gt;&quot; +
       &quot;&lt;label for='secret'&gt;Secret:&lt;/label&gt; &lt;input name='post[secret]' type='hidden' value='0' /&gt;&lt;input name='post[secret]' checked='checked' type='checkbox' id='post_secret' value='1' /&gt;&lt;br/&gt;&quot; +
       &quot;&lt;/form&gt;&quot;

     assert_dom_equal expected, output_buffer
  end

  def test_fields_for_with_labelled_builder
    fields_for(:post, @post, :builder =&gt; LabelledFormBuilder) do |f|
      concat f.text_field(:title)
      concat f.text_area(:body)
      concat f.check_box(:secret)
    end

    expected =
      &quot;&lt;label for='title'&gt;Title:&lt;/label&gt; &lt;input name='post[title]' size='30' type='text' id='post_title' value='Hello World' /&gt;&lt;br/&gt;&quot; +
      &quot;&lt;label for='body'&gt;Body:&lt;/label&gt; &lt;textarea name='post[body]' id='post_body' rows='20' cols='40'&gt;Back to the hill and over it again!&lt;/textarea&gt;&lt;br/&gt;&quot; +
      &quot;&lt;label for='secret'&gt;Secret:&lt;/label&gt; &lt;input name='post[secret]' type='hidden' value='0' /&gt;&lt;input name='post[secret]' checked='checked' type='checkbox' id='post_secret' value='1' /&gt;&lt;br/&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_form_for_with_labelled_builder_with_nested_fields_for_without_options_hash
    klass = nil

    form_for(:post, @post, :builder =&gt; LabelledFormBuilder) do |f|
      f.fields_for(:comments, Comment.new) do |nested_fields|
        klass = nested_fields.class
        ''
      end
    end

    assert_equal LabelledFormBuilder, klass
  end

  def test_form_for_with_labelled_builder_with_nested_fields_for_with_options_hash
    klass = nil

    form_for(:post, @post, :builder =&gt; LabelledFormBuilder) do |f|
      f.fields_for(:comments, Comment.new, :index =&gt; 'foo') do |nested_fields|
        klass = nested_fields.class
        ''
      end
    end

    assert_equal LabelledFormBuilder, klass
  end

  class LabelledFormBuilderSubclass &lt; LabelledFormBuilder; end

  def test_form_for_with_labelled_builder_with_nested_fields_for_with_custom_builder
    klass = nil

    form_for(:post, @post, :builder =&gt; LabelledFormBuilder) do |f|
      f.fields_for(:comments, Comment.new, :builder =&gt; LabelledFormBuilderSubclass) do |nested_fields|
        klass = nested_fields.class
        ''
      end
    end

    assert_equal LabelledFormBuilderSubclass, klass
  end

  def test_form_for_with_html_options_adds_options_to_form_tag
    form_for(:post, @post, :html =&gt; {:id =&gt; 'some_form', :class =&gt; 'some_class'}) do |f| end
    expected = &quot;&lt;form action=\&quot;http://www.example.com\&quot; class=\&quot;some_class\&quot; id=\&quot;some_form\&quot; method=\&quot;post\&quot;&gt;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  def test_form_for_with_string_url_option
    form_for(:post, @post, :url =&gt; 'http://www.otherdomain.com') do |f| end

    assert_equal '&lt;form action=&quot;http://www.otherdomain.com&quot; method=&quot;post&quot;&gt;&lt;/form&gt;', output_buffer
  end

  def test_form_for_with_hash_url_option
    form_for(:post, @post, :url =&gt; {:controller =&gt; 'controller', :action =&gt; 'action'}) do |f| end

    assert_equal 'controller', @controller.url_for_options[:controller]
    assert_equal 'action', @controller.url_for_options[:action]
  end

  def test_form_for_with_record_url_option
    form_for(:post, @post, :url =&gt; @post) do |f| end

    expected = &quot;&lt;form action=\&quot;/posts/123\&quot; method=\&quot;post\&quot;&gt;&lt;/form&gt;&quot;
    assert_equal expected, output_buffer
  end

  def test_form_for_with_existing_object
    form_for(@post) do |f| end

    expected = &quot;&lt;form action=\&quot;/posts/123\&quot; class=\&quot;edit_post\&quot; id=\&quot;edit_post_123\&quot; method=\&quot;post\&quot;&gt;&lt;div style=\&quot;margin:0;padding:0;display:inline\&quot;&gt;&lt;input name=\&quot;_method\&quot; type=\&quot;hidden\&quot; value=\&quot;put\&quot; /&gt;&lt;/div&gt;&lt;/form&gt;&quot;
    assert_equal expected, output_buffer
  end

  def test_form_for_with_new_object
    post = Post.new
    post.new_record = true
    def post.id() nil end

    form_for(post) do |f| end

    expected = &quot;&lt;form action=\&quot;/posts\&quot; class=\&quot;new_post\&quot; id=\&quot;new_post\&quot; method=\&quot;post\&quot;&gt;&lt;/form&gt;&quot;
    assert_equal expected, output_buffer
  end

  def test_form_for_with_existing_object_in_list
    @post.new_record = false
    @comment.save

    form_for([@post, @comment]) {}

    expected = %(&lt;form action=&quot;#{comment_path(@post, @comment)}&quot; class=&quot;edit_comment&quot; id=&quot;edit_comment_1&quot; method=&quot;post&quot;&gt;&lt;div style=&quot;margin:0;padding:0;display:inline&quot;&gt;&lt;input name=&quot;_method&quot; type=&quot;hidden&quot; value=&quot;put&quot; /&gt;&lt;/div&gt;&lt;/form&gt;)
    assert_dom_equal expected, output_buffer
  end

  def test_form_for_with_new_object_in_list
    @post.new_record = false

    form_for([@post, @comment]) {}

    expected = %(&lt;form action=&quot;#{comments_path(@post)}&quot; class=&quot;new_comment&quot; id=&quot;new_comment&quot; method=&quot;post&quot;&gt;&lt;/form&gt;)
    assert_dom_equal expected, output_buffer
  end

  def test_form_for_with_existing_object_and_namespace_in_list
    @post.new_record = false
    @comment.save

    form_for([:admin, @post, @comment]) {}

    expected = %(&lt;form action=&quot;#{admin_comment_path(@post, @comment)}&quot; class=&quot;edit_comment&quot; id=&quot;edit_comment_1&quot; method=&quot;post&quot;&gt;&lt;div style=&quot;margin:0;padding:0;display:inline&quot;&gt;&lt;input name=&quot;_method&quot; type=&quot;hidden&quot; value=&quot;put&quot; /&gt;&lt;/div&gt;&lt;/form&gt;)
    assert_dom_equal expected, output_buffer
  end

  def test_form_for_with_new_object_and_namespace_in_list
    @post.new_record = false

    form_for([:admin, @post, @comment]) {}

    expected = %(&lt;form action=&quot;#{admin_comments_path(@post)}&quot; class=&quot;new_comment&quot; id=&quot;new_comment&quot; method=&quot;post&quot;&gt;&lt;/form&gt;)
    assert_dom_equal expected, output_buffer
  end

  def test_form_for_with_existing_object_and_custom_url
    form_for(@post, :url =&gt; &quot;/super_posts&quot;) do |f| end

    expected = &quot;&lt;form action=\&quot;/super_posts\&quot; class=\&quot;edit_post\&quot; id=\&quot;edit_post_123\&quot; method=\&quot;post\&quot;&gt;&lt;div style=\&quot;margin:0;padding:0;display:inline\&quot;&gt;&lt;input name=\&quot;_method\&quot; type=\&quot;hidden\&quot; value=\&quot;put\&quot; /&gt;&lt;/div&gt;&lt;/form&gt;&quot;
    assert_equal expected, output_buffer
  end

  def test_remote_form_for_with_html_options_adds_options_to_form_tag
    self.extend ActionView::Helpers::PrototypeHelper

    remote_form_for(:post, @post, :html =&gt; {:id =&gt; 'some_form', :class =&gt; 'some_class'}) do |f| end
    expected = &quot;&lt;form action=\&quot;http://www.example.com\&quot; class=\&quot;some_class\&quot; id=\&quot;some_form\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Request('http://www.example.com', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;\&quot;&gt;&lt;/form&gt;&quot;

    assert_dom_equal expected, output_buffer
  end

  protected
    def comments_path(post)
      &quot;/posts/#{post.id}/comments&quot;
    end
    alias_method :post_comments_path, :comments_path

    def comment_path(post, comment)
      &quot;/posts/#{post.id}/comments/#{comment.id}&quot;
    end
    alias_method :post_comment_path, :comment_path

    def admin_comments_path(post)
      &quot;/admin/posts/#{post.id}/comments&quot;
    end
    alias_method :admin_post_comments_path, :admin_comments_path

    def admin_comment_path(post, comment)
      &quot;/admin/posts/#{post.id}/comments/#{comment.id}&quot;
    end
    alias_method :admin_post_comment_path, :admin_comment_path

    def posts_path
      &quot;/posts&quot;
    end

    def post_path(post)
      &quot;/posts/#{post.id}&quot;
    end

    def protect_against_forgery?
      false
    end
end
</pre>
    </div>