  <div id="fileHeader">
    <h1>text_helper_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/template/text_helper_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Nov 27 16:38:16 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'
require 'testing_sandbox'
begin
  require 'redcloth'
rescue LoadError
  $stderr.puts &quot;Skipping textilize tests. `gem install RedCloth` to enable.&quot;
end

class TextHelperTest &lt; ActionView::TestCase
  tests ActionView::Helpers::TextHelper
  include TestingSandbox

  def setup
    # This simulates the fact that instance variables are reset every time
    # a view is rendered.  The cycle helper depends on this behavior.
    @_cycles = nil if (defined? @_cycles)
  end

  def test_concat
    self.output_buffer = 'foo'
    assert_equal 'foobar', concat('bar')
    assert_equal 'foobar', output_buffer
  end

  def test_simple_format
    assert_equal &quot;&lt;p&gt;&lt;/p&gt;&quot;, simple_format(nil)

    assert_equal &quot;&lt;p&gt;crazy\n&lt;br /&gt; cross\n&lt;br /&gt; platform linebreaks&lt;/p&gt;&quot;, simple_format(&quot;crazy\r\n cross\r platform linebreaks&quot;)
    assert_equal &quot;&lt;p&gt;A paragraph&lt;/p&gt;\n\n&lt;p&gt;and another one!&lt;/p&gt;&quot;, simple_format(&quot;A paragraph\n\nand another one!&quot;)
    assert_equal &quot;&lt;p&gt;A paragraph\n&lt;br /&gt; With a newline&lt;/p&gt;&quot;, simple_format(&quot;A paragraph\n With a newline&quot;)

    text = &quot;A\nB\nC\nD&quot;.freeze
    assert_equal &quot;&lt;p&gt;A\n&lt;br /&gt;B\n&lt;br /&gt;C\n&lt;br /&gt;D&lt;/p&gt;&quot;, simple_format(text)

    text = &quot;A\r\n  \nB\n\n\r\n\t\nC\nD&quot;.freeze
    assert_equal &quot;&lt;p&gt;A\n&lt;br /&gt;  \n&lt;br /&gt;B&lt;/p&gt;\n\n&lt;p&gt;\t\n&lt;br /&gt;C\n&lt;br /&gt;D&lt;/p&gt;&quot;, simple_format(text)

     assert_equal %q(&lt;p class=&quot;test&quot;&gt;This is a classy test&lt;/p&gt;), simple_format(&quot;This is a classy test&quot;, :class =&gt; 'test')
     assert_equal %Q(&lt;p class=&quot;test&quot;&gt;para 1&lt;/p&gt;\n\n&lt;p class=&quot;test&quot;&gt;para 2&lt;/p&gt;), simple_format(&quot;para 1\n\npara 2&quot;, :class =&gt; 'test')
  end

  def test_truncate
    assert_equal &quot;Hello World!&quot;, truncate(&quot;Hello World!&quot;, :length =&gt; 12)
    assert_equal &quot;Hello Wor...&quot;, truncate(&quot;Hello World!!&quot;, :length =&gt; 12)
  end

  def test_truncate_should_use_default_length_of_30
    str = &quot;This is a string that will go longer then the default truncate length of 30&quot;
    assert_equal str[0...27] + &quot;...&quot;, truncate(str)
  end

  def test_truncate_with_options_hash
    assert_equal &quot;This is a string that wil[...]&quot;, truncate(&quot;This is a string that will go longer then the default truncate length of 30&quot;, :omission =&gt; &quot;[...]&quot;)
    assert_equal &quot;Hello W...&quot;, truncate(&quot;Hello World!&quot;, :length =&gt; 10)
    assert_equal &quot;Hello[...]&quot;, truncate(&quot;Hello World!&quot;, :omission =&gt; &quot;[...]&quot;, :length =&gt; 10)
  end

  if RUBY_VERSION &lt; '1.9.0'
    def test_truncate_multibyte
      with_kcode 'none' do
        assert_equal &quot;\354\225\210\353\205\225\355...&quot;, truncate(&quot;\354\225\210\353\205\225\355\225\230\354\204\270\354\232\224&quot;, :length =&gt; 10)
      end
      with_kcode 'u' do
        assert_equal &quot;\354\225\204\353\246\254\353\236\221 \354\225\204\353\246\254 ...&quot;,
          truncate(&quot;\354\225\204\353\246\254\353\236\221 \354\225\204\353\246\254 \354\225\204\353\235\274\353\246\254\354\230\244&quot;, :length =&gt; 10)
      end
    end
  else
    def test_truncate_multibyte
      assert_equal &quot;\354\225\210\353\205\225\355...&quot;,
        truncate(&quot;\354\225\210\353\205\225\355\225\230\354\204\270\354\232\224&quot;, :length =&gt; 10)

      assert_equal &quot;\354\225\204\353\246\254\353\236\221 \354\225\204\353\246\254 ...&quot;.force_encoding('UTF-8'),
        truncate(&quot;\354\225\204\353\246\254\353\236\221 \354\225\204\353\246\254 \354\225\204\353\235\274\353\246\254\354\230\244&quot;.force_encoding('UTF-8'), :length =&gt; 10)
    end
  end

  def test_highlighter
    assert_equal(
      &quot;This is a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; morning&quot;,
      highlight(&quot;This is a beautiful morning&quot;, &quot;beautiful&quot;)
    )

    assert_equal(
      &quot;This is a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; morning, but also a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; day&quot;,
      highlight(&quot;This is a beautiful morning, but also a beautiful day&quot;, &quot;beautiful&quot;)
    )

    assert_equal(
      &quot;This is a &lt;b&gt;beautiful&lt;/b&gt; morning, but also a &lt;b&gt;beautiful&lt;/b&gt; day&quot;,
      highlight(&quot;This is a beautiful morning, but also a beautiful day&quot;, &quot;beautiful&quot;, '&lt;b&gt;\1&lt;/b&gt;')
    )

    assert_equal(
      &quot;This text is not changed because we supplied an empty phrase&quot;,
      highlight(&quot;This text is not changed because we supplied an empty phrase&quot;, nil)
    )

    assert_equal '   ', highlight('   ', 'blank text is returned verbatim')
  end

  def test_highlight_with_regexp
    assert_equal(
      &quot;This is a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful!&lt;/strong&gt; morning&quot;,
      highlight(&quot;This is a beautiful! morning&quot;, &quot;beautiful!&quot;)
    )

    assert_equal(
      &quot;This is a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful! morning&lt;/strong&gt;&quot;,
      highlight(&quot;This is a beautiful! morning&quot;, &quot;beautiful! morning&quot;)
    )

    assert_equal(
      &quot;This is a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful? morning&lt;/strong&gt;&quot;,
      highlight(&quot;This is a beautiful? morning&quot;, &quot;beautiful? morning&quot;)
    )
  end

  def test_highlight_with_multiple_phrases_in_one_pass
    assert_equal %(&lt;em&gt;wow&lt;/em&gt; &lt;em&gt;em&lt;/em&gt;), highlight('wow em', %w(wow em), '&lt;em&gt;\1&lt;/em&gt;')
  end

  def test_highlight_with_options_hash
    assert_equal(
      &quot;This is a &lt;b&gt;beautiful&lt;/b&gt; morning, but also a &lt;b&gt;beautiful&lt;/b&gt; day&quot;,
      highlight(&quot;This is a beautiful morning, but also a beautiful day&quot;, &quot;beautiful&quot;, :highlighter =&gt; '&lt;b&gt;\1&lt;/b&gt;')
    )
  end

  def test_highlight_with_html
    assert_equal(
      &quot;&lt;p&gt;This is a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; morning, but also a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; day&lt;/p&gt;&quot;,
      highlight(&quot;&lt;p&gt;This is a beautiful morning, but also a beautiful day&lt;/p&gt;&quot;, &quot;beautiful&quot;)
    )
    assert_equal(
      &quot;&lt;p&gt;This is a &lt;em&gt;&lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt;&lt;/em&gt; morning, but also a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; day&lt;/p&gt;&quot;,
      highlight(&quot;&lt;p&gt;This is a &lt;em&gt;beautiful&lt;/em&gt; morning, but also a beautiful day&lt;/p&gt;&quot;, &quot;beautiful&quot;)
    )
    assert_equal(
      &quot;&lt;p&gt;This is a &lt;em class=\&quot;error\&quot;&gt;&lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt;&lt;/em&gt; morning, but also a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; &lt;span class=\&quot;last\&quot;&gt;day&lt;/span&gt;&lt;/p&gt;&quot;,
      highlight(&quot;&lt;p&gt;This is a &lt;em class=\&quot;error\&quot;&gt;beautiful&lt;/em&gt; morning, but also a beautiful &lt;span class=\&quot;last\&quot;&gt;day&lt;/span&gt;&lt;/p&gt;&quot;, &quot;beautiful&quot;)
    )
    assert_equal(
      &quot;&lt;p class=\&quot;beautiful\&quot;&gt;This is a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; morning, but also a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; day&lt;/p&gt;&quot;,
      highlight(&quot;&lt;p class=\&quot;beautiful\&quot;&gt;This is a beautiful morning, but also a beautiful day&lt;/p&gt;&quot;, &quot;beautiful&quot;)
    )
    assert_equal(
      &quot;&lt;p&gt;This is a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; &lt;a href=\&quot;http://example.com/beautiful\#top?what=beautiful%20morning&amp;when=now+then\&quot;&gt;morning&lt;/a&gt;, but also a &lt;strong class=\&quot;highlight\&quot;&gt;beautiful&lt;/strong&gt; day&lt;/p&gt;&quot;,
      highlight(&quot;&lt;p&gt;This is a beautiful &lt;a href=\&quot;http://example.com/beautiful\#top?what=beautiful%20morning&amp;when=now+then\&quot;&gt;morning&lt;/a&gt;, but also a beautiful day&lt;/p&gt;&quot;, &quot;beautiful&quot;)
    )
  end

  def test_excerpt
    assert_equal(&quot;...is a beautiful morn...&quot;, excerpt(&quot;This is a beautiful morning&quot;, &quot;beautiful&quot;, 5))
    assert_equal(&quot;This is a...&quot;, excerpt(&quot;This is a beautiful morning&quot;, &quot;this&quot;, 5))
    assert_equal(&quot;...iful morning&quot;, excerpt(&quot;This is a beautiful morning&quot;, &quot;morning&quot;, 5))
    assert_nil excerpt(&quot;This is a beautiful morning&quot;, &quot;day&quot;)
  end

  def test_excerpt_in_borderline_cases
    assert_equal(&quot;&quot;, excerpt(&quot;&quot;, &quot;&quot;, 0))
    assert_equal(&quot;a&quot;, excerpt(&quot;a&quot;, &quot;a&quot;, 0))
    assert_equal(&quot;...b...&quot;, excerpt(&quot;abc&quot;, &quot;b&quot;, 0))
    assert_equal(&quot;abc&quot;, excerpt(&quot;abc&quot;, &quot;b&quot;, 1))
    assert_equal(&quot;abc...&quot;, excerpt(&quot;abcd&quot;, &quot;b&quot;, 1))
    assert_equal(&quot;...abc&quot;, excerpt(&quot;zabc&quot;, &quot;b&quot;, 1))
    assert_equal(&quot;...abc...&quot;, excerpt(&quot;zabcd&quot;, &quot;b&quot;, 1))
    assert_equal(&quot;zabcd&quot;, excerpt(&quot;zabcd&quot;, &quot;b&quot;, 2))

    # excerpt strips the resulting string before ap-/prepending excerpt_string.
    # whether this behavior is meaningful when excerpt_string is not to be
    # appended is questionable.
    assert_equal(&quot;zabcd&quot;, excerpt(&quot;  zabcd  &quot;, &quot;b&quot;, 4))
    assert_equal(&quot;...abc...&quot;, excerpt(&quot;z  abc  d&quot;, &quot;b&quot;, 1))
  end

  def test_excerpt_with_regex
    assert_equal('...is a beautiful! mor...', excerpt('This is a beautiful! morning', 'beautiful', 5))
    assert_equal('...is a beautiful? mor...', excerpt('This is a beautiful? morning', 'beautiful', 5))
  end

  def test_excerpt_with_options_hash
    assert_equal(&quot;...is a beautiful morn...&quot;, excerpt(&quot;This is a beautiful morning&quot;, &quot;beautiful&quot;, :radius =&gt; 5))
    assert_equal(&quot;[...]is a beautiful morn[...]&quot;, excerpt(&quot;This is a beautiful morning&quot;, &quot;beautiful&quot;, :omission =&gt; &quot;[...]&quot;,:radius =&gt; 5))
    assert_equal(
      &quot;This is the ultimate supercalifragilisticexpialidoceous very looooooooooooooooooong looooooooooooong beautiful morning with amazing sunshine and awesome tempera[...]&quot;,
      excerpt(&quot;This is the ultimate supercalifragilisticexpialidoceous very looooooooooooooooooong looooooooooooong beautiful morning with amazing sunshine and awesome temperatures. So what are you gonna do about it?&quot;, &quot;very&quot;,
      :omission =&gt; &quot;[...]&quot;)
    )
  end

  if RUBY_VERSION &lt; '1.9'
    def test_excerpt_with_utf8
      with_kcode('u') do
        assert_equal(&quot;...\357\254\203ciency could not be...&quot;, excerpt(&quot;That's why e\357\254\203ciency could not be helped&quot;, 'could', 8))
      end
      with_kcode('none') do
        assert_equal(&quot;...\203ciency could not be...&quot;, excerpt(&quot;That's why e\357\254\203ciency could not be helped&quot;, 'could', 8))
      end
    end
  else
    def test_excerpt_with_utf8
      assert_equal(&quot;...\357\254\203ciency could not be...&quot;.force_encoding('UTF-8'), excerpt(&quot;That's why e\357\254\203ciency could not be helped&quot;.force_encoding('UTF-8'), 'could', 8))
      assert_equal(&quot;...\203ciency could not be...&quot;, excerpt(&quot;That's why e\357\254\203ciency could not be helped&quot;, 'could', 8))
    end
  end

  def test_word_wrap
    assert_equal(&quot;my very very\nvery long\nstring&quot;, word_wrap(&quot;my very very very long string&quot;, 15))
  end

  def test_word_wrap_with_extra_newlines
    assert_equal(&quot;my very very\nvery long\nstring\n\nwith another\nline&quot;, word_wrap(&quot;my very very very long string\n\nwith another line&quot;, 15))
  end

  def test_word_wrap_with_options_hash
    assert_equal(&quot;my very very\nvery long\nstring&quot;, word_wrap(&quot;my very very very long string&quot;, :line_width =&gt; 15))
  end

  def test_pluralization
    assert_equal(&quot;1 count&quot;, pluralize(1, &quot;count&quot;))
    assert_equal(&quot;2 counts&quot;, pluralize(2, &quot;count&quot;))
    assert_equal(&quot;1 count&quot;, pluralize('1', &quot;count&quot;))
    assert_equal(&quot;2 counts&quot;, pluralize('2', &quot;count&quot;))
    assert_equal(&quot;1,066 counts&quot;, pluralize('1,066', &quot;count&quot;))
    assert_equal(&quot;1.25 counts&quot;, pluralize('1.25', &quot;count&quot;))
    assert_equal(&quot;2 counters&quot;, pluralize(2, &quot;count&quot;, &quot;counters&quot;))
    assert_equal(&quot;0 counters&quot;, pluralize(nil, &quot;count&quot;, &quot;counters&quot;))
    assert_equal(&quot;2 people&quot;, pluralize(2, &quot;person&quot;))
    assert_equal(&quot;10 buffaloes&quot;, pluralize(10, &quot;buffalo&quot;))
    assert_equal(&quot;1 berry&quot;, pluralize(1, &quot;berry&quot;))
    assert_equal(&quot;12 berries&quot;, pluralize(12, &quot;berry&quot;))
  end

  def test_auto_link_parsing
    urls = %w(
      http://www.rubyonrails.com
      http://www.rubyonrails.com:80
      http://www.rubyonrails.com/~minam
      https://www.rubyonrails.com/~minam
      http://www.rubyonrails.com/~minam/url%20with%20spaces
      http://www.rubyonrails.com/foo.cgi?something=here
      http://www.rubyonrails.com/foo.cgi?something=here&amp;and=here
      http://www.rubyonrails.com/contact;new
      http://www.rubyonrails.com/contact;new%20with%20spaces
      http://www.rubyonrails.com/contact;new?with=query&amp;string=params
      http://www.rubyonrails.com/~minam/contact;new?with=query&amp;string=params
      http://en.wikipedia.org/wiki/Wikipedia:Today%27s_featured_picture_%28animation%29/January_20%2C_2007
      http://www.mail-archive.com/rails@lists.rubyonrails.org/
      http://www.amazon.com/Testing-Equal-Sign-In-Path/ref=pd_bbs_sr_1?ie=UTF8&amp;s=books&amp;qid=1198861734&amp;sr=8-1
      http://en.wikipedia.org/wiki/Texas_hold'em
      https://www.google.com/doku.php?id=gps:resource:scs:start
      http://connect.oraclecorp.com/search?search[q]=green+france&amp;search[type]=Group
      http://of.openfoundry.org/projects/492/download#4th.Release.3
      http://maps.google.co.uk/maps?f=q&amp;q=the+london+eye&amp;ie=UTF8&amp;ll=51.503373,-0.11939&amp;spn=0.007052,0.012767&amp;z=16&amp;iwloc=A
    )

    urls.each do |url|
      assert_equal generate_result(url), auto_link(url)
    end
  end

  def generate_result(link_text, href = nil)
    href ||= link_text
    %{&lt;a href=&quot;#{CGI::escapeHTML href}&quot;&gt;#{CGI::escapeHTML link_text}&lt;/a&gt;}
  end

  def test_auto_linking
    email_raw    = 'david@loudthinking.com'
    email_result = %{&lt;a href=&quot;mailto:#{email_raw}&quot;&gt;#{email_raw}&lt;/a&gt;}
    link_raw     = 'http://www.rubyonrails.com'
    link_result  = generate_result(link_raw)
    link_result_with_options = %{&lt;a href=&quot;#{link_raw}&quot; target=&quot;_blank&quot;&gt;#{link_raw}&lt;/a&gt;}

    assert_equal '', auto_link(nil)
    assert_equal '', auto_link('')
    assert_equal &quot;#{link_result} #{link_result} #{link_result}&quot;, auto_link(&quot;#{link_raw} #{link_raw} #{link_raw}&quot;)

    assert_equal %(hello #{email_result}), auto_link(&quot;hello #{email_raw}&quot;, :email_addresses)
    assert_equal %(Go to #{link_result}), auto_link(&quot;Go to #{link_raw}&quot;, :urls)
    assert_equal %(Go to #{link_raw}), auto_link(&quot;Go to #{link_raw}&quot;, :email_addresses)
    assert_equal %(Go to #{link_result} and say hello to #{email_result}), auto_link(&quot;Go to #{link_raw} and say hello to #{email_raw}&quot;)
    assert_equal %(&lt;p&gt;Link #{link_result}&lt;/p&gt;), auto_link(&quot;&lt;p&gt;Link #{link_raw}&lt;/p&gt;&quot;)
    assert_equal %(&lt;p&gt;#{link_result} Link&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{link_raw} Link&lt;/p&gt;&quot;)
    assert_equal %(&lt;p&gt;Link #{link_result_with_options}&lt;/p&gt;), auto_link(&quot;&lt;p&gt;Link #{link_raw}&lt;/p&gt;&quot;, :all, {:target =&gt; &quot;_blank&quot;})
    assert_equal %(Go to #{link_result}.), auto_link(%(Go to #{link_raw}.))
    assert_equal %(&lt;p&gt;Go to #{link_result}, then say hello to #{email_result}.&lt;/p&gt;), auto_link(%(&lt;p&gt;Go to #{link_raw}, then say hello to #{email_raw}.&lt;/p&gt;))

    email2_raw    = '+david@loudthinking.com'
    email2_result = %{&lt;a href=&quot;mailto:#{email2_raw}&quot;&gt;#{email2_raw}&lt;/a&gt;}
    assert_equal email2_result, auto_link(email2_raw)

    email3_raw    = '+david@loudthinking.com'
    email3_result = %{&lt;a href=&quot;&amp;#109;&amp;#97;&amp;#105;&amp;#108;&amp;#116;&amp;#111;&amp;#58;+%64%61%76%69%64@%6c%6f%75%64%74%68%69%6e%6b%69%6e%67.%63%6f%6d&quot;&gt;#{email3_raw}&lt;/a&gt;}
    assert_equal email3_result, auto_link(email3_raw, :all, :encode =&gt; :hex)
    assert_equal email3_result, auto_link(email3_raw, :email_addresses, :encode =&gt; :hex)

    link2_raw    = 'www.rubyonrails.com'
    link2_result = generate_result(link2_raw, &quot;http://#{link2_raw}&quot;)
    assert_equal %(Go to #{link2_result}), auto_link(&quot;Go to #{link2_raw}&quot;, :urls)
    assert_equal %(Go to #{link2_raw}), auto_link(&quot;Go to #{link2_raw}&quot;, :email_addresses)
    assert_equal %(&lt;p&gt;Link #{link2_result}&lt;/p&gt;), auto_link(&quot;&lt;p&gt;Link #{link2_raw}&lt;/p&gt;&quot;)
    assert_equal %(&lt;p&gt;#{link2_result} Link&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{link2_raw} Link&lt;/p&gt;&quot;)
    assert_equal %(Go to #{link2_result}.), auto_link(%(Go to #{link2_raw}.))
    assert_equal %(&lt;p&gt;Say hello to #{email_result}, then go to #{link2_result}.&lt;/p&gt;), auto_link(%(&lt;p&gt;Say hello to #{email_raw}, then go to #{link2_raw}.&lt;/p&gt;))

    link3_raw    = 'http://manuals.ruby-on-rails.com/read/chapter.need_a-period/103#page281'
    link3_result = generate_result(link3_raw)
    assert_equal %(Go to #{link3_result}), auto_link(&quot;Go to #{link3_raw}&quot;, :urls)
    assert_equal %(Go to #{link3_raw}), auto_link(&quot;Go to #{link3_raw}&quot;, :email_addresses)
    assert_equal %(&lt;p&gt;Link #{link3_result}&lt;/p&gt;), auto_link(&quot;&lt;p&gt;Link #{link3_raw}&lt;/p&gt;&quot;)
    assert_equal %(&lt;p&gt;#{link3_result} Link&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{link3_raw} Link&lt;/p&gt;&quot;)
    assert_equal %(Go to #{link3_result}.), auto_link(%(Go to #{link3_raw}.))
    assert_equal %(&lt;p&gt;Go to #{link3_result}. Seriously, #{link3_result}? I think I'll say hello to #{email_result}. Instead.&lt;/p&gt;),
       auto_link(%(&lt;p&gt;Go to #{link3_raw}. Seriously, #{link3_raw}? I think I'll say hello to #{email_raw}. Instead.&lt;/p&gt;))

    link4_raw    = 'http://foo.example.com/controller/action?parm=value&amp;p2=v2#anchor123'
    link4_result = generate_result(link4_raw)
    assert_equal %(&lt;p&gt;Link #{link4_result}&lt;/p&gt;), auto_link(&quot;&lt;p&gt;Link #{link4_raw}&lt;/p&gt;&quot;)
    assert_equal %(&lt;p&gt;#{link4_result} Link&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{link4_raw} Link&lt;/p&gt;&quot;)

    link5_raw    = 'http://foo.example.com:3000/controller/action'
    link5_result = generate_result(link5_raw)
    assert_equal %(&lt;p&gt;#{link5_result} Link&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{link5_raw} Link&lt;/p&gt;&quot;)

    link6_raw    = 'http://foo.example.com:3000/controller/action+pack'
    link6_result = generate_result(link6_raw)
    assert_equal %(&lt;p&gt;#{link6_result} Link&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{link6_raw} Link&lt;/p&gt;&quot;)

    link7_raw    = 'http://foo.example.com/controller/action?parm=value&amp;p2=v2#anchor-123'
    link7_result = generate_result(link7_raw)
    assert_equal %(&lt;p&gt;#{link7_result} Link&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{link7_raw} Link&lt;/p&gt;&quot;)

    link8_raw    = 'http://foo.example.com:3000/controller/action.html'
    link8_result = generate_result(link8_raw)
    assert_equal %(Go to #{link8_result}), auto_link(&quot;Go to #{link8_raw}&quot;, :urls)
    assert_equal %(Go to #{link8_raw}), auto_link(&quot;Go to #{link8_raw}&quot;, :email_addresses)
    assert_equal %(&lt;p&gt;Link #{link8_result}&lt;/p&gt;), auto_link(&quot;&lt;p&gt;Link #{link8_raw}&lt;/p&gt;&quot;)
    assert_equal %(&lt;p&gt;#{link8_result} Link&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{link8_raw} Link&lt;/p&gt;&quot;)
    assert_equal %(Go to #{link8_result}.), auto_link(%(Go to #{link8_raw}.))
    assert_equal %(&lt;p&gt;Go to #{link8_result}. Seriously, #{link8_result}? I think I'll say hello to #{email_result}. Instead.&lt;/p&gt;),
       auto_link(%(&lt;p&gt;Go to #{link8_raw}. Seriously, #{link8_raw}? I think I'll say hello to #{email_raw}. Instead.&lt;/p&gt;))

    link9_raw    = 'http://business.timesonline.co.uk/article/0,,9065-2473189,00.html'
    link9_result = generate_result(link9_raw)
    assert_equal %(Go to #{link9_result}), auto_link(&quot;Go to #{link9_raw}&quot;, :urls)
    assert_equal %(Go to #{link9_raw}), auto_link(&quot;Go to #{link9_raw}&quot;, :email_addresses)
    assert_equal %(&lt;p&gt;Link #{link9_result}&lt;/p&gt;), auto_link(&quot;&lt;p&gt;Link #{link9_raw}&lt;/p&gt;&quot;)
    assert_equal %(&lt;p&gt;#{link9_result} Link&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{link9_raw} Link&lt;/p&gt;&quot;)
    assert_equal %(Go to #{link9_result}.), auto_link(%(Go to #{link9_raw}.))
    assert_equal %(&lt;p&gt;Go to #{link9_result}. Seriously, #{link9_result}? I think I'll say hello to #{email_result}. Instead.&lt;/p&gt;),
       auto_link(%(&lt;p&gt;Go to #{link9_raw}. Seriously, #{link9_raw}? I think I'll say hello to #{email_raw}. Instead.&lt;/p&gt;))

    link10_raw    = 'http://www.mail-archive.com/ruby-talk@ruby-lang.org/'
    link10_result = generate_result(link10_raw)
    assert_equal %(&lt;p&gt;#{link10_result} Link&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{link10_raw} Link&lt;/p&gt;&quot;)
  end

  def test_auto_link_already_linked
    linked1 = generate_result('Ruby On Rails', 'http://www.rubyonrails.com')
    linked2 = generate_result('www.rubyonrails.com', 'http://www.rubyonrails.com')
    assert_equal linked1, auto_link(linked1)
    assert_equal linked2, auto_link(linked2)
  end

  def test_auto_link_with_brackets
    link1_raw = 'http://en.wikipedia.org/wiki/Sprite_(computer_graphics)'
    link1_result = generate_result(link1_raw)
    assert_equal link1_result, auto_link(link1_raw)
    assert_equal &quot;(link: #{link1_result})&quot;, auto_link(&quot;(link: #{link1_raw})&quot;)

    link2_raw = 'http://en.wikipedia.org/wiki/Sprite_[computer_graphics]'
    link2_result = generate_result(link2_raw)
    assert_equal link2_result, auto_link(link2_raw)
    assert_equal &quot;[link: #{link2_result}]&quot;, auto_link(&quot;[link: #{link2_raw}]&quot;)

    link3_raw = 'http://en.wikipedia.org/wiki/Sprite_{computer_graphics}'
    link3_result = generate_result(link3_raw)
    assert_equal link3_result, auto_link(link3_raw)
    assert_equal &quot;{link: #{link3_result}}&quot;, auto_link(&quot;{link: #{link3_raw}}&quot;)
  end

  def test_auto_link_in_tags
    link_raw    = 'http://www.rubyonrails.org/images/rails.png'
    link_result = %Q(&lt;img src=&quot;#{link_raw}&quot; /&gt;)
    assert_equal link_result, auto_link(link_result)
  end

  def test_auto_link_at_eol
    url1 = &quot;http://api.rubyonrails.com/Foo.html&quot;
    url2 = &quot;http://www.ruby-doc.org/core/Bar.html&quot;

    assert_equal %(&lt;p&gt;&lt;a href=&quot;#{url1}&quot;&gt;#{url1}&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;#{url2}&quot;&gt;#{url2}&lt;/a&gt;&lt;br /&gt;&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{url1}&lt;br /&gt;#{url2}&lt;br /&gt;&lt;/p&gt;&quot;)
  end

  def test_auto_link_with_block
    url = &quot;http://api.rubyonrails.com/Foo.html&quot;
    email = &quot;fantabulous@shiznadel.ic&quot;

    assert_equal %(&lt;p&gt;&lt;a href=&quot;#{url}&quot;&gt;#{url[0...7]}...&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;mailto:#{email}&quot;&gt;#{email[0...7]}...&lt;/a&gt;&lt;br /&gt;&lt;/p&gt;), auto_link(&quot;&lt;p&gt;#{url}&lt;br /&gt;#{email}&lt;br /&gt;&lt;/p&gt;&quot;) { |url| truncate(url, :length =&gt; 10) }
  end

  def test_auto_link_with_options_hash
    assert_dom_equal 'Welcome to my new blog at &lt;a href=&quot;http://www.myblog.com/&quot; class=&quot;menu&quot; target=&quot;_blank&quot;&gt;http://www.myblog.com/&lt;/a&gt;. Please e-mail me at &lt;a href=&quot;mailto:me@email.com&quot; class=&quot;menu&quot; target=&quot;_blank&quot;&gt;me@email.com&lt;/a&gt;.',
      auto_link(&quot;Welcome to my new blog at http://www.myblog.com/. Please e-mail me at me@email.com.&quot;,
                :link =&gt; :all, :html =&gt; { :class =&gt; &quot;menu&quot;, :target =&gt; &quot;_blank&quot; })
  end

  def test_cycle_class
    value = Cycle.new(&quot;one&quot;, 2, &quot;3&quot;)
    assert_equal(&quot;one&quot;, value.to_s)
    assert_equal(&quot;2&quot;, value.to_s)
    assert_equal(&quot;3&quot;, value.to_s)
    assert_equal(&quot;one&quot;, value.to_s)
    value.reset
    assert_equal(&quot;one&quot;, value.to_s)
    assert_equal(&quot;2&quot;, value.to_s)
    assert_equal(&quot;3&quot;, value.to_s)
  end

  def test_cycle_class_with_no_arguments
    assert_raise(ArgumentError) { value = Cycle.new() }
  end

  def test_cycle
    assert_equal(&quot;one&quot;, cycle(&quot;one&quot;, 2, &quot;3&quot;))
    assert_equal(&quot;2&quot;, cycle(&quot;one&quot;, 2, &quot;3&quot;))
    assert_equal(&quot;3&quot;, cycle(&quot;one&quot;, 2, &quot;3&quot;))
    assert_equal(&quot;one&quot;, cycle(&quot;one&quot;, 2, &quot;3&quot;))
    assert_equal(&quot;2&quot;, cycle(&quot;one&quot;, 2, &quot;3&quot;))
    assert_equal(&quot;3&quot;, cycle(&quot;one&quot;, 2, &quot;3&quot;))
  end

  def test_cycle_with_no_arguments
    assert_raise(ArgumentError) { value = cycle() }
  end

  def test_cycle_resets_with_new_values
    assert_equal(&quot;even&quot;, cycle(&quot;even&quot;, &quot;odd&quot;))
    assert_equal(&quot;odd&quot;, cycle(&quot;even&quot;, &quot;odd&quot;))
    assert_equal(&quot;even&quot;, cycle(&quot;even&quot;, &quot;odd&quot;))
    assert_equal(&quot;1&quot;, cycle(1, 2, 3))
    assert_equal(&quot;2&quot;, cycle(1, 2, 3))
    assert_equal(&quot;3&quot;, cycle(1, 2, 3))
    assert_equal(&quot;1&quot;, cycle(1, 2, 3))
  end

  def test_named_cycles
    assert_equal(&quot;1&quot;, cycle(1, 2, 3, :name =&gt; &quot;numbers&quot;))
    assert_equal(&quot;red&quot;, cycle(&quot;red&quot;, &quot;blue&quot;, :name =&gt; &quot;colors&quot;))
    assert_equal(&quot;2&quot;, cycle(1, 2, 3, :name =&gt; &quot;numbers&quot;))
    assert_equal(&quot;blue&quot;, cycle(&quot;red&quot;, &quot;blue&quot;, :name =&gt; &quot;colors&quot;))
    assert_equal(&quot;3&quot;, cycle(1, 2, 3, :name =&gt; &quot;numbers&quot;))
    assert_equal(&quot;red&quot;, cycle(&quot;red&quot;, &quot;blue&quot;, :name =&gt; &quot;colors&quot;))
  end

  def test_current_cycle_with_default_name
    cycle(&quot;even&quot;,&quot;odd&quot;)
    assert_equal &quot;even&quot;, current_cycle
    cycle(&quot;even&quot;,&quot;odd&quot;)
    assert_equal &quot;odd&quot;, current_cycle
    cycle(&quot;even&quot;,&quot;odd&quot;)
    assert_equal &quot;even&quot;, current_cycle
  end

  def test_current_cycle_with_named_cycles
    cycle(&quot;red&quot;, &quot;blue&quot;, :name =&gt; &quot;colors&quot;)
    assert_equal &quot;red&quot;, current_cycle(&quot;colors&quot;)
    cycle(&quot;red&quot;, &quot;blue&quot;, :name =&gt; &quot;colors&quot;)
    assert_equal &quot;blue&quot;, current_cycle(&quot;colors&quot;)
    cycle(&quot;red&quot;, &quot;blue&quot;, :name =&gt; &quot;colors&quot;)
    assert_equal &quot;red&quot;, current_cycle(&quot;colors&quot;)
  end

  def test_current_cycle_safe_call
    assert_nothing_raised { current_cycle }
    assert_nothing_raised { current_cycle(&quot;colors&quot;) }
  end

  def test_current_cycle_with_more_than_two_names
    cycle(1,2,3)
    assert_equal &quot;1&quot;, current_cycle
    cycle(1,2,3)
    assert_equal &quot;2&quot;, current_cycle
    cycle(1,2,3)
    assert_equal &quot;3&quot;, current_cycle
    cycle(1,2,3)
    assert_equal &quot;1&quot;, current_cycle
  end

  def test_default_named_cycle
    assert_equal(&quot;1&quot;, cycle(1, 2, 3))
    assert_equal(&quot;2&quot;, cycle(1, 2, 3, :name =&gt; &quot;default&quot;))
    assert_equal(&quot;3&quot;, cycle(1, 2, 3))
  end

  def test_reset_cycle
    assert_equal(&quot;1&quot;, cycle(1, 2, 3))
    assert_equal(&quot;2&quot;, cycle(1, 2, 3))
    reset_cycle
    assert_equal(&quot;1&quot;, cycle(1, 2, 3))
  end

  def test_reset_unknown_cycle
    reset_cycle(&quot;colors&quot;)
  end

  def test_recet_named_cycle
    assert_equal(&quot;1&quot;, cycle(1, 2, 3, :name =&gt; &quot;numbers&quot;))
    assert_equal(&quot;red&quot;, cycle(&quot;red&quot;, &quot;blue&quot;, :name =&gt; &quot;colors&quot;))
    reset_cycle(&quot;numbers&quot;)
    assert_equal(&quot;1&quot;, cycle(1, 2, 3, :name =&gt; &quot;numbers&quot;))
    assert_equal(&quot;blue&quot;, cycle(&quot;red&quot;, &quot;blue&quot;, :name =&gt; &quot;colors&quot;))
    assert_equal(&quot;2&quot;, cycle(1, 2, 3, :name =&gt; &quot;numbers&quot;))
    assert_equal(&quot;red&quot;, cycle(&quot;red&quot;, &quot;blue&quot;, :name =&gt; &quot;colors&quot;))
  end

  def test_cycle_no_instance_variable_clashes
    @cycles = %w{Specialized Fuji Giant}
    assert_equal(&quot;red&quot;, cycle(&quot;red&quot;, &quot;blue&quot;))
    assert_equal(&quot;blue&quot;, cycle(&quot;red&quot;, &quot;blue&quot;))
    assert_equal(&quot;red&quot;, cycle(&quot;red&quot;, &quot;blue&quot;))
    assert_equal(%w{Specialized Fuji Giant}, @cycles)
  end

  if defined? RedCloth
    def test_textilize
      assert_equal(&quot;&lt;p&gt;&lt;strong&gt;This is Textile!&lt;/strong&gt;  Rejoice!&lt;/p&gt;&quot;, textilize(&quot;*This is Textile!*  Rejoice!&quot;))
    end

    def test_textilize_with_blank
      assert_equal(&quot;&quot;, textilize(&quot;&quot;))
    end

    def test_textilize_with_options
      assert_equal(&quot;&lt;p&gt;This is worded &amp;lt;strong&amp;gt;strongly&amp;lt;/strong&amp;gt;&lt;/p&gt;&quot;, textilize(&quot;This is worded &lt;strong&gt;strongly&lt;/strong&gt;&quot;, :filter_html))
    end

    def test_textilize_with_hard_breaks
      assert_equal(&quot;&lt;p&gt;This is one scary world.&lt;br /&gt;\n True.&lt;/p&gt;&quot;, textilize(&quot;This is one scary world.\n True.&quot;))
    end
  end
end
</pre>
    </div>