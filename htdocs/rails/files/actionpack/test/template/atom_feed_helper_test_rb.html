  <div id="fileHeader">
    <h1>atom_feed_helper_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/template/atom_feed_helper_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:53 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

Scroll = Struct.new(:id, :to_param, :title, :body, :updated_at, :created_at)

class ScrollsController &lt; ActionController::Base
  FEEDS = {}
  FEEDS[&quot;defaults&quot;] = &lt;&lt;-EOT
        atom_feed(:schema_date =&gt; '2008') do |feed|
          feed.title(&quot;My great blog!&quot;)
          feed.updated((@scrolls.first.created_at))

          for scroll in @scrolls
            feed.entry(scroll) do |entry|
              entry.title(scroll.title)
              entry.content(scroll.body, :type =&gt; 'html')

              entry.author do |author|
                author.name(&quot;DHH&quot;)
              end
            end
          end
        end
    EOT
    FEEDS[&quot;entry_options&quot;] = &lt;&lt;-EOT
        atom_feed do |feed|
          feed.title(&quot;My great blog!&quot;)
          feed.updated((@scrolls.first.created_at))

          for scroll in @scrolls
            feed.entry(scroll, :url =&gt; &quot;/otherstuff/&quot; + scroll.to_param, :updated =&gt; Time.utc(2007, 1, scroll.id)) do |entry|
              entry.title(scroll.title)
              entry.content(scroll.body, :type =&gt; 'html')

              entry.author do |author|
                author.name(&quot;DHH&quot;)
              end
            end
          end
        end
    EOT
    FEEDS[&quot;xml_block&quot;] = &lt;&lt;-EOT
        atom_feed do |feed|
          feed.title(&quot;My great blog!&quot;)
          feed.updated((@scrolls.first.created_at))

          feed.author do |author|
            author.name(&quot;DHH&quot;)
          end

          for scroll in @scrolls
            feed.entry(scroll, :url =&gt; &quot;/otherstuff/&quot; + scroll.to_param, :updated =&gt; Time.utc(2007, 1, scroll.id)) do |entry|
              entry.title(scroll.title)
              entry.content(scroll.body, :type =&gt; 'html')
            end
          end
        end
    EOT
    FEEDS[&quot;feed_with_atomPub_namespace&quot;] = &lt;&lt;-EOT
        atom_feed({'xmlns:app' =&gt; 'http://www.w3.org/2007/app',
                 'xmlns:openSearch' =&gt; 'http://a9.com/-/spec/opensearch/1.1/'}) do |feed|
          feed.title(&quot;My great blog!&quot;)
          feed.updated((@scrolls.first.created_at))

          for scroll in @scrolls
            feed.entry(scroll) do |entry|
              entry.title(scroll.title)
              entry.content(scroll.body, :type =&gt; 'html')
              entry.tag!('app:edited', Time.now)

              entry.author do |author|
                author.name(&quot;DHH&quot;)
              end
            end
          end
        end
    EOT
    FEEDS[&quot;feed_with_overridden_ids&quot;] = &lt;&lt;-EOT
        atom_feed({:id =&gt; 'tag:test.rubyonrails.org,2008:test/'}) do |feed|
          feed.title(&quot;My great blog!&quot;)
          feed.updated((@scrolls.first.created_at))

          for scroll in @scrolls
            feed.entry(scroll, :id =&gt; &quot;tag:test.rubyonrails.org,2008:&quot;+scroll.id.to_s) do |entry|
              entry.title(scroll.title)
              entry.content(scroll.body, :type =&gt; 'html')
              entry.tag!('app:edited', Time.now)

              entry.author do |author|
                author.name(&quot;DHH&quot;)
              end
            end
          end
        end
    EOT
  FEEDS[&quot;feed_with_xml_processing_instructions&quot;] = &lt;&lt;-EOT
        atom_feed(:schema_date =&gt; '2008',
          :instruct =&gt; {'xml-stylesheet' =&gt; { :href=&gt; 't.css', :type =&gt; 'text/css' }}) do |feed|
          feed.title(&quot;My great blog!&quot;)
          feed.updated((@scrolls.first.created_at))

          for scroll in @scrolls
            feed.entry(scroll) do |entry|
              entry.title(scroll.title)
              entry.content(scroll.body, :type =&gt; 'html')

              entry.author do |author|
                author.name(&quot;DHH&quot;)
              end
            end
          end
        end
    EOT
  FEEDS[&quot;feed_with_xml_processing_instructions_duplicate_targets&quot;] = &lt;&lt;-EOT
        atom_feed(:schema_date =&gt; '2008',
          :instruct =&gt; {'target1' =&gt; [{ :a =&gt; '1', :b =&gt; '2' }, { :c =&gt; '3', :d =&gt; '4' }]}) do |feed|
          feed.title(&quot;My great blog!&quot;)
          feed.updated((@scrolls.first.created_at))

          for scroll in @scrolls
            feed.entry(scroll) do |entry|
              entry.title(scroll.title)
              entry.content(scroll.body, :type =&gt; 'html')

              entry.author do |author|
                author.name(&quot;DHH&quot;)
              end
            end
          end
        end
    EOT
    FEEDS[&quot;feed_with_xhtml_content&quot;] = &lt;&lt;-'EOT'
        atom_feed do |feed|
          feed.title(&quot;My great blog!&quot;)
          feed.updated((@scrolls.first.created_at))

          for scroll in @scrolls
            feed.entry(scroll) do |entry|
              entry.title(scroll.title)
              entry.summary(:type =&gt; 'xhtml') do |xhtml|
                xhtml.p &quot;before #{scroll.id}&quot;
                xhtml.p {xhtml &lt;&lt; scroll.body}
                xhtml.p &quot;after #{scroll.id}&quot;
              end
              entry.tag!('app:edited', Time.now)

              entry.author do |author|
                author.name(&quot;DHH&quot;)
              end
            end
          end
        end
    EOT
    FEEDS[&quot;provide_builder&quot;] = &lt;&lt;-'EOT'
          # we pass in the new_xml to the helper so it doesn't
          # call anything on the original builder
          new_xml = Builder::XmlMarkup.new(:target=&gt;'')
          atom_feed(:xml =&gt; new_xml) do |feed|
            feed.title(&quot;My great blog!&quot;)
            feed.updated((@scrolls.first.created_at))

            for scroll in @scrolls
              feed.entry(scroll) do |entry|
                entry.title(scroll.title)
                entry.content(scroll.body, :type =&gt; 'html')

                entry.author do |author|
                  author.name(&quot;DHH&quot;)
                end
              end
            end
          end
    EOT
  def index
    @scrolls = [
      Scroll.new(1, &quot;1&quot;, &quot;Hello One&quot;, &quot;Something &lt;i&gt;COOL!&lt;/i&gt;&quot;, Time.utc(2007, 12, 12, 15), Time.utc(2007, 12, 12, 15)),
      Scroll.new(2, &quot;2&quot;, &quot;Hello Two&quot;, &quot;Something Boring&quot;, Time.utc(2007, 12, 12, 15)),
    ]

    render :inline =&gt; FEEDS[params[:id]], :type =&gt; :builder
  end

  protected

  def rescue_action(e)
    raise(e)
  end
end

class AtomFeedTest &lt; ActionController::TestCase
  tests ScrollsController

  def setup
    @request.host = &quot;www.nextangle.com&quot;
  end

  def test_feed_should_use_default_language_if_none_is_given
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;defaults&quot;
      assert_match %r{xml:lang=&quot;en-US&quot;}, @response.body
    end
  end

  def test_feed_should_include_two_entries
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;defaults&quot;
      assert_select &quot;entry&quot;, 2
    end
  end

  def test_entry_should_only_use_published_if_created_at_is_present
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;defaults&quot;
      assert_select &quot;published&quot;, 1
    end
  end

  def test_providing_builder_to_atom_feed
    with_restful_routing(:scrolls) do
      get :index, :id=&gt;&quot;provide_builder&quot;
      # because we pass in the non-default builder, the content generated by the
      # helper should go 'nowhere'.  Leaving the response body blank.
      assert @response.body.blank?
    end
  end

  def test_entry_with_prefilled_options_should_use_those_instead_of_querying_the_record
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;entry_options&quot;

      assert_select &quot;updated&quot;, Time.utc(2007, 1, 1).xmlschema
      assert_select &quot;updated&quot;, Time.utc(2007, 1, 2).xmlschema
    end
  end

  def test_self_url_should_default_to_current_request_url
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;defaults&quot;
      assert_select &quot;link[rel=self][href=http://www.nextangle.com/scrolls?id=defaults]&quot;
    end
  end

  def test_feed_id_should_be_a_valid_tag
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;defaults&quot;
      assert_select &quot;id&quot;, :text =&gt; &quot;tag:www.nextangle.com,2008:/scrolls?id=defaults&quot;
    end
  end

  def test_entry_id_should_be_a_valid_tag
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;defaults&quot;
      assert_select &quot;entry id&quot;, :text =&gt; &quot;tag:www.nextangle.com,2008:Scroll/1&quot;
      assert_select &quot;entry id&quot;, :text =&gt; &quot;tag:www.nextangle.com,2008:Scroll/2&quot;
    end
  end

  def test_feed_should_allow_nested_xml_blocks
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;xml_block&quot;
      assert_select &quot;author name&quot;, :text =&gt; &quot;DHH&quot;
    end
  end

  def test_feed_should_include_atomPub_namespace
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;feed_with_atomPub_namespace&quot;
      assert_match %r{xml:lang=&quot;en-US&quot;}, @response.body
      assert_match %r{xmlns=&quot;http://www.w3.org/2005/Atom&quot;}, @response.body
      assert_match %r{xmlns:app=&quot;http://www.w3.org/2007/app&quot;}, @response.body
    end
  end

  def test_feed_should_allow_overriding_ids
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;feed_with_overridden_ids&quot;
      assert_select &quot;id&quot;, :text =&gt; &quot;tag:test.rubyonrails.org,2008:test/&quot;
      assert_select &quot;entry id&quot;, :text =&gt; &quot;tag:test.rubyonrails.org,2008:1&quot;
      assert_select &quot;entry id&quot;, :text =&gt; &quot;tag:test.rubyonrails.org,2008:2&quot;
    end
  end

  def test_feed_xml_processing_instructions
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; 'feed_with_xml_processing_instructions'
      assert_match %r{&lt;\?xml-stylesheet [^\?]*type=&quot;text/css&quot;}, @response.body
      assert_match %r{&lt;\?xml-stylesheet [^\?]*href=&quot;t.css&quot;}, @response.body
    end
  end

  def test_feed_xml_processing_instructions_duplicate_targets
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; 'feed_with_xml_processing_instructions_duplicate_targets'
      assert_match %r{&lt;\?target1 (a=&quot;1&quot; b=&quot;2&quot;|b=&quot;2&quot; a=&quot;1&quot;)\?&gt;}, @response.body
      assert_match %r{&lt;\?target1 (c=&quot;3&quot; d=&quot;4&quot;|d=&quot;4&quot; c=&quot;3&quot;)\?&gt;}, @response.body
    end
  end

  def test_feed_xhtml
    with_restful_routing(:scrolls) do
      get :index, :id =&gt; &quot;feed_with_xhtml_content&quot;
      assert_match %r{xmlns=&quot;http://www.w3.org/1999/xhtml&quot;}, @response.body
      assert_select &quot;summary div p&quot;, :text =&gt; &quot;Something Boring&quot;
      assert_select &quot;summary div p&quot;, :text =&gt; &quot;after 2&quot;
    end
  end
private
    def with_restful_routing(resources)
      with_routing do |set|
        set.draw do |map|
          map.resources(resources)
        end
        yield
      end
    end
end
</pre>
    </div>