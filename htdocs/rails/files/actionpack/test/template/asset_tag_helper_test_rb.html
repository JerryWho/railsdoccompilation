  <div id="fileHeader">
    <h1>asset_tag_helper_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/template/asset_tag_helper_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 19:55:10 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

class AssetTagHelperTest &lt; ActionView::TestCase
  tests ActionView::Helpers::AssetTagHelper

  def setup
    silence_warnings do
      ActionView::Helpers::AssetTagHelper.send(
        :const_set,
        :JAVASCRIPTS_DIR,
        File.dirname(__FILE__) + &quot;/../fixtures/public/javascripts&quot;
      )

      ActionView::Helpers::AssetTagHelper.send(
        :const_set,
        :STYLESHEETS_DIR,
        File.dirname(__FILE__) + &quot;/../fixtures/public/stylesheets&quot;
      )

      ActionView::Helpers::AssetTagHelper.send(
        :const_set,
        :ASSETS_DIR,
        File.dirname(__FILE__) + &quot;/../fixtures/public&quot;
      )
    end

    @controller = Class.new do
      attr_accessor :request
      def url_for(*args) &quot;http://www.example.com&quot; end
    end.new

    @request = Class.new do
      def protocol() 'http://' end
      def ssl?() false end
      def host_with_port() 'localhost' end
    end.new

    @controller.request = @request

    ActionView::Helpers::AssetTagHelper::reset_javascript_include_default
  end

  def teardown
    ActionController::Base.perform_caching = false
    ActionController::Base.asset_host = nil
    ENV.delete('RAILS_ASSET_ID')
  end

  AutoDiscoveryToTag = {
    %(auto_discovery_link_tag) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;alternate&quot; title=&quot;RSS&quot; type=&quot;application/rss+xml&quot; /&gt;),
    %(auto_discovery_link_tag(:rss)) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;alternate&quot; title=&quot;RSS&quot; type=&quot;application/rss+xml&quot; /&gt;),
    %(auto_discovery_link_tag(:atom)) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;alternate&quot; title=&quot;ATOM&quot; type=&quot;application/atom+xml&quot; /&gt;),
    %(auto_discovery_link_tag(:xml)) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;alternate&quot; title=&quot;XML&quot; type=&quot;application/xml&quot; /&gt;),
    %(auto_discovery_link_tag(:rss, :action =&gt; &quot;feed&quot;)) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;alternate&quot; title=&quot;RSS&quot; type=&quot;application/rss+xml&quot; /&gt;),
    %(auto_discovery_link_tag(:rss, &quot;http://localhost/feed&quot;)) =&gt; %(&lt;link href=&quot;http://localhost/feed&quot; rel=&quot;alternate&quot; title=&quot;RSS&quot; type=&quot;application/rss+xml&quot; /&gt;),
    %(auto_discovery_link_tag(:rss, {:action =&gt; &quot;feed&quot;}, {:title =&gt; &quot;My RSS&quot;})) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;alternate&quot; title=&quot;My RSS&quot; type=&quot;application/rss+xml&quot; /&gt;),
    %(auto_discovery_link_tag(:rss, {}, {:title =&gt; &quot;My RSS&quot;})) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;alternate&quot; title=&quot;My RSS&quot; type=&quot;application/rss+xml&quot; /&gt;),
    %(auto_discovery_link_tag(nil, {}, {:type =&gt; &quot;text/html&quot;})) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;alternate&quot; title=&quot;&quot; type=&quot;text/html&quot; /&gt;),
    %(auto_discovery_link_tag(nil, {}, {:title =&gt; &quot;No stream.. really&quot;, :type =&gt; &quot;text/html&quot;})) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;alternate&quot; title=&quot;No stream.. really&quot; type=&quot;text/html&quot; /&gt;),
    %(auto_discovery_link_tag(:rss, {}, {:title =&gt; &quot;My RSS&quot;, :type =&gt; &quot;text/html&quot;})) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;alternate&quot; title=&quot;My RSS&quot; type=&quot;text/html&quot; /&gt;),
    %(auto_discovery_link_tag(:atom, {}, {:rel =&gt; &quot;Not so alternate&quot;})) =&gt; %(&lt;link href=&quot;http://www.example.com&quot; rel=&quot;Not so alternate&quot; title=&quot;ATOM&quot; type=&quot;application/atom+xml&quot; /&gt;),
  }

  JavascriptPathToTag = {
    %(javascript_path(&quot;xmlhr&quot;)) =&gt; %(/javascripts/xmlhr.js),
    %(javascript_path(&quot;super/xmlhr&quot;)) =&gt; %(/javascripts/super/xmlhr.js),
    %(javascript_path(&quot;/super/xmlhr.js&quot;)) =&gt; %(/super/xmlhr.js)
  }

  PathToJavascriptToTag = {
    %(path_to_javascript(&quot;xmlhr&quot;)) =&gt; %(/javascripts/xmlhr.js),
    %(path_to_javascript(&quot;super/xmlhr&quot;)) =&gt; %(/javascripts/super/xmlhr.js),
    %(path_to_javascript(&quot;/super/xmlhr.js&quot;)) =&gt; %(/super/xmlhr.js)
  }

  JavascriptIncludeToTag = {
    %(javascript_include_tag(&quot;xmlhr&quot;)) =&gt; %(&lt;script src=&quot;/javascripts/xmlhr.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
    %(javascript_include_tag(&quot;xmlhr.js&quot;)) =&gt; %(&lt;script src=&quot;/javascripts/xmlhr.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
    %(javascript_include_tag(&quot;xmlhr&quot;, :lang =&gt; &quot;vbscript&quot;)) =&gt; %(&lt;script lang=&quot;vbscript&quot; src=&quot;/javascripts/xmlhr.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
    %(javascript_include_tag(&quot;common.javascript&quot;, &quot;/elsewhere/cools&quot;)) =&gt; %(&lt;script src=&quot;/javascripts/common.javascript&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/elsewhere/cools.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
    %(javascript_include_tag(:defaults)) =&gt; %(&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
    %(javascript_include_tag(:all)) =&gt; %(&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/bank.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/robber.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/version.1.0.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
    %(javascript_include_tag(:all, :recursive =&gt; true)) =&gt; %(&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/bank.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/robber.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/subdir/subdir.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/version.1.0.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
    %(javascript_include_tag(:defaults, &quot;test&quot;)) =&gt; %(&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/test.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
    %(javascript_include_tag(&quot;test&quot;, :defaults)) =&gt; %(&lt;script src=&quot;/javascripts/test.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;)
  }

  StylePathToTag = {
    %(stylesheet_path(&quot;style&quot;)) =&gt; %(/stylesheets/style.css),
    %(stylesheet_path(&quot;style.css&quot;)) =&gt; %(/stylesheets/style.css),
    %(stylesheet_path('dir/file')) =&gt; %(/stylesheets/dir/file.css),
    %(stylesheet_path('/dir/file.rcss')) =&gt; %(/dir/file.rcss)
  }

  PathToStyleToTag = {
    %(path_to_stylesheet(&quot;style&quot;)) =&gt; %(/stylesheets/style.css),
    %(path_to_stylesheet(&quot;style.css&quot;)) =&gt; %(/stylesheets/style.css),
    %(path_to_stylesheet('dir/file')) =&gt; %(/stylesheets/dir/file.css),
    %(path_to_stylesheet('/dir/file.rcss')) =&gt; %(/dir/file.rcss)
  }

  StyleLinkToTag = {
    %(stylesheet_link_tag(&quot;style&quot;)) =&gt; %(&lt;link href=&quot;/stylesheets/style.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
    %(stylesheet_link_tag(&quot;style.css&quot;)) =&gt; %(&lt;link href=&quot;/stylesheets/style.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
    %(stylesheet_link_tag(&quot;/dir/file&quot;)) =&gt; %(&lt;link href=&quot;/dir/file.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
    %(stylesheet_link_tag(&quot;dir/file&quot;)) =&gt; %(&lt;link href=&quot;/stylesheets/dir/file.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
    %(stylesheet_link_tag(&quot;style&quot;, :media =&gt; &quot;all&quot;)) =&gt; %(&lt;link href=&quot;/stylesheets/style.css&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
    %(stylesheet_link_tag(:all)) =&gt; %(&lt;link href=&quot;/stylesheets/bank.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/robber.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/version.1.0.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
    %(stylesheet_link_tag(:all, :recursive =&gt; true)) =&gt; %(&lt;link href=&quot;/stylesheets/bank.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/robber.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/subdir/subdir.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/version.1.0.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
    %(stylesheet_link_tag(:all, :media =&gt; &quot;all&quot;)) =&gt; %(&lt;link href=&quot;/stylesheets/bank.css&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/robber.css&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/version.1.0.css&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
    %(stylesheet_link_tag(&quot;random.styles&quot;, &quot;/css/stylish&quot;)) =&gt; %(&lt;link href=&quot;/stylesheets/random.styles&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/css/stylish.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
    %(stylesheet_link_tag(&quot;http://www.example.com/styles/style&quot;)) =&gt; %(&lt;link href=&quot;http://www.example.com/styles/style.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;)
  }

  ImagePathToTag = {
    %(image_path(&quot;xml&quot;))          =&gt; %(/images/xml),
    %(image_path(&quot;xml.png&quot;))      =&gt; %(/images/xml.png),
    %(image_path(&quot;dir/xml.png&quot;))  =&gt; %(/images/dir/xml.png),
    %(image_path(&quot;/dir/xml.png&quot;)) =&gt; %(/dir/xml.png)
  }

  PathToImageToTag = {
    %(path_to_image(&quot;xml&quot;))          =&gt; %(/images/xml),
    %(path_to_image(&quot;xml.png&quot;))      =&gt; %(/images/xml.png),
    %(path_to_image(&quot;dir/xml.png&quot;))  =&gt; %(/images/dir/xml.png),
    %(path_to_image(&quot;/dir/xml.png&quot;)) =&gt; %(/dir/xml.png)
  }

  ImageLinkToTag = {
    %(image_tag(&quot;xml.png&quot;)) =&gt; %(&lt;img alt=&quot;Xml&quot; src=&quot;/images/xml.png&quot; /&gt;),
    %(image_tag(&quot;..jpg&quot;)) =&gt; %(&lt;img alt=&quot;&quot; src=&quot;/images/..jpg&quot; /&gt;),
    %(image_tag(&quot;rss.gif&quot;, :alt =&gt; &quot;rss syndication&quot;)) =&gt; %(&lt;img alt=&quot;rss syndication&quot; src=&quot;/images/rss.gif&quot; /&gt;),
    %(image_tag(&quot;gold.png&quot;, :size =&gt; &quot;45x70&quot;)) =&gt; %(&lt;img alt=&quot;Gold&quot; height=&quot;70&quot; src=&quot;/images/gold.png&quot; width=&quot;45&quot; /&gt;),
    %(image_tag(&quot;gold.png&quot;, &quot;size&quot; =&gt; &quot;45x70&quot;)) =&gt; %(&lt;img alt=&quot;Gold&quot; height=&quot;70&quot; src=&quot;/images/gold.png&quot; width=&quot;45&quot; /&gt;),
    %(image_tag(&quot;error.png&quot;, &quot;size&quot; =&gt; &quot;45&quot;)) =&gt; %(&lt;img alt=&quot;Error&quot; src=&quot;/images/error.png&quot; /&gt;),
    %(image_tag(&quot;error.png&quot;, &quot;size&quot; =&gt; &quot;45 x 70&quot;)) =&gt; %(&lt;img alt=&quot;Error&quot; src=&quot;/images/error.png&quot; /&gt;),
    %(image_tag(&quot;error.png&quot;, &quot;size&quot; =&gt; &quot;x&quot;)) =&gt; %(&lt;img alt=&quot;Error&quot; src=&quot;/images/error.png&quot; /&gt;),
    %(image_tag(&quot;http://www.rubyonrails.com/images/rails.png&quot;)) =&gt; %(&lt;img alt=&quot;Rails&quot; src=&quot;http://www.rubyonrails.com/images/rails.png&quot; /&gt;),
    %(image_tag(&quot;http://www.rubyonrails.com/images/rails.png&quot;)) =&gt; %(&lt;img alt=&quot;Rails&quot; src=&quot;http://www.rubyonrails.com/images/rails.png&quot; /&gt;),
    %(image_tag(&quot;mouse.png&quot;, :mouseover =&gt; &quot;/images/mouse_over.png&quot;)) =&gt; %(&lt;img alt=&quot;Mouse&quot; onmouseover=&quot;this.src='/images/mouse_over.png'&quot; onmouseout=&quot;this.src='/images/mouse.png'&quot; src=&quot;/images/mouse.png&quot; /&gt;),
    %(image_tag(&quot;mouse.png&quot;, :mouseover =&gt; image_path(&quot;mouse_over.png&quot;))) =&gt; %(&lt;img alt=&quot;Mouse&quot; onmouseover=&quot;this.src='/images/mouse_over.png'&quot; onmouseout=&quot;this.src='/images/mouse.png'&quot; src=&quot;/images/mouse.png&quot; /&gt;)
  }


  def test_auto_discovery_link_tag
    AutoDiscoveryToTag.each { |method, tag| assert_dom_equal(tag, eval(method)) }
  end

  def test_javascript_path
    JavascriptPathToTag.each { |method, tag| assert_dom_equal(tag, eval(method)) }
  end

  def test_path_to_javascript_alias_for_javascript_path
    PathToJavascriptToTag.each { |method, tag| assert_dom_equal(tag, eval(method)) }
  end

  def test_javascript_include_tag_with_blank_asset_id
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    JavascriptIncludeToTag.each { |method, tag| assert_dom_equal(tag, eval(method)) }
  end

  def test_javascript_include_tag_with_given_asset_id
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;1&quot;
    assert_dom_equal(%(&lt;script src=&quot;/javascripts/prototype.js?1&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js?1&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js?1&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js?1&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js?1&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;), javascript_include_tag(:defaults))
  end

  def test_register_javascript_include_default
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionView::Helpers::AssetTagHelper::register_javascript_include_default 'slider'
    assert_dom_equal  %(&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/slider.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;), javascript_include_tag(:defaults)
  end

  def test_register_javascript_include_default_mixed_defaults
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionView::Helpers::AssetTagHelper::register_javascript_include_default 'slider'
    ActionView::Helpers::AssetTagHelper::register_javascript_include_default 'lib1', '/elsewhere/blub/lib2'
    assert_dom_equal  %(&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/slider.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/lib1.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/elsewhere/blub/lib2.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;), javascript_include_tag(:defaults)
  end

  def test_custom_javascript_expansions
    ActionView::Helpers::AssetTagHelper::register_javascript_expansion :monkey =&gt; [&quot;head&quot;, &quot;body&quot;, &quot;tail&quot;]
    assert_dom_equal  %(&lt;script src=&quot;/javascripts/first.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/head.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/body.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/tail.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/last.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;), javascript_include_tag('first', :monkey, 'last')
  end

  def test_custom_javascript_expansions_and_defaults_puts_application_js_at_the_end
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionView::Helpers::AssetTagHelper::register_javascript_expansion :monkey =&gt; [&quot;head&quot;, &quot;body&quot;, &quot;tail&quot;]
    assert_dom_equal  %(&lt;script src=&quot;/javascripts/first.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/head.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/body.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/tail.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/last.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;), javascript_include_tag('first', :defaults, :monkey, 'last')
  end

  def test_custom_javascript_expansions_with_undefined_symbol
    ActionView::Helpers::AssetTagHelper::register_javascript_expansion :monkey =&gt; nil
    assert_raise(ArgumentError) { javascript_include_tag('first', :monkey, 'last') }
  end

  def test_stylesheet_path
    StylePathToTag.each { |method, tag| assert_dom_equal(tag, eval(method)) }
  end

  def test_path_to_stylesheet_alias_for_stylesheet_path
    PathToStyleToTag.each { |method, tag| assert_dom_equal(tag, eval(method)) }
  end

  def test_stylesheet_link_tag
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    StyleLinkToTag.each { |method, tag| assert_dom_equal(tag, eval(method)) }
  end

  def test_custom_stylesheet_expansions
    ActionView::Helpers::AssetTagHelper::register_stylesheet_expansion :monkey =&gt; [&quot;head&quot;, &quot;body&quot;, &quot;tail&quot;]
    assert_dom_equal  %(&lt;link href=&quot;/stylesheets/first.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/head.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/body.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/tail.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/last.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;), stylesheet_link_tag('first', :monkey, 'last')
  end

  def test_custom_stylesheet_expansions_with_undefined_symbol
    ActionView::Helpers::AssetTagHelper::register_stylesheet_expansion :monkey =&gt; nil
    assert_raise(ArgumentError) { stylesheet_link_tag('first', :monkey, 'last') }
  end

  def test_image_path
    ImagePathToTag.each { |method, tag| assert_dom_equal(tag, eval(method)) }
  end

  def test_path_to_image_alias_for_image_path
    PathToImageToTag.each { |method, tag| assert_dom_equal(tag, eval(method)) }
  end

  def test_image_tag
    ImageLinkToTag.each { |method, tag| assert_dom_equal(tag, eval(method)) }
  end

  def test_image_tag_windows_behaviour
    old_asset_id, ENV[&quot;RAILS_ASSET_ID&quot;] = ENV[&quot;RAILS_ASSET_ID&quot;], &quot;1&quot;
    # This simulates the behaviour of File#exist? on windows when testing a file ending in &quot;.&quot;
    # If the file &quot;rails.png&quot; exists, windows will return true when asked if &quot;rails.png.&quot; exists (notice trailing &quot;.&quot;)
    # OS X, linux etc will return false in this case.
    File.stubs(:exist?).with('template/../fixtures/public/images/rails.png.').returns(true)
    assert_equal '&lt;img alt=&quot;Rails&quot; src=&quot;/images/rails.png?1&quot; /&gt;', image_tag('rails.png')
  ensure
    if old_asset_id
      ENV[&quot;RAILS_ASSET_ID&quot;] = old_asset_id
    else
      ENV.delete(&quot;RAILS_ASSET_ID&quot;)
    end
  end

  def test_timebased_asset_id
    expected_time = File.stat(File.expand_path(File.dirname(__FILE__) + &quot;/../fixtures/public/images/rails.png&quot;)).mtime.to_i.to_s
    assert_equal %(&lt;img alt=&quot;Rails&quot; src=&quot;/images/rails.png?#{expected_time}&quot; /&gt;), image_tag(&quot;rails.png&quot;)
  end

  def test_timebased_asset_id_with_relative_url_root
      ActionController::Base.relative_url_root = &quot;/collaboration/hieraki&quot;
      expected_time = File.stat(File.expand_path(File.dirname(__FILE__) + &quot;/../fixtures/public/images/rails.png&quot;)).mtime.to_i.to_s
      assert_equal %(&lt;img alt=&quot;Rails&quot; src=&quot;#{ActionController::Base.relative_url_root}/images/rails.png?#{expected_time}&quot; /&gt;), image_tag(&quot;rails.png&quot;)
    ensure
      ActionController::Base.relative_url_root = &quot;&quot;
  end
    
  def test_should_skip_asset_id_on_complete_url
    assert_equal %(&lt;img alt=&quot;Rails&quot; src=&quot;http://www.example.com/rails.png&quot; /&gt;), image_tag(&quot;http://www.example.com/rails.png&quot;)
  end

  def test_should_use_preset_asset_id
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;4500&quot;
    assert_equal %(&lt;img alt=&quot;Rails&quot; src=&quot;/images/rails.png?4500&quot; /&gt;), image_tag(&quot;rails.png&quot;)
  end

  def test_preset_empty_asset_id
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    assert_equal %(&lt;img alt=&quot;Rails&quot; src=&quot;/images/rails.png&quot; /&gt;), image_tag(&quot;rails.png&quot;)
  end

  def test_should_not_modify_source_string
    source = '/images/rails.png'
    copy = source.dup
    image_tag(source)
    assert_equal copy, source
  end

  def test_caching_image_path_with_caching_and_proc_asset_host_using_request
    ENV['RAILS_ASSET_ID'] = ''
    ActionController::Base.asset_host = Proc.new do |source, request|
      if request.ssl?
        &quot;#{request.protocol}#{request.host_with_port}&quot;
      else
        &quot;#{request.protocol}assets#{source.length}.example.com&quot;
      end
    end
    
    ActionController::Base.perform_caching = true


    @controller.request.stubs(:ssl?).returns(false)
    assert_equal &quot;http://assets15.example.com/images/xml.png&quot;, image_path(&quot;xml.png&quot;)

    @controller.request.stubs(:ssl?).returns(true)
    assert_equal &quot;http://localhost/images/xml.png&quot;, image_path(&quot;xml.png&quot;)
  end

  def test_caching_javascript_include_tag_when_caching_on
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionController::Base.asset_host = 'http://a0.example.com'
    ActionController::Base.perform_caching = true

    assert_dom_equal(
      %(&lt;script src=&quot;http://a0.example.com/javascripts/all.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; true)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'all.js'))

    assert_dom_equal(
      %(&lt;script src=&quot;http://a0.example.com/javascripts/money.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; &quot;money&quot;)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'money.js'))

    assert_dom_equal(
      %(&lt;script src=&quot;http://a0.example.com/absolute/test.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; &quot;/absolute/test&quot;)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::ASSETS_DIR, 'absolute', 'test.js'))

  ensure
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'all.js'))
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'money.js'))
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::ASSETS_DIR, 'absolute'))
  end

  def test_caching_javascript_include_tag_when_caching_on_with_proc_asset_host
    ENV['RAILS_ASSET_ID'] = ''
    ActionController::Base.asset_host = Proc.new { |source| &quot;http://a#{source.length}.example.com&quot; }
    ActionController::Base.perform_caching = true

    assert_equal '/javascripts/scripts.js'.length, 23
    assert_dom_equal(
      %(&lt;script src=&quot;http://a23.example.com/javascripts/scripts.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; 'scripts')
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'scripts.js'))

  ensure
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'scripts.js'))
  end

  def test_caching_javascript_include_tag_when_caching_on_with_2_argument_proc_asset_host
    ENV['RAILS_ASSET_ID'] = ''
    ActionController::Base.asset_host = Proc.new { |source, request|
      if request.ssl?
        &quot;#{request.protocol}#{request.host_with_port}&quot;
      else
        &quot;#{request.protocol}assets#{source.length}.example.com&quot;
      end
    }
    ActionController::Base.perform_caching = true

    assert_equal '/javascripts/vanilla.js'.length, 23
    assert_dom_equal(
      %(&lt;script src=&quot;http://assets23.example.com/javascripts/vanilla.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; 'vanilla')
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'vanilla.js'))

    class &lt;&lt; @controller.request
      def protocol() 'https://' end
      def ssl?() true end
    end

    assert_equal '/javascripts/secure.js'.length, 22
    assert_dom_equal(
      %(&lt;script src=&quot;https://localhost/javascripts/secure.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; 'secure')
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'secure.js'))

  ensure
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'vanilla.js'))
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'secure.js'))
  end

  def test_caching_javascript_include_tag_when_caching_on_with_2_argument_object_asset_host
    ENV['RAILS_ASSET_ID'] = ''
    ActionController::Base.asset_host = Class.new do
      def call(source, request)
        if request.ssl?
          &quot;#{request.protocol}#{request.host_with_port}&quot;
        else
          &quot;#{request.protocol}assets#{source.length}.example.com&quot;
        end
      end
    end.new

    ActionController::Base.perform_caching = true

    assert_equal '/javascripts/vanilla.js'.length, 23
    assert_dom_equal(
      %(&lt;script src=&quot;http://assets23.example.com/javascripts/vanilla.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; 'vanilla')
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'vanilla.js'))

    class &lt;&lt; @controller.request
      def protocol() 'https://' end
      def ssl?() true end
    end

    assert_equal '/javascripts/secure.js'.length, 22
    assert_dom_equal(
      %(&lt;script src=&quot;https://localhost/javascripts/secure.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; 'secure')
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'secure.js'))

  ensure
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'vanilla.js'))
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'secure.js'))
  end

  def test_caching_javascript_include_tag_when_caching_on_and_using_subdirectory
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionController::Base.asset_host = 'http://a%d.example.com'
    ActionController::Base.perform_caching = true

    hash = '/javascripts/cache/money.js'.hash % 4
    assert_dom_equal(
      %(&lt;script src=&quot;http://a#{hash}.example.com/javascripts/cache/money.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; &quot;cache/money&quot;)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'cache', 'money.js'))
  ensure
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'cache', 'money.js'))
  end

  def test_caching_javascript_include_tag_with_all_and_recursive_puts_defaults_at_the_start_of_the_file
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionController::Base.asset_host = 'http://a0.example.com'
    ActionController::Base.perform_caching = true

    assert_dom_equal(
      %(&lt;script src=&quot;http://a0.example.com/javascripts/combined.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; &quot;combined&quot;, :recursive =&gt; true)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'combined.js'))

    assert_equal(
      %(// prototype js\n\n// effects js\n\n// dragdrop js\n\n// controls js\n\n// application js\n\n// bank js\n\n// robber js\n\n// subdir js\n\n\n// version.1.0 js),
      IO.read(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'combined.js'))
    )

  ensure
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'combined.js'))
  end

  def test_caching_javascript_include_tag_with_all_puts_defaults_at_the_start_of_the_file
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionController::Base.asset_host = 'http://a0.example.com'
    ActionController::Base.perform_caching = true

    assert_dom_equal(
      %(&lt;script src=&quot;http://a0.example.com/javascripts/combined.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; &quot;combined&quot;)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'combined.js'))

    assert_equal(
      %(// prototype js\n\n// effects js\n\n// dragdrop js\n\n// controls js\n\n// application js\n\n// bank js\n\n// robber js\n\n// version.1.0 js),
      IO.read(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'combined.js'))
    )

  ensure
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'combined.js'))
  end

  def test_caching_javascript_include_tag_with_relative_url_root
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionController::Base.relative_url_root = &quot;/collaboration/hieraki&quot;
    ActionController::Base.perform_caching = true

    assert_dom_equal(
      %(&lt;script src=&quot;/collaboration/hieraki/javascripts/all.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; true)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'all.js'))

    assert_dom_equal(
      %(&lt;script src=&quot;/collaboration/hieraki/javascripts/money.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; &quot;money&quot;)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'money.js'))

  ensure
    ActionController::Base.relative_url_root = nil
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'all.js'))
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'money.js'))
  end

  def test_caching_javascript_include_tag_when_caching_off
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionController::Base.perform_caching = false

    assert_dom_equal(
      %(&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/bank.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/robber.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/version.1.0.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; true)
    )

    assert_dom_equal(
      %(&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/bank.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/robber.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/subdir/subdir.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/version.1.0.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; true, :recursive =&gt; true)
    )

    assert !File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'all.js'))

    assert_dom_equal(
      %(&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/bank.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/robber.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/version.1.0.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; &quot;money&quot;)
    )

    assert_dom_equal(
      %(&lt;script src=&quot;/javascripts/prototype.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/effects.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/dragdrop.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/controls.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/application.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/bank.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/robber.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/subdir/subdir.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/javascripts/version.1.0.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;),
      javascript_include_tag(:all, :cache =&gt; &quot;money&quot;, :recursive =&gt; true)
    )

    assert !File.exist?(File.join(ActionView::Helpers::AssetTagHelper::JAVASCRIPTS_DIR, 'money.js'))
  end

  def test_caching_stylesheet_link_tag_when_caching_on
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionController::Base.asset_host = 'http://a0.example.com'
    ActionController::Base.perform_caching = true

    assert_dom_equal(
      %(&lt;link href=&quot;http://a0.example.com/stylesheets/all.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :cache =&gt; true)
    )

    expected = Dir[&quot;#{ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR}/*.css&quot;].map { |p| File.mtime(p) }.max
    assert_equal expected, File.mtime(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'all.css'))

    assert_dom_equal(
      %(&lt;link href=&quot;http://a0.example.com/stylesheets/money.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :cache =&gt; &quot;money&quot;)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'money.css'))

    assert_dom_equal(
      %(&lt;link href=&quot;http://a0.example.com/absolute/test.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :cache =&gt; &quot;/absolute/test&quot;)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::ASSETS_DIR, 'absolute', 'test.css'))
  ensure
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'all.css'))
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'money.css'))
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::ASSETS_DIR, 'absolute'))
  end

  def test_concat_stylesheet_link_tag_when_caching_off
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;

    assert_dom_equal(
      %(&lt;link href=&quot;/stylesheets/all.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :concat =&gt; true)
    )

    expected = Dir[&quot;#{ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR}/*.css&quot;].map { |p| File.mtime(p) }.max
    assert_equal expected, File.mtime(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'all.css'))

    assert_dom_equal(
      %(&lt;link href=&quot;/stylesheets/money.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :concat =&gt; &quot;money&quot;)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'money.css'))

    assert_dom_equal(
      %(&lt;link href=&quot;/absolute/test.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :concat =&gt; &quot;/absolute/test&quot;)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::ASSETS_DIR, 'absolute', 'test.css'))
  ensure
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'all.css'))
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'money.css'))
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::ASSETS_DIR, 'absolute'))
  end

  def test_caching_stylesheet_link_tag_when_caching_on_with_proc_asset_host
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionController::Base.asset_host = Proc.new { |source| &quot;http://a#{source.length}.example.com&quot; }
    ActionController::Base.perform_caching = true

    assert_equal '/stylesheets/styles.css'.length, 23
    assert_dom_equal(
      %(&lt;link href=&quot;http://a23.example.com/stylesheets/styles.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :cache =&gt; 'styles')
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'styles.css'))

  ensure
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'styles.css'))
  end

  def test_caching_stylesheet_link_tag_with_relative_url_root
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionController::Base.relative_url_root = &quot;/collaboration/hieraki&quot;
    ActionController::Base.perform_caching = true

    assert_dom_equal(
      %(&lt;link href=&quot;/collaboration/hieraki/stylesheets/all.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :cache =&gt; true)
    )

    expected = Dir[&quot;#{ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR}/*.css&quot;].map { |p| File.mtime(p) }.max
    assert_equal expected, File.mtime(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'all.css'))

    assert_dom_equal(
      %(&lt;link href=&quot;/collaboration/hieraki/stylesheets/money.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :cache =&gt; &quot;money&quot;)
    )

    assert File.exist?(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'money.css'))
  ensure
    ActionController::Base.relative_url_root = nil
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'all.css'))
    FileUtils.rm_f(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'money.css'))
  end

  def test_caching_stylesheet_include_tag_when_caching_off
    ENV[&quot;RAILS_ASSET_ID&quot;] = &quot;&quot;
    ActionController::Base.perform_caching = false

    assert_dom_equal(
      %(&lt;link href=&quot;/stylesheets/bank.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/robber.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/version.1.0.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :cache =&gt; true)
    )

    assert_dom_equal(
      %(&lt;link href=&quot;/stylesheets/bank.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/robber.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/subdir/subdir.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/version.1.0.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :cache =&gt; true, :recursive =&gt; true)
    )

    assert !File.exist?(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'all.css'))

    assert_dom_equal(
      %(&lt;link href=&quot;/stylesheets/bank.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/robber.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/version.1.0.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :cache =&gt; &quot;money&quot;)
    )

    assert_dom_equal(
      %(&lt;link href=&quot;/stylesheets/bank.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/robber.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/subdir/subdir.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n&lt;link href=&quot;/stylesheets/version.1.0.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;),
      stylesheet_link_tag(:all, :cache =&gt; &quot;money&quot;, :recursive =&gt; true)
    )

    assert !File.exist?(File.join(ActionView::Helpers::AssetTagHelper::STYLESHEETS_DIR, 'money.css'))
  end
end

class AssetTagHelperNonVhostTest &lt; ActionView::TestCase
  tests ActionView::Helpers::AssetTagHelper

  def setup
    ActionController::Base.relative_url_root = &quot;/collaboration/hieraki&quot;

    @controller = Class.new do
      attr_accessor :request

      def url_for(options)
        &quot;http://www.example.com/collaboration/hieraki&quot;
      end
    end.new

    @request = Class.new do
      def protocol
        'gopher://'
      end
    end.new

    @controller.request = @request

    ActionView::Helpers::AssetTagHelper::reset_javascript_include_default
  end

  def teardown
    ActionController::Base.relative_url_root = nil
  end

  def test_should_compute_proper_path
    assert_dom_equal(%(&lt;link href=&quot;http://www.example.com/collaboration/hieraki&quot; rel=&quot;alternate&quot; title=&quot;RSS&quot; type=&quot;application/rss+xml&quot; /&gt;), auto_discovery_link_tag)
    assert_dom_equal(%(/collaboration/hieraki/javascripts/xmlhr.js), javascript_path(&quot;xmlhr&quot;))
    assert_dom_equal(%(/collaboration/hieraki/stylesheets/style.css), stylesheet_path(&quot;style&quot;))
    assert_dom_equal(%(/collaboration/hieraki/images/xml.png), image_path(&quot;xml.png&quot;))
    assert_dom_equal(%(&lt;img alt=&quot;Mouse&quot; onmouseover=&quot;this.src='/collaboration/hieraki/images/mouse_over.png'&quot; onmouseout=&quot;this.src='/collaboration/hieraki/images/mouse.png'&quot; src=&quot;/collaboration/hieraki/images/mouse.png&quot; /&gt;), image_tag(&quot;mouse.png&quot;, :mouseover =&gt; &quot;/images/mouse_over.png&quot;))
    assert_dom_equal(%(&lt;img alt=&quot;Mouse2&quot; onmouseover=&quot;this.src='/collaboration/hieraki/images/mouse_over2.png'&quot; onmouseout=&quot;this.src='/collaboration/hieraki/images/mouse2.png'&quot; src=&quot;/collaboration/hieraki/images/mouse2.png&quot; /&gt;), image_tag(&quot;mouse2.png&quot;, :mouseover =&gt; image_path(&quot;mouse_over2.png&quot;)))
  end

  def test_should_ignore_relative_root_path_on_complete_url
    assert_dom_equal(%(http://www.example.com/images/xml.png), image_path(&quot;http://www.example.com/images/xml.png&quot;))
  end

  def test_should_compute_proper_path_with_asset_host
    ActionController::Base.asset_host = &quot;http://assets.example.com&quot;
    assert_dom_equal(%(&lt;link href=&quot;http://www.example.com/collaboration/hieraki&quot; rel=&quot;alternate&quot; title=&quot;RSS&quot; type=&quot;application/rss+xml&quot; /&gt;), auto_discovery_link_tag)
    assert_dom_equal(%(http://assets.example.com/collaboration/hieraki/javascripts/xmlhr.js), javascript_path(&quot;xmlhr&quot;))
    assert_dom_equal(%(http://assets.example.com/collaboration/hieraki/stylesheets/style.css), stylesheet_path(&quot;style&quot;))
    assert_dom_equal(%(http://assets.example.com/collaboration/hieraki/images/xml.png), image_path(&quot;xml.png&quot;))
    assert_dom_equal(%(&lt;img alt=&quot;Mouse&quot; onmouseover=&quot;this.src='http://assets.example.com/collaboration/hieraki/images/mouse_over.png'&quot; onmouseout=&quot;this.src='http://assets.example.com/collaboration/hieraki/images/mouse.png'&quot; src=&quot;http://assets.example.com/collaboration/hieraki/images/mouse.png&quot; /&gt;), image_tag(&quot;mouse.png&quot;, :mouseover =&gt; &quot;/images/mouse_over.png&quot;))
    assert_dom_equal(%(&lt;img alt=&quot;Mouse2&quot; onmouseover=&quot;this.src='http://assets.example.com/collaboration/hieraki/images/mouse_over2.png'&quot; onmouseout=&quot;this.src='http://assets.example.com/collaboration/hieraki/images/mouse2.png'&quot; src=&quot;http://assets.example.com/collaboration/hieraki/images/mouse2.png&quot; /&gt;), image_tag(&quot;mouse2.png&quot;, :mouseover =&gt; image_path(&quot;mouse_over2.png&quot;)))
  ensure
    ActionController::Base.asset_host = &quot;&quot;
  end

  def test_should_ignore_asset_host_on_complete_url
    ActionController::Base.asset_host = &quot;http://assets.example.com&quot;
    assert_dom_equal(%(&lt;link href=&quot;http://bar.example.com/stylesheets/style.css&quot; media=&quot;screen&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;), stylesheet_link_tag(&quot;http://bar.example.com/stylesheets/style.css&quot;))
  ensure
    ActionController::Base.asset_host = &quot;&quot;
  end

  def test_should_wildcard_asset_host_between_zero_and_four
    ActionController::Base.asset_host = 'http://a%d.example.com'
    assert_match %r(http://a[0123].example.com/collaboration/hieraki/images/xml.png), image_path('xml.png')
  ensure
    ActionController::Base.asset_host = nil
  end

  def test_asset_host_without_protocol_should_use_request_protocol
    ActionController::Base.asset_host = 'a.example.com'
    assert_equal 'gopher://a.example.com/collaboration/hieraki/images/xml.png', image_path('xml.png')
  ensure
    ActionController::Base.asset_host = nil
  end

  def test_asset_host_without_protocol_should_use_request_protocol_even_if_path_present
    ActionController::Base.asset_host = 'a.example.com/files/go/here'
    assert_equal 'gopher://a.example.com/files/go/here/collaboration/hieraki/images/xml.png', image_path('xml.png')
  ensure
    ActionController::Base.asset_host = nil
  end

  def test_assert_css_and_js_of_the_same_name_return_correct_extension
    assert_dom_equal(%(/collaboration/hieraki/javascripts/foo.js), javascript_path(&quot;foo&quot;))
    assert_dom_equal(%(/collaboration/hieraki/stylesheets/foo.css), stylesheet_path(&quot;foo&quot;))

  end
end
</pre>
    </div>