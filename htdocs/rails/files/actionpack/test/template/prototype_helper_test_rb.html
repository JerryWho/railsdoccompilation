  <div id="fileHeader">
    <h1>prototype_helper_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/template/prototype_helper_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Nov 27 16:38:16 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

Bunny = Struct.new(:Bunny, :id)

class Author
  attr_reader :id
  def save; @id = 1 end
  def new_record?; @id.nil? end
  def name
    @id.nil? ? 'new author' : &quot;author ##{@id}&quot;
  end
end

class Article
  attr_reader :id
  attr_reader :author_id
  def save; @id = 1; @author_id = 1 end
  def new_record?; @id.nil? end
  def name
    @id.nil? ? 'new article' : &quot;article ##{@id}&quot;
  end
end

class Author::Nested &lt; Author; end


class PrototypeHelperBaseTest &lt; ActionView::TestCase
  attr_accessor :template_format, :output_buffer

  def setup
    @template = self
    @controller = Class.new do
      def url_for(options)
        if options.is_a?(String)
          options
        else
          url =  &quot;http://www.example.com/&quot;
          url &lt;&lt; options[:action].to_s if options and options[:action]
          url &lt;&lt; &quot;?a=#{options[:a]}&quot; if options &amp;&amp; options[:a]
          url &lt;&lt; &quot;&amp;b=#{options[:b]}&quot; if options &amp;&amp; options[:a] &amp;&amp; options[:b]
          url
        end
      end
    end.new
  end

  protected
    def request_forgery_protection_token
      nil
    end

    def protect_against_forgery?
      false
    end

    def create_generator
      block = Proc.new { |*args| yield *args if block_given? }
      JavaScriptGenerator.new self, &amp;block
    end
end

class PrototypeHelperTest &lt; PrototypeHelperBaseTest
  def setup
    @record = @author = Author.new
    @article = Article.new
    super
  end

  def test_link_to_remote
    assert_dom_equal %(&lt;a class=\&quot;fine\&quot; href=\&quot;#\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:true, evalScripts:true}); return false;\&quot;&gt;Remote outauthor&lt;/a&gt;),
      link_to_remote(&quot;Remote outauthor&quot;, { :url =&gt; { :action =&gt; &quot;whatnot&quot;  }}, { :class =&gt; &quot;fine&quot;  })
    assert_dom_equal %(&lt;a href=\&quot;#\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:true, evalScripts:true, onComplete:function(request){alert(request.responseText)}}); return false;\&quot;&gt;Remote outauthor&lt;/a&gt;),
      link_to_remote(&quot;Remote outauthor&quot;, :complete =&gt; &quot;alert(request.responseText)&quot;, :url =&gt; { :action =&gt; &quot;whatnot&quot;  })
    assert_dom_equal %(&lt;a href=\&quot;#\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:true, evalScripts:true, onSuccess:function(request){alert(request.responseText)}}); return false;\&quot;&gt;Remote outauthor&lt;/a&gt;),
      link_to_remote(&quot;Remote outauthor&quot;, :success =&gt; &quot;alert(request.responseText)&quot;, :url =&gt; { :action =&gt; &quot;whatnot&quot;  })
    assert_dom_equal %(&lt;a href=\&quot;#\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:true, evalScripts:true, onFailure:function(request){alert(request.responseText)}}); return false;\&quot;&gt;Remote outauthor&lt;/a&gt;),
      link_to_remote(&quot;Remote outauthor&quot;, :failure =&gt; &quot;alert(request.responseText)&quot;, :url =&gt; { :action =&gt; &quot;whatnot&quot;  })
    assert_dom_equal %(&lt;a href=\&quot;#\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot?a=10&amp;amp;b=20', {asynchronous:true, evalScripts:true, onFailure:function(request){alert(request.responseText)}}); return false;\&quot;&gt;Remote outauthor&lt;/a&gt;),
      link_to_remote(&quot;Remote outauthor&quot;, :failure =&gt; &quot;alert(request.responseText)&quot;, :url =&gt; { :action =&gt; &quot;whatnot&quot;, :a =&gt; '10', :b =&gt; '20' })
    assert_dom_equal %(&lt;a href=\&quot;#\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:false, evalScripts:true}); return false;\&quot;&gt;Remote outauthor&lt;/a&gt;),
      link_to_remote(&quot;Remote outauthor&quot;, :url =&gt; { :action =&gt; &quot;whatnot&quot; }, :type =&gt; :synchronous)
    assert_dom_equal %(&lt;a href=\&quot;#\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:true, evalScripts:true, insertion:'bottom'}); return false;\&quot;&gt;Remote outauthor&lt;/a&gt;),
      link_to_remote(&quot;Remote outauthor&quot;, :url =&gt; { :action =&gt; &quot;whatnot&quot; }, :position =&gt; :bottom)
  end

  def test_link_to_remote_html_options
    assert_dom_equal %(&lt;a class=\&quot;fine\&quot; href=\&quot;#\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:true, evalScripts:true}); return false;\&quot;&gt;Remote outauthor&lt;/a&gt;),
      link_to_remote(&quot;Remote outauthor&quot;, { :url =&gt; { :action =&gt; &quot;whatnot&quot;  }, :html =&gt; { :class =&gt; &quot;fine&quot; } })
  end

  def test_link_to_remote_url_quote_escaping
    assert_dom_equal %(&lt;a href=&quot;#&quot; onclick=&quot;new Ajax.Request('http://www.example.com/whatnot\\\'s', {asynchronous:true, evalScripts:true}); return false;&quot;&gt;Remote&lt;/a&gt;),
      link_to_remote(&quot;Remote&quot;, { :url =&gt; { :action =&gt; &quot;whatnot's&quot; } })
  end

  def test_button_to_remote
    assert_dom_equal %(&lt;input class=\&quot;fine\&quot; type=\&quot;button\&quot; value=\&quot;Remote outpost\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:true, evalScripts:true});\&quot; /&gt;),
      button_to_remote(&quot;Remote outpost&quot;, { :url =&gt; { :action =&gt; &quot;whatnot&quot;  }}, { :class =&gt; &quot;fine&quot;  })
    assert_dom_equal %(&lt;input type=\&quot;button\&quot; value=\&quot;Remote outpost\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:true, evalScripts:true, onComplete:function(request){alert(request.reponseText)}});\&quot; /&gt;),
      button_to_remote(&quot;Remote outpost&quot;, :complete =&gt; &quot;alert(request.reponseText)&quot;, :url =&gt; { :action =&gt; &quot;whatnot&quot;  })
    assert_dom_equal %(&lt;input type=\&quot;button\&quot; value=\&quot;Remote outpost\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:true, evalScripts:true, onSuccess:function(request){alert(request.reponseText)}});\&quot; /&gt;),
      button_to_remote(&quot;Remote outpost&quot;, :success =&gt; &quot;alert(request.reponseText)&quot;, :url =&gt; { :action =&gt; &quot;whatnot&quot;  })
    assert_dom_equal %(&lt;input type=\&quot;button\&quot; value=\&quot;Remote outpost\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot', {asynchronous:true, evalScripts:true, onFailure:function(request){alert(request.reponseText)}});\&quot; /&gt;),
      button_to_remote(&quot;Remote outpost&quot;, :failure =&gt; &quot;alert(request.reponseText)&quot;, :url =&gt; { :action =&gt; &quot;whatnot&quot;  })
    assert_dom_equal %(&lt;input type=\&quot;button\&quot; value=\&quot;Remote outpost\&quot; onclick=\&quot;new Ajax.Request('http://www.example.com/whatnot?a=10&amp;amp;b=20', {asynchronous:true, evalScripts:true, onFailure:function(request){alert(request.reponseText)}});\&quot; /&gt;),
      button_to_remote(&quot;Remote outpost&quot;, :failure =&gt; &quot;alert(request.reponseText)&quot;, :url =&gt; { :action =&gt; &quot;whatnot&quot;, :a =&gt; '10', :b =&gt; '20' })
  end

  def test_periodically_call_remote
    assert_dom_equal %(&lt;script type=&quot;text/javascript&quot;&gt;\n//&lt;![CDATA[\nnew PeriodicalExecuter(function() {new Ajax.Updater('schremser_bier', 'http://www.example.com/mehr_bier', {asynchronous:true, evalScripts:true})}, 10)\n//]]&gt;\n&lt;/script&gt;),
      periodically_call_remote(:update =&gt; &quot;schremser_bier&quot;, :url =&gt; { :action =&gt; &quot;mehr_bier&quot; })
  end

  def test_periodically_call_remote_with_frequency
    assert_dom_equal(
      &quot;&lt;script type=\&quot;text/javascript\&quot;&gt;\n//&lt;![CDATA[\nnew PeriodicalExecuter(function() {new Ajax.Request('http://www.example.com/', {asynchronous:true, evalScripts:true})}, 2)\n//]]&gt;\n&lt;/script&gt;&quot;,
      periodically_call_remote(:frequency =&gt; 2)
    )
  end

  def test_form_remote_tag
    assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater('glass_of_beer', 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;\&quot;&gt;),
      form_remote_tag(:update =&gt; &quot;glass_of_beer&quot;, :url =&gt; { :action =&gt; :fast  })
    assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater({success:'glass_of_beer'}, 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;\&quot;&gt;),
      form_remote_tag(:update =&gt; { :success =&gt; &quot;glass_of_beer&quot; }, :url =&gt; { :action =&gt; :fast  })
    assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater({failure:'glass_of_water'}, 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;\&quot;&gt;),
      form_remote_tag(:update =&gt; { :failure =&gt; &quot;glass_of_water&quot; }, :url =&gt; { :action =&gt; :fast  })
    assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater({success:'glass_of_beer',failure:'glass_of_water'}, 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;\&quot;&gt;),
      form_remote_tag(:update =&gt; { :success =&gt; 'glass_of_beer', :failure =&gt; &quot;glass_of_water&quot; }, :url =&gt; { :action =&gt; :fast  })
  end

  def test_form_remote_tag_with_method
    assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater('glass_of_beer', 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;\&quot;&gt;&lt;div style='margin:0;padding:0;display:inline'&gt;&lt;input name='_method' type='hidden' value='put' /&gt;&lt;/div&gt;),
      form_remote_tag(:update =&gt; &quot;glass_of_beer&quot;, :url =&gt; { :action =&gt; :fast  }, :html =&gt; { :method =&gt; :put })
  end

  def test_form_remote_tag_with_block_in_erb
    __in_erb_template = ''
    form_remote_tag(:update =&gt; &quot;glass_of_beer&quot;, :url =&gt; { :action =&gt; :fast  }) { concat &quot;Hello world!&quot; }
    assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater('glass_of_beer', 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;\&quot;&gt;Hello world!&lt;/form&gt;), output_buffer
  end

  def test_remote_form_for_with_record_identification_with_new_record
    remote_form_for(@record, {:html =&gt; { :id =&gt; 'create-author' }}) {}

    expected = %(&lt;form action='#{authors_path}' onsubmit=&quot;new Ajax.Request('#{authors_path}', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;&quot; class='new_author' id='create-author' method='post'&gt;&lt;/form&gt;)
    assert_dom_equal expected, output_buffer
  end

  def test_remote_form_for_with_record_identification_without_html_options
    remote_form_for(@record) {}

    expected = %(&lt;form action='#{authors_path}' onsubmit=&quot;new Ajax.Request('#{authors_path}', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;&quot; class='new_author' method='post' id='new_author'&gt;&lt;/form&gt;)
    assert_dom_equal expected, output_buffer
  end

  def test_remote_form_for_with_record_identification_with_existing_record
    @record.save
    remote_form_for(@record) {}

    expected = %(&lt;form action='#{author_path(@record)}' id='edit_author_1' method='post' onsubmit=&quot;new Ajax.Request('#{author_path(@record)}', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;&quot; class='edit_author'&gt;&lt;div style='margin:0;padding:0;display:inline'&gt;&lt;input name='_method' type='hidden' value='put' /&gt;&lt;/div&gt;&lt;/form&gt;)
    assert_dom_equal expected, output_buffer
  end

  def test_remote_form_for_with_new_object_in_list
    remote_form_for([@author, @article]) {}

    expected = %(&lt;form action='#{author_articles_path(@author)}' onsubmit=&quot;new Ajax.Request('#{author_articles_path(@author)}', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;&quot; class='new_article' method='post' id='new_article'&gt;&lt;/form&gt;)
    assert_dom_equal expected, output_buffer
  end

  def test_remote_form_for_with_existing_object_in_list
    @author.save
    @article.save
    remote_form_for([@author, @article]) {}

    expected = %(&lt;form action='#{author_article_path(@author, @article)}' id='edit_article_1' method='post' onsubmit=&quot;new Ajax.Request('#{author_article_path(@author, @article)}', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;&quot; class='edit_article'&gt;&lt;div style='margin:0;padding:0;display:inline'&gt;&lt;input name='_method' type='hidden' value='put' /&gt;&lt;/div&gt;&lt;/form&gt;)
    assert_dom_equal expected, output_buffer
  end

  def test_on_callbacks
    callbacks = [:uninitialized, :loading, :loaded, :interactive, :complete, :success, :failure]
    callbacks.each do |callback|
      assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater('glass_of_beer', 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, on#{callback.to_s.capitalize}:function(request){monkeys();}, parameters:Form.serialize(this)}); return false;&quot;&gt;),
        form_remote_tag(:update =&gt; &quot;glass_of_beer&quot;, :url =&gt; { :action =&gt; :fast  }, callback=&gt;&quot;monkeys();&quot;)
      assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater({success:'glass_of_beer'}, 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, on#{callback.to_s.capitalize}:function(request){monkeys();}, parameters:Form.serialize(this)}); return false;&quot;&gt;),
        form_remote_tag(:update =&gt; { :success =&gt; &quot;glass_of_beer&quot; }, :url =&gt; { :action =&gt; :fast  }, callback=&gt;&quot;monkeys();&quot;)
      assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater({failure:'glass_of_beer'}, 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, on#{callback.to_s.capitalize}:function(request){monkeys();}, parameters:Form.serialize(this)}); return false;&quot;&gt;),
        form_remote_tag(:update =&gt; { :failure =&gt; &quot;glass_of_beer&quot; }, :url =&gt; { :action =&gt; :fast  }, callback=&gt;&quot;monkeys();&quot;)
      assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater({success:'glass_of_beer',failure:'glass_of_water'}, 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, on#{callback.to_s.capitalize}:function(request){monkeys();}, parameters:Form.serialize(this)}); return false;&quot;&gt;),
        form_remote_tag(:update =&gt; { :success =&gt; &quot;glass_of_beer&quot;, :failure =&gt; &quot;glass_of_water&quot; }, :url =&gt; { :action =&gt; :fast  }, callback=&gt;&quot;monkeys();&quot;)
    end

    #HTTP status codes 200 up to 599 have callbacks
    #these should work
    100.upto(599) do |callback|
      assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater('glass_of_beer', 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, on#{callback.to_s.capitalize}:function(request){monkeys();}, parameters:Form.serialize(this)}); return false;&quot;&gt;),
        form_remote_tag(:update =&gt; &quot;glass_of_beer&quot;, :url =&gt; { :action =&gt; :fast  }, callback=&gt;&quot;monkeys();&quot;)
    end

    #test 200 and 404
    assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater('glass_of_beer', 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, on200:function(request){monkeys();}, on404:function(request){bananas();}, parameters:Form.serialize(this)}); return false;&quot;&gt;),
      form_remote_tag(:update =&gt; &quot;glass_of_beer&quot;, :url =&gt; { :action =&gt; :fast  }, 200=&gt;&quot;monkeys();&quot;, 404=&gt;&quot;bananas();&quot;)

    #these shouldn't
    1.upto(99) do |callback|
      assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater('glass_of_beer', 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;&quot;&gt;),
        form_remote_tag(:update =&gt; &quot;glass_of_beer&quot;, :url =&gt; { :action =&gt; :fast  }, callback=&gt;&quot;monkeys();&quot;)
    end
    600.upto(999) do |callback|
      assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater('glass_of_beer', 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;&quot;&gt;),
        form_remote_tag(:update =&gt; &quot;glass_of_beer&quot;, :url =&gt; { :action =&gt; :fast  }, callback=&gt;&quot;monkeys();&quot;)
    end

    #test ultimate combo
    assert_dom_equal %(&lt;form action=\&quot;http://www.example.com/fast\&quot; method=\&quot;post\&quot; onsubmit=\&quot;new Ajax.Updater('glass_of_beer', 'http://www.example.com/fast', {asynchronous:true, evalScripts:true, on200:function(request){monkeys();}, on404:function(request){bananas();}, onComplete:function(request){c();}, onFailure:function(request){f();}, onLoading:function(request){c1()}, onSuccess:function(request){s()}, parameters:Form.serialize(this)}); return false;\&quot;&gt;),
      form_remote_tag(:update =&gt; &quot;glass_of_beer&quot;, :url =&gt; { :action =&gt; :fast  }, :loading =&gt; &quot;c1()&quot;, :success =&gt; &quot;s()&quot;, :failure =&gt; &quot;f();&quot;, :complete =&gt; &quot;c();&quot;, 200=&gt;&quot;monkeys();&quot;, 404=&gt;&quot;bananas();&quot;)

  end

  def test_submit_to_remote
    assert_dom_equal %(&lt;input name=\&quot;More beer!\&quot; onclick=\&quot;new Ajax.Updater('empty_bottle', 'http://www.example.com/', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this.form)});\&quot; type=\&quot;button\&quot; value=\&quot;1000000\&quot; /&gt;),
      submit_to_remote(&quot;More beer!&quot;, 1_000_000, :update =&gt; &quot;empty_bottle&quot;)
  end

  def test_observe_field
    assert_dom_equal %(&lt;script type=\&quot;text/javascript\&quot;&gt;\n//&lt;![CDATA[\nnew Form.Element.Observer('glass', 300, function(element, value) {new Ajax.Request('http://www.example.com/reorder_if_empty', {asynchronous:true, evalScripts:true, parameters:value})})\n//]]&gt;\n&lt;/script&gt;),
      observe_field(&quot;glass&quot;, :frequency =&gt; 5.minutes, :url =&gt; { :action =&gt; &quot;reorder_if_empty&quot; })
  end

  def test_observe_field_using_with_option
    expected = %(&lt;script type=\&quot;text/javascript\&quot;&gt;\n//&lt;![CDATA[\nnew Form.Element.Observer('glass', 300, function(element, value) {new Ajax.Request('http://www.example.com/check_value', {asynchronous:true, evalScripts:true, parameters:'id=' + encodeURIComponent(value)})})\n//]]&gt;\n&lt;/script&gt;)
    assert_dom_equal expected, observe_field(&quot;glass&quot;, :frequency =&gt; 5.minutes, :url =&gt; { :action =&gt; &quot;check_value&quot; }, :with =&gt; 'id')
    assert_dom_equal expected, observe_field(&quot;glass&quot;, :frequency =&gt; 5.minutes, :url =&gt; { :action =&gt; &quot;check_value&quot; }, :with =&gt; &quot;'id=' + encodeURIComponent(value)&quot;)
  end

  def test_observe_field_using_json_in_with_option
    expected = %(&lt;script type=\&quot;text/javascript\&quot;&gt;\n//&lt;![CDATA[\nnew Form.Element.Observer('glass', 300, function(element, value) {new Ajax.Request('http://www.example.com/check_value', {asynchronous:true, evalScripts:true, parameters:{'id':value}})})\n//]]&gt;\n&lt;/script&gt;)
    assert_dom_equal expected, observe_field(&quot;glass&quot;, :frequency =&gt; 5.minutes, :url =&gt; { :action =&gt; &quot;check_value&quot; }, :with =&gt; &quot;{'id':value}&quot;)
  end

  def test_observe_field_using_function_for_callback
    assert_dom_equal %(&lt;script type=\&quot;text/javascript\&quot;&gt;\n//&lt;![CDATA[\nnew Form.Element.Observer('glass', 300, function(element, value) {alert('Element changed')})\n//]]&gt;\n&lt;/script&gt;),
      observe_field(&quot;glass&quot;, :frequency =&gt; 5.minutes, :function =&gt; &quot;alert('Element changed')&quot;)
  end

  def test_observe_form
    assert_dom_equal %(&lt;script type=\&quot;text/javascript\&quot;&gt;\n//&lt;![CDATA[\nnew Form.Observer('cart', 2, function(element, value) {new Ajax.Request('http://www.example.com/cart_changed', {asynchronous:true, evalScripts:true, parameters:value})})\n//]]&gt;\n&lt;/script&gt;),
      observe_form(&quot;cart&quot;, :frequency =&gt; 2, :url =&gt; { :action =&gt; &quot;cart_changed&quot; })
  end

  def test_observe_form_using_function_for_callback
    assert_dom_equal %(&lt;script type=\&quot;text/javascript\&quot;&gt;\n//&lt;![CDATA[\nnew Form.Observer('cart', 2, function(element, value) {alert('Form changed')})\n//]]&gt;\n&lt;/script&gt;),
      observe_form(&quot;cart&quot;, :frequency =&gt; 2, :function =&gt; &quot;alert('Form changed')&quot;)
  end

  def test_observe_field_without_frequency
    assert_dom_equal %(&lt;script type=\&quot;text/javascript\&quot;&gt;\n//&lt;![CDATA[\nnew Form.Element.EventObserver('glass', function(element, value) {new Ajax.Request('http://www.example.com/', {asynchronous:true, evalScripts:true, parameters:value})})\n//]]&gt;\n&lt;/script&gt;),
      observe_field(&quot;glass&quot;)
  end

  def test_update_page
    old_output_buffer = output_buffer

    block = Proc.new { |page| page.replace_html('foo', 'bar') }
    assert_equal create_generator(&amp;block).to_s, update_page(&amp;block)

    assert_equal old_output_buffer, output_buffer
  end

  def test_update_page_tag
    block = Proc.new { |page| page.replace_html('foo', 'bar') }
    assert_equal javascript_tag(create_generator(&amp;block).to_s), update_page_tag(&amp;block)
  end

  def test_update_page_tag_with_html_options
    block = Proc.new { |page| page.replace_html('foo', 'bar') }
    assert_equal javascript_tag(create_generator(&amp;block).to_s, {:defer =&gt; 'true'}), update_page_tag({:defer =&gt; 'true'}, &amp;block)
  end


  protected
    def author_path(record)
      &quot;/authors/#{record.id}&quot;
    end

    def authors_path
      &quot;/authors&quot;
    end

    def author_articles_path(author)
      &quot;/authors/#{author.id}/articles&quot;
    end

    def author_article_path(author, article)
      &quot;/authors/#{author.id}/articles/#{article.id}&quot;
    end
end

class JavaScriptGeneratorTest &lt; PrototypeHelperBaseTest
  def setup
    super
    @generator = create_generator
  end

  def test_insert_html_with_string
    assert_equal 'Element.insert(&quot;element&quot;, { top: &quot;\\u003Cp\\u003EThis is a test\\u003C/p\\u003E&quot; });',
      @generator.insert_html(:top, 'element', '&lt;p&gt;This is a test&lt;/p&gt;')
    assert_equal 'Element.insert(&quot;element&quot;, { bottom: &quot;\\u003Cp\u003EThis is a test\\u003C/p\u003E&quot; });',
      @generator.insert_html(:bottom, 'element', '&lt;p&gt;This is a test&lt;/p&gt;')
    assert_equal 'Element.insert(&quot;element&quot;, { before: &quot;\\u003Cp\u003EThis is a test\\u003C/p\u003E&quot; });',
      @generator.insert_html(:before, 'element', '&lt;p&gt;This is a test&lt;/p&gt;')
    assert_equal 'Element.insert(&quot;element&quot;, { after: &quot;\\u003Cp\u003EThis is a test\\u003C/p\u003E&quot; });',
      @generator.insert_html(:after, 'element', '&lt;p&gt;This is a test&lt;/p&gt;')
  end

  def test_replace_html_with_string
    assert_equal 'Element.update(&quot;element&quot;, &quot;\\u003Cp\\u003EThis is a test\\u003C/p\\u003E&quot;);',
      @generator.replace_html('element', '&lt;p&gt;This is a test&lt;/p&gt;')
  end

  def test_replace_element_with_string
    assert_equal 'Element.replace(&quot;element&quot;, &quot;\\u003Cdiv id=\&quot;element\&quot;\\u003E\\u003Cp\\u003EThis is a test\\u003C/p\\u003E\\u003C/div\\u003E&quot;);',
      @generator.replace('element', '&lt;div id=&quot;element&quot;&gt;&lt;p&gt;This is a test&lt;/p&gt;&lt;/div&gt;')
  end

  def test_remove
    assert_equal 'Element.remove(&quot;foo&quot;);',
      @generator.remove('foo')
    assert_equal '[&quot;foo&quot;,&quot;bar&quot;,&quot;baz&quot;].each(Element.remove);',
      @generator.remove('foo', 'bar', 'baz')
  end

  def test_show
    assert_equal 'Element.show(&quot;foo&quot;);',
      @generator.show('foo')
    assert_equal '[&quot;foo&quot;,&quot;bar&quot;,&quot;baz&quot;].each(Element.show);',
      @generator.show('foo', 'bar', 'baz')
  end

  def test_hide
    assert_equal 'Element.hide(&quot;foo&quot;);',
      @generator.hide('foo')
    assert_equal '[&quot;foo&quot;,&quot;bar&quot;,&quot;baz&quot;].each(Element.hide);',
      @generator.hide('foo', 'bar', 'baz')
  end

  def test_toggle
    assert_equal 'Element.toggle(&quot;foo&quot;);',
      @generator.toggle('foo')
    assert_equal '[&quot;foo&quot;,&quot;bar&quot;,&quot;baz&quot;].each(Element.toggle);',
      @generator.toggle('foo', 'bar', 'baz')
  end

  def test_alert
    assert_equal 'alert(&quot;hello&quot;);', @generator.alert('hello')
  end

  def test_redirect_to
    assert_equal 'window.location.href = &quot;http://www.example.com/welcome&quot;;',
      @generator.redirect_to(:action =&gt; 'welcome')
    assert_equal 'window.location.href = &quot;http://www.example.com/welcome?a=b&amp;c=d&quot;;',
      @generator.redirect_to(&quot;http://www.example.com/welcome?a=b&amp;c=d&quot;)
  end

  def test_reload
    assert_equal 'window.location.reload();',
      @generator.reload
  end

  def test_delay
    @generator.delay(20) do
      @generator.hide('foo')
    end

    assert_equal &quot;setTimeout(function() {\n;\nElement.hide(\&quot;foo\&quot;);\n}, 20000);&quot;, @generator.to_s
  end

  def test_to_s
    @generator.insert_html(:top, 'element', '&lt;p&gt;This is a test&lt;/p&gt;')
    @generator.insert_html(:bottom, 'element', '&lt;p&gt;This is a test&lt;/p&gt;')
    @generator.remove('foo', 'bar')
    @generator.replace_html('baz', '&lt;p&gt;This is a test&lt;/p&gt;')

    assert_equal &lt;&lt;-EOS.chomp, @generator.to_s
Element.insert(&quot;element&quot;, { top: &quot;\\u003Cp\\u003EThis is a test\\u003C/p\\u003E&quot; });
Element.insert(&quot;element&quot;, { bottom: &quot;\\u003Cp\\u003EThis is a test\\u003C/p\\u003E&quot; });
[&quot;foo&quot;,&quot;bar&quot;].each(Element.remove);
Element.update(&quot;baz&quot;, &quot;\\u003Cp\\u003EThis is a test\\u003C/p\\u003E&quot;);
    EOS
  end

  def test_element_access
    assert_equal %($(&quot;hello&quot;);), @generator['hello']
  end

  def test_element_access_on_records
    assert_equal %($(&quot;bunny_5&quot;);),   @generator[Bunny.new(:id =&gt; 5)]
    assert_equal %($(&quot;new_bunny&quot;);), @generator[Bunny.new]
  end

  def test_element_proxy_one_deep
    @generator['hello'].hide
    assert_equal %($(&quot;hello&quot;).hide();), @generator.to_s
  end

  def test_element_proxy_variable_access
    @generator['hello']['style']
    assert_equal %($(&quot;hello&quot;).style;), @generator.to_s
  end

  def test_element_proxy_variable_access_with_assignment
    @generator['hello']['style']['color'] = 'red'
    assert_equal %($(&quot;hello&quot;).style.color = &quot;red&quot;;), @generator.to_s
  end

  def test_element_proxy_assignment
    @generator['hello'].width = 400
    assert_equal %($(&quot;hello&quot;).width = 400;), @generator.to_s
  end

  def test_element_proxy_two_deep
    @generator['hello'].hide(&quot;first&quot;).clean_whitespace
    assert_equal %($(&quot;hello&quot;).hide(&quot;first&quot;).cleanWhitespace();), @generator.to_s
  end

  def test_select_access
    assert_equal %($$(&quot;div.hello&quot;);), @generator.select('div.hello')
  end

  def test_select_proxy_one_deep
    @generator.select('p.welcome b').first.hide
    assert_equal %($$(&quot;p.welcome b&quot;).first().hide();), @generator.to_s
  end

  def test_visual_effect
    assert_equal %(new Effect.Puff(&quot;blah&quot;,{});),
      @generator.visual_effect(:puff,'blah')
  end

  def test_visual_effect_toggle
    assert_equal %(Effect.toggle(&quot;blah&quot;,'appear',{});),
      @generator.visual_effect(:toggle_appear,'blah')
  end

  def test_sortable
    assert_equal %(Sortable.create(&quot;blah&quot;, {onUpdate:function(){new Ajax.Request('http://www.example.com/order', {asynchronous:true, evalScripts:true, parameters:Sortable.serialize(&quot;blah&quot;)})}});),
      @generator.sortable('blah', :url =&gt; { :action =&gt; &quot;order&quot; })
    assert_equal %(Sortable.create(&quot;blah&quot;, {onUpdate:function(){new Ajax.Request('http://www.example.com/order', {asynchronous:false, evalScripts:true, parameters:Sortable.serialize(&quot;blah&quot;)})}});),
      @generator.sortable('blah', :url =&gt; { :action =&gt; &quot;order&quot; }, :type =&gt; :synchronous)
  end

  def test_draggable
    assert_equal %(new Draggable(&quot;blah&quot;, {});),
      @generator.draggable('blah')
  end

  def test_drop_receiving
    assert_equal %(Droppables.add(&quot;blah&quot;, {onDrop:function(element){new Ajax.Request('http://www.example.com/order', {asynchronous:true, evalScripts:true, parameters:'id=' + encodeURIComponent(element.id)})}});),
      @generator.drop_receiving('blah', :url =&gt; { :action =&gt; &quot;order&quot; })
    assert_equal %(Droppables.add(&quot;blah&quot;, {onDrop:function(element){new Ajax.Request('http://www.example.com/order', {asynchronous:false, evalScripts:true, parameters:'id=' + encodeURIComponent(element.id)})}});),
      @generator.drop_receiving('blah', :url =&gt; { :action =&gt; &quot;order&quot; }, :type =&gt; :synchronous)
  end

  def test_collection_first_and_last
    @generator.select('p.welcome b').first.hide()
    @generator.select('p.welcome b').last.show()
    assert_equal &lt;&lt;-EOS.strip, @generator.to_s
$$(&quot;p.welcome b&quot;).first().hide();
$$(&quot;p.welcome b&quot;).last().show();
      EOS
  end

  def test_collection_proxy_with_each
    @generator.select('p.welcome b').each do |value|
      value.remove_class_name 'selected'
    end
    @generator.select('p.welcome b').each do |value, index|
      @generator.visual_effect :highlight, value
    end
    assert_equal &lt;&lt;-EOS.strip, @generator.to_s
$$(&quot;p.welcome b&quot;).each(function(value, index) {
value.removeClassName(&quot;selected&quot;);
});
$$(&quot;p.welcome b&quot;).each(function(value, index) {
new Effect.Highlight(value,{});
});
      EOS
  end

  def test_collection_proxy_on_collect
    @generator.select('p').collect('a') { |para| para.show }
    @generator.select('p').collect { |para| para.hide }
    assert_equal &lt;&lt;-EOS.strip, @generator.to_s
var a = $$(&quot;p&quot;).collect(function(value, index) {
return value.show();
});
$$(&quot;p&quot;).collect(function(value, index) {
return value.hide();
});
    EOS
    @generator = create_generator
  end

  def test_collection_proxy_with_grep
    @generator.select('p').grep 'a', /^a/ do |value|
      @generator &lt;&lt; '(value.className == &quot;welcome&quot;)'
    end
    @generator.select('p').grep 'b', /b$/ do |value, index|
      @generator.call 'alert', value
      @generator &lt;&lt; '(value.className == &quot;welcome&quot;)'
    end

    assert_equal &lt;&lt;-EOS.strip, @generator.to_s
var a = $$(&quot;p&quot;).grep(/^a/, function(value, index) {
return (value.className == &quot;welcome&quot;);
});
var b = $$(&quot;p&quot;).grep(/b$/, function(value, index) {
alert(value);
return (value.className == &quot;welcome&quot;);
});
    EOS
  end

  def test_collection_proxy_with_inject
    @generator.select('p').inject 'a', [] do |memo, value|
      @generator &lt;&lt; '(value.className == &quot;welcome&quot;)'
    end
    @generator.select('p').inject 'b', nil do |memo, value, index|
      @generator.call 'alert', memo
      @generator &lt;&lt; '(value.className == &quot;welcome&quot;)'
    end

    assert_equal &lt;&lt;-EOS.strip, @generator.to_s
var a = $$(&quot;p&quot;).inject([], function(memo, value, index) {
return (value.className == &quot;welcome&quot;);
});
var b = $$(&quot;p&quot;).inject(null, function(memo, value, index) {
alert(memo);
return (value.className == &quot;welcome&quot;);
});
    EOS
  end

  def test_collection_proxy_with_pluck
    @generator.select('p').pluck('a', 'className')
    assert_equal %(var a = $$(&quot;p&quot;).pluck(&quot;className&quot;);), @generator.to_s
  end

  def test_collection_proxy_with_zip
    ActionView::Helpers::JavaScriptCollectionProxy.new(@generator, '[1, 2, 3]').zip('a', [4, 5, 6], [7, 8, 9])
    ActionView::Helpers::JavaScriptCollectionProxy.new(@generator, '[1, 2, 3]').zip('b', [4, 5, 6], [7, 8, 9]) do |array|
      @generator.call 'array.reverse'
    end

    assert_equal &lt;&lt;-EOS.strip, @generator.to_s
var a = [1, 2, 3].zip([4,5,6], [7,8,9]);
var b = [1, 2, 3].zip([4,5,6], [7,8,9], function(array) {
return array.reverse();
});
    EOS
  end

  def test_collection_proxy_with_find_all
    @generator.select('p').find_all 'a' do |value, index|
      @generator &lt;&lt; '(value.className == &quot;welcome&quot;)'
    end

    assert_equal &lt;&lt;-EOS.strip, @generator.to_s
var a = $$(&quot;p&quot;).findAll(function(value, index) {
return (value.className == &quot;welcome&quot;);
});
    EOS
  end

  def test_collection_proxy_with_in_groups_of
    @generator.select('p').in_groups_of('a', 3)
    @generator.select('p').in_groups_of('a', 3, 'x')
    assert_equal &lt;&lt;-EOS.strip, @generator.to_s
var a = $$(&quot;p&quot;).inGroupsOf(3);
var a = $$(&quot;p&quot;).inGroupsOf(3, &quot;x&quot;);
    EOS
  end

  def test_collection_proxy_with_each_slice
    @generator.select('p').each_slice('a', 3)
    @generator.select('p').each_slice('a', 3) do |group, index|
      group.reverse
    end

    assert_equal &lt;&lt;-EOS.strip, @generator.to_s
var a = $$(&quot;p&quot;).eachSlice(3);
var a = $$(&quot;p&quot;).eachSlice(3, function(value, index) {
return value.reverse();
});
    EOS
  end

  def test_debug_rjs
    ActionView::Base.debug_rjs = true
    @generator['welcome'].replace_html 'Welcome'
    assert_equal &quot;try {\n$(\&quot;welcome\&quot;).update(\&quot;Welcome\&quot;);\n} catch (e) { alert('RJS error:\\n\\n' + e.toString()); alert('$(\\\&quot;welcome\\\&quot;).update(\\\&quot;Welcome\\\&quot;);'); throw e }&quot;, @generator.to_s
  ensure
    ActionView::Base.debug_rjs = false
  end

  def test_literal
    literal = @generator.literal(&quot;function() {}&quot;)
    assert_equal &quot;function() {}&quot;, ActiveSupport::JSON.encode(literal)
    assert_equal &quot;&quot;, @generator.to_s
  end

  def test_class_proxy
    @generator.form.focus('my_field')
    assert_equal &quot;Form.focus(\&quot;my_field\&quot;);&quot;, @generator.to_s
  end

  def test_call_with_block
    @generator.call(:before)
    @generator.call(:my_method) do |p|
      p[:one].show
      p[:two].hide
    end
    @generator.call(:in_between)
    @generator.call(:my_method_with_arguments, true, &quot;hello&quot;) do |p|
      p[:three].visual_effect(:highlight)
    end
    assert_equal &quot;before();\nmy_method(function() { $(\&quot;one\&quot;).show();\n$(\&quot;two\&quot;).hide(); });\nin_between();\nmy_method_with_arguments(true, \&quot;hello\&quot;, function() { $(\&quot;three\&quot;).visualEffect(\&quot;highlight\&quot;); });&quot;, @generator.to_s
  end

  def test_class_proxy_call_with_block
    @generator.my_object.my_method do |p|
      p[:one].show
      p[:two].hide
    end
    assert_equal &quot;MyObject.myMethod(function() { $(\&quot;one\&quot;).show();\n$(\&quot;two\&quot;).hide(); });&quot;, @generator.to_s
  end
end

</pre>
    </div>