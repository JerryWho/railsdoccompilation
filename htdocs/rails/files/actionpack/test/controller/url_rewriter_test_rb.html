  <div id="fileHeader">
    <h1>url_rewriter_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/url_rewriter_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:53 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

ActionController::UrlRewriter

class UrlRewriterTests &lt; ActionController::TestCase
  def setup
    @request = ActionController::TestRequest.new
    @params = {}
    @rewriter = ActionController::UrlRewriter.new(@request, @params)
  end

  def test_port
    assert_equal('http://test.host:1271/c/a/i',
      @rewriter.rewrite(:controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i', :port =&gt; 1271)
    )
  end

  def test_protocol_with_and_without_separator
    assert_equal('https://test.host/c/a/i',
      @rewriter.rewrite(:protocol =&gt; 'https', :controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i')
    )

    assert_equal('https://test.host/c/a/i',
      @rewriter.rewrite(:protocol =&gt; 'https://', :controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i')
    )
  end

  def test_user_name_and_password
    assert_equal(
      'http://david:secret@test.host/c/a/i',
      @rewriter.rewrite(:user =&gt; &quot;david&quot;, :password =&gt; &quot;secret&quot;, :controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i')
    )
  end

  def test_user_name_and_password_with_escape_codes
    assert_equal(
      'http://openid.aol.com%2Fnextangler:one+two%3F@test.host/c/a/i',
      @rewriter.rewrite(:user =&gt; &quot;openid.aol.com/nextangler&quot;, :password =&gt; &quot;one two?&quot;, :controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i')
    )
  end

  def test_anchor
    assert_equal(
      'http://test.host/c/a/i#anchor',
      @rewriter.rewrite(:controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i', :anchor =&gt; 'anchor')
    )
  end

  def test_anchor_should_call_to_param
    assert_equal(
      'http://test.host/c/a/i#anchor',
      @rewriter.rewrite(:controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i', :anchor =&gt; Struct.new(:to_param).new('anchor'))
    )
  end

  def test_anchor_should_be_cgi_escaped
    assert_equal(
      'http://test.host/c/a/i#anc%2Fhor',
      @rewriter.rewrite(:controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i', :anchor =&gt; Struct.new(:to_param).new('anc/hor'))
    )
  end

  def test_overwrite_params
    @params[:controller] = 'hi'
    @params[:action] = 'bye'
    @params[:id] = '2'

    assert_deprecated /overwrite_params/ do
      assert_equal '/hi/hi/2', @rewriter.rewrite(:only_path =&gt; true, :overwrite_params =&gt; {:action =&gt; 'hi'})
      u = @rewriter.rewrite(:only_path =&gt; false, :overwrite_params =&gt; {:action =&gt; 'hi'})
      assert_match %r(/hi/hi/2$), u
    end
  end

  def test_overwrite_removes_original
    @params[:controller] = 'search'
    @params[:action] = 'list'
    @params[:list_page] = 1

    assert_deprecated /overwrite_params/ do
      assert_equal '/search/list?list_page=2', @rewriter.rewrite(:only_path =&gt; true, :overwrite_params =&gt; {&quot;list_page&quot; =&gt; 2})
      u = @rewriter.rewrite(:only_path =&gt; false, :overwrite_params =&gt; {:list_page =&gt; 2})
      assert_equal 'http://test.host/search/list?list_page=2', u
    end
  end

  def test_to_str
    @params[:controller] = 'hi'
    @params[:action] = 'bye'
    @request.parameters[:id] = '2'

    assert_equal 'http://, test.host, /, hi, bye, {&quot;id&quot;=&gt;&quot;2&quot;}', @rewriter.to_str
  end

  def test_trailing_slash
    options = {:controller =&gt; 'foo', :action =&gt; 'bar', :id =&gt; '3', :only_path =&gt; true}
    assert_equal '/foo/bar/3', @rewriter.rewrite(options)
    assert_equal '/foo/bar/3?query=string', @rewriter.rewrite(options.merge({:query =&gt; 'string'}))
    options.update({:trailing_slash =&gt; true})
    assert_equal '/foo/bar/3/', @rewriter.rewrite(options)
    options.update({:query =&gt; 'string'})
    assert_equal '/foo/bar/3/?query=string', @rewriter.rewrite(options)
  end
end

class UrlWriterTests &lt; ActionController::TestCase
  class W
    include ActionController::UrlWriter
  end

  def teardown
    W.default_url_options.clear
  end

  def add_host!
    W.default_url_options[:host] = 'www.basecamphq.com'
  end

  def test_exception_is_thrown_without_host
    assert_raise RuntimeError do
      W.new.url_for :controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i'
    end
  end

  def test_anchor
    assert_equal('/c/a#anchor',
      W.new.url_for(:only_path =&gt; true, :controller =&gt; 'c', :action =&gt; 'a', :anchor =&gt; 'anchor')
    )
  end

  def test_anchor_should_call_to_param
    assert_equal('/c/a#anchor',
      W.new.url_for(:only_path =&gt; true, :controller =&gt; 'c', :action =&gt; 'a', :anchor =&gt; Struct.new(:to_param).new('anchor'))
    )
  end

  def test_anchor_should_be_cgi_escaped
    assert_equal('/c/a#anc%2Fhor',
      W.new.url_for(:only_path =&gt; true, :controller =&gt; 'c', :action =&gt; 'a', :anchor =&gt; Struct.new(:to_param).new('anc/hor'))
    )
  end

  def test_default_host
    add_host!
    assert_equal('http://www.basecamphq.com/c/a/i',
      W.new.url_for(:controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i')
    )
  end

  def test_host_may_be_overridden
    add_host!
    assert_equal('http://37signals.basecamphq.com/c/a/i',
      W.new.url_for(:host =&gt; '37signals.basecamphq.com', :controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i')
    )
  end

  def test_port
    add_host!
    assert_equal('http://www.basecamphq.com:3000/c/a/i',
      W.new.url_for(:controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i', :port =&gt; 3000)
    )
  end

  def test_protocol
    add_host!
    assert_equal('https://www.basecamphq.com/c/a/i',
      W.new.url_for(:controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i', :protocol =&gt; 'https')
    )
  end

  def test_protocol_with_and_without_separator
    add_host!
    assert_equal('https://www.basecamphq.com/c/a/i',
      W.new.url_for(:controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i', :protocol =&gt; 'https')
    )
    assert_equal('https://www.basecamphq.com/c/a/i',
      W.new.url_for(:controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i', :protocol =&gt; 'https://')
    )
  end

  def test_trailing_slash
    add_host!
    options = {:controller =&gt; 'foo', :trailing_slash =&gt; true, :action =&gt; 'bar', :id =&gt; '33'}
    assert_equal('http://www.basecamphq.com/foo/bar/33/', W.new.url_for(options) )
  end

  def test_trailing_slash_with_protocol
    add_host!
    options = { :trailing_slash =&gt; true,:protocol =&gt; 'https', :controller =&gt; 'foo', :action =&gt; 'bar', :id =&gt; '33'}
    assert_equal('https://www.basecamphq.com/foo/bar/33/', W.new.url_for(options) )
    assert_equal 'https://www.basecamphq.com/foo/bar/33/?query=string', W.new.url_for(options.merge({:query =&gt; 'string'}))
  end

  def test_trailing_slash_with_only_path
    options = {:controller =&gt; 'foo', :trailing_slash =&gt; true}
    assert_equal '/foo/', W.new.url_for(options.merge({:only_path =&gt; true}))
    options.update({:action =&gt; 'bar', :id =&gt; '33'})
    assert_equal '/foo/bar/33/', W.new.url_for(options.merge({:only_path =&gt; true}))
    assert_equal '/foo/bar/33/?query=string', W.new.url_for(options.merge({:query =&gt; 'string',:only_path =&gt; true}))
  end

  def test_trailing_slash_with_anchor
    options = {:trailing_slash =&gt; true, :controller =&gt; 'foo', :action =&gt; 'bar', :id =&gt; '33', :only_path =&gt; true, :anchor=&gt; 'chapter7'}
    assert_equal '/foo/bar/33/#chapter7', W.new.url_for(options)
    assert_equal '/foo/bar/33/?query=string#chapter7', W.new.url_for(options.merge({:query =&gt; 'string'}))
  end

  def test_trailing_slash_with_params
    url = W.new.url_for(:trailing_slash =&gt; true, :only_path =&gt; true, :controller =&gt; 'cont', :action =&gt; 'act', :p1 =&gt; 'cafe', :p2 =&gt; 'link')
    params = extract_params(url)
    assert_equal params[0], { :p1 =&gt; 'cafe' }.to_query
    assert_equal params[1], { :p2 =&gt; 'link' }.to_query
  end

  def test_relative_url_root_is_respected
    orig_relative_url_root = ActionController::Base.relative_url_root
    ActionController::Base.relative_url_root = '/subdir'

    add_host!
    assert_equal('https://www.basecamphq.com/subdir/c/a/i',
      W.new.url_for(:controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 'i', :protocol =&gt; 'https')
    )
  ensure
    ActionController::Base.relative_url_root = orig_relative_url_root
  end

  def test_named_routes
    ActionController::Routing::Routes.draw do |map|
      map.no_args '/this/is/verbose', :controller =&gt; 'home', :action =&gt; 'index'
      map.home '/home/sweet/home/:user', :controller =&gt; 'home', :action =&gt; 'index'
      map.connect ':controller/:action/:id'
    end

    # We need to create a new class in order to install the new named route.
    kls = Class.new { include ActionController::UrlWriter }
    controller = kls.new
    assert controller.respond_to?(:home_url)
    assert_equal 'http://www.basecamphq.com/home/sweet/home/again',
      controller.send(:home_url, :host =&gt; 'www.basecamphq.com', :user =&gt; 'again')

    assert_equal(&quot;/home/sweet/home/alabama&quot;, controller.send(:home_path, :user =&gt; 'alabama', :host =&gt; 'unused'))
    assert_equal(&quot;http://www.basecamphq.com/home/sweet/home/alabama&quot;, controller.send(:home_url, :user =&gt; 'alabama', :host =&gt; 'www.basecamphq.com'))
    assert_equal(&quot;http://www.basecamphq.com/this/is/verbose&quot;, controller.send(:no_args_url, :host=&gt;'www.basecamphq.com'))
  ensure
    ActionController::Routing::Routes.load!
  end

  def test_relative_url_root_is_respected_for_named_routes
    orig_relative_url_root = ActionController::Base.relative_url_root
    ActionController::Base.relative_url_root = '/subdir'

    ActionController::Routing::Routes.draw do |map|
      map.home '/home/sweet/home/:user', :controller =&gt; 'home', :action =&gt; 'index'
    end

    kls = Class.new { include ActionController::UrlWriter }
    controller = kls.new

    assert_equal 'http://www.basecamphq.com/subdir/home/sweet/home/again',
      controller.send(:home_url, :host =&gt; 'www.basecamphq.com', :user =&gt; 'again')
  ensure
    ActionController::Routing::Routes.load!
    ActionController::Base.relative_url_root = orig_relative_url_root
  end

  def test_only_path
    ActionController::Routing::Routes.draw do |map|
      map.home '/home/sweet/home/:user', :controller =&gt; 'home', :action =&gt; 'index'
      map.connect ':controller/:action/:id'
    end

    # We need to create a new class in order to install the new named route.
    kls = Class.new { include ActionController::UrlWriter }
    controller = kls.new
    assert controller.respond_to?(:home_url)
    assert_equal '/brave/new/world',
      controller.send(:url_for, :controller =&gt; 'brave', :action =&gt; 'new', :id =&gt; 'world', :only_path =&gt; true)

    assert_equal(&quot;/home/sweet/home/alabama&quot;, controller.send(:home_url, :user =&gt; 'alabama', :host =&gt; 'unused', :only_path =&gt; true))
    assert_equal(&quot;/home/sweet/home/alabama&quot;, controller.send(:home_path, 'alabama'))
  ensure
    ActionController::Routing::Routes.load!
  end

  def test_one_parameter
    assert_equal('/c/a?param=val',
      W.new.url_for(:only_path =&gt; true, :controller =&gt; 'c', :action =&gt; 'a', :param =&gt; 'val')
    )
  end

  def test_two_parameters
    url = W.new.url_for(:only_path =&gt; true, :controller =&gt; 'c', :action =&gt; 'a', :p1 =&gt; 'X1', :p2 =&gt; 'Y2')
    params = extract_params(url)
    assert_equal params[0], { :p1 =&gt; 'X1' }.to_query
    assert_equal params[1], { :p2 =&gt; 'Y2' }.to_query
  end

  def test_hash_parameter
    url = W.new.url_for(:only_path =&gt; true, :controller =&gt; 'c', :action =&gt; 'a', :query =&gt; {:name =&gt; 'Bob', :category =&gt; 'prof'})
    params = extract_params(url)
    assert_equal params[0], { 'query[category]' =&gt; 'prof' }.to_query
    assert_equal params[1], { 'query[name]'     =&gt; 'Bob'  }.to_query
  end

  def test_array_parameter
    url = W.new.url_for(:only_path =&gt; true, :controller =&gt; 'c', :action =&gt; 'a', :query =&gt; ['Bob', 'prof'])
    params = extract_params(url)
    assert_equal params[0], { 'query[]' =&gt; 'Bob'  }.to_query
    assert_equal params[1], { 'query[]' =&gt; 'prof' }.to_query
  end

  def test_hash_recursive_parameters
    url = W.new.url_for(:only_path =&gt; true, :controller =&gt; 'c', :action =&gt; 'a', :query =&gt; {:person =&gt; {:name =&gt; 'Bob', :position =&gt; 'prof'}, :hobby =&gt; 'piercing'})
    params = extract_params(url)
    assert_equal params[0], { 'query[hobby]'            =&gt; 'piercing' }.to_query
    assert_equal params[1], { 'query[person][name]'     =&gt; 'Bob'      }.to_query
    assert_equal params[2], { 'query[person][position]' =&gt; 'prof'     }.to_query
  end

  def test_hash_recursive_and_array_parameters
    url = W.new.url_for(:only_path =&gt; true, :controller =&gt; 'c', :action =&gt; 'a', :id =&gt; 101, :query =&gt; {:person =&gt; {:name =&gt; 'Bob', :position =&gt; ['prof', 'art director']}, :hobby =&gt; 'piercing'})
    assert_match %r(^/c/a/101), url
    params = extract_params(url)
    assert_equal params[0], { 'query[hobby]'              =&gt; 'piercing'     }.to_query
    assert_equal params[1], { 'query[person][name]'       =&gt; 'Bob'          }.to_query
    assert_equal params[2], { 'query[person][position][]' =&gt; 'prof'         }.to_query
    assert_equal params[3], { 'query[person][position][]' =&gt; 'art director' }.to_query
  end

  def test_path_generation_for_symbol_parameter_keys
    assert_generates(&quot;/image&quot;, :controller=&gt; :image)
  end

  def test_named_routes_with_nil_keys
    ActionController::Routing::Routes.clear!
    ActionController::Routing::Routes.draw do |map|
      map.main '', :controller =&gt; 'posts', :format =&gt; nil
      map.resources :posts
      map.connect ':controller/:action/:id'
    end
    # We need to create a new class in order to install the new named route.
    kls = Class.new { include ActionController::UrlWriter }
    kls.default_url_options[:host] = 'www.basecamphq.com'

    controller = kls.new
    params = {:action =&gt; :index, :controller =&gt; :posts, :format =&gt; :xml}
    assert_equal(&quot;http://www.basecamphq.com/posts.xml&quot;, controller.send(:url_for, params))
    params[:format] = nil
    assert_equal(&quot;http://www.basecamphq.com/&quot;, controller.send(:url_for, params))
  ensure
    ActionController::Routing::Routes.load!
  end

  def test_formatted_url_methods_are_deprecated
    ActionController::Routing::Routes.draw do |map|
      map.resources :posts
    end
    # We need to create a new class in order to install the new named route.
    kls = Class.new { include ActionController::UrlWriter }
    controller = kls.new
    params = {:id =&gt; 1, :format =&gt; :xml}
    assert_deprecated do
      assert_equal(&quot;/posts/1.xml&quot;, controller.send(:formatted_post_path, params))    
    end
    assert_deprecated do
      assert_equal(&quot;/posts/1.xml&quot;, controller.send(:formatted_post_path, 1, :xml))    
    end
  ensure
    ActionController::Routing::Routes.load!
  end

  def test_multiple_includes_maintain_distinct_options
    first_class = Class.new { include ActionController::UrlWriter }
    second_class = Class.new { include ActionController::UrlWriter }

    first_host, second_host = 'firsthost.com', 'secondhost.com'

    first_class.default_url_options[:host] = first_host
    second_class.default_url_options[:host] = second_host

    assert_equal first_class.default_url_options[:host], first_host
    assert_equal second_class.default_url_options[:host], second_host
  end

  private
    def extract_params(url)
      url.split('?', 2).last.split('&amp;')
    end
end
</pre>
    </div>