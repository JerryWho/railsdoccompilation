  <div id="fileHeader">
    <h1>base_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/base_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Nov 27 16:38:15 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'
require 'pp' # require 'pp' early to prevent hidden_methods from not picking up the pretty-print methods until too late

# Provide some controller to run the tests on.
module Submodule
  class ContainedEmptyController &lt; ActionController::Base
  end
  class ContainedNonEmptyController &lt; ActionController::Base
    def public_action
      render :nothing =&gt; true
    end
    
    hide_action :hidden_action
    def hidden_action
      raise &quot;Noooo!&quot;
    end
    
    def another_hidden_action
    end
    hide_action :another_hidden_action
  end
  class SubclassedController &lt; ContainedNonEmptyController
    hide_action :public_action # Hiding it here should not affect the superclass.
  end
end
class EmptyController &lt; ActionController::Base
end
class NonEmptyController &lt; ActionController::Base
  def public_action
  end
  
  hide_action :hidden_action
  def hidden_action
  end
end

class MethodMissingController &lt; ActionController::Base
  
  hide_action :shouldnt_be_called
  def shouldnt_be_called
    raise &quot;NO WAY!&quot;
  end
  
protected
  
  def method_missing(selector)
    render :text =&gt; selector.to_s
  end
  
end

class DefaultUrlOptionsController &lt; ActionController::Base
  def default_url_options_action
  end

  def default_url_options(options = nil)
    { :host =&gt; 'www.override.com', :action =&gt; 'new', :bacon =&gt; 'chunky' }
  end
end

class ControllerClassTests &lt; Test::Unit::TestCase
  def test_controller_path
    assert_equal 'empty', EmptyController.controller_path
    assert_equal EmptyController.controller_path, EmptyController.new.controller_path
    assert_equal 'submodule/contained_empty', Submodule::ContainedEmptyController.controller_path
    assert_equal Submodule::ContainedEmptyController.controller_path, Submodule::ContainedEmptyController.new.controller_path
  end
  def test_controller_name
    assert_equal 'empty', EmptyController.controller_name
    assert_equal 'contained_empty', Submodule::ContainedEmptyController.controller_name
 end
end

class ControllerInstanceTests &lt; Test::Unit::TestCase
  def setup
    @empty = EmptyController.new
    @contained = Submodule::ContainedEmptyController.new
    @empty_controllers = [@empty, @contained, Submodule::SubclassedController.new]
    
    @non_empty_controllers = [NonEmptyController.new,
                              Submodule::ContainedNonEmptyController.new]
  end

  def test_action_methods
    @empty_controllers.each do |c|
      hide_mocha_methods_from_controller(c)
      assert_equal Set.new, c.__send__(:action_methods), &quot;#{c.controller_path} should be empty!&quot;
    end
    @non_empty_controllers.each do |c|
      hide_mocha_methods_from_controller(c)
      assert_equal Set.new(%w(public_action)), c.__send__(:action_methods), &quot;#{c.controller_path} should not be empty!&quot;
    end
  end

  protected
    # Mocha adds some public instance methods to Object that would be
    # considered actions, so explicitly hide_action them.
    def hide_mocha_methods_from_controller(controller)
      mocha_methods = [
        :expects, :mocha, :mocha_inspect, :reset_mocha, :stubba_object,
        :stubba_method, :stubs, :verify, :__metaclass__, :__is_a__, :to_matcher,
      ]
      controller.class.__send__(:hide_action, *mocha_methods)
    end
end


class PerformActionTest &lt; ActionController::TestCase
  class MockLogger
    attr_reader :logged

    def initialize
      @logged = []
    end

    def method_missing(method, *args)
      @logged &lt;&lt; args.first
    end
  end

  def use_controller(controller_class)
    @controller = controller_class.new

    # enable a logger so that (e.g.) the benchmarking stuff runs, so we can get
    # a more accurate simulation of what happens in &quot;real life&quot;.
    @controller.logger = Logger.new(nil)

    @request    = ActionController::TestRequest.new
    @response   = ActionController::TestResponse.new

    @request.host = &quot;www.nextangle.com&quot;

    rescue_action_in_public!
  end
  
  def test_get_on_priv_should_show_selector
    use_controller MethodMissingController
    get :shouldnt_be_called
    assert_response :success
    assert_equal 'shouldnt_be_called', @response.body
  end
  
  def test_method_missing_is_not_an_action_name
    use_controller MethodMissingController
    assert ! @controller.__send__(:action_methods).include?('method_missing')
    
    get :method_missing
    assert_response :success
    assert_equal 'method_missing', @response.body
  end
  
  def test_get_on_hidden_should_fail
    use_controller NonEmptyController
    get :hidden_action
    assert_response 404
    
    get :another_hidden_action
    assert_response 404
  end

  def test_namespaced_action_should_log_module_name
    use_controller Submodule::ContainedNonEmptyController
    @controller.logger = MockLogger.new
    get :public_action
    assert_match /Processing\sSubmodule::ContainedNonEmptyController#public_action/, @controller.logger.logged[1]
  end
end

class DefaultUrlOptionsTest &lt; ActionController::TestCase
  tests DefaultUrlOptionsController

  def setup
    @request.host = 'www.example.com'
    rescue_action_in_public!
  end

  def test_default_url_options_are_used_if_set
    ActionController::Routing::Routes.draw do |map|
      map.default_url_options 'default_url_options', :controller =&gt; 'default_url_options'
      map.connect ':controller/:action/:id'
    end

    get :default_url_options_action # Make a dummy request so that the controller is initialized properly.

    assert_equal 'http://www.override.com/default_url_options/new?bacon=chunky', @controller.url_for(:controller =&gt; 'default_url_options')
    assert_equal 'http://www.override.com/default_url_options?bacon=chunky', @controller.send(:default_url_options_url)
  ensure
    ActionController::Routing::Routes.load!
  end
end

class EmptyUrlOptionsTest &lt; ActionController::TestCase
  tests NonEmptyController

  def setup
    @request.host = 'www.example.com'
    rescue_action_in_public!
  end

  def test_ensure_url_for_works_as_expected_when_called_with_no_options_if_default_url_options_is_not_set
    get :public_action
    assert_equal &quot;http://www.example.com/non_empty/public_action&quot;, @controller.url_for
  end
end

class EnsureNamedRoutesWorksTicket22BugTest &lt; Test::Unit::TestCase
  def test_named_routes_still_work
    ActionController::Routing::Routes.draw do |map|
      map.resources :things
    end
    EmptyController.send :include, ActionController::UrlWriter

    assert_equal '/things', EmptyController.new.send(:things_path)
  ensure
    ActionController::Routing::Routes.load!
  end
end
</pre>
    </div>