  <div id="fileHeader">
    <h1>webservice_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/webservice_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:53 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

class WebServiceTest &lt; ActionController::IntegrationTest
  class TestController &lt; ActionController::Base
    def assign_parameters
      if params[:full]
        render :text =&gt; dump_params_keys
      else
        render :text =&gt; (params.keys - ['controller', 'action']).sort.join(&quot;, &quot;)
      end
    end

    def dump_params_keys(hash = params)
      hash.keys.sort.inject(&quot;&quot;) do |s, k|
        value = hash[k]
        value = Hash === value ? &quot;(#{dump_params_keys(value)})&quot; : &quot;&quot;
        s &lt;&lt; &quot;, &quot; unless s.empty?
        s &lt;&lt; &quot;#{k}#{value}&quot;
      end
    end

    def rescue_action(e) raise end
  end

  def setup
    @controller = TestController.new
    @default_param_parsers = ActionController::Base.param_parsers.dup
  end

  def teardown
    ActionController::Base.param_parsers = @default_param_parsers
  end

  def test_check_parameters
    with_test_route_set do
      get &quot;/&quot;
      assert_equal '', @controller.response.body
    end
  end

  def test_post_xml
    with_test_route_set do
      post &quot;/&quot;, '&lt;entry attributed=&quot;true&quot;&gt;&lt;summary&gt;content...&lt;/summary&gt;&lt;/entry&gt;',
        {'CONTENT_TYPE' =&gt; 'application/xml'}

      assert_equal 'entry', @controller.response.body
      assert @controller.params.has_key?(:entry)
      assert_equal 'content...', @controller.params[&quot;entry&quot;]['summary']
      assert_equal 'true', @controller.params[&quot;entry&quot;]['attributed']
    end
  end

  def test_put_xml
    with_test_route_set do
      put &quot;/&quot;, '&lt;entry attributed=&quot;true&quot;&gt;&lt;summary&gt;content...&lt;/summary&gt;&lt;/entry&gt;',
        {'CONTENT_TYPE' =&gt; 'application/xml'}

      assert_equal 'entry', @controller.response.body
      assert @controller.params.has_key?(:entry)
      assert_equal 'content...', @controller.params[&quot;entry&quot;]['summary']
      assert_equal 'true', @controller.params[&quot;entry&quot;]['attributed']
    end
  end

  def test_put_xml_using_a_type_node
    with_test_route_set do
      put &quot;/&quot;, '&lt;type attributed=&quot;true&quot;&gt;&lt;summary&gt;content...&lt;/summary&gt;&lt;/type&gt;',
        {'CONTENT_TYPE' =&gt; 'application/xml'}

      assert_equal 'type', @controller.response.body
      assert @controller.params.has_key?(:type)
      assert_equal 'content...', @controller.params[&quot;type&quot;]['summary']
      assert_equal 'true', @controller.params[&quot;type&quot;]['attributed']
    end
  end

  def test_put_xml_using_a_type_node_and_attribute
    with_test_route_set do
      put &quot;/&quot;, '&lt;type attributed=&quot;true&quot;&gt;&lt;summary type=&quot;boolean&quot;&gt;false&lt;/summary&gt;&lt;/type&gt;',
        {'CONTENT_TYPE' =&gt; 'application/xml'}

      assert_equal 'type', @controller.response.body
      assert @controller.params.has_key?(:type)
      assert_equal false, @controller.params[&quot;type&quot;]['summary']
      assert_equal 'true', @controller.params[&quot;type&quot;]['attributed']
    end
  end

  def test_post_xml_using_a_type_node
    with_test_route_set do
      post &quot;/&quot;, '&lt;font attributed=&quot;true&quot;&gt;&lt;type&gt;arial&lt;/type&gt;&lt;/font&gt;',
        {'CONTENT_TYPE' =&gt; 'application/xml'}

      assert_equal 'font', @controller.response.body
      assert @controller.params.has_key?(:font)
      assert_equal 'arial', @controller.params['font']['type']
      assert_equal 'true', @controller.params[&quot;font&quot;]['attributed']
    end
  end

  def test_post_xml_using_a_root_node_named_type
    with_test_route_set do
      post &quot;/&quot;, '&lt;type type=&quot;integer&quot;&gt;33&lt;/type&gt;',
        {'CONTENT_TYPE' =&gt; 'application/xml'}

      assert @controller.params.has_key?(:type)
      assert_equal 33, @controller.params['type']
    end
  end

  def test_post_xml_using_an_attributted_node_named_type
    with_test_route_set do
      ActionController::Base.param_parsers[Mime::XML] = Proc.new { |data| Hash.from_xml(data)['request'].with_indifferent_access }
      post &quot;/&quot;, '&lt;request&gt;&lt;type type=&quot;string&quot;&gt;Arial,12&lt;/type&gt;&lt;z&gt;3&lt;/z&gt;&lt;/request&gt;',
        {'CONTENT_TYPE' =&gt; 'application/xml'}

      assert_equal 'type, z', @controller.response.body
      assert @controller.params.has_key?(:type)
      assert_equal 'Arial,12', @controller.params['type'], @controller.params.inspect
      assert_equal '3', @controller.params['z'], @controller.params.inspect
    end
  end

  def test_register_and_use_yaml
    with_test_route_set do
      ActionController::Base.param_parsers[Mime::YAML] = Proc.new { |d| YAML.load(d) }
      post &quot;/&quot;, {&quot;entry&quot; =&gt; &quot;loaded from yaml&quot;}.to_yaml,
        {'CONTENT_TYPE' =&gt; 'application/x-yaml'}

      assert_equal 'entry', @controller.response.body
      assert @controller.params.has_key?(:entry)
      assert_equal 'loaded from yaml', @controller.params[&quot;entry&quot;]
    end
  end

  def test_register_and_use_yaml_as_symbol
    with_test_route_set do
      ActionController::Base.param_parsers[Mime::YAML] = :yaml
      post &quot;/&quot;, {&quot;entry&quot; =&gt; &quot;loaded from yaml&quot;}.to_yaml,
        {'CONTENT_TYPE' =&gt; 'application/x-yaml'}

      assert_equal 'entry', @controller.response.body
      assert @controller.params.has_key?(:entry)
      assert_equal 'loaded from yaml', @controller.params[&quot;entry&quot;]
    end
  end

  def test_register_and_use_xml_simple
    with_test_route_set do
      ActionController::Base.param_parsers[Mime::XML] = Proc.new { |data| Hash.from_xml(data)['request'].with_indifferent_access }
      post &quot;/&quot;, '&lt;request&gt;&lt;summary&gt;content...&lt;/summary&gt;&lt;title&gt;SimpleXml&lt;/title&gt;&lt;/request&gt;',
        {'CONTENT_TYPE' =&gt; 'application/xml'}

      assert_equal 'summary, title', @controller.response.body
      assert @controller.params.has_key?(:summary)
      assert @controller.params.has_key?(:title)
      assert_equal 'content...', @controller.params[&quot;summary&quot;]
      assert_equal 'SimpleXml', @controller.params[&quot;title&quot;]
    end
  end

  def test_use_xml_ximple_with_empty_request
    with_test_route_set do
      ActionController::Base.param_parsers[Mime::XML] = :xml_simple
      assert_nothing_raised { post &quot;/&quot;, &quot;&quot;, {'CONTENT_TYPE' =&gt; 'application/xml'} }
      assert_equal &quot;&quot;, @controller.response.body
    end
  end

  def test_dasherized_keys_as_xml
    with_test_route_set do
      ActionController::Base.param_parsers[Mime::XML] = :xml_simple
      post &quot;/?full=1&quot;, &quot;&lt;first-key&gt;\n&lt;sub-key&gt;...&lt;/sub-key&gt;\n&lt;/first-key&gt;&quot;,
        {'CONTENT_TYPE' =&gt; 'application/xml'}
      assert_equal 'action, controller, first_key(sub_key), full', @controller.response.body
      assert_equal &quot;...&quot;, @controller.params[:first_key][:sub_key]
    end
  end

  def test_typecast_as_xml
    with_test_route_set do
      ActionController::Base.param_parsers[Mime::XML] = :xml_simple
      xml = &lt;&lt;-XML
        &lt;data&gt;
          &lt;a type=&quot;integer&quot;&gt;15&lt;/a&gt;
          &lt;b type=&quot;boolean&quot;&gt;false&lt;/b&gt;
          &lt;c type=&quot;boolean&quot;&gt;true&lt;/c&gt;
          &lt;d type=&quot;date&quot;&gt;2005-03-17&lt;/d&gt;
          &lt;e type=&quot;datetime&quot;&gt;2005-03-17T21:41:07Z&lt;/e&gt;
          &lt;f&gt;unparsed&lt;/f&gt;
          &lt;g type=&quot;integer&quot;&gt;1&lt;/g&gt;
          &lt;g&gt;hello&lt;/g&gt;
          &lt;g type=&quot;date&quot;&gt;1974-07-25&lt;/g&gt;
        &lt;/data&gt;
      XML
      post &quot;/&quot;, xml, {'CONTENT_TYPE' =&gt; 'application/xml'}

      params = @controller.params
      assert_equal 15, params[:data][:a]
      assert_equal false, params[:data][:b]
      assert_equal true, params[:data][:c]
      assert_equal Date.new(2005,3,17), params[:data][:d]
      assert_equal Time.utc(2005,3,17,21,41,7), params[:data][:e]
      assert_equal &quot;unparsed&quot;, params[:data][:f]
      assert_equal [1, &quot;hello&quot;, Date.new(1974,7,25)], params[:data][:g]
    end
  end

  def test_entities_unescaped_as_xml_simple
    with_test_route_set do
      ActionController::Base.param_parsers[Mime::XML] = :xml_simple
      xml = &lt;&lt;-XML
        &lt;data&gt;&amp;lt;foo &amp;quot;bar&amp;apos;s&amp;quot; &amp;amp; friends&amp;gt;&lt;/data&gt;
      XML
      post &quot;/&quot;, xml, {'CONTENT_TYPE' =&gt; 'application/xml'}
      assert_equal %(&lt;foo &quot;bar's&quot; &amp; friends&gt;), @controller.params[:data]
    end
  end

  def test_typecast_as_yaml
    with_test_route_set do
      ActionController::Base.param_parsers[Mime::YAML] = :yaml
      yaml = &lt;&lt;-YAML
        ---
        data:
          a: 15
          b: false
          c: true
          d: 2005-03-17
          e: 2005-03-17T21:41:07Z
          f: unparsed
          g:
            - 1
            - hello
            - 1974-07-25
      YAML
      post &quot;/&quot;, yaml, {'CONTENT_TYPE' =&gt; 'application/x-yaml'}
      params = @controller.params
      assert_equal 15, params[:data][:a]
      assert_equal false, params[:data][:b]
      assert_equal true, params[:data][:c]
      assert_equal Date.new(2005,3,17), params[:data][:d]
      assert_equal Time.utc(2005,3,17,21,41,7), params[:data][:e]
      assert_equal &quot;unparsed&quot;, params[:data][:f]
      assert_equal [1, &quot;hello&quot;, Date.new(1974,7,25)], params[:data][:g]
    end
  end

  private
    def with_test_route_set
      with_routing do |set|
        set.draw do |map|
          map.with_options :controller =&gt; &quot;web_service_test/test&quot; do |c|
            c.connect &quot;/&quot;, :action =&gt; &quot;assign_parameters&quot;
          end
        end
        yield
      end
    end
end
</pre>
    </div>