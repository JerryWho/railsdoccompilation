  <div id="fileHeader">
    <h1>rack_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/rack_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:53 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

class BaseRackTest &lt; ActiveSupport::TestCase
  def setup
    @env = {
      &quot;HTTP_MAX_FORWARDS&quot; =&gt; &quot;10&quot;,
      &quot;SERVER_NAME&quot; =&gt; &quot;glu.ttono.us&quot;,
      &quot;FCGI_ROLE&quot; =&gt; &quot;RESPONDER&quot;,
      &quot;AUTH_TYPE&quot; =&gt; &quot;Basic&quot;,
      &quot;HTTP_X_FORWARDED_HOST&quot; =&gt; &quot;glu.ttono.us&quot;,
      &quot;HTTP_ACCEPT_CHARSET&quot; =&gt; &quot;UTF-8&quot;,
      &quot;HTTP_ACCEPT_ENCODING&quot; =&gt; &quot;gzip, deflate&quot;,
      &quot;HTTP_CACHE_CONTROL&quot; =&gt; &quot;no-cache, max-age=0&quot;,
      &quot;HTTP_PRAGMA&quot; =&gt; &quot;no-cache&quot;,
      &quot;HTTP_USER_AGENT&quot; =&gt; &quot;Mozilla/5.0 (Macintosh; U; PPC Mac OS X; en)&quot;,
      &quot;PATH_INFO&quot; =&gt; &quot;/homepage/&quot;,
      &quot;HTTP_ACCEPT_LANGUAGE&quot; =&gt; &quot;en&quot;,
      &quot;HTTP_NEGOTIATE&quot; =&gt; &quot;trans&quot;,
      &quot;HTTP_HOST&quot; =&gt; &quot;glu.ttono.us:8007&quot;,
      &quot;HTTP_REFERER&quot; =&gt; &quot;http://www.google.com/search?q=glu.ttono.us&quot;,
      &quot;HTTP_FROM&quot; =&gt; &quot;googlebot&quot;,
      &quot;SERVER_PROTOCOL&quot; =&gt; &quot;HTTP/1.1&quot;,
      &quot;REDIRECT_URI&quot; =&gt; &quot;/dispatch.fcgi&quot;,
      &quot;SCRIPT_NAME&quot; =&gt; &quot;/dispatch.fcgi&quot;,
      &quot;SERVER_ADDR&quot; =&gt; &quot;207.7.108.53&quot;,
      &quot;REMOTE_ADDR&quot; =&gt; &quot;207.7.108.53&quot;,
      &quot;REMOTE_HOST&quot; =&gt; &quot;google.com&quot;,
      &quot;REMOTE_IDENT&quot; =&gt; &quot;kevin&quot;,
      &quot;REMOTE_USER&quot; =&gt; &quot;kevin&quot;,
      &quot;SERVER_SOFTWARE&quot; =&gt; &quot;lighttpd/1.4.5&quot;,
      &quot;HTTP_COOKIE&quot; =&gt; &quot;_session_id=c84ace84796670c052c6ceb2451fb0f2; is_admin=yes&quot;,
      &quot;HTTP_X_FORWARDED_SERVER&quot; =&gt; &quot;glu.ttono.us&quot;,
      &quot;REQUEST_URI&quot; =&gt; &quot;/admin&quot;,
      &quot;DOCUMENT_ROOT&quot; =&gt; &quot;/home/kevinc/sites/typo/public&quot;,
      &quot;PATH_TRANSLATED&quot; =&gt; &quot;/home/kevinc/sites/typo/public/homepage/&quot;,
      &quot;SERVER_PORT&quot; =&gt; &quot;8007&quot;,
      &quot;QUERY_STRING&quot; =&gt; &quot;&quot;,
      &quot;REMOTE_PORT&quot; =&gt; &quot;63137&quot;,
      &quot;GATEWAY_INTERFACE&quot; =&gt; &quot;CGI/1.1&quot;,
      &quot;HTTP_X_FORWARDED_FOR&quot; =&gt; &quot;65.88.180.234&quot;,
      &quot;HTTP_ACCEPT&quot; =&gt; &quot;*/*&quot;,
      &quot;SCRIPT_FILENAME&quot; =&gt; &quot;/home/kevinc/sites/typo/public/dispatch.fcgi&quot;,
      &quot;REDIRECT_STATUS&quot; =&gt; &quot;200&quot;,
      &quot;REQUEST_METHOD&quot; =&gt; &quot;GET&quot;
    }
    @request = ActionController::Request.new(@env)
    # some Nokia phone browsers omit the space after the semicolon separator.
    # some developers have grown accustomed to using comma in cookie values.
    @alt_cookie_fmt_request = ActionController::Request.new(@env.merge({&quot;HTTP_COOKIE&quot;=&gt;&quot;_session_id=c84ace847,96670c052c6ceb2451fb0f2;is_admin=yes&quot;}))
  end

  def default_test; end

  private

  def set_content_data(data)
    @request.env['REQUEST_METHOD'] = 'POST'
    @request.env['CONTENT_LENGTH'] = data.length
    @request.env['CONTENT_TYPE'] = 'application/x-www-form-urlencoded; charset=utf-8'
    @request.env['rack.input'] = StringIO.new(data)
  end
end

class RackRequestTest &lt; BaseRackTest
  def test_proxy_request
    assert_equal 'glu.ttono.us', @request.host_with_port
  end

  def test_http_host
    @env.delete &quot;HTTP_X_FORWARDED_HOST&quot;
    @env['HTTP_HOST'] = &quot;rubyonrails.org:8080&quot;
    assert_equal &quot;rubyonrails.org&quot;, @request.host
    assert_equal &quot;rubyonrails.org:8080&quot;, @request.host_with_port

    @env['HTTP_X_FORWARDED_HOST'] = &quot;www.firsthost.org, www.secondhost.org&quot;
    assert_equal &quot;www.secondhost.org&quot;, @request.host
  end

  def test_http_host_with_default_port_overrides_server_port
    @env.delete &quot;HTTP_X_FORWARDED_HOST&quot;
    @env['HTTP_HOST'] = &quot;rubyonrails.org&quot;
    assert_equal &quot;rubyonrails.org&quot;, @request.host_with_port
  end

  def test_host_with_port_defaults_to_server_name_if_no_host_headers
    @env.delete &quot;HTTP_X_FORWARDED_HOST&quot;
    @env.delete &quot;HTTP_HOST&quot;
    assert_equal &quot;glu.ttono.us:8007&quot;, @request.host_with_port
  end

  def test_host_with_port_falls_back_to_server_addr_if_necessary
    @env.delete &quot;HTTP_X_FORWARDED_HOST&quot;
    @env.delete &quot;HTTP_HOST&quot;
    @env.delete &quot;SERVER_NAME&quot;
    assert_equal &quot;207.7.108.53&quot;, @request.host
    assert_equal 8007, @request.port
    assert_equal &quot;207.7.108.53:8007&quot;, @request.host_with_port
  end

  def test_host_with_port_if_http_standard_port_is_specified
    @env['HTTP_X_FORWARDED_HOST'] = &quot;glu.ttono.us:80&quot;
    assert_equal &quot;glu.ttono.us&quot;, @request.host_with_port
  end

  def test_host_with_port_if_https_standard_port_is_specified
    @env['HTTP_X_FORWARDED_PROTO'] = &quot;https&quot;
    @env['HTTP_X_FORWARDED_HOST'] = &quot;glu.ttono.us:443&quot;
    assert_equal &quot;glu.ttono.us&quot;, @request.host_with_port
  end

  def test_host_if_ipv6_reference
    @env.delete &quot;HTTP_X_FORWARDED_HOST&quot;
    @env['HTTP_HOST'] = &quot;[2001:1234:5678:9abc:def0::dead:beef]&quot;
    assert_equal &quot;[2001:1234:5678:9abc:def0::dead:beef]&quot;, @request.host
  end

  def test_host_if_ipv6_reference_with_port
    @env.delete &quot;HTTP_X_FORWARDED_HOST&quot;
    @env['HTTP_HOST'] = &quot;[2001:1234:5678:9abc:def0::dead:beef]:8008&quot;
    assert_equal &quot;[2001:1234:5678:9abc:def0::dead:beef]&quot;, @request.host
  end

  def test_cgi_environment_variables
    assert_equal &quot;Basic&quot;, @request.auth_type
    assert_equal 0, @request.content_length
    assert_equal nil, @request.content_type
    assert_equal &quot;CGI/1.1&quot;, @request.gateway_interface
    assert_equal &quot;*/*&quot;, @request.accept
    assert_equal &quot;UTF-8&quot;, @request.accept_charset
    assert_equal &quot;gzip, deflate&quot;, @request.accept_encoding
    assert_equal &quot;en&quot;, @request.accept_language
    assert_equal &quot;no-cache, max-age=0&quot;, @request.cache_control
    assert_equal &quot;googlebot&quot;, @request.from
    assert_equal &quot;glu.ttono.us&quot;, @request.host
    assert_equal &quot;trans&quot;, @request.negotiate
    assert_equal &quot;no-cache&quot;, @request.pragma
    assert_equal &quot;http://www.google.com/search?q=glu.ttono.us&quot;, @request.referer
    assert_equal &quot;Mozilla/5.0 (Macintosh; U; PPC Mac OS X; en)&quot;, @request.user_agent
    assert_equal &quot;/homepage/&quot;, @request.path_info
    assert_equal &quot;/home/kevinc/sites/typo/public/homepage/&quot;, @request.path_translated
    assert_equal &quot;&quot;, @request.query_string
    assert_equal &quot;207.7.108.53&quot;, @request.remote_addr
    assert_equal &quot;google.com&quot;, @request.remote_host
    assert_equal &quot;kevin&quot;, @request.remote_ident
    assert_equal &quot;kevin&quot;, @request.remote_user
    assert_equal :get, @request.request_method
    assert_equal &quot;/dispatch.fcgi&quot;, @request.script_name
    assert_equal &quot;glu.ttono.us&quot;, @request.server_name
    assert_equal 8007, @request.server_port
    assert_equal &quot;HTTP/1.1&quot;, @request.server_protocol
    assert_equal &quot;lighttpd&quot;, @request.server_software
  end

  def test_cookie_syntax_resilience
    cookies = @request.cookies
    assert_equal &quot;c84ace84796670c052c6ceb2451fb0f2&quot;, cookies[&quot;_session_id&quot;], cookies.inspect
    assert_equal &quot;yes&quot;, cookies[&quot;is_admin&quot;], cookies.inspect

    alt_cookies = @alt_cookie_fmt_request.cookies
    #assert_equal &quot;c84ace847,96670c052c6ceb2451fb0f2&quot;, alt_cookies[&quot;_session_id&quot;], alt_cookies.inspect
    assert_equal &quot;yes&quot;, alt_cookies[&quot;is_admin&quot;], alt_cookies.inspect
  end
end

class RackRequestParamsParsingTest &lt; BaseRackTest
  def test_doesnt_break_when_content_type_has_charset
    set_content_data 'flamenco=love'

    assert_equal({&quot;flamenco&quot;=&gt; &quot;love&quot;}, @request.request_parameters)
  end

  def test_doesnt_interpret_request_uri_as_query_string_when_missing
    @request.env['REQUEST_URI'] = 'foo'
    assert_equal({}, @request.query_parameters)
  end
end

class RackRequestContentTypeTest &lt; BaseRackTest
  def test_html_content_type_verification
    @request.env['CONTENT_TYPE'] = Mime::HTML.to_s
    assert @request.content_type.verify_request?
  end

  def test_xml_content_type_verification
    @request.env['CONTENT_TYPE'] = Mime::XML.to_s
    assert !@request.content_type.verify_request?
  end
end

class RackRequestNeedsRewoundTest &lt; BaseRackTest
  def test_body_should_be_rewound
    data = 'foo'
    @env['rack.input'] = StringIO.new(data)
    @env['CONTENT_LENGTH'] = data.length
    @env['CONTENT_TYPE'] = 'application/x-www-form-urlencoded; charset=utf-8'

    # Read the request body by parsing params.
    request = ActionController::Request.new(@env)
    request.request_parameters

    # Should have rewound the body.
    assert_equal 0, request.body.pos
  end
end

class RackResponseTest &lt; BaseRackTest
  def setup
    super
    @response = ActionController::Response.new
  end

  def test_simple_output
    @response.body = &quot;Hello, World!&quot;
    @response.prepare!

    status, headers, body = @response.to_a
    assert_equal 200, status
    assert_equal({
      &quot;Content-Type&quot; =&gt; &quot;text/html; charset=utf-8&quot;,
      &quot;Cache-Control&quot; =&gt; &quot;private, max-age=0, must-revalidate&quot;,
      &quot;ETag&quot; =&gt; '&quot;65a8e27d8879283831b664bd8b7f0ad4&quot;',
      &quot;Content-Length&quot; =&gt; &quot;13&quot;
    }, headers)

    parts = []
    body.each { |part| parts &lt;&lt; part }
    assert_equal [&quot;Hello, World!&quot;], parts
  end

  def test_utf8_output
    @response.body = [1090, 1077, 1089, 1090].pack(&quot;U*&quot;)
    @response.prepare!

    status, headers, body = @response.to_a
    assert_equal 200, status
    assert_equal({
      &quot;Content-Type&quot; =&gt; &quot;text/html; charset=utf-8&quot;,
      &quot;Cache-Control&quot; =&gt; &quot;private, max-age=0, must-revalidate&quot;,
      &quot;ETag&quot; =&gt; '&quot;ebb5e89e8a94e9dd22abf5d915d112b2&quot;',
      &quot;Content-Length&quot; =&gt; &quot;8&quot;
    }, headers)
  end

  def test_streaming_block
    @response.body = Proc.new do |response, output|
      5.times { |n| output.write(n) }
    end
    @response.prepare!

    status, headers, body = @response.to_a
    assert_equal 200, status
    assert_equal({
      &quot;Content-Type&quot; =&gt; &quot;text/html; charset=utf-8&quot;,
      &quot;Cache-Control&quot; =&gt; &quot;no-cache&quot;
    }, headers)

    parts = []
    body.each { |part| parts &lt;&lt; part }
    assert_equal [&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;], parts
  end

  def test_streaming_block_with_flush_is_deprecated
    @response.body = Proc.new do |response, output|
      5.times do |n|
        output.write(n)
        output.flush
      end
    end

    assert_deprecated(/output.flush is no longer needed/) do
      @response.prepare!
      status, headers, body = @response.to_a

      parts = []
      body.each { |part| parts &lt;&lt; part }
    end
  end
end

class RackResponseHeadersTest &lt; BaseRackTest
  def setup
    super
    @response = ActionController::Response.new
    @response.status = &quot;200 OK&quot;
  end

  def test_content_type
    [204, 304].each do |c|
      @response.status = c.to_s
      assert !response_headers.has_key?(&quot;Content-Type&quot;), &quot;#{c} should not have Content-Type header&quot;
    end

    [200, 302, 404, 500].each do |c|
      @response.status = c.to_s
      assert response_headers.has_key?(&quot;Content-Type&quot;), &quot;#{c} did not have Content-Type header&quot;
    end
  end

  def test_status
    assert !response_headers.has_key?('Status')
  end

  private
    def response_headers
      @response.prepare!
      @response.to_a[1]
    end
end
</pre>
    </div>