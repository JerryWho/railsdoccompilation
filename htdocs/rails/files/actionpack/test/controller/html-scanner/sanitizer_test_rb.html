  <div id="fileHeader">
    <h1>sanitizer_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/html-scanner/sanitizer_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Nov 27 16:38:15 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

class SanitizerTest &lt; ActionController::TestCase
  def setup
    @sanitizer = nil # used by assert_sanitizer
  end

  def test_strip_tags
    sanitizer = HTML::FullSanitizer.new
    assert_equal(&quot;&lt;&lt;&lt;bad html&quot;, sanitizer.sanitize(&quot;&lt;&lt;&lt;bad html&quot;))
    assert_equal(&quot;&lt;&lt;&quot;, sanitizer.sanitize(&quot;&lt;&lt;&lt;bad html&gt;&quot;))
    assert_equal(&quot;Dont touch me&quot;, sanitizer.sanitize(&quot;Dont touch me&quot;))
    assert_equal(&quot;This is a test.&quot;, sanitizer.sanitize(&quot;&lt;p&gt;This &lt;u&gt;is&lt;u&gt; a &lt;a href='test.html'&gt;&lt;strong&gt;test&lt;/strong&gt;&lt;/a&gt;.&lt;/p&gt;&quot;))
    assert_equal(&quot;Weirdos&quot;, sanitizer.sanitize(&quot;Wei&lt;&lt;a&gt;a onclick='alert(document.cookie);'&lt;/a&gt;/&gt;rdos&quot;))
    assert_equal(&quot;This is a test.&quot;, sanitizer.sanitize(&quot;This is a test.&quot;))
    assert_equal(
    %{This is a test.\n\n\nIt no longer contains any HTML.\n}, sanitizer.sanitize(
    %{&lt;title&gt;This is &lt;b&gt;a &lt;a href=&quot;&quot; target=&quot;_blank&quot;&gt;test&lt;/a&gt;&lt;/b&gt;.&lt;/title&gt;\n\n&lt;!-- it has a comment --&gt;\n\n&lt;p&gt;It no &lt;b&gt;longer &lt;strong&gt;contains &lt;em&gt;any &lt;strike&gt;HTML&lt;/strike&gt;&lt;/em&gt;.&lt;/strong&gt;&lt;/b&gt;&lt;/p&gt;\n}))
    assert_equal &quot;This has a  here.&quot;, sanitizer.sanitize(&quot;This has a &lt;!-- comment --&gt; here.&quot;)
    assert_equal &quot;This has a  here.&quot;, sanitizer.sanitize(&quot;This has a &lt;![CDATA[&lt;section&gt;]]&gt; here.&quot;)
    assert_equal &quot;This has an unclosed &quot;, sanitizer.sanitize(&quot;This has an unclosed &lt;![CDATA[&lt;section&gt;]] here...&quot;)
    assert_equal &quot;non printable char is a tag&quot;, sanitizer.sanitize(&quot;&lt;\x07a href='/hello'&gt;non printable char is a tag&lt;/a&gt;&quot;)
    [nil, '', '   '].each { |blank| assert_equal blank, sanitizer.sanitize(blank) }
  end

  def test_strip_links
    sanitizer = HTML::LinkSanitizer.new
    assert_equal &quot;Dont touch me&quot;, sanitizer.sanitize(&quot;Dont touch me&quot;)    
    assert_equal &quot;on my mind\nall day long&quot;, sanitizer.sanitize(&quot;&lt;a href='almost'&gt;on my mind&lt;/a&gt;\n&lt;A href='almost'&gt;all day long&lt;/A&gt;&quot;)
    assert_equal &quot;0wn3d&quot;, sanitizer.sanitize(&quot;&lt;a href='http://www.rubyonrails.com/'&gt;&lt;a href='http://www.rubyonrails.com/' onlclick='steal()'&gt;0wn3d&lt;/a&gt;&lt;/a&gt;&quot;) 
    assert_equal &quot;Magic&quot;, sanitizer.sanitize(&quot;&lt;a href='http://www.rubyonrails.com/'&gt;Mag&lt;a href='http://www.ruby-lang.org/'&gt;ic&quot;) 
    assert_equal &quot;FrrFox&quot;, sanitizer.sanitize(&quot;&lt;href onlclick='steal()'&gt;FrrFox&lt;/a&gt;&lt;/href&gt;&quot;) 
    assert_equal &quot;My mind\nall &lt;b&gt;day&lt;/b&gt; long&quot;, sanitizer.sanitize(&quot;&lt;a href='almost'&gt;My mind&lt;/a&gt;\n&lt;A href='almost'&gt;all &lt;b&gt;day&lt;/b&gt; long&lt;/A&gt;&quot;)
    assert_equal &quot;all &lt;b&gt;day&lt;/b&gt; long&quot;, sanitizer.sanitize(&quot;&lt;&lt;a&gt;a href='hello'&gt;all &lt;b&gt;day&lt;/b&gt; long&lt;&lt;/A&gt;/a&gt;&quot;)

    assert_equal &quot;&lt;a&lt;a&quot;, sanitizer.sanitize(&quot;&lt;a&lt;a&quot;)
  end

  def test_sanitize_form
    assert_sanitized &quot;&lt;form action=\&quot;/foo/bar\&quot; method=\&quot;post\&quot;&gt;&lt;input&gt;&lt;/form&gt;&quot;, ''
  end

  def test_sanitize_plaintext
    raw = &quot;&lt;plaintext&gt;&lt;span&gt;foo&lt;/span&gt;&lt;/plaintext&gt;&quot;
    assert_sanitized raw, &quot;&lt;span&gt;foo&lt;/span&gt;&quot;
  end

  def test_sanitize_script
    assert_sanitized &quot;a b c&lt;script language=\&quot;Javascript\&quot;&gt;blah blah blah&lt;/script&gt;d e f&quot;, &quot;a b cd e f&quot;
  end

  # fucked
  def test_sanitize_js_handlers
    raw = %{onthis=&quot;do that&quot; &lt;a href=&quot;#&quot; onclick=&quot;hello&quot; name=&quot;foo&quot; onbogus=&quot;remove me&quot;&gt;hello&lt;/a&gt;}
    assert_sanitized raw, %{onthis=&quot;do that&quot; &lt;a name=&quot;foo&quot; href=&quot;#&quot;&gt;hello&lt;/a&gt;}
  end

  def test_sanitize_javascript_href
    raw = %{href=&quot;javascript:bang&quot; &lt;a href=&quot;javascript:bang&quot; name=&quot;hello&quot;&gt;foo&lt;/a&gt;, &lt;span href=&quot;javascript:bang&quot;&gt;bar&lt;/span&gt;}
    assert_sanitized raw, %{href=&quot;javascript:bang&quot; &lt;a name=&quot;hello&quot;&gt;foo&lt;/a&gt;, &lt;span&gt;bar&lt;/span&gt;}
  end
  
  def test_sanitize_image_src
    raw = %{src=&quot;javascript:bang&quot; &lt;img src=&quot;javascript:bang&quot; width=&quot;5&quot;&gt;foo&lt;/img&gt;, &lt;span src=&quot;javascript:bang&quot;&gt;bar&lt;/span&gt;}
    assert_sanitized raw, %{src=&quot;javascript:bang&quot; &lt;img width=&quot;5&quot;&gt;foo&lt;/img&gt;, &lt;span&gt;bar&lt;/span&gt;}
  end

  HTML::WhiteListSanitizer.allowed_tags.each do |tag_name|
    define_method &quot;test_should_allow_#{tag_name}_tag&quot; do
      assert_sanitized &quot;start &lt;#{tag_name} title=\&quot;1\&quot; onclick=\&quot;foo\&quot;&gt;foo &lt;bad&gt;bar&lt;/bad&gt; baz&lt;/#{tag_name}&gt; end&quot;, %(start &lt;#{tag_name} title=&quot;1&quot;&gt;foo bar baz&lt;/#{tag_name}&gt; end)
    end
  end

  def test_should_allow_anchors
    assert_sanitized %(&lt;a href=&quot;foo&quot; onclick=&quot;bar&quot;&gt;&lt;script&gt;baz&lt;/script&gt;&lt;/a&gt;), %(&lt;a href=&quot;foo&quot;&gt;&lt;/a&gt;)
  end

  # RFC 3986, sec 4.2
  def test_allow_colons_in_path_component
    assert_sanitized(&quot;&lt;a href=\&quot;./this:that\&quot;&gt;foo&lt;/a&gt;&quot;)
  end

  %w(src width height alt).each do |img_attr|
    define_method &quot;test_should_allow_image_#{img_attr}_attribute&quot; do
      assert_sanitized %(&lt;img #{img_attr}=&quot;foo&quot; onclick=&quot;bar&quot; /&gt;), %(&lt;img #{img_attr}=&quot;foo&quot; /&gt;)
    end
  end

  def test_should_handle_non_html
    assert_sanitized 'abc'
  end

  def test_should_handle_blank_text
    assert_sanitized nil
    assert_sanitized ''
  end

  def test_should_allow_custom_tags
    text = &quot;&lt;u&gt;foo&lt;/u&gt;&quot;
    sanitizer = HTML::WhiteListSanitizer.new
    assert_equal(text, sanitizer.sanitize(text, :tags =&gt; %w(u)))
  end

  def test_should_allow_only_custom_tags
    text = &quot;&lt;u&gt;foo&lt;/u&gt; with &lt;i&gt;bar&lt;/i&gt;&quot;
    sanitizer = HTML::WhiteListSanitizer.new
    assert_equal(&quot;&lt;u&gt;foo&lt;/u&gt; with bar&quot;, sanitizer.sanitize(text, :tags =&gt; %w(u)))
  end

  def test_should_allow_custom_tags_with_attributes
    text = %(&lt;blockquote cite=&quot;http://example.com/&quot;&gt;foo&lt;/blockquote&gt;)
    sanitizer = HTML::WhiteListSanitizer.new
    assert_equal(text, sanitizer.sanitize(text))
  end

  def test_should_allow_custom_tags_with_custom_attributes
    text = %(&lt;blockquote foo=&quot;bar&quot;&gt;Lorem ipsum&lt;/blockquote&gt;)
    sanitizer = HTML::WhiteListSanitizer.new
    assert_equal(text, sanitizer.sanitize(text, :attributes =&gt; ['foo']))
  end

  [%w(img src), %w(a href)].each do |(tag, attr)|
    define_method &quot;test_should_strip_#{attr}_attribute_in_#{tag}_with_bad_protocols&quot; do
      assert_sanitized %(&lt;#{tag} #{attr}=&quot;javascript:bang&quot; title=&quot;1&quot;&gt;boo&lt;/#{tag}&gt;), %(&lt;#{tag} title=&quot;1&quot;&gt;boo&lt;/#{tag}&gt;)
    end
  end

  def test_should_flag_bad_protocols
    sanitizer = HTML::WhiteListSanitizer.new
    %w(about chrome data disk hcp help javascript livescript lynxcgi lynxexec ms-help ms-its mhtml mocha opera res resource shell vbscript view-source vnd.ms.radio wysiwyg).each do |proto|
      assert sanitizer.send(:contains_bad_protocols?, 'src', &quot;#{proto}://bad&quot;)
    end
  end

  def test_should_accept_good_protocols
    sanitizer = HTML::WhiteListSanitizer.new
    HTML::WhiteListSanitizer.allowed_protocols.each do |proto|
      assert !sanitizer.send(:contains_bad_protocols?, 'src', &quot;#{proto}://good&quot;)
    end
  end

  def test_should_reject_hex_codes_in_protocol
    assert_sanitized %(&lt;a href=&quot;&amp;#37;6A&amp;#37;61&amp;#37;76&amp;#37;61&amp;#37;73&amp;#37;63&amp;#37;72&amp;#37;69&amp;#37;70&amp;#37;74&amp;#37;3A&amp;#37;61&amp;#37;6C&amp;#37;65&amp;#37;72&amp;#37;74&amp;#37;28&amp;#37;22&amp;#37;58&amp;#37;53&amp;#37;53&amp;#37;22&amp;#37;29&quot;&gt;1&lt;/a&gt;), &quot;&lt;a&gt;1&lt;/a&gt;&quot;
    assert @sanitizer.send(:contains_bad_protocols?, 'src', &quot;%6A%61%76%61%73%63%72%69%70%74%3A%61%6C%65%72%74%28%22%58%53%53%22%29&quot;)
  end

  def test_should_block_script_tag
    assert_sanitized %(&lt;SCRIPT\nSRC=http://ha.ckers.org/xss.js&gt;&lt;/SCRIPT&gt;), &quot;&quot;
  end

  [%(&lt;IMG SRC=&quot;javascript:alert('XSS');&quot;&gt;), 
   %(&lt;IMG SRC=javascript:alert('XSS')&gt;), 
   %(&lt;IMG SRC=JaVaScRiPt:alert('XSS')&gt;), 
   %(&lt;IMG &quot;&quot;&quot;&gt;&lt;SCRIPT&gt;alert(&quot;XSS&quot;)&lt;/SCRIPT&gt;&quot;&gt;),
   %(&lt;IMG SRC=javascript:alert(&amp;quot;XSS&amp;quot;)&gt;),
   %(&lt;IMG SRC=javascript:alert(String.fromCharCode(88,83,83))&gt;),
   %(&lt;IMG SRC=&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#39;&amp;#88;&amp;#83;&amp;#83;&amp;#39;&amp;#41;&gt;),
   %(&lt;IMG SRC=&amp;#0000106&amp;#0000097&amp;#0000118&amp;#0000097&amp;#0000115&amp;#0000099&amp;#0000114&amp;#0000105&amp;#0000112&amp;#0000116&amp;#0000058&amp;#0000097&amp;#0000108&amp;#0000101&amp;#0000114&amp;#0000116&amp;#0000040&amp;#0000039&amp;#0000088&amp;#0000083&amp;#0000083&amp;#0000039&amp;#0000041&gt;),
   %(&lt;IMG SRC=&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29&gt;),
   %(&lt;IMG SRC=&quot;jav\tascript:alert('XSS');&quot;&gt;),
   %(&lt;IMG SRC=&quot;jav&amp;#x09;ascript:alert('XSS');&quot;&gt;),
   %(&lt;IMG SRC=&quot;jav&amp;#x0A;ascript:alert('XSS');&quot;&gt;),
   %(&lt;IMG SRC=&quot;jav&amp;#x0D;ascript:alert('XSS');&quot;&gt;),
   %(&lt;IMG SRC=&quot; &amp;#14;  javascript:alert('XSS');&quot;&gt;),
   %(&lt;IMG SRC=`javascript:alert(&quot;RSnake says, 'XSS'&quot;)`&gt;)].each_with_index do |img_hack, i|
    define_method &quot;test_should_not_fall_for_xss_image_hack_#{i+1}&quot; do
      assert_sanitized img_hack, &quot;&lt;img&gt;&quot;
    end
  end
  
  def test_should_sanitize_tag_broken_up_by_null
    assert_sanitized %(&lt;SCR\0IPT&gt;alert(\&quot;XSS\&quot;)&lt;/SCR\0IPT&gt;), &quot;alert(\&quot;XSS\&quot;)&quot;
  end
  
  def test_should_sanitize_invalid_script_tag
    assert_sanitized %(&lt;SCRIPT/XSS SRC=&quot;http://ha.ckers.org/xss.js&quot;&gt;&lt;/SCRIPT&gt;), &quot;&quot;
  end
  
  def test_should_sanitize_script_tag_with_multiple_open_brackets
    assert_sanitized %(&lt;&lt;SCRIPT&gt;alert(&quot;XSS&quot;);//&lt;&lt;/SCRIPT&gt;), &quot;&amp;lt;&quot;
    assert_sanitized %(&lt;iframe src=http://ha.ckers.org/scriptlet.html\n&lt;a), %(&amp;lt;a)
  end
  
  def test_should_sanitize_unclosed_script
    assert_sanitized %(&lt;SCRIPT SRC=http://ha.ckers.org/xss.js?&lt;B&gt;), &quot;&lt;b&gt;&quot;
  end
  
  def test_should_sanitize_half_open_scripts
    assert_sanitized %(&lt;IMG SRC=&quot;javascript:alert('XSS')&quot;), &quot;&lt;img&gt;&quot;
  end
  
  def test_should_not_fall_for_ridiculous_hack
    img_hack = %(&lt;IMG\nSRC\n=\n&quot;\nj\na\nv\na\ns\nc\nr\ni\np\nt\n:\na\nl\ne\nr\nt\n(\n'\nX\nS\nS\n'\n)\n&quot;\n&gt;)
    assert_sanitized img_hack, &quot;&lt;img&gt;&quot;
  end

  # fucked
  def test_should_sanitize_attributes
    assert_sanitized %(&lt;SPAN title=&quot;'&gt;&lt;script&gt;alert()&lt;/script&gt;&quot;&gt;blah&lt;/SPAN&gt;), %(&lt;span title=&quot;'&amp;gt;&amp;lt;script&amp;gt;alert()&amp;lt;/script&amp;gt;&quot;&gt;blah&lt;/span&gt;)
  end

  def test_should_sanitize_illegal_style_properties
    raw      = %(display:block; position:absolute; left:0; top:0; width:100%; height:100%; z-index:1; background-color:black; background-image:url(http://www.ragingplatypus.com/i/cam-full.jpg); background-x:center; background-y:center; background-repeat:repeat;)
    expected = %(display: block; width: 100%; height: 100%; background-color: black; background-image: ; background-x: center; background-y: center;)
    assert_equal expected, sanitize_css(raw)
  end

  def test_should_sanitize_with_trailing_space
    raw = &quot;display:block; &quot;
    expected = &quot;display: block;&quot;
    assert_equal expected, sanitize_css(raw)
  end

  def test_should_sanitize_xul_style_attributes
    raw = %(-moz-binding:url('http://ha.ckers.org/xssmoz.xml#xss'))
    assert_equal '', sanitize_css(raw)
  end
  
  def test_should_sanitize_invalid_tag_names
    assert_sanitized(%(a b c&lt;script/XSS src=&quot;http://ha.ckers.org/xss.js&quot;&gt;&lt;/script&gt;d e f), &quot;a b cd e f&quot;)
  end
  
  def test_should_sanitize_non_alpha_and_non_digit_characters_in_tags
    assert_sanitized('&lt;a onclick!#$%&amp;()*~+-_.,:;?@[/|\]^`=alert(&quot;XSS&quot;)&gt;foo&lt;/a&gt;', &quot;&lt;a&gt;foo&lt;/a&gt;&quot;)
  end
  
  def test_should_sanitize_invalid_tag_names_in_single_tags
    assert_sanitized('&lt;img/src=&quot;http://ha.ckers.org/xss.js&quot;/&gt;', &quot;&lt;img /&gt;&quot;)
  end

  def test_should_sanitize_img_dynsrc_lowsrc
    assert_sanitized(%(&lt;img lowsrc=&quot;javascript:alert('XSS')&quot; /&gt;), &quot;&lt;img /&gt;&quot;)
  end

  def test_should_sanitize_div_background_image_unicode_encoded
    raw = %(background-image:\0075\0072\006C\0028'\006a\0061\0076\0061\0073\0063\0072\0069\0070\0074\003a\0061\006c\0065\0072\0074\0028.1027\0058.1053\0053\0027\0029'\0029)
    assert_equal '', sanitize_css(raw)
  end

  def test_should_sanitize_div_style_expression
    raw = %(width: expression(alert('XSS'));)
    assert_equal '', sanitize_css(raw)
  end

  def test_should_sanitize_img_vbscript
    assert_sanitized %(&lt;img src='vbscript:msgbox(&quot;XSS&quot;)' /&gt;), '&lt;img /&gt;'
  end

  def test_should_sanitize_cdata_section
    assert_sanitized &quot;&lt;![CDATA[&lt;span&gt;section&lt;/span&gt;]]&gt;&quot;, &quot;&amp;lt;![CDATA[&amp;lt;span&gt;section&amp;lt;/span&gt;]]&gt;&quot;
  end

  def test_should_sanitize_unterminated_cdata_section
    assert_sanitized &quot;&lt;![CDATA[&lt;span&gt;neverending...&quot;, &quot;&amp;lt;![CDATA[&amp;lt;span&gt;neverending...]]&gt;&quot;
  end

  def test_should_not_mangle_urls_with_ampersand
     assert_sanitized %{&lt;a href=\&quot;http://www.domain.com?var1=1&amp;amp;var2=2\&quot;&gt;my link&lt;/a&gt;}
  end

protected
  def assert_sanitized(input, expected = nil)
    @sanitizer ||= HTML::WhiteListSanitizer.new
    if input
      assert_dom_equal expected || input, @sanitizer.sanitize(input)
    else
      assert_nil @sanitizer.sanitize(input)
    end
  end

  def sanitize_css(input)
    (@sanitizer ||= HTML::WhiteListSanitizer.new).sanitize_css(input)
  end
end
</pre>
    </div>