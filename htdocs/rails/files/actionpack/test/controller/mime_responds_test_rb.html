  <div id="fileHeader">
    <h1>mime_responds_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/mime_responds_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 19:55:10 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

class RespondToController &lt; ActionController::Base
  layout :set_layout

  def html_xml_or_rss
    respond_to do |type|
      type.html { render :text =&gt; &quot;HTML&quot;    }
      type.xml  { render :text =&gt; &quot;XML&quot;     }
      type.rss  { render :text =&gt; &quot;RSS&quot;     }
      type.all  { render :text =&gt; &quot;Nothing&quot; }
    end
  end

  def js_or_html
    respond_to do |type|
      type.html { render :text =&gt; &quot;HTML&quot;    }
      type.js   { render :text =&gt; &quot;JS&quot;      }
      type.all  { render :text =&gt; &quot;Nothing&quot; }
    end
  end

  def json_or_yaml
    respond_to do |type|
      type.json { render :text =&gt; &quot;JSON&quot; }
      type.yaml { render :text =&gt; &quot;YAML&quot; }
    end
  end

  def html_or_xml
    respond_to do |type|
      type.html { render :text =&gt; &quot;HTML&quot;    }
      type.xml  { render :text =&gt; &quot;XML&quot;     }
      type.all  { render :text =&gt; &quot;Nothing&quot; }
    end
  end

  def forced_xml
    request.format = :xml

    respond_to do |type|
      type.html { render :text =&gt; &quot;HTML&quot;    }
      type.xml  { render :text =&gt; &quot;XML&quot;     }
    end
  end

  def just_xml
    respond_to do |type|
      type.xml  { render :text =&gt; &quot;XML&quot; }
    end
  end

  def using_defaults
    respond_to do |type|
      type.html
      type.js
      type.xml
    end
  end

  def using_defaults_with_type_list
    respond_to(:html, :js, :xml)
  end

  def made_for_content_type
    respond_to do |type|
      type.rss  { render :text =&gt; &quot;RSS&quot;  }
      type.atom { render :text =&gt; &quot;ATOM&quot; }
      type.all  { render :text =&gt; &quot;Nothing&quot; }
    end
  end

  def custom_type_handling
    respond_to do |type|
      type.html { render :text =&gt; &quot;HTML&quot;    }
      type.custom(&quot;application/crazy-xml&quot;)  { render :text =&gt; &quot;Crazy XML&quot;  }
      type.all  { render :text =&gt; &quot;Nothing&quot; }
    end
  end

  def custom_constant_handling
    Mime::Type.register(&quot;text/x-mobile&quot;, :mobile)

    respond_to do |type|
      type.html   { render :text =&gt; &quot;HTML&quot;   }
      type.mobile { render :text =&gt; &quot;Mobile&quot; }
    end
  ensure
    Mime.module_eval { remove_const :MOBILE if const_defined?(:MOBILE) }
  end

  def custom_constant_handling_without_block
    Mime::Type.register(&quot;text/x-mobile&quot;, :mobile)

    respond_to do |type|
      type.html   { render :text =&gt; &quot;HTML&quot;   }
      type.mobile
    end

  ensure
    Mime.module_eval { remove_const :MOBILE if const_defined?(:MOBILE) }
  end

  def handle_any
    respond_to do |type|
      type.html { render :text =&gt; &quot;HTML&quot; }
      type.any(:js, :xml) { render :text =&gt; &quot;Either JS or XML&quot; }
    end
  end

  def handle_any_any
    respond_to do |type|
      type.html { render :text =&gt; 'HTML' }
      type.any { render :text =&gt; 'Whatever you ask for, I got it' }
    end
  end

  def all_types_with_layout
    respond_to do |type|
      type.html
      type.js
    end
  end

  def iphone_with_html_response_type
    Mime::Type.register_alias(&quot;text/html&quot;, :iphone)
    request.format = :iphone if request.env[&quot;HTTP_ACCEPT&quot;] == &quot;text/iphone&quot;

    respond_to do |type|
      type.html   { @type = &quot;Firefox&quot; }
      type.iphone { @type = &quot;iPhone&quot;  }
    end

  ensure
    Mime.module_eval { remove_const :IPHONE if const_defined?(:IPHONE) }
  end

  def iphone_with_html_response_type_without_layout
    Mime::Type.register_alias(&quot;text/html&quot;, :iphone)
    request.format = &quot;iphone&quot; if request.env[&quot;HTTP_ACCEPT&quot;] == &quot;text/iphone&quot;

    respond_to do |type|
      type.html   { @type = &quot;Firefox&quot;; render :action =&gt; &quot;iphone_with_html_response_type&quot; }
      type.iphone { @type = &quot;iPhone&quot; ; render :action =&gt; &quot;iphone_with_html_response_type&quot; }
    end

  ensure
    Mime.module_eval { remove_const :IPHONE if const_defined?(:IPHONE) }
  end

  def rescue_action(e)
    raise
  end

  protected
    def set_layout
      if [&quot;all_types_with_layout&quot;, &quot;iphone_with_html_response_type&quot;].include?(action_name)
        &quot;respond_to/layouts/standard&quot;
      elsif action_name == &quot;iphone_with_html_response_type_without_layout&quot;
        &quot;respond_to/layouts/missing&quot;
      end
    end
end

class MimeControllerTest &lt; ActionController::TestCase
  tests RespondToController

  def setup
    ActionController::Base.use_accept_header = true
    @request.host = &quot;www.example.com&quot;
  end

  def teardown
    ActionController::Base.use_accept_header = false
  end

  def test_html
    @request.accept = &quot;text/html&quot;
    get :js_or_html
    assert_equal 'HTML', @response.body

    get :html_or_xml
    assert_equal 'HTML', @response.body

    get :just_xml
    assert_response 406
  end

  def test_all
    @request.accept = &quot;*/*&quot;
    get :js_or_html
    assert_equal 'HTML', @response.body # js is not part of all

    get :html_or_xml
    assert_equal 'HTML', @response.body

    get :just_xml
    assert_equal 'XML', @response.body
  end

  def test_xml
    @request.accept = &quot;application/xml&quot;
    get :html_xml_or_rss
    assert_equal 'XML', @response.body
  end

  def test_js_or_html
    @request.accept = &quot;text/javascript, text/html&quot;
    get :js_or_html
    assert_equal 'JS', @response.body

    get :html_or_xml
    assert_equal 'HTML', @response.body

    get :just_xml
    assert_response 406
  end

  def test_json_or_yaml
    get :json_or_yaml
    assert_equal 'JSON', @response.body

    get :json_or_yaml, :format =&gt; 'json'
    assert_equal 'JSON', @response.body

    get :json_or_yaml, :format =&gt; 'yaml'
    assert_equal 'YAML', @response.body

    { 'YAML' =&gt; %w(text/yaml),
      'JSON' =&gt; %w(application/json text/x-json)
    }.each do |body, content_types|
      content_types.each do |content_type|
        @request.accept = content_type
        get :json_or_yaml
        assert_equal body, @response.body
      end
    end
  end

  def test_js_or_anything
    @request.accept = &quot;text/javascript, */*&quot;
    get :js_or_html
    assert_equal 'JS', @response.body

    get :html_or_xml
    assert_equal 'HTML', @response.body

    get :just_xml
    assert_equal 'XML', @response.body
  end

  def test_using_defaults
    @request.accept = &quot;*/*&quot;
    get :using_defaults
    assert_equal &quot;text/html&quot;, @response.content_type
    assert_equal 'Hello world!', @response.body

    @request.accept = &quot;text/javascript&quot;
    get :using_defaults
    assert_equal &quot;text/javascript&quot;, @response.content_type
    assert_equal '$(&quot;body&quot;).visualEffect(&quot;highlight&quot;);', @response.body

    @request.accept = &quot;application/xml&quot;
    get :using_defaults
    assert_equal &quot;application/xml&quot;, @response.content_type
    assert_equal &quot;&lt;p&gt;Hello world!&lt;/p&gt;\n&quot;, @response.body
  end

  def test_using_defaults_with_type_list
    @request.accept = &quot;*/*&quot;
    get :using_defaults_with_type_list
    assert_equal &quot;text/html&quot;, @response.content_type
    assert_equal 'Hello world!', @response.body

    @request.accept = &quot;text/javascript&quot;
    get :using_defaults_with_type_list
    assert_equal &quot;text/javascript&quot;, @response.content_type
    assert_equal '$(&quot;body&quot;).visualEffect(&quot;highlight&quot;);', @response.body

    @request.accept = &quot;application/xml&quot;
    get :using_defaults_with_type_list
    assert_equal &quot;application/xml&quot;, @response.content_type
    assert_equal &quot;&lt;p&gt;Hello world!&lt;/p&gt;\n&quot;, @response.body
  end

  def test_with_atom_content_type
    @request.env[&quot;CONTENT_TYPE&quot;] = &quot;application/atom+xml&quot;
    get :made_for_content_type
    assert_equal &quot;ATOM&quot;, @response.body
  end

  def test_with_rss_content_type
    @request.env[&quot;CONTENT_TYPE&quot;] = &quot;application/rss+xml&quot;
    get :made_for_content_type
    assert_equal &quot;RSS&quot;, @response.body
  end

  def test_synonyms
    @request.accept = &quot;application/javascript&quot;
    get :js_or_html
    assert_equal 'JS', @response.body

    @request.accept = &quot;application/x-xml&quot;
    get :html_xml_or_rss
    assert_equal &quot;XML&quot;, @response.body
  end

  def test_custom_types
    @request.accept = &quot;application/crazy-xml&quot;
    get :custom_type_handling
    assert_equal &quot;application/crazy-xml&quot;, @response.content_type
    assert_equal 'Crazy XML', @response.body

    @request.accept = &quot;text/html&quot;
    get :custom_type_handling
    assert_equal &quot;text/html&quot;, @response.content_type
    assert_equal 'HTML', @response.body
  end

  def test_xhtml_alias
    @request.accept = &quot;application/xhtml+xml,application/xml&quot;
    get :html_or_xml
    assert_equal 'HTML', @response.body
  end

  def test_firefox_simulation
    @request.accept = &quot;text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5&quot;
    get :html_or_xml
    assert_equal 'HTML', @response.body
  end

  def test_handle_any
    @request.accept = &quot;*/*&quot;
    get :handle_any
    assert_equal 'HTML', @response.body

    @request.accept = &quot;text/javascript&quot;
    get :handle_any
    assert_equal 'Either JS or XML', @response.body

    @request.accept = &quot;text/xml&quot;
    get :handle_any
    assert_equal 'Either JS or XML', @response.body
  end

  def test_handle_any_any
    @request.accept = &quot;*/*&quot;
    get :handle_any_any
    assert_equal 'HTML', @response.body
  end

  def test_handle_any_any_parameter_format
    get :handle_any_any, {:format=&gt;'html'}
    assert_equal 'HTML', @response.body
  end

  def test_handle_any_any_explicit_html
    @request.accept = &quot;text/html&quot;
    get :handle_any_any
    assert_equal 'HTML', @response.body
  end

  def test_handle_any_any_javascript
    @request.accept = &quot;text/javascript&quot;
    get :handle_any_any
    assert_equal 'Whatever you ask for, I got it', @response.body
  end

  def test_handle_any_any_xml
    @request.accept = &quot;text/xml&quot;
    get :handle_any_any
    assert_equal 'Whatever you ask for, I got it', @response.body
  end

  def test_rjs_type_skips_layout
    @request.accept = &quot;text/javascript&quot;
    get :all_types_with_layout
    assert_equal 'RJS for all_types_with_layout', @response.body
  end

  def test_html_type_with_layout
    @request.accept = &quot;text/html&quot;
    get :all_types_with_layout
    assert_equal '&lt;html&gt;&lt;div id=&quot;html&quot;&gt;HTML for all_types_with_layout&lt;/div&gt;&lt;/html&gt;', @response.body
  end

  def test_xhr
    xhr :get, :js_or_html
    assert_equal 'JS', @response.body

    xhr :get, :using_defaults
    assert_equal '$(&quot;body&quot;).visualEffect(&quot;highlight&quot;);', @response.body
  end

  def test_custom_constant
    get :custom_constant_handling, :format =&gt; &quot;mobile&quot;
    assert_equal &quot;text/x-mobile&quot;, @response.content_type
    assert_equal &quot;Mobile&quot;, @response.body
  end

  def test_custom_constant_handling_without_block
    get :custom_constant_handling_without_block, :format =&gt; &quot;mobile&quot;
    assert_equal &quot;text/x-mobile&quot;, @response.content_type
    assert_equal &quot;Mobile&quot;, @response.body
  end

  def test_forced_format
    get :html_xml_or_rss
    assert_equal &quot;HTML&quot;, @response.body

    get :html_xml_or_rss, :format =&gt; &quot;html&quot;
    assert_equal &quot;HTML&quot;, @response.body

    get :html_xml_or_rss, :format =&gt; &quot;xml&quot;
    assert_equal &quot;XML&quot;, @response.body

    get :html_xml_or_rss, :format =&gt; &quot;rss&quot;
    assert_equal &quot;RSS&quot;, @response.body
  end

  def test_internally_forced_format
    get :forced_xml
    assert_equal &quot;XML&quot;, @response.body

    get :forced_xml, :format =&gt; &quot;html&quot;
    assert_equal &quot;XML&quot;, @response.body
  end

  def test_extension_synonyms
    get :html_xml_or_rss, :format =&gt; &quot;xhtml&quot;
    assert_equal &quot;HTML&quot;, @response.body
  end

  def test_render_action_for_html
    @controller.instance_eval do
      def render(*args)
        unless args.empty?
          @action = args.first[:action]
        end
        response.body = &quot;#{@action} - #{@template.template_format}&quot;
      end
    end

    get :using_defaults
    assert_equal &quot;using_defaults - html&quot;, @response.body

    get :using_defaults, :format =&gt; &quot;xml&quot;
    assert_equal &quot;using_defaults - xml&quot;, @response.body
  end

  def test_format_with_custom_response_type
    get :iphone_with_html_response_type
    assert_equal '&lt;html&gt;&lt;div id=&quot;html&quot;&gt;Hello future from Firefox!&lt;/div&gt;&lt;/html&gt;', @response.body

    get :iphone_with_html_response_type, :format =&gt; &quot;iphone&quot;
    assert_equal &quot;text/html&quot;, @response.content_type
    assert_equal '&lt;html&gt;&lt;div id=&quot;iphone&quot;&gt;Hello iPhone future from iPhone!&lt;/div&gt;&lt;/html&gt;', @response.body
  end

  def test_format_with_custom_response_type_and_request_headers
    @request.accept = &quot;text/iphone&quot;
    get :iphone_with_html_response_type
    assert_equal '&lt;html&gt;&lt;div id=&quot;iphone&quot;&gt;Hello iPhone future from iPhone!&lt;/div&gt;&lt;/html&gt;', @response.body
    assert_equal &quot;text/html&quot;, @response.content_type
  end

  def test_format_with_custom_response_type_and_request_headers_with_only_one_layout_present
    get :iphone_with_html_response_type_without_layout
    assert_equal '&lt;html&gt;&lt;div id=&quot;html_missing&quot;&gt;Hello future from Firefox!&lt;/div&gt;&lt;/html&gt;', @response.body

    @request.accept = &quot;text/iphone&quot;
    assert_raise(ActionView::MissingTemplate) { get :iphone_with_html_response_type_without_layout }
  end
end

class AbstractPostController &lt; ActionController::Base
  self.view_paths = File.dirname(__FILE__) + &quot;/../fixtures/post_test/&quot;
end

# For testing layouts which are set automatically
class PostController &lt; AbstractPostController
  around_filter :with_iphone

  def index
    respond_to do |type|
      type.html
      type.iphone
    end
  end

  protected
    def with_iphone
      Mime::Type.register_alias(&quot;text/html&quot;, :iphone)
      request.format = &quot;iphone&quot; if request.env[&quot;HTTP_ACCEPT&quot;] == &quot;text/iphone&quot;
      yield
    ensure
      Mime.module_eval { remove_const :IPHONE if const_defined?(:IPHONE) }
    end
end

class SuperPostController &lt; PostController
  def index
    respond_to do |type|
      type.html
      type.iphone
    end
  end
end

class MimeControllerLayoutsTest &lt; ActionController::TestCase
  tests PostController

  def setup
    @request.host = &quot;www.example.com&quot;
  end

  def test_missing_layout_renders_properly
    get :index
    assert_equal '&lt;html&gt;&lt;div id=&quot;html&quot;&gt;Hello Firefox&lt;/div&gt;&lt;/html&gt;', @response.body

    @request.accept = &quot;text/iphone&quot;
    get :index
    assert_equal 'Hello iPhone', @response.body
  end

  def test_format_with_inherited_layouts
    @controller = SuperPostController.new

    get :index
    assert_equal 'Super Firefox', @response.body

    @request.accept = &quot;text/iphone&quot;
    get :index
    assert_equal '&lt;html&gt;&lt;div id=&quot;super_iphone&quot;&gt;Super iPhone&lt;/div&gt;&lt;/html&gt;', @response.body
  end
end
</pre>
    </div>