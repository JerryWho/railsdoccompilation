  <div id="fileHeader">
    <h1>content_type_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/content_type_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 19:55:10 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

class ContentTypeController &lt; ActionController::Base
  def render_content_type_from_body
    response.content_type = Mime::RSS
    render :text =&gt; &quot;hello world!&quot;
  end

  def render_defaults
    render :text =&gt; &quot;hello world!&quot;
  end

  def render_content_type_from_render
    render :text =&gt; &quot;hello world!&quot;, :content_type =&gt; Mime::RSS
  end

  def render_charset_from_body
    response.charset = &quot;utf-16&quot;
    render :text =&gt; &quot;hello world!&quot;
  end

  def render_nil_charset_from_body
    response.charset = nil
    render :text =&gt; &quot;hello world!&quot;
  end

  def render_default_for_rhtml
  end

  def render_default_for_rxml
  end

  def render_default_for_rjs
  end

  def render_change_for_rxml
    response.content_type = Mime::HTML
    render :action =&gt; &quot;render_default_for_rxml&quot;
  end

  def render_default_content_types_for_respond_to
    respond_to do |format|
      format.html { render :text   =&gt; &quot;hello world!&quot; }
      format.xml  { render :action =&gt; &quot;render_default_content_types_for_respond_to.rhtml&quot; }
      format.js   { render :text   =&gt; &quot;hello world!&quot; }
      format.rss  { render :text   =&gt; &quot;hello world!&quot;, :content_type =&gt; Mime::XML }
    end
  end

  def rescue_action(e) raise end
end

class ContentTypeTest &lt; ActionController::TestCase
  tests ContentTypeController

  def setup
    # enable a logger so that (e.g.) the benchmarking stuff runs, so we can get
    # a more accurate simulation of what happens in &quot;real life&quot;.
    @controller.logger = Logger.new(nil)
  end

  def test_render_defaults
    get :render_defaults
    assert_equal &quot;utf-8&quot;, @response.charset
    assert_equal Mime::HTML, @response.content_type
  end

  def test_render_changed_charset_default
    ContentTypeController.default_charset = &quot;utf-16&quot;
    get :render_defaults
    assert_equal &quot;utf-16&quot;, @response.charset
    assert_equal Mime::HTML, @response.content_type
    ContentTypeController.default_charset = &quot;utf-8&quot;
  end

  def test_content_type_from_body
    get :render_content_type_from_body
    assert_equal &quot;application/rss+xml&quot;, @response.content_type
    assert_equal &quot;utf-8&quot;, @response.charset
  end

  def test_content_type_from_render
    get :render_content_type_from_render
    assert_equal &quot;application/rss+xml&quot;, @response.content_type
    assert_equal &quot;utf-8&quot;, @response.charset
  end

  def test_charset_from_body
    get :render_charset_from_body
    assert_equal Mime::HTML, @response.content_type
    assert_equal &quot;utf-16&quot;, @response.charset
  end

  def test_nil_charset_from_body
    get :render_nil_charset_from_body
    assert_equal Mime::HTML, @response.content_type
    assert_equal &quot;utf-8&quot;, @response.charset, @response.headers.inspect
  end

  def test_nil_default_for_rhtml
    ContentTypeController.default_charset = nil
    get :render_default_for_rhtml
    assert_equal Mime::HTML, @response.content_type
    assert_nil @response.charset, @response.headers.inspect
  ensure
    ContentTypeController.default_charset = &quot;utf-8&quot;
  end

  def test_default_for_rhtml
    get :render_default_for_rhtml
    assert_equal Mime::HTML, @response.content_type
    assert_equal &quot;utf-8&quot;, @response.charset
  end

  def test_default_for_rxml
    get :render_default_for_rxml
    assert_equal Mime::XML, @response.content_type
    assert_equal &quot;utf-8&quot;, @response.charset
  end

  def test_default_for_rjs
    xhr :post, :render_default_for_rjs
    assert_equal Mime::JS, @response.content_type
    assert_equal &quot;utf-8&quot;, @response.charset
  end

  def test_change_for_rxml
    get :render_change_for_rxml
    assert_equal Mime::HTML, @response.content_type
    assert_equal &quot;utf-8&quot;, @response.charset
  end
end

class AcceptBasedContentTypeTest &lt; ActionController::TestCase

  tests ContentTypeController

  def setup
    ActionController::Base.use_accept_header = true
  end

  def teardown
    ActionController::Base.use_accept_header = false
  end


  def test_render_default_content_types_for_respond_to
    @request.accept = Mime::HTML.to_s
    get :render_default_content_types_for_respond_to
    assert_equal Mime::HTML, @response.content_type

    @request.accept = Mime::JS.to_s
    get :render_default_content_types_for_respond_to
    assert_equal Mime::JS, @response.content_type
  end

  def test_render_default_content_types_for_respond_to_with_template
    @request.accept = Mime::XML.to_s
    get :render_default_content_types_for_respond_to
    assert_equal Mime::XML, @response.content_type
  end

  def test_render_default_content_types_for_respond_to_with_overwrite
    @request.accept = Mime::RSS.to_s
    get :render_default_content_types_for_respond_to
    assert_equal Mime::XML, @response.content_type
  end
end
</pre>
    </div>