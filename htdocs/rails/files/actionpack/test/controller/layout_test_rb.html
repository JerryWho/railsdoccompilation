  <div id="fileHeader">
    <h1>layout_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/layout_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 19:55:10 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

# The view_paths array must be set on Base and not LayoutTest so that LayoutTest's inherited
# method has access to the view_paths array when looking for a layout to automatically assign.
old_load_paths = ActionController::Base.view_paths

ActionView::Template::register_template_handler :mab,
  lambda { |template| template.source.inspect }

ActionController::Base.view_paths = [ File.dirname(__FILE__) + '/../fixtures/layout_tests/' ]

class LayoutTest &lt; ActionController::Base
  def self.controller_path; 'views' end
  self.view_paths = ActionController::Base.view_paths.dup
end

# Restore view_paths to previous value
ActionController::Base.view_paths = old_load_paths

class ProductController &lt; LayoutTest
end

class ItemController &lt; LayoutTest
end

class ThirdPartyTemplateLibraryController &lt; LayoutTest
end

module ControllerNameSpace
end

class ControllerNameSpace::NestedController &lt; LayoutTest
end

class MultipleExtensions &lt; LayoutTest
end

class LayoutAutoDiscoveryTest &lt; ActionController::TestCase
  def setup
    @request.host = &quot;www.nextangle.com&quot;
  end

  def test_application_layout_is_default_when_no_controller_match
    @controller = ProductController.new
    get :hello
    assert_equal 'layout_test.rhtml hello.rhtml', @response.body
  end

  def test_controller_name_layout_name_match
    @controller = ItemController.new
    get :hello
    assert_equal 'item.rhtml hello.rhtml', @response.body
  end

  def test_third_party_template_library_auto_discovers_layout
    @controller = ThirdPartyTemplateLibraryController.new
    get :hello
    assert_equal 'layouts/third_party_template_library.mab', @controller.active_layout.to_s
    assert_equal 'layouts/third_party_template_library', @response.layout
    assert_response :success
    assert_equal 'Mab', @response.body
  end

  def test_namespaced_controllers_auto_detect_layouts
    @controller = ControllerNameSpace::NestedController.new
    get :hello
    assert_equal 'layouts/controller_name_space/nested', @controller.active_layout.to_s
    assert_equal 'controller_name_space/nested.rhtml hello.rhtml', @response.body
  end

  def test_namespaced_controllers_auto_detect_layouts
    @controller = MultipleExtensions.new
    get :hello
    assert_equal 'layouts/multiple_extensions.html.erb', @controller.active_layout.to_s
    assert_equal 'multiple_extensions.html.erb hello.rhtml', @response.body.strip
  end
end

class DefaultLayoutController &lt; LayoutTest
end

class AbsolutePathLayoutController &lt; LayoutTest
  layout File.expand_path(File.expand_path(__FILE__) + '/../../fixtures/layout_tests/layouts/layout_test.rhtml')
end

class HasOwnLayoutController &lt; LayoutTest
  layout 'item'
end

class PrependsViewPathController &lt; LayoutTest
  def hello
    prepend_view_path File.dirname(__FILE__) + '/../fixtures/layout_tests/alt/'
    render :layout =&gt; 'alt'
  end
end

class SetsLayoutInRenderController &lt; LayoutTest
  def hello
    render :layout =&gt; 'third_party_template_library'
  end
end

class RendersNoLayoutController &lt; LayoutTest
  def hello
    render :layout =&gt; false
  end
end

class LayoutSetInResponseTest &lt; ActionController::TestCase
  def test_layout_set_when_using_default_layout
    @controller = DefaultLayoutController.new
    get :hello
    assert_equal 'layouts/layout_test', @response.layout
  end

  def test_layout_set_when_set_in_controller
    @controller = HasOwnLayoutController.new
    get :hello
    assert_equal 'layouts/item', @response.layout
  end

  def test_layout_set_when_using_render
    @controller = SetsLayoutInRenderController.new
    get :hello
    assert_equal 'layouts/third_party_template_library', @response.layout
  end

  def test_layout_is_not_set_when_none_rendered
    @controller = RendersNoLayoutController.new
    get :hello
    assert_nil @response.layout
  end

  def test_exempt_from_layout_honored_by_render_template
    ActionController::Base.exempt_from_layout :rhtml
    @controller = RenderWithTemplateOptionController.new

    get :hello
    assert_equal &quot;alt/hello.rhtml&quot;, @response.body.strip

  ensure
    ActionController::Base.exempt_from_layout.delete(/\.rhtml$/)
  end

  def test_layout_is_picked_from_the_controller_instances_view_path
    @controller = PrependsViewPathController.new
    get :hello
    assert_equal 'layouts/alt', @response.layout
  end

  def test_absolute_pathed_layout
    @controller = AbsolutePathLayoutController.new
    get :hello
    assert_equal &quot;layout_test.rhtml hello.rhtml&quot;, @response.body.strip
  end
end

class RenderWithTemplateOptionController &lt; LayoutTest
  def hello
    render :template =&gt; 'alt/hello'
  end
end

class SetsNonExistentLayoutFile &lt; LayoutTest
  layout &quot;nofile.rhtml&quot;
end

class LayoutExceptionRaised &lt; ActionController::TestCase
  def test_exception_raised_when_layout_file_not_found
    @controller = SetsNonExistentLayoutFile.new
    get :hello
    assert_kind_of ActionView::MissingTemplate, @response.template.instance_eval { @exception }
  end
end

class LayoutStatusIsRendered &lt; LayoutTest
  def hello
    render :status =&gt; 401
  end
end

class LayoutStatusIsRenderedTest &lt; ActionController::TestCase
  def test_layout_status_is_rendered
    @controller = LayoutStatusIsRendered.new
    get :hello
    assert_response 401
  end
end

unless RUBY_PLATFORM =~ /(:?mswin|mingw|bccwin)/
  class LayoutSymlinkedTest &lt; LayoutTest
    layout &quot;symlinked/symlinked_layout&quot;
  end

  class LayoutSymlinkedIsRenderedTest &lt; ActionController::TestCase
    def test_symlinked_layout_is_rendered
      @controller = LayoutSymlinkedTest.new
      get :hello
      assert_response 200
      assert_equal &quot;layouts/symlinked/symlinked_layout&quot;, @response.layout
    end
  end
end

</pre>
    </div>