  <div id="fileHeader">
    <h1>render_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/render_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:53 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'
require 'controller/fake_models'

module Fun
  class GamesController &lt; ActionController::Base
    def hello_world
    end
  end
end

class MockLogger
  attr_reader :logged

  def initialize
    @logged = []
  end

  def method_missing(method, *args)
    @logged &lt;&lt; args.first
  end
end

class TestController &lt; ActionController::Base
  protect_from_forgery

  class LabellingFormBuilder &lt; ActionView::Helpers::FormBuilder
  end

  layout :determine_layout

  def hello_world
  end

  def conditional_hello
    if stale?(:last_modified =&gt; Time.now.utc.beginning_of_day, :etag =&gt; [:foo, 123])
      render :action =&gt; 'hello_world'
    end
  end
  
  def conditional_hello_with_public_header
    if stale?(:last_modified =&gt; Time.now.utc.beginning_of_day, :etag =&gt; [:foo, 123], :public =&gt; true)
      render :action =&gt; 'hello_world'
    end
  end
  
  def conditional_hello_with_public_header_and_expires_at
    expires_in 1.minute
    if stale?(:last_modified =&gt; Time.now.utc.beginning_of_day, :etag =&gt; [:foo, 123], :public =&gt; true)
      render :action =&gt; 'hello_world'
    end
  end
  
  def conditional_hello_with_expires_in
    expires_in 1.minute
    render :action =&gt; 'hello_world'
  end
  
  def conditional_hello_with_expires_in_with_public
    expires_in 1.minute, :public =&gt; true
    render :action =&gt; 'hello_world'
  end
  
  def conditional_hello_with_expires_in_with_public_with_more_keys
    expires_in 1.minute, :public =&gt; true, 'max-stale' =&gt; 5.hours
    render :action =&gt; 'hello_world'
  end
  
  def conditional_hello_with_expires_in_with_public_with_more_keys_old_syntax
    expires_in 1.minute, :public =&gt; true, :private =&gt; nil, 'max-stale' =&gt; 5.hours
    render :action =&gt; 'hello_world'
  end

  def conditional_hello_with_bangs
    render :action =&gt; 'hello_world'
  end
  before_filter :handle_last_modified_and_etags, :only=&gt;:conditional_hello_with_bangs

  def handle_last_modified_and_etags
    fresh_when(:last_modified =&gt; Time.now.utc.beginning_of_day, :etag =&gt; [ :foo, 123 ])
  end

  def render_hello_world
    render :template =&gt; &quot;test/hello_world&quot;
  end

  def render_hello_world_with_last_modified_set
    response.last_modified = Date.new(2008, 10, 10).to_time
    render :template =&gt; &quot;test/hello_world&quot;
  end

  def render_hello_world_with_etag_set
    response.etag = &quot;hello_world&quot;
    render :template =&gt; &quot;test/hello_world&quot;
  end

  def render_hello_world_with_forward_slash
    render :template =&gt; &quot;/test/hello_world&quot;
  end

  def render_template_in_top_directory
    render :template =&gt; 'shared'
  end

  def render_template_in_top_directory_with_slash
    render :template =&gt; '/shared'
  end

  def render_hello_world_from_variable
    @person = &quot;david&quot;
    render :text =&gt; &quot;hello #{@person}&quot;
  end

  def render_action_hello_world
    render :action =&gt; &quot;hello_world&quot;
  end

  def render_action_hello_world_as_string
    render &quot;hello_world&quot;
  end

  def render_action_hello_world_with_symbol
    render :action =&gt; :hello_world
  end

  def render_text_hello_world
    render :text =&gt; &quot;hello world&quot;
  end

  def render_text_hello_world_with_layout
    @variable_for_layout = &quot;, I'm here!&quot;
    render :text =&gt; &quot;hello world&quot;, :layout =&gt; true
  end

  def hello_world_with_layout_false
    render :layout =&gt; false
  end

  def render_file_with_instance_variables
    @secret = 'in the sauce'
    path = File.join(File.dirname(__FILE__), '../fixtures/test/render_file_with_ivar.erb')
    render :file =&gt; path
  end

  def render_file_as_string_with_instance_variables
    @secret = 'in the sauce'
    path = File.expand_path(File.join(File.dirname(__FILE__), '../fixtures/test/render_file_with_ivar.erb'))
    render path
  end

  def render_file_not_using_full_path
    @secret = 'in the sauce'
    render :file =&gt; 'test/render_file_with_ivar'
  end

  def render_file_not_using_full_path_with_dot_in_path
    @secret = 'in the sauce'
    render :file =&gt; 'test/dot.directory/render_file_with_ivar'
  end

  def render_file_using_pathname
    @secret = 'in the sauce'
    render :file =&gt; Pathname.new(File.dirname(__FILE__)).join('..', 'fixtures', 'test', 'dot.directory', 'render_file_with_ivar.erb')
  end

  def render_file_from_template
    @secret = 'in the sauce'
    @path = File.expand_path(File.join(File.dirname(__FILE__), '../fixtures/test/render_file_with_ivar.erb'))
  end

  def render_file_with_locals
    path = File.join(File.dirname(__FILE__), '../fixtures/test/render_file_with_locals.erb')
    render :file =&gt; path, :locals =&gt; {:secret =&gt; 'in the sauce'}
  end

  def render_file_as_string_with_locals
    path = File.expand_path(File.join(File.dirname(__FILE__), '../fixtures/test/render_file_with_locals.erb'))
    render path, :locals =&gt; {:secret =&gt; 'in the sauce'}
  end

  def accessing_request_in_template
    render :inline =&gt;  &quot;Hello: &lt;%= request.host %&gt;&quot;
  end

  def accessing_logger_in_template
    render :inline =&gt;  &quot;&lt;%= logger.class %&gt;&quot;
  end

  def accessing_action_name_in_template
    render :inline =&gt;  &quot;&lt;%= action_name %&gt;&quot;
  end

  def accessing_controller_name_in_template
    render :inline =&gt;  &quot;&lt;%= controller_name %&gt;&quot;
  end

  def render_json_nil
    render :json =&gt; nil
  end

  def render_json_hello_world
    render :json =&gt; ActiveSupport::JSON.encode(:hello =&gt; 'world')
  end

  def render_json_hello_world_with_callback
    render :json =&gt; ActiveSupport::JSON.encode(:hello =&gt; 'world'), :callback =&gt; 'alert'
  end

  def render_json_with_custom_content_type
    render :json =&gt; ActiveSupport::JSON.encode(:hello =&gt; 'world'), :content_type =&gt; 'text/javascript'
  end

  def render_symbol_json
    render :json =&gt; ActiveSupport::JSON.encode(:hello =&gt; 'world')
  end

  def render_json_with_render_to_string
    render :json =&gt; {:hello =&gt; render_to_string(:partial =&gt; 'partial')}
  end

  def render_custom_code
    render :text =&gt; &quot;hello world&quot;, :status =&gt; 404
  end

  def render_custom_code_rjs
    render :update, :status =&gt; 404 do |page|
      page.replace :foo, :partial =&gt; 'partial'
    end
  end

  def render_text_with_nil
    render :text =&gt; nil
  end

  def render_text_with_false
    render :text =&gt; false
  end

  def render_nothing_with_appendix
    render :text =&gt; &quot;appended&quot;
  end

  def render_vanilla_js_hello
    render :js =&gt; &quot;alert('hello')&quot;
  end

  def render_xml_hello
    @name = &quot;David&quot;
    render :template =&gt; &quot;test/hello&quot;
  end

  def render_xml_hello_as_string_template
    @name = &quot;David&quot;
    render &quot;test/hello&quot;
  end

  def render_xml_with_custom_content_type
    render :xml =&gt; &quot;&lt;blah/&gt;&quot;, :content_type =&gt; &quot;application/atomsvc+xml&quot;
  end

  def render_line_offset
    render :inline =&gt; '&lt;% raise %&gt;', :locals =&gt; {:foo =&gt; 'bar'}
  end

  def heading
    head :ok
  end

  def greeting
    # let's just rely on the template
  end

  def blank_response
    render :text =&gt; ' '
  end

  def layout_test
    render :action =&gt; &quot;hello_world&quot;
  end

  def builder_layout_test
    render :action =&gt; &quot;hello&quot;, :layout =&gt; &quot;layouts/builder&quot;
  end

  def builder_partial_test
    render :action =&gt; &quot;hello_world_container&quot;
  end

  def partials_list
    @test_unchanged = 'hello'
    @customers = [ Customer.new(&quot;david&quot;), Customer.new(&quot;mary&quot;) ]
    render :action =&gt; &quot;list&quot;
  end

  def partial_only
    render :partial =&gt; true
  end

  def hello_in_a_string
    @customers = [ Customer.new(&quot;david&quot;), Customer.new(&quot;mary&quot;) ]
    render :text =&gt; &quot;How's there? &quot; + render_to_string(:template =&gt; &quot;test/list&quot;)
  end

  def accessing_params_in_template
    render :inline =&gt; &quot;Hello: &lt;%= params[:name] %&gt;&quot;
  end

  def accessing_local_assigns_in_inline_template
    name = params[:local_name]
    render :inline =&gt; &quot;&lt;%= 'Goodbye, ' + local_name %&gt;&quot;,
           :locals =&gt; { :local_name =&gt; name }
  end

  def render_implicit_html_template
  end

  def render_explicit_html_template
  end

  def render_implicit_html_template_from_xhr_request
  end

  def render_implicit_js_template_without_layout
  end

  def render_html_explicit_template_and_layout
    render :template =&gt; 'test/render_implicit_html_template_from_xhr_request', :layout =&gt; 'layouts/default_html'
  end

  def formatted_html_erb
  end

  def formatted_xml_erb
  end

  def render_to_string_test
    @foo = render_to_string :inline =&gt; &quot;this is a test&quot;
  end

  def default_render
    if @alternate_default_render
      @alternate_default_render.call
    else
      super
    end
  end

  def render_action_hello_world_as_symbol
    render :action =&gt; :hello_world
  end

  def layout_test_with_different_layout
    render :action =&gt; &quot;hello_world&quot;, :layout =&gt; &quot;standard&quot;
  end

  def layout_test_with_different_layout_and_string_action
    render &quot;hello_world&quot;, :layout =&gt; &quot;standard&quot;
  end

  def layout_test_with_different_layout_and_symbol_action
    render :hello_world, :layout =&gt; &quot;standard&quot;
  end

  def rendering_without_layout
    render :action =&gt; &quot;hello_world&quot;, :layout =&gt; false
  end

  def layout_overriding_layout
    render :action =&gt; &quot;hello_world&quot;, :layout =&gt; &quot;standard&quot;
  end

  def rendering_nothing_on_layout
    render :nothing =&gt; true
  end

  def render_to_string_with_assigns
    @before = &quot;i'm before the render&quot;
    render_to_string :text =&gt; &quot;foo&quot;
    @after = &quot;i'm after the render&quot;
    render :action =&gt; &quot;test/hello_world&quot;
  end

  def render_to_string_with_exception
    render_to_string :file =&gt; &quot;exception that will not be caught - this will certainly not work&quot;
  end

  def render_to_string_with_caught_exception
    @before = &quot;i'm before the render&quot;
    begin
      render_to_string :file =&gt; &quot;exception that will be caught- hope my future instance vars still work!&quot;
    rescue
    end
    @after = &quot;i'm after the render&quot;
    render :action =&gt; &quot;test/hello_world&quot;
  end

  def accessing_params_in_template_with_layout
    render :layout =&gt; nil, :inline =&gt;  &quot;Hello: &lt;%= params[:name] %&gt;&quot;
  end

  def render_with_explicit_template
    render :template =&gt; &quot;test/hello_world&quot;
  end

  def render_with_explicit_string_template
    render &quot;test/hello_world&quot;
  end

  def render_with_explicit_template_with_locals
    render :template =&gt; &quot;test/render_file_with_locals&quot;, :locals =&gt; { :secret =&gt; 'area51' }
  end

  def double_render
    render :text =&gt; &quot;hello&quot;
    render :text =&gt; &quot;world&quot;
  end

  def double_redirect
    redirect_to :action =&gt; &quot;double_render&quot;
    redirect_to :action =&gt; &quot;double_render&quot;
  end

  def render_and_redirect
    render :text =&gt; &quot;hello&quot;
    redirect_to :action =&gt; &quot;double_render&quot;
  end

  def render_to_string_and_render
    @stuff = render_to_string :text =&gt; &quot;here is some cached stuff&quot;
    render :text =&gt; &quot;Hi web users! #{@stuff}&quot;
  end

  def render_to_string_with_inline_and_render
    render_to_string :inline =&gt; &quot;&lt;%= 'dlrow olleh'.reverse %&gt;&quot;
    render :template =&gt; &quot;test/hello_world&quot;
  end

  def rendering_with_conflicting_local_vars
    @name = &quot;David&quot;
    def @template.name() nil end
    render :action =&gt; &quot;potential_conflicts&quot;
  end

  def hello_world_from_rxml_using_action
    render :action =&gt; &quot;hello_world_from_rxml.builder&quot;
  end

  def hello_world_from_rxml_using_template
    render :template =&gt; &quot;test/hello_world_from_rxml.builder&quot;
  end

  module RenderTestHelper
    def rjs_helper_method_from_module
      page.visual_effect :highlight
    end
  end

  helper RenderTestHelper
  helper do
    def rjs_helper_method(value)
      page.visual_effect :highlight, value
    end
  end

  def enum_rjs_test
    render :update do |page|
      page.select('.product').each do |value|
        page.rjs_helper_method_from_module
        page.rjs_helper_method(value)
        page.sortable(value, :url =&gt; { :action =&gt; &quot;order&quot; })
        page.draggable(value)
      end
    end
  end

  def delete_with_js
    @project_id = 4
  end

  def render_js_with_explicit_template
    @project_id = 4
    render :template =&gt; 'test/delete_with_js'
  end

  def render_js_with_explicit_action_template
    @project_id = 4
    render :action =&gt; 'delete_with_js'
  end

  def update_page
    render :update do |page|
      page.replace_html 'balance', '$37,000,000.00'
      page.visual_effect :highlight, 'balance'
    end
  end

  def update_page_with_instance_variables
    @money = '$37,000,000.00'
    @div_id = 'balance'
    render :update do |page|
      page.replace_html @div_id, @money
      page.visual_effect :highlight, @div_id
    end
  end

  def update_page_with_view_method
    render :update do |page|
      page.replace_html 'person', pluralize(2, 'person')
    end
  end

  def action_talk_to_layout
    # Action template sets variable that's picked up by layout
  end

  def render_text_with_assigns
    @hello = &quot;world&quot;
    render :text =&gt; &quot;foo&quot;
  end

  def yield_content_for
    render :action =&gt; &quot;content_for&quot;, :layout =&gt; &quot;yield&quot;
  end

  def render_content_type_from_body
    response.content_type = Mime::RSS
    render :text =&gt; &quot;hello world!&quot;
  end

  def head_with_location_header
    head :location =&gt; &quot;/foo&quot;
  end

  def head_with_symbolic_status
    head :status =&gt; params[:status].intern
  end

  def head_with_integer_status
    head :status =&gt; params[:status].to_i
  end

  def head_with_string_status
    head :status =&gt; params[:status]
  end

  def head_with_custom_header
    head :x_custom_header =&gt; &quot;something&quot;
  end

  def head_with_status_code_first
    head :forbidden, :x_custom_header =&gt; &quot;something&quot;
  end

  def render_with_location
    render :xml =&gt; &quot;&lt;hello/&gt;&quot;, :location =&gt; &quot;http://example.com&quot;, :status =&gt; 201
  end

  def render_with_object_location
    customer = Customer.new(&quot;Some guy&quot;, 1)
    render :xml =&gt; &quot;&lt;customer/&gt;&quot;, :location =&gt; customer_url(customer), :status =&gt; :created
  end

  def render_with_to_xml
    to_xmlable = Class.new do
      def to_xml
        &quot;&lt;i-am-xml/&gt;&quot;
      end
    end.new

    render :xml =&gt; to_xmlable
  end

  def render_using_layout_around_block
    render :action =&gt; &quot;using_layout_around_block&quot;
  end

  def render_using_layout_around_block_with_args
    render :action =&gt; &quot;using_layout_around_block_with_args&quot;
  end

  def render_using_layout_around_block_in_main_layout_and_within_content_for_layout
    render :action =&gt; &quot;using_layout_around_block&quot;, :layout =&gt; &quot;layouts/block_with_layout&quot;
  end

  def partial_dot_html
    render :partial =&gt; 'partial.html.erb'
  end

  def partial_as_rjs
    render :update do |page|
      page.replace :foo, :partial =&gt; 'partial'
    end
  end

  def respond_to_partial_as_rjs
    respond_to do |format|
      format.js do
        render :update do |page|
          page.replace :foo, :partial =&gt; 'partial'
        end
      end
    end
  end

  def partial
    render :partial =&gt; 'partial'
  end

  def render_alternate_default
    # For this test, the method &quot;default_render&quot; is overridden:
    @alternate_default_render = lambda do
      render :update do |page|
        page.replace :foo, :partial =&gt; 'partial'
      end
    end
  end

  def partial_only_with_layout
    render :partial =&gt; &quot;partial_only&quot;, :layout =&gt; true
  end

  def render_to_string_with_partial
    @partial_only = render_to_string :partial =&gt; &quot;partial_only&quot;
    @partial_with_locals = render_to_string :partial =&gt; &quot;customer&quot;, :locals =&gt; { :customer =&gt; Customer.new(&quot;david&quot;) }
    render :action =&gt; &quot;test/hello_world&quot;
  end

  def partial_with_counter
    render :partial =&gt; &quot;counter&quot;, :locals =&gt; { :counter_counter =&gt; 5 }
  end

  def partial_with_locals
    render :partial =&gt; &quot;customer&quot;, :locals =&gt; { :customer =&gt; Customer.new(&quot;david&quot;) }
  end

  def partial_with_form_builder
    render :partial =&gt; ActionView::Helpers::FormBuilder.new(:post, nil, @template, {}, Proc.new {})
  end

  def partial_with_form_builder_subclass
    render :partial =&gt; LabellingFormBuilder.new(:post, nil, @template, {}, Proc.new {})
  end

  def partial_collection
    render :partial =&gt; &quot;customer&quot;, :collection =&gt; [ Customer.new(&quot;david&quot;), Customer.new(&quot;mary&quot;) ]
  end

  def partial_collection_with_as
    render :partial =&gt; &quot;customer_with_var&quot;, :collection =&gt; [ Customer.new(&quot;david&quot;), Customer.new(&quot;mary&quot;) ], :as =&gt; :customer
  end

  def partial_collection_with_counter
    render :partial =&gt; &quot;customer_counter&quot;, :collection =&gt; [ Customer.new(&quot;david&quot;), Customer.new(&quot;mary&quot;) ]
  end

  def partial_collection_with_as_and_counter
    render :partial =&gt; &quot;customer_counter_with_as&quot;, :collection =&gt; [ Customer.new(&quot;david&quot;), Customer.new(&quot;mary&quot;) ], :as =&gt; :client
  end

  def partial_collection_with_locals
    render :partial =&gt; &quot;customer_greeting&quot;, :collection =&gt; [ Customer.new(&quot;david&quot;), Customer.new(&quot;mary&quot;) ], :locals =&gt; { :greeting =&gt; &quot;Bonjour&quot; }
  end

  def partial_collection_with_spacer
    render :partial =&gt; &quot;customer&quot;, :spacer_template =&gt; &quot;partial_only&quot;, :collection =&gt; [ Customer.new(&quot;david&quot;), Customer.new(&quot;mary&quot;) ]
  end

  def partial_collection_shorthand_with_locals
    render :partial =&gt; [ Customer.new(&quot;david&quot;), Customer.new(&quot;mary&quot;) ], :locals =&gt; { :greeting =&gt; &quot;Bonjour&quot; }
  end

  def partial_collection_shorthand_with_different_types_of_records
    render :partial =&gt; [
        BadCustomer.new(&quot;mark&quot;),
        GoodCustomer.new(&quot;craig&quot;),
        BadCustomer.new(&quot;john&quot;),
        GoodCustomer.new(&quot;zach&quot;),
        GoodCustomer.new(&quot;brandon&quot;),
        BadCustomer.new(&quot;dan&quot;) ],
      :locals =&gt; { :greeting =&gt; &quot;Bonjour&quot; }
  end

  def empty_partial_collection
    render :partial =&gt; &quot;customer&quot;, :collection =&gt; []
  end

  def partial_collection_shorthand_with_different_types_of_records_with_counter
    partial_collection_shorthand_with_different_types_of_records
  end

  def missing_partial
    render :partial =&gt; 'thisFileIsntHere'
  end

  def partial_with_hash_object
    render :partial =&gt; &quot;hash_object&quot;, :object =&gt; {:first_name =&gt; &quot;Sam&quot;}
  end

  def partial_with_nested_object
    render :partial =&gt; &quot;quiz/questions/question&quot;, :object =&gt; Quiz::Question.new(&quot;first&quot;)
  end

  def partial_with_nested_object_shorthand
    render Quiz::Question.new(&quot;first&quot;)
  end

  def partial_hash_collection
    render :partial =&gt; &quot;hash_object&quot;, :collection =&gt; [ {:first_name =&gt; &quot;Pratik&quot;}, {:first_name =&gt; &quot;Amy&quot;} ]
  end

  def partial_hash_collection_with_locals
    render :partial =&gt; &quot;hash_greeting&quot;, :collection =&gt; [ {:first_name =&gt; &quot;Pratik&quot;}, {:first_name =&gt; &quot;Amy&quot;} ], :locals =&gt; { :greeting =&gt; &quot;Hola&quot; }
  end

  def partial_with_implicit_local_assignment
    @customer = Customer.new(&quot;Marcel&quot;)
    render :partial =&gt; &quot;customer&quot;
  end

  def render_call_to_partial_with_layout
    render :action =&gt; &quot;calling_partial_with_layout&quot;
  end

  def render_call_to_partial_with_layout_in_main_layout_and_within_content_for_layout
    render :action =&gt; &quot;calling_partial_with_layout&quot;, :layout =&gt; &quot;layouts/partial_with_layout&quot;
  end

  def rescue_action(e)
    raise
  end

  private
    def determine_layout
      case action_name
        when &quot;hello_world&quot;, &quot;layout_test&quot;, &quot;rendering_without_layout&quot;,
             &quot;rendering_nothing_on_layout&quot;, &quot;render_text_hello_world&quot;,
             &quot;render_text_hello_world_with_layout&quot;,
             &quot;hello_world_with_layout_false&quot;,
             &quot;partial_only&quot;, &quot;partial_only_with_layout&quot;,
             &quot;accessing_params_in_template&quot;,
             &quot;accessing_params_in_template_with_layout&quot;,
             &quot;render_with_explicit_template&quot;,
             &quot;render_with_explicit_string_template&quot;,
             &quot;render_js_with_explicit_template&quot;,
             &quot;render_js_with_explicit_action_template&quot;,
             &quot;delete_with_js&quot;, &quot;update_page&quot;, &quot;update_page_with_instance_variables&quot;

          &quot;layouts/standard&quot;
        when &quot;render_implicit_js_template_without_layout&quot;
          &quot;layouts/default_html&quot;
        when &quot;action_talk_to_layout&quot;, &quot;layout_overriding_layout&quot;
          &quot;layouts/talk_from_action&quot;
        when &quot;render_implicit_html_template_from_xhr_request&quot;
          (request.xhr? ? 'layouts/xhr' : 'layouts/standard')
      end
    end
end

class RenderTest &lt; ActionController::TestCase
  tests TestController

  def setup
    # enable a logger so that (e.g.) the benchmarking stuff runs, so we can get
    # a more accurate simulation of what happens in &quot;real life&quot;.
    @controller.logger = Logger.new(nil)

    @request.host = &quot;www.nextangle.com&quot;
  end

  def test_simple_show
    get :hello_world
    assert_response 200
    assert_response :success
    assert_template &quot;test/hello_world&quot;
    assert_equal &quot;&lt;html&gt;Hello world!&lt;/html&gt;&quot;, @response.body
  end

  def test_renders_default_template_for_missing_action
    get :'hyphen-ated'
    assert_template 'test/hyphen-ated'
  end

  def test_render
    get :render_hello_world
    assert_template &quot;test/hello_world&quot;
  end

  def test_line_offset
    begin
      get :render_line_offset
      flunk &quot;the action should have raised an exception&quot;
    rescue RuntimeError =&gt; exc
      line = exc.backtrace.first
      assert(line =~ %r{:(\d+):})
      assert_equal &quot;1&quot;, $1,
        &quot;The line offset is wrong, perhaps the wrong exception has been raised, exception was: #{exc.inspect}&quot;
    end
  end

  def test_render_with_forward_slash
    get :render_hello_world_with_forward_slash
    assert_template &quot;test/hello_world&quot;
  end

  def test_render_in_top_directory
    get :render_template_in_top_directory
    assert_template &quot;shared&quot;
    assert_equal &quot;Elastica&quot;, @response.body
  end

  def test_render_in_top_directory_with_slash
    get :render_template_in_top_directory_with_slash
    assert_template &quot;shared&quot;
    assert_equal &quot;Elastica&quot;, @response.body
  end

  def test_render_from_variable
    get :render_hello_world_from_variable
    assert_equal &quot;hello david&quot;, @response.body
  end

  def test_render_action
    get :render_action_hello_world
    assert_template &quot;test/hello_world&quot;
  end

  def test_render_action_hello_world_as_string
    get :render_action_hello_world_as_string
    assert_equal &quot;Hello world!&quot;, @response.body
    assert_template &quot;test/hello_world&quot;
  end

  def test_render_action_with_symbol
    get :render_action_hello_world_with_symbol
    assert_template &quot;test/hello_world&quot;
  end

  def test_render_text
    get :render_text_hello_world
    assert_equal &quot;hello world&quot;, @response.body
  end

  def test_do_with_render_text_and_layout
    get :render_text_hello_world_with_layout
    assert_equal &quot;&lt;html&gt;hello world, I'm here!&lt;/html&gt;&quot;, @response.body
  end

  def test_xhr_with_render_text_and_layout
    xhr :get, :render_text_hello_world_with_layout
    assert_equal &quot;&lt;html&gt;hello world, I'm here!&lt;/html&gt;&quot;, @response.body
  end

  def test_do_with_render_action_and_layout_false
    get :hello_world_with_layout_false
    assert_equal 'Hello world!', @response.body
  end

  def test_render_file_with_instance_variables
    get :render_file_with_instance_variables
    assert_equal &quot;The secret is in the sauce\n&quot;, @response.body
  end

  def test_render_file_as_string_with_instance_variables
    get :render_file_as_string_with_instance_variables
    assert_equal &quot;The secret is in the sauce\n&quot;, @response.body
  end

  def test_render_file_not_using_full_path
    get :render_file_not_using_full_path
    assert_equal &quot;The secret is in the sauce\n&quot;, @response.body
  end

  def test_render_file_not_using_full_path_with_dot_in_path
    get :render_file_not_using_full_path_with_dot_in_path
    assert_equal &quot;The secret is in the sauce\n&quot;, @response.body
  end

  def test_render_file_using_pathname
    get :render_file_using_pathname
    assert_equal &quot;The secret is in the sauce\n&quot;, @response.body
  end

  def test_render_file_with_locals
    get :render_file_with_locals
    assert_equal &quot;The secret is in the sauce\n&quot;, @response.body
  end

  def test_render_file_as_string_with_locals
    get :render_file_as_string_with_locals
    assert_equal &quot;The secret is in the sauce\n&quot;, @response.body
  end

  def test_render_file_from_template
    get :render_file_from_template
    assert_equal &quot;The secret is in the sauce\n&quot;, @response.body
  end

  def test_render_json_nil
    get :render_json_nil
    assert_equal 'null', @response.body
    assert_equal 'application/json', @response.content_type
  end

  def test_render_json
    get :render_json_hello_world
    assert_equal '{&quot;hello&quot;:&quot;world&quot;}', @response.body
    assert_equal 'application/json', @response.content_type
  end

  def test_render_json_with_callback
    get :render_json_hello_world_with_callback
    assert_equal 'alert({&quot;hello&quot;:&quot;world&quot;})', @response.body
    assert_equal 'application/json', @response.content_type
  end

  def test_render_json_with_custom_content_type
    get :render_json_with_custom_content_type
    assert_equal '{&quot;hello&quot;:&quot;world&quot;}', @response.body
    assert_equal 'text/javascript', @response.content_type
  end

  def test_render_symbol_json
    get :render_symbol_json
    assert_equal '{&quot;hello&quot;:&quot;world&quot;}', @response.body
    assert_equal 'application/json', @response.content_type
  end

  def test_render_json_with_render_to_string
    get :render_json_with_render_to_string
    assert_equal '{&quot;hello&quot;:&quot;partial html&quot;}', @response.body
    assert_equal 'application/json', @response.content_type
  end

  def test_render_custom_code
    get :render_custom_code
    assert_response 404
    assert_response :missing
    assert_equal 'hello world', @response.body
  end

  def test_render_custom_code_rjs
    get :render_custom_code_rjs
    assert_response 404
    assert_equal %(Element.replace(&quot;foo&quot;, &quot;partial html&quot;);), @response.body
  end

  def test_render_text_with_nil
    get :render_text_with_nil
    assert_response 200
    assert_equal ' ', @response.body
  end

  def test_render_text_with_false
    get :render_text_with_false
    assert_equal 'false', @response.body
  end

  def test_render_nothing_with_appendix
    get :render_nothing_with_appendix
    assert_response 200
    assert_equal 'appended', @response.body
  end

  def test_attempt_to_access_object_method
    assert_raise(ActionController::UnknownAction, &quot;No action responded to [clone]&quot;) { get :clone }
  end

  def test_private_methods
    assert_raise(ActionController::UnknownAction, &quot;No action responded to [determine_layout]&quot;) { get :determine_layout }
  end

  def test_access_to_request_in_view
    get :accessing_request_in_template
    assert_equal &quot;Hello: www.nextangle.com&quot;, @response.body
  end

  def test_access_to_logger_in_view
    get :accessing_logger_in_template
    assert_equal &quot;Logger&quot;, @response.body
  end

  def test_access_to_action_name_in_view
    get :accessing_action_name_in_template
    assert_equal &quot;accessing_action_name_in_template&quot;, @response.body
  end

  def test_access_to_controller_name_in_view
    get :accessing_controller_name_in_template
    assert_equal &quot;test&quot;, @response.body # name is explicitly set to 'test' inside the controller.
  end

  def test_render_vanilla_js
    get :render_vanilla_js_hello
    assert_equal &quot;alert('hello')&quot;, @response.body
    assert_equal &quot;text/javascript&quot;, @response.content_type
  end

  def test_render_xml
    get :render_xml_hello
    assert_equal &quot;&lt;html&gt;\n  &lt;p&gt;Hello David&lt;/p&gt;\n&lt;p&gt;This is grand!&lt;/p&gt;\n&lt;/html&gt;\n&quot;, @response.body
    assert_equal &quot;application/xml&quot;, @response.content_type
  end

  def test_render_xml_as_string_template
    get :render_xml_hello_as_string_template
    assert_equal &quot;&lt;html&gt;\n  &lt;p&gt;Hello David&lt;/p&gt;\n&lt;p&gt;This is grand!&lt;/p&gt;\n&lt;/html&gt;\n&quot;, @response.body
    assert_equal &quot;application/xml&quot;, @response.content_type
  end

  def test_render_xml_with_default
    get :greeting
    assert_equal &quot;&lt;p&gt;This is grand!&lt;/p&gt;\n&quot;, @response.body
  end

  def test_render_xml_with_partial
    get :builder_partial_test
    assert_equal &quot;&lt;test&gt;\n  &lt;hello/&gt;\n&lt;/test&gt;\n&quot;, @response.body
  end

  def test_enum_rjs_test
    ActiveSupport::SecureRandom.stubs(:base64).returns(&quot;asdf&quot;)
    get :enum_rjs_test
    body = %{
      $$(&quot;.product&quot;).each(function(value, index) {
      new Effect.Highlight(element,{});
      new Effect.Highlight(value,{});
      Sortable.create(value, {onUpdate:function(){new Ajax.Request('/test/order', {asynchronous:true, evalScripts:true, parameters:Sortable.serialize(value) + '&amp;authenticity_token=' + encodeURIComponent('asdf')})}});
      new Draggable(value, {});
      });
    }.gsub(/^      /, '').strip
    assert_equal body, @response.body
  end

  def test_layout_rendering
    get :layout_test
    assert_equal &quot;&lt;html&gt;Hello world!&lt;/html&gt;&quot;, @response.body
  end

  def test_render_xml_with_layouts
    get :builder_layout_test
    assert_equal &quot;&lt;wrapper&gt;\n&lt;html&gt;\n  &lt;p&gt;Hello &lt;/p&gt;\n&lt;p&gt;This is grand!&lt;/p&gt;\n&lt;/html&gt;\n&lt;/wrapper&gt;\n&quot;, @response.body
  end

  def test_partials_list
    get :partials_list
    assert_equal &quot;goodbyeHello: davidHello: marygoodbye\n&quot;, @response.body
  end

  def test_render_to_string
    get :hello_in_a_string
    assert_equal &quot;How's there? goodbyeHello: davidHello: marygoodbye\n&quot;, @response.body
  end

  def test_render_to_string_resets_assigns
    get :render_to_string_test
    assert_equal &quot;The value of foo is: ::this is a test::\n&quot;, @response.body
  end

  def test_render_to_string_inline
    get :render_to_string_with_inline_and_render
    assert_template &quot;test/hello_world&quot;
  end

  def test_nested_rendering
    @controller = Fun::GamesController.new
    get :hello_world
    assert_equal &quot;Living in a nested world&quot;, @response.body
  end

  def test_accessing_params_in_template
    get :accessing_params_in_template, :name =&gt; &quot;David&quot;
    assert_equal &quot;Hello: David&quot;, @response.body
  end

  def test_accessing_local_assigns_in_inline_template
    get :accessing_local_assigns_in_inline_template, :local_name =&gt; &quot;Local David&quot;
    assert_equal &quot;Goodbye, Local David&quot;, @response.body
  end

  def test_render_in_an_rjs_template_should_pick_html_templates_when_available
    [:js, &quot;js&quot;].each do |format|
      assert_nothing_raised do
        get :render_implicit_html_template, :format =&gt; format
        assert_equal %(document.write(&quot;Hello world\\n&quot;);), @response.body
      end
    end
  end

  def test_explicitly_rendering_an_html_template_with_implicit_html_template_renders_should_be_possible_from_an_rjs_template
    [:js, &quot;js&quot;].each do |format|
      assert_nothing_raised do
        get :render_explicit_html_template, :format =&gt; format
        assert_equal %(document.write(&quot;Hello world\\n&quot;);), @response.body
      end
    end
  end

  def test_should_implicitly_render_html_template_from_xhr_request
    xhr :get, :render_implicit_html_template_from_xhr_request
    assert_equal &quot;XHR!\nHello HTML!&quot;, @response.body
  end

  def test_should_render_explicit_html_template_with_html_layout
    xhr :get, :render_html_explicit_template_and_layout
    assert_equal &quot;&lt;html&gt;Hello HTML!&lt;/html&gt;\n&quot;, @response.body
  end

  def test_should_implicitly_render_js_template_without_layout
    get :render_implicit_js_template_without_layout, :format =&gt; :js
    assert_no_match /&lt;html&gt;/, @response.body
  end

  def test_should_render_formatted_template
    get :formatted_html_erb
    assert_equal 'formatted html erb', @response.body
  end

  def test_should_render_formatted_xml_erb_template
    get :formatted_xml_erb, :format =&gt; :xml
    assert_equal '&lt;test&gt;passed formatted xml erb&lt;/test&gt;', @response.body
  end

  def test_should_render_formatted_html_erb_template
    get :formatted_xml_erb
    assert_equal '&lt;test&gt;passed formatted html erb&lt;/test&gt;', @response.body
  end

  def test_should_render_formatted_html_erb_template_with_faulty_accepts_header
    @request.accept = &quot;image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, appliction/x-shockwave-flash, */*&quot;
    get :formatted_xml_erb
    assert_equal '&lt;test&gt;passed formatted html erb&lt;/test&gt;', @response.body
  end

  def test_should_render_xml_but_keep_custom_content_type
    get :render_xml_with_custom_content_type
    assert_equal &quot;application/atomsvc+xml&quot;, @response.content_type
  end

  def test_render_with_default_from_accept_header
    xhr :get, :greeting
    assert_equal &quot;$(\&quot;body\&quot;).visualEffect(\&quot;highlight\&quot;);&quot;, @response.body
  end

  def test_render_rjs_with_default
    get :delete_with_js
    assert_equal %!Element.remove(&quot;person&quot;);\nnew Effect.Highlight(\&quot;project-4\&quot;,{});!, @response.body
  end

  def test_render_rjs_template_explicitly
    get :render_js_with_explicit_template
    assert_equal %!Element.remove(&quot;person&quot;);\nnew Effect.Highlight(\&quot;project-4\&quot;,{});!, @response.body
  end

  def test_rendering_rjs_action_explicitly
    get :render_js_with_explicit_action_template
    assert_equal %!Element.remove(&quot;person&quot;);\nnew Effect.Highlight(\&quot;project-4\&quot;,{});!, @response.body
  end

  def test_layout_test_with_different_layout
    get :layout_test_with_different_layout
    assert_equal &quot;&lt;html&gt;Hello world!&lt;/html&gt;&quot;, @response.body
  end

  def test_layout_test_with_different_layout_and_string_action
    get :layout_test_with_different_layout_and_string_action
    assert_equal &quot;&lt;html&gt;Hello world!&lt;/html&gt;&quot;, @response.body
  end

  def test_layout_test_with_different_layout_and_symbol_action
    get :layout_test_with_different_layout_and_symbol_action
    assert_equal &quot;&lt;html&gt;Hello world!&lt;/html&gt;&quot;, @response.body
  end

  def test_rendering_without_layout
    get :rendering_without_layout
    assert_equal &quot;Hello world!&quot;, @response.body
  end

  def test_layout_overriding_layout
    get :layout_overriding_layout
    assert_no_match %r{&lt;title&gt;}, @response.body
  end

  def test_rendering_nothing_on_layout
    get :rendering_nothing_on_layout
    assert_equal &quot; &quot;, @response.body
  end

  def test_render_to_string
    assert_not_deprecated { get :hello_in_a_string }
    assert_equal &quot;How's there? goodbyeHello: davidHello: marygoodbye\n&quot;, @response.body
  end

  def test_render_to_string_doesnt_break_assigns
    get :render_to_string_with_assigns
    assert_equal &quot;i'm before the render&quot;, assigns(:before)
    assert_equal &quot;i'm after the render&quot;, assigns(:after)
  end

  def test_bad_render_to_string_still_throws_exception
    assert_raise(ActionView::MissingTemplate) { get :render_to_string_with_exception }
  end

  def test_render_to_string_that_throws_caught_exception_doesnt_break_assigns
    assert_nothing_raised { get :render_to_string_with_caught_exception }
    assert_equal &quot;i'm before the render&quot;, assigns(:before)
    assert_equal &quot;i'm after the render&quot;, assigns(:after)
  end

  def test_accessing_params_in_template_with_layout
    get :accessing_params_in_template_with_layout, :name =&gt; &quot;David&quot;
    assert_equal &quot;&lt;html&gt;Hello: David&lt;/html&gt;&quot;, @response.body
  end

  def test_render_with_explicit_template
    get :render_with_explicit_template
    assert_response :success
  end

  def test_render_with_explicit_string_template
    get :render_with_explicit_string_template
    assert_equal &quot;&lt;html&gt;Hello world!&lt;/html&gt;&quot;, @response.body
  end

  def test_double_render
    assert_raise(ActionController::DoubleRenderError) { get :double_render }
  end

  def test_double_redirect
    assert_raise(ActionController::DoubleRenderError) { get :double_redirect }
  end

  def test_render_and_redirect
    assert_raise(ActionController::DoubleRenderError) { get :render_and_redirect }
  end

  # specify the one exception to double render rule - render_to_string followed by render
  def test_render_to_string_and_render
    get :render_to_string_and_render
    assert_equal(&quot;Hi web users! here is some cached stuff&quot;, @response.body)
  end

  def test_rendering_with_conflicting_local_vars
    get :rendering_with_conflicting_local_vars
    assert_equal(&quot;First: David\nSecond: Stephan\nThird: David\nFourth: David\nFifth: &quot;, @response.body)
  end

  def test_action_talk_to_layout
    get :action_talk_to_layout
    assert_equal &quot;&lt;title&gt;Talking to the layout&lt;/title&gt;\nAction was here!&quot;, @response.body
  end

  def test_render_text_with_assigns
    get :render_text_with_assigns
    assert_equal &quot;world&quot;, assigns[&quot;hello&quot;]
  end

  def test_template_with_locals
    get :render_with_explicit_template_with_locals
    assert_equal &quot;The secret is area51\n&quot;, @response.body
  end

  def test_update_page
    get :update_page
    assert_template nil
    assert_equal 'text/javascript; charset=utf-8', @response.headers['Content-Type']
    assert_equal 2, @response.body.split($/).length
  end

  def test_update_page_with_instance_variables
    get :update_page_with_instance_variables
    assert_template nil
    assert_equal 'text/javascript; charset=utf-8', @response.headers[&quot;Content-Type&quot;]
    assert_match /balance/, @response.body
    assert_match /\$37/, @response.body
  end

  def test_update_page_with_view_method
    get :update_page_with_view_method
    assert_template nil
    assert_equal 'text/javascript; charset=utf-8', @response.headers[&quot;Content-Type&quot;]
    assert_match /2 people/, @response.body
  end

  def test_yield_content_for
    assert_not_deprecated { get :yield_content_for }
    assert_equal &quot;&lt;title&gt;Putting stuff in the title!&lt;/title&gt;\n\nGreat stuff!\n&quot;, @response.body
  end

  def test_overwritting_rendering_relative_file_with_extension
    get :hello_world_from_rxml_using_template
    assert_equal &quot;&lt;html&gt;\n  &lt;p&gt;Hello&lt;/p&gt;\n&lt;/html&gt;\n&quot;, @response.body

    get :hello_world_from_rxml_using_action
    assert_equal &quot;&lt;html&gt;\n  &lt;p&gt;Hello&lt;/p&gt;\n&lt;/html&gt;\n&quot;, @response.body
  end

  def test_head_with_location_header
    get :head_with_location_header
    assert @response.body.blank?
    assert_equal &quot;/foo&quot;, @response.headers[&quot;Location&quot;]
    assert_response :ok
  end

  def test_head_with_custom_header
    get :head_with_custom_header
    assert @response.body.blank?
    assert_equal &quot;something&quot;, @response.headers[&quot;X-Custom-Header&quot;]
    assert_response :ok
  end

  def test_head_with_symbolic_status
    get :head_with_symbolic_status, :status =&gt; &quot;ok&quot;
    assert_equal &quot;200 OK&quot;, @response.status
    assert_response :ok

    get :head_with_symbolic_status, :status =&gt; &quot;not_found&quot;
    assert_equal &quot;404 Not Found&quot;, @response.status
    assert_response :not_found

    get :head_with_symbolic_status, :status =&gt; &quot;no_content&quot;
    assert_equal &quot;204 No Content&quot;, @response.status
    assert !@response.headers.include?('Content-Length')
    assert_response :no_content

    ActionController::StatusCodes::SYMBOL_TO_STATUS_CODE.each do |status, code|
      get :head_with_symbolic_status, :status =&gt; status.to_s
      assert_equal code, @response.response_code
      assert_response status
    end
  end

  def test_head_with_integer_status
    ActionController::StatusCodes::STATUS_CODES.each do |code, message|
      get :head_with_integer_status, :status =&gt; code.to_s
      assert_equal message, @response.message
    end
  end

  def test_head_with_string_status
    get :head_with_string_status, :status =&gt; &quot;404 Eat Dirt&quot;
    assert_equal 404, @response.response_code
    assert_equal &quot;Eat Dirt&quot;, @response.message
    assert_response :not_found
  end

  def test_head_with_status_code_first
    get :head_with_status_code_first
    assert_equal 403, @response.response_code
    assert_equal &quot;Forbidden&quot;, @response.message
    assert_equal &quot;something&quot;, @response.headers[&quot;X-Custom-Header&quot;]
    assert_response :forbidden
  end

  def test_rendering_with_location_should_set_header
    get :render_with_location
    assert_equal &quot;http://example.com&quot;, @response.headers[&quot;Location&quot;]
  end

  def test_rendering_xml_should_call_to_xml_if_possible
    get :render_with_to_xml
    assert_equal &quot;&lt;i-am-xml/&gt;&quot;, @response.body
  end

  def test_rendering_with_object_location_should_set_header_with_url_for
    ActionController::Routing::Routes.draw do |map|
      map.resources :customers
      map.connect ':controller/:action/:id'
    end

    get :render_with_object_location
    assert_equal &quot;http://www.nextangle.com/customers/1&quot;, @response.headers[&quot;Location&quot;]
  end

  def test_should_use_implicit_content_type
    get :implicit_content_type, :format =&gt; 'atom'
    assert_equal Mime::ATOM, @response.content_type
  end

  def test_using_layout_around_block
    get :render_using_layout_around_block
    assert_equal &quot;Before (David)\nInside from block\nAfter&quot;, @response.body
  end

  def test_using_layout_around_block_in_main_layout_and_within_content_for_layout
    get :render_using_layout_around_block_in_main_layout_and_within_content_for_layout
    assert_equal &quot;Before (Anthony)\nInside from first block in layout\nAfter\nBefore (David)\nInside from block\nAfter\nBefore (Ramm)\nInside from second block in layout\nAfter\n&quot;, @response.body
  end

  def test_using_layout_around_block_with_args
    get :render_using_layout_around_block_with_args
    assert_equal &quot;Before\narg1arg2\nAfter&quot;, @response.body
  end

  def test_partial_only
    get :partial_only
    assert_equal &quot;only partial&quot;, @response.body
  end

  def test_should_render_html_formatted_partial
    get :partial
    assert_equal 'partial html', @response.body
  end

  def test_should_render_html_partial_with_dot
    get :partial_dot_html
    assert_equal 'partial html', @response.body
  end

  def test_should_render_html_formatted_partial_with_rjs
    xhr :get, :partial_as_rjs
    assert_equal %(Element.replace(&quot;foo&quot;, &quot;partial html&quot;);), @response.body
  end

  def test_should_render_html_formatted_partial_with_rjs_and_js_format
    xhr :get, :respond_to_partial_as_rjs
    assert_equal %(Element.replace(&quot;foo&quot;, &quot;partial html&quot;);), @response.body
  end

  def test_should_render_js_partial
    xhr :get, :partial, :format =&gt; 'js'
    assert_equal 'partial js', @response.body
  end

  def test_should_render_with_alternate_default_render
    xhr :get, :render_alternate_default
    assert_equal %(Element.replace(&quot;foo&quot;, &quot;partial html&quot;);), @response.body
  end

  def test_partial_only_with_layout
    get :partial_only_with_layout
    assert_equal &quot;&lt;html&gt;only partial&lt;/html&gt;&quot;, @response.body
  end

  def test_render_to_string_partial
    get :render_to_string_with_partial
    assert_equal &quot;only partial&quot;, assigns(:partial_only)
    assert_equal &quot;Hello: david&quot;, assigns(:partial_with_locals)
  end

  def test_partial_with_counter
    get :partial_with_counter
    assert_equal &quot;5&quot;, @response.body
  end

  def test_partial_with_locals
    get :partial_with_locals
    assert_equal &quot;Hello: david&quot;, @response.body
  end

  def test_partial_with_form_builder
    get :partial_with_form_builder
    assert_match(/&lt;label/, @response.body)
    assert_template('test/_form')
  end

  def test_partial_with_form_builder_subclass
    get :partial_with_form_builder_subclass
    assert_match(/&lt;label/, @response.body)
    assert_template('test/_labelling_form')
  end

  def test_partial_collection
    get :partial_collection
    assert_equal &quot;Hello: davidHello: mary&quot;, @response.body
  end

  def test_partial_collection_with_as
    get :partial_collection_with_as
    assert_equal &quot;david david davidmary mary mary&quot;, @response.body
  end

  def test_partial_collection_with_counter
    get :partial_collection_with_counter
    assert_equal &quot;david0mary1&quot;, @response.body
  end

  def test_partial_collection_with_as_and_counter
    get :partial_collection_with_as_and_counter
    assert_equal &quot;david0mary1&quot;, @response.body
  end

  def test_partial_collection_with_locals
    get :partial_collection_with_locals
    assert_equal &quot;Bonjour: davidBonjour: mary&quot;, @response.body
  end

  def test_partial_collection_with_spacer
    get :partial_collection_with_spacer
    assert_equal &quot;Hello: davidonly partialHello: mary&quot;, @response.body
    assert_template :partial =&gt; 'test/_partial_only'
    assert_template :partial =&gt; '_customer'
  end

  def test_partial_collection_shorthand_with_locals
    get :partial_collection_shorthand_with_locals
    assert_equal &quot;Bonjour: davidBonjour: mary&quot;, @response.body
    assert_template :partial =&gt; 'customers/_customer', :count =&gt; 2
    assert_template :partial =&gt; '_completely_fake_and_made_up_template_that_cannot_possibly_be_rendered', :count =&gt; 0
  end

  def test_partial_collection_shorthand_with_different_types_of_records
    get :partial_collection_shorthand_with_different_types_of_records
    assert_equal &quot;Bonjour bad customer: mark0Bonjour good customer: craig1Bonjour bad customer: john2Bonjour good customer: zach3Bonjour good customer: brandon4Bonjour bad customer: dan5&quot;, @response.body
    assert_template :partial =&gt; 'good_customers/_good_customer', :count =&gt; 3
    assert_template :partial =&gt; 'bad_customers/_bad_customer', :count =&gt; 3
  end

  def test_empty_partial_collection
    get :empty_partial_collection
    assert_equal &quot; &quot;, @response.body
    assert_template :partial =&gt; false
  end

  def test_partial_with_hash_object
    get :partial_with_hash_object
    assert_equal &quot;Sam\nmaS\n&quot;, @response.body
  end

  def test_partial_with_nested_object
    get :partial_with_nested_object
    assert_equal &quot;first&quot;, @response.body
  end

  def test_partial_with_nested_object_shorthand
    get :partial_with_nested_object_shorthand
    assert_equal &quot;first&quot;, @response.body
  end

  def test_hash_partial_collection
    get :partial_hash_collection
    assert_equal &quot;Pratik\nkitarP\nAmy\nymA\n&quot;, @response.body
  end

  def test_partial_hash_collection_with_locals
    get :partial_hash_collection_with_locals
    assert_equal &quot;Hola: PratikHola: Amy&quot;, @response.body
  end

  def test_partial_with_implicit_local_assignment
    assert_deprecated do
      get :partial_with_implicit_local_assignment
      assert_equal &quot;Hello: Marcel&quot;, @response.body
    end
  end

  def test_render_missing_partial_template
    assert_raise(ActionView::MissingTemplate) do
      get :missing_partial
    end
  end

  def test_render_call_to_partial_with_layout
    get :render_call_to_partial_with_layout
    assert_equal &quot;Before (David)\nInside from partial (David)\nAfter&quot;, @response.body
  end

  def test_render_call_to_partial_with_layout_in_main_layout_and_within_content_for_layout
    get :render_call_to_partial_with_layout_in_main_layout_and_within_content_for_layout
    assert_equal &quot;Before (Anthony)\nInside from partial (Anthony)\nAfter\nBefore (David)\nInside from partial (David)\nAfter\nBefore (Ramm)\nInside from partial (Ramm)\nAfter&quot;, @response.body
  end
end

class ExpiresInRenderTest &lt; ActionController::TestCase
  tests TestController

  def setup
    @request.host = &quot;www.nextangle.com&quot;
  end
  
  def test_expires_in_header
    get :conditional_hello_with_expires_in
    assert_equal &quot;max-age=60, private&quot;, @response.headers[&quot;Cache-Control&quot;]
  end
  
  def test_expires_in_header_with_public
    get :conditional_hello_with_expires_in_with_public
    assert_equal &quot;max-age=60, public&quot;, @response.headers[&quot;Cache-Control&quot;]
  end
  
  def test_expires_in_header_with_additional_headers
    get :conditional_hello_with_expires_in_with_public_with_more_keys
    assert_equal &quot;max-age=60, public, max-stale=18000&quot;, @response.headers[&quot;Cache-Control&quot;]
  end
  
  def test_expires_in_old_syntax
    get :conditional_hello_with_expires_in_with_public_with_more_keys_old_syntax
    assert_equal &quot;max-age=60, public, max-stale=18000&quot;, @response.headers[&quot;Cache-Control&quot;]
  end
end


class EtagRenderTest &lt; ActionController::TestCase
  tests TestController

  def setup
    @request.host = &quot;www.nextangle.com&quot;
    @expected_bang_etag = etag_for(expand_key([:foo, 123]))
  end

  def test_render_blank_body_shouldnt_set_etag
    get :blank_response
    assert !@response.etag?, @response.headers.inspect
  end

  def test_render_200_should_set_etag
    get :render_hello_world_from_variable
    assert_equal etag_for(&quot;hello david&quot;), @response.headers['ETag']
    assert_equal &quot;private, max-age=0, must-revalidate&quot;, @response.headers['Cache-Control']
  end

  def test_render_against_etag_request_should_304_when_match
    @request.if_none_match = etag_for(&quot;hello david&quot;)
    get :render_hello_world_from_variable
    assert_equal &quot;304 Not Modified&quot;, @response.status
    assert @response.body.empty?
  end

  def test_render_against_etag_request_should_have_no_content_length_when_match
    @request.if_none_match = etag_for(&quot;hello david&quot;)
    get :render_hello_world_from_variable
    assert_nil @response.headers[&quot;Content-Length&quot;], @response.headers.inspect
  end

  def test_render_against_etag_request_should_200_when_no_match
    @request.if_none_match = etag_for(&quot;hello somewhere else&quot;)
    get :render_hello_world_from_variable
    assert_equal &quot;200 OK&quot;, @response.status
    assert !@response.body.empty?
  end

  def test_render_should_not_set_etag_when_last_modified_has_been_specified
    get :render_hello_world_with_last_modified_set
    assert_equal &quot;200 OK&quot;, @response.status
    assert_not_nil @response.last_modified
    assert_nil @response.etag
    assert @response.body.present?
  end

  def test_render_with_etag
    get :render_hello_world_from_variable
    expected_etag = etag_for('hello david')
    assert_equal expected_etag, @response.headers['ETag']
    @response = ActionController::TestResponse.new

    @request.if_none_match = expected_etag
    get :render_hello_world_from_variable
    assert_equal &quot;304 Not Modified&quot;, @response.status

    @request.if_none_match = &quot;\&quot;diftag\&quot;&quot;
    get :render_hello_world_from_variable
    assert_equal &quot;200 OK&quot;, @response.status
  end

  def render_with_404_shouldnt_have_etag
    get :render_custom_code
    assert_nil @response.headers['ETag']
  end

  def test_etag_should_not_be_changed_when_already_set
    get :render_hello_world_with_etag_set
    assert_equal etag_for(&quot;hello_world&quot;), @response.headers['ETag']
  end

  def test_etag_should_govern_renders_with_layouts_too
    get :builder_layout_test
    assert_equal &quot;&lt;wrapper&gt;\n&lt;html&gt;\n  &lt;p&gt;Hello &lt;/p&gt;\n&lt;p&gt;This is grand!&lt;/p&gt;\n&lt;/html&gt;\n&lt;/wrapper&gt;\n&quot;, @response.body
    assert_equal etag_for(&quot;&lt;wrapper&gt;\n&lt;html&gt;\n  &lt;p&gt;Hello &lt;/p&gt;\n&lt;p&gt;This is grand!&lt;/p&gt;\n&lt;/html&gt;\n&lt;/wrapper&gt;\n&quot;), @response.headers['ETag']
  end

  def test_etag_with_bang_should_set_etag
    get :conditional_hello_with_bangs
    assert_equal @expected_bang_etag, @response.headers[&quot;ETag&quot;]
    assert_response :success
  end

  def test_etag_with_bang_should_obey_if_none_match
    @request.if_none_match = @expected_bang_etag
    get :conditional_hello_with_bangs
    assert_response :not_modified
  end
  
  def test_etag_with_public_true_should_set_header
    get :conditional_hello_with_public_header
    assert_equal &quot;public&quot;, @response.headers['Cache-Control']
  end
  
  def test_etag_with_public_true_should_set_header_and_retain_other_headers
    get :conditional_hello_with_public_header_and_expires_at
    assert_equal &quot;max-age=60, public&quot;, @response.headers['Cache-Control']
  end

  protected
    def etag_for(text)
      %(&quot;#{Digest::MD5.hexdigest(text)}&quot;)
    end

    def expand_key(args)
      ActiveSupport::Cache.expand_cache_key(args)
    end
end

class LastModifiedRenderTest &lt; ActionController::TestCase
  tests TestController

  def setup
    @request.host = &quot;www.nextangle.com&quot;
    @last_modified = Time.now.utc.beginning_of_day.httpdate
  end

  def test_responds_with_last_modified
    get :conditional_hello
    assert_equal @last_modified, @response.headers['Last-Modified']
  end

  def test_request_not_modified
    @request.if_modified_since = @last_modified
    get :conditional_hello
    assert_equal &quot;304 Not Modified&quot;, @response.status
    assert @response.body.blank?, @response.body
    assert_equal @last_modified, @response.headers['Last-Modified']
  end

  def test_request_not_modified_but_etag_differs
    @request.if_modified_since = @last_modified
    @request.if_none_match = &quot;234&quot;
    get :conditional_hello
    assert_response :success
  end

  def test_request_modified
    @request.if_modified_since = 'Thu, 16 Jul 2008 00:00:00 GMT'
    get :conditional_hello
    assert_equal &quot;200 OK&quot;, @response.status
    assert !@response.body.blank?
    assert_equal @last_modified, @response.headers['Last-Modified']
  end

  def test_request_with_bang_gets_last_modified
    get :conditional_hello_with_bangs
    assert_equal @last_modified, @response.headers['Last-Modified']
    assert_response :success
  end

  def test_request_with_bang_obeys_last_modified
    @request.if_modified_since = @last_modified
    get :conditional_hello_with_bangs
    assert_response :not_modified
  end

  def test_last_modified_works_with_less_than_too
    @request.if_modified_since = 5.years.ago.httpdate
    get :conditional_hello_with_bangs
    assert_response :success
  end
end

class RenderingLoggingTest &lt; ActionController::TestCase
  tests TestController

  def setup
    @request.host = &quot;www.nextangle.com&quot;
  end

  def test_logger_prints_layout_and_template_rendering_info
    @controller.logger = MockLogger.new
    get :layout_test
    logged = @controller.logger.logged.find_all {|l| l =~ /render/i }
    assert_equal &quot;Rendering template within layouts/standard&quot;, logged[0]
    assert_equal &quot;Rendering test/hello_world&quot;, logged[1]
  end
end
</pre>
    </div>