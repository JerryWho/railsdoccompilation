  <div id="fileHeader">
    <h1>assert_select_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/assert_select_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Nov 27 16:38:15 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>#--
# Copyright (c) 2006 Assaf Arkin (http://labnotes.org)
# Under MIT and/or CC By license.
#++

require 'abstract_unit'
require 'controller/fake_controllers'


unless defined?(ActionMailer)
  begin
    $:.unshift(&quot;#{File.dirname(__FILE__)}/../../../actionmailer/lib&quot;)
    require 'action_mailer'
  rescue LoadError =&gt; e
    raise unless e.message =~ /action_mailer/
    require 'rubygems'
    gem 'actionmailer'
  end
end

ActionMailer::Base.template_root = FIXTURE_LOAD_PATH

class AssertSelectTest &lt; ActionController::TestCase
  Assertion = ActiveSupport::TestCase::Assertion

  class AssertSelectMailer &lt; ActionMailer::Base
    def test(html)
      recipients &quot;test &lt;test@test.host&gt;&quot;
      from &quot;test@test.host&quot;
      subject &quot;Test e-mail&quot;
      part :content_type=&gt;&quot;text/html&quot;, :body=&gt;html
    end
  end

  class AssertSelectController &lt; ActionController::Base
    def response_with=(content)
      @content = content
    end

    def response_with(&amp;block)
      @update = block
    end

    def html()
      render :text=&gt;@content, :layout=&gt;false, :content_type=&gt;Mime::HTML
      @content = nil
    end

    def rjs()
      render :update do |page|
        @update.call page
      end
      @update = nil
    end

    def xml()
      render :text=&gt;@content, :layout=&gt;false, :content_type=&gt;Mime::XML
      @content = nil
    end

    def rescue_action(e)
      raise e
    end
  end

  tests AssertSelectController

  def setup
    ActionMailer::Base.delivery_method = :test
    ActionMailer::Base.perform_deliveries = true
    ActionMailer::Base.deliveries = []
  end

  def teardown
    ActionMailer::Base.deliveries.clear
  end

  def assert_failure(message, &amp;block)
    e = assert_raise(Assertion, &amp;block)
    assert_match(message, e.message) if Regexp === message
    assert_equal(message, e.message) if String === message
  end

  #
  # Test assert select.
  #

  def test_assert_select
    render_html %Q{&lt;div id=&quot;1&quot;&gt;&lt;/div&gt;&lt;div id=&quot;2&quot;&gt;&lt;/div&gt;}
    assert_select &quot;div&quot;, 2
    assert_failure(/Expected at least 3 elements matching \&quot;div\&quot;, found 2/) { assert_select &quot;div&quot;, 3 }
    assert_failure(/Expected at least 1 element matching \&quot;p\&quot;, found 0/) { assert_select &quot;p&quot; }
  end

  def test_equality_true_false
    render_html %Q{&lt;div id=&quot;1&quot;&gt;&lt;/div&gt;&lt;div id=&quot;2&quot;&gt;&lt;/div&gt;}
    assert_nothing_raised    { assert_select &quot;div&quot; }
    assert_raise(Assertion) { assert_select &quot;p&quot; }
    assert_nothing_raised    { assert_select &quot;div&quot;, true }
    assert_raise(Assertion) { assert_select &quot;p&quot;, true }
    assert_raise(Assertion) { assert_select &quot;div&quot;, false }
    assert_nothing_raised    { assert_select &quot;p&quot;, false }
  end

  def test_equality_string_and_regexp
    render_html %Q{&lt;div id=&quot;1&quot;&gt;foo&lt;/div&gt;&lt;div id=&quot;2&quot;&gt;foo&lt;/div&gt;}
    assert_nothing_raised    { assert_select &quot;div&quot;, &quot;foo&quot; }
    assert_raise(Assertion) { assert_select &quot;div&quot;, &quot;bar&quot; }
    assert_nothing_raised    { assert_select &quot;div&quot;, :text=&gt;&quot;foo&quot; }
    assert_raise(Assertion) { assert_select &quot;div&quot;, :text=&gt;&quot;bar&quot; }
    assert_nothing_raised    { assert_select &quot;div&quot;, /(foo|bar)/ }
    assert_raise(Assertion) { assert_select &quot;div&quot;, /foobar/ }
    assert_nothing_raised    { assert_select &quot;div&quot;, :text=&gt;/(foo|bar)/ }
    assert_raise(Assertion) { assert_select &quot;div&quot;, :text=&gt;/foobar/ }
    assert_raise(Assertion) { assert_select &quot;p&quot;, :text=&gt;/foobar/ }
  end

  def test_equality_of_html
    render_html %Q{&lt;p&gt;\n&lt;em&gt;&quot;This is &lt;strong&gt;not&lt;/strong&gt; a big problem,&quot;&lt;/em&gt; he said.\n&lt;/p&gt;}
    text = &quot;\&quot;This is not a big problem,\&quot; he said.&quot;
    html = &quot;&lt;em&gt;\&quot;This is &lt;strong&gt;not&lt;/strong&gt; a big problem,\&quot;&lt;/em&gt; he said.&quot;
    assert_nothing_raised    { assert_select &quot;p&quot;, text }
    assert_raise(Assertion) { assert_select &quot;p&quot;, html }
    assert_nothing_raised    { assert_select &quot;p&quot;, :html=&gt;html }
    assert_raise(Assertion) { assert_select &quot;p&quot;, :html=&gt;text }
    # No stripping for pre.
    render_html %Q{&lt;pre&gt;\n&lt;em&gt;&quot;This is &lt;strong&gt;not&lt;/strong&gt; a big problem,&quot;&lt;/em&gt; he said.\n&lt;/pre&gt;}
    text = &quot;\n\&quot;This is not a big problem,\&quot; he said.\n&quot;
    html = &quot;\n&lt;em&gt;\&quot;This is &lt;strong&gt;not&lt;/strong&gt; a big problem,\&quot;&lt;/em&gt; he said.\n&quot;
    assert_nothing_raised    { assert_select &quot;pre&quot;, text }
    assert_raise(Assertion) { assert_select &quot;pre&quot;, html }
    assert_nothing_raised    { assert_select &quot;pre&quot;, :html=&gt;html }
    assert_raise(Assertion) { assert_select &quot;pre&quot;, :html=&gt;text }
  end

  def test_counts
    render_html %Q{&lt;div id=&quot;1&quot;&gt;foo&lt;/div&gt;&lt;div id=&quot;2&quot;&gt;foo&lt;/div&gt;}
    assert_nothing_raised               { assert_select &quot;div&quot;, 2 }
    assert_failure(/Expected at least 3 elements matching \&quot;div\&quot;, found 2/) do
      assert_select &quot;div&quot;, 3
    end
    assert_nothing_raised               { assert_select &quot;div&quot;, 1..2 }
    assert_failure(/Expected between 3 and 4 elements matching \&quot;div\&quot;, found 2/) do
      assert_select &quot;div&quot;, 3..4
    end
    assert_nothing_raised               { assert_select &quot;div&quot;, :count=&gt;2 }
    assert_failure(/Expected at least 3 elements matching \&quot;div\&quot;, found 2/) do
      assert_select &quot;div&quot;, :count=&gt;3
    end
    assert_nothing_raised               { assert_select &quot;div&quot;, :minimum=&gt;1 }
    assert_nothing_raised               { assert_select &quot;div&quot;, :minimum=&gt;2 }
    assert_failure(/Expected at least 3 elements matching \&quot;div\&quot;, found 2/) do
      assert_select &quot;div&quot;, :minimum=&gt;3
    end
    assert_nothing_raised               { assert_select &quot;div&quot;, :maximum=&gt;2 }
    assert_nothing_raised               { assert_select &quot;div&quot;, :maximum=&gt;3 }
    assert_failure(/Expected at most 1 element matching \&quot;div\&quot;, found 2/) do
      assert_select &quot;div&quot;, :maximum=&gt;1
    end
    assert_nothing_raised               { assert_select &quot;div&quot;, :minimum=&gt;1, :maximum=&gt;2 }
    assert_failure(/Expected between 3 and 4 elements matching \&quot;div\&quot;, found 2/) do
      assert_select &quot;div&quot;, :minimum=&gt;3, :maximum=&gt;4
    end
  end

  def test_substitution_values
    render_html %Q{&lt;div id=&quot;1&quot;&gt;foo&lt;/div&gt;&lt;div id=&quot;2&quot;&gt;foo&lt;/div&gt;}
    assert_select &quot;div#?&quot;, /\d+/ do |elements|
      assert_equal 2, elements.size
    end
    assert_select &quot;div&quot; do
      assert_select &quot;div#?&quot;, /\d+/ do |elements|
        assert_equal 2, elements.size
        assert_select &quot;#1&quot;
        assert_select &quot;#2&quot;
      end
    end
  end

  def test_nested_assert_select
    render_html %Q{&lt;div id=&quot;1&quot;&gt;foo&lt;/div&gt;&lt;div id=&quot;2&quot;&gt;foo&lt;/div&gt;}
    assert_select &quot;div&quot; do |elements|
      assert_equal 2, elements.size
      assert_select elements[0], &quot;#1&quot;
      assert_select elements[1], &quot;#2&quot;
    end
    assert_select &quot;div&quot; do
      assert_select &quot;div&quot; do |elements|
        assert_equal 2, elements.size
        # Testing in a group is one thing
        assert_select &quot;#1,#2&quot;
        # Testing individually is another.
        assert_select &quot;#1&quot;
        assert_select &quot;#2&quot;
        assert_select &quot;#3&quot;, false
      end
    end

    assert_failure(/Expected at least 1 element matching \&quot;#4\&quot;, found 0\./) do
      assert_select &quot;div&quot; do
        assert_select &quot;#4&quot;
      end
    end
  end

  def test_assert_select_text_match
    render_html %Q{&lt;div id=&quot;1&quot;&gt;&lt;span&gt;foo&lt;/span&gt;&lt;/div&gt;&lt;div id=&quot;2&quot;&gt;&lt;span&gt;bar&lt;/span&gt;&lt;/div&gt;}
    assert_select &quot;div&quot; do
      assert_nothing_raised    { assert_select &quot;div&quot;, &quot;foo&quot; }
      assert_nothing_raised    { assert_select &quot;div&quot;, &quot;bar&quot; }
      assert_nothing_raised    { assert_select &quot;div&quot;, /\w*/ }
      assert_nothing_raised    { assert_select &quot;div&quot;, /\w*/, :count=&gt;2 }
      assert_raise(Assertion) { assert_select &quot;div&quot;, :text=&gt;&quot;foo&quot;, :count=&gt;2 }
      assert_nothing_raised    { assert_select &quot;div&quot;, :html=&gt;&quot;&lt;span&gt;bar&lt;/span&gt;&quot; }
      assert_nothing_raised    { assert_select &quot;div&quot;, :html=&gt;&quot;&lt;span&gt;bar&lt;/span&gt;&quot; }
      assert_nothing_raised    { assert_select &quot;div&quot;, :html=&gt;/\w*/ }
      assert_nothing_raised    { assert_select &quot;div&quot;, :html=&gt;/\w*/, :count=&gt;2 }
      assert_raise(Assertion) { assert_select &quot;div&quot;, :html=&gt;&quot;&lt;span&gt;foo&lt;/span&gt;&quot;, :count=&gt;2 }
    end
  end

  # With single result.
  def test_assert_select_from_rjs_with_single_result
    render_rjs do |page|
      page.replace_html &quot;test&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;\n&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
    end
    assert_select &quot;div&quot; do |elements|
      assert elements.size == 2
      assert_select &quot;#1&quot;
      assert_select &quot;#2&quot;
    end
    assert_select &quot;div#?&quot;, /\d+/ do |elements|
      assert_select &quot;#1&quot;
      assert_select &quot;#2&quot;
    end
  end

  # With multiple results.
  def test_assert_select_from_rjs_with_multiple_results
    render_rjs do |page|
      page.replace_html &quot;test&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;&quot;
      page.replace_html &quot;test2&quot;, &quot;&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
    end
    assert_select &quot;div&quot; do |elements|
      assert elements.size == 2
      assert_select &quot;#1&quot;
      assert_select &quot;#2&quot;
    end
  end

  def test_assert_select_rjs_for_positioned_insert_should_fail_when_mixing_arguments
    render_rjs do |page|
      page.insert_html :top, &quot;test1&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;&quot;
      page.insert_html :bottom, &quot;test2&quot;, &quot;&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
    end
    assert_raise(Assertion) {assert_select_rjs :insert, :top, &quot;test2&quot;}
  end

  def test_elect_with_xml_namespace_attributes
    render_html %Q{&lt;link xlink:href=&quot;http://nowhere.com&quot;&gt;&lt;/link&gt;}
    assert_nothing_raised { assert_select &quot;link[xlink:href=http://nowhere.com]&quot; }
  end

  #
  # Test css_select.
  #

  def test_css_select
    render_html %Q{&lt;div id=&quot;1&quot;&gt;&lt;/div&gt;&lt;div id=&quot;2&quot;&gt;&lt;/div&gt;}
    assert 2, css_select(&quot;div&quot;).size
    assert 0, css_select(&quot;p&quot;).size
  end

  def test_nested_css_select
    render_html %Q{&lt;div id=&quot;1&quot;&gt;foo&lt;/div&gt;&lt;div id=&quot;2&quot;&gt;foo&lt;/div&gt;}
    assert_select &quot;div#?&quot;, /\d+/ do |elements|
      assert_equal 1, css_select(elements[0], &quot;div&quot;).size
      assert_equal 1, css_select(elements[1], &quot;div&quot;).size
    end
    assert_select &quot;div&quot; do
      assert_equal 2, css_select(&quot;div&quot;).size
      css_select(&quot;div&quot;).each do |element|
        # Testing as a group is one thing
        assert !css_select(&quot;#1,#2&quot;).empty?
        # Testing individually is another
        assert !css_select(&quot;#1&quot;).empty?
        assert !css_select(&quot;#2&quot;).empty?
      end
    end
  end

  # With one result.
  def test_css_select_from_rjs_with_single_result
    render_rjs do |page|
      page.replace_html &quot;test&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;\n&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
    end
    assert_equal 2, css_select(&quot;div&quot;).size
    assert_equal 1, css_select(&quot;#1&quot;).size
    assert_equal 1, css_select(&quot;#2&quot;).size
  end

  # With multiple results.
  def test_css_select_from_rjs_with_multiple_results
    render_rjs do |page|
      page.replace_html &quot;test&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;&quot;
      page.replace_html &quot;test2&quot;, &quot;&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
    end

    assert_equal 2, css_select(&quot;div&quot;).size
    assert_equal 1, css_select(&quot;#1&quot;).size
    assert_equal 1, css_select(&quot;#2&quot;).size
  end

  #
  # Test assert_select_rjs.
  #

  # Test that we can pick up all statements in the result.
  def test_assert_select_rjs_picks_up_all_statements
    render_rjs do |page|
      page.replace &quot;test&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;&quot;
      page.replace_html &quot;test2&quot;, &quot;&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
      page.insert_html :top, &quot;test3&quot;, &quot;&lt;div id=\&quot;3\&quot;&gt;foo&lt;/div&gt;&quot;
    end

    found = false
    assert_select_rjs do
      assert_select &quot;#1&quot;
      assert_select &quot;#2&quot;
      assert_select &quot;#3&quot;
      found = true
    end
    assert found
  end

  # Test that we fail if there is nothing to pick.
  def test_assert_select_rjs_fails_if_nothing_to_pick
    render_rjs { }
    assert_raise(Assertion) { assert_select_rjs }
  end

  def test_assert_select_rjs_with_unicode
    # Test that non-ascii characters (which are converted into \uXXXX in RJS) are decoded correctly.
    render_rjs do |page|
      page.replace &quot;test&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;\343\203\201\343\202\261\343\203\203\343\203\210&lt;/div&gt;&quot;
    end
    assert_select_rjs do
      str = &quot;#1&quot;
      assert_select str, :text =&gt; &quot;\343\203\201\343\202\261\343\203\203\343\203\210&quot;
      assert_select str, &quot;\343\203\201\343\202\261\343\203\203\343\203\210&quot;
      if str.respond_to?(:force_encoding)
        str.force_encoding(Encoding::UTF_8)
        assert_select str, /\343\203\201..\343\203\210/u
        assert_raise(Assertion) { assert_select str, /\343\203\201.\343\203\210/u }
      else
        assert_select str, Regexp.new(&quot;\343\203\201..\343\203\210&quot;,0,'U')
        assert_raise(Assertion) { assert_select str, Regexp.new(&quot;\343\203\201.\343\203\210&quot;,0,'U') }
      end
    end
  end

  def test_assert_select_rjs_with_id
    # Test that we can pick up all statements in the result.
    render_rjs do |page|
      page.replace &quot;test1&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;&quot;
      page.replace_html &quot;test2&quot;, &quot;&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
      page.insert_html :top, &quot;test3&quot;, &quot;&lt;div id=\&quot;3\&quot;&gt;foo&lt;/div&gt;&quot;
    end
    assert_select_rjs &quot;test1&quot; do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#1&quot;
    end
    assert_select_rjs &quot;test2&quot; do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#2&quot;
    end
    assert_select_rjs &quot;test3&quot; do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#3&quot;
    end
    assert_raise(Assertion) { assert_select_rjs &quot;test4&quot; }
  end

  def test_assert_select_rjs_for_replace
    render_rjs do |page|
      page.replace &quot;test1&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;&quot;
      page.replace_html &quot;test2&quot;, &quot;&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
      page.insert_html :top, &quot;test3&quot;, &quot;&lt;div id=\&quot;3\&quot;&gt;foo&lt;/div&gt;&quot;
    end
    # Replace.
    assert_select_rjs :replace do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#1&quot;
    end
    assert_select_rjs :replace, &quot;test1&quot; do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#1&quot;
    end
    assert_raise(Assertion) { assert_select_rjs :replace, &quot;test2&quot; }
    # Replace HTML.
    assert_select_rjs :replace_html do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#2&quot;
    end
    assert_select_rjs :replace_html, &quot;test2&quot; do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#2&quot;
    end
    assert_raise(Assertion) { assert_select_rjs :replace_html, &quot;test1&quot; }
  end

  def test_assert_select_rjs_for_chained_replace
    render_rjs do |page|
      page['test1'].replace &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;&quot;
      page['test2'].replace_html &quot;&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
      page.insert_html :top, &quot;test3&quot;, &quot;&lt;div id=\&quot;3\&quot;&gt;foo&lt;/div&gt;&quot;
    end
    # Replace.
    assert_select_rjs :chained_replace do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#1&quot;
    end
    assert_select_rjs :chained_replace, &quot;test1&quot; do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#1&quot;
    end
    assert_raise(Assertion) { assert_select_rjs :chained_replace, &quot;test2&quot; }
    # Replace HTML.
    assert_select_rjs :chained_replace_html do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#2&quot;
    end
    assert_select_rjs :chained_replace_html, &quot;test2&quot; do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#2&quot;
    end
    assert_raise(Assertion) { assert_select_rjs :replace_html, &quot;test1&quot; }
  end

  # Simple remove
  def test_assert_select_rjs_for_remove
    render_rjs do |page|
      page.remove &quot;test1&quot;
    end

    assert_select_rjs :remove, &quot;test1&quot;
  end

  def test_assert_select_rjs_for_remove_offers_useful_error_when_assertion_fails
    render_rjs do |page|
      page.remove &quot;test_with_typo&quot;
    end

    assert_select_rjs :remove, &quot;test1&quot;

  rescue Assertion
    assert_equal &quot;No RJS statement that removes 'test1' was rendered.&quot;, $!.message
  end

  def test_assert_select_rjs_for_remove_ignores_block
    render_rjs do |page|
      page.remove &quot;test1&quot;
    end

    assert_nothing_raised do
      assert_select_rjs :remove, &quot;test1&quot; do
        assert_select &quot;p&quot;
      end
    end
  end

  # Simple show
  def test_assert_select_rjs_for_show
    render_rjs do |page|
      page.show &quot;test1&quot;
    end

    assert_select_rjs :show, &quot;test1&quot;
  end

  def test_assert_select_rjs_for_show_offers_useful_error_when_assertion_fails
    render_rjs do |page|
      page.show &quot;test_with_typo&quot;
    end

    assert_select_rjs :show, &quot;test1&quot;

  rescue Assertion
    assert_equal &quot;No RJS statement that shows 'test1' was rendered.&quot;, $!.message
  end

  def test_assert_select_rjs_for_show_ignores_block
    render_rjs do |page|
      page.show &quot;test1&quot;
    end

    assert_nothing_raised do
      assert_select_rjs :show, &quot;test1&quot; do
        assert_select &quot;p&quot;
      end
    end
  end

  # Simple hide
  def test_assert_select_rjs_for_hide
    render_rjs do |page|
      page.hide &quot;test1&quot;
    end

    assert_select_rjs :hide, &quot;test1&quot;
  end

  def test_assert_select_rjs_for_hide_offers_useful_error_when_assertion_fails
    render_rjs do |page|
      page.hide &quot;test_with_typo&quot;
    end

    assert_select_rjs :hide, &quot;test1&quot;

  rescue Assertion
    assert_equal &quot;No RJS statement that hides 'test1' was rendered.&quot;, $!.message
  end

  def test_assert_select_rjs_for_hide_ignores_block
    render_rjs do |page|
      page.hide &quot;test1&quot;
    end

    assert_nothing_raised do
      assert_select_rjs :hide, &quot;test1&quot; do
        assert_select &quot;p&quot;
      end
    end
  end

  # Simple toggle
  def test_assert_select_rjs_for_toggle
    render_rjs do |page|
      page.toggle &quot;test1&quot;
    end

    assert_select_rjs :toggle, &quot;test1&quot;
  end

  def test_assert_select_rjs_for_toggle_offers_useful_error_when_assertion_fails
    render_rjs do |page|
      page.toggle &quot;test_with_typo&quot;
    end

    assert_select_rjs :toggle, &quot;test1&quot;

  rescue Assertion
    assert_equal &quot;No RJS statement that toggles 'test1' was rendered.&quot;, $!.message
  end

  def test_assert_select_rjs_for_toggle_ignores_block
    render_rjs do |page|
      page.toggle &quot;test1&quot;
    end

    assert_nothing_raised do
      assert_select_rjs :toggle, &quot;test1&quot; do
        assert_select &quot;p&quot;
      end
    end
  end

  # Non-positioned insert.
  def test_assert_select_rjs_for_nonpositioned_insert
    render_rjs do |page|
      page.replace &quot;test1&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;&quot;
      page.replace_html &quot;test2&quot;, &quot;&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
      page.insert_html :top, &quot;test3&quot;, &quot;&lt;div id=\&quot;3\&quot;&gt;foo&lt;/div&gt;&quot;
    end
    assert_select_rjs :insert_html do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#3&quot;
    end
    assert_select_rjs :insert_html, &quot;test3&quot; do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#3&quot;
    end
    assert_raise(Assertion) { assert_select_rjs :insert_html, &quot;test1&quot; }
  end

  # Positioned insert.
  def test_assert_select_rjs_for_positioned_insert
    render_rjs do |page|
      page.insert_html :top, &quot;test1&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;&quot;
      page.insert_html :bottom, &quot;test2&quot;, &quot;&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
      page.insert_html :before, &quot;test3&quot;, &quot;&lt;div id=\&quot;3\&quot;&gt;foo&lt;/div&gt;&quot;
      page.insert_html :after, &quot;test4&quot;, &quot;&lt;div id=\&quot;4\&quot;&gt;foo&lt;/div&gt;&quot;
    end
    assert_select_rjs :insert, :top do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#1&quot;
    end
    assert_select_rjs :insert, :bottom do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#2&quot;
    end
    assert_select_rjs :insert, :before do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#3&quot;
    end
    assert_select_rjs :insert, :after do
      assert_select &quot;div&quot;, 1
      assert_select &quot;#4&quot;
    end
    assert_select_rjs :insert_html do
      assert_select &quot;div&quot;, 4
    end
  end

  def test_assert_select_rjs_raise_errors
    assert_raise(ArgumentError) { assert_select_rjs(:destroy) }
    assert_raise(ArgumentError) { assert_select_rjs(:insert, :left) }
  end

  # Simple selection from a single result.
  def test_nested_assert_select_rjs_with_single_result
    render_rjs do |page|
      page.replace_html &quot;test&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;\n&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
    end

    assert_select_rjs &quot;test&quot; do |elements|
      assert_equal 2, elements.size
      assert_select &quot;#1&quot;
      assert_select &quot;#2&quot;
    end
  end

  # Deal with two results.
  def test_nested_assert_select_rjs_with_two_results
    render_rjs do |page|
      page.replace_html &quot;test&quot;, &quot;&lt;div id=\&quot;1\&quot;&gt;foo&lt;/div&gt;&quot;
      page.replace_html &quot;test2&quot;, &quot;&lt;div id=\&quot;2\&quot;&gt;foo&lt;/div&gt;&quot;
    end

    assert_select_rjs &quot;test&quot; do |elements|
      assert_equal 1, elements.size
      assert_select &quot;#1&quot;
    end

    assert_select_rjs &quot;test2&quot; do |elements|
      assert_equal 1, elements.size
      assert_select &quot;#2&quot;
    end
  end

  def test_feed_item_encoded
    render_xml &lt;&lt;-EOF
&lt;rss version=&quot;2.0&quot;&gt;
  &lt;channel&gt;
    &lt;item&gt;
      &lt;description&gt;
        &lt;![CDATA[
          &lt;p&gt;Test 1&lt;/p&gt;
        ]]&gt;
      &lt;/description&gt;
    &lt;/item&gt;
    &lt;item&gt;
      &lt;description&gt;
        &lt;![CDATA[
          &lt;p&gt;Test 2&lt;/p&gt;
        ]]&gt;
      &lt;/description&gt;
    &lt;/item&gt;
  &lt;/channel&gt;
&lt;/rss&gt;
EOF
    assert_select &quot;channel item description&quot; do
      # Test element regardless of wrapper.
      assert_select_encoded do
        assert_select &quot;p&quot;, :count=&gt;2, :text=&gt;/Test/
      end
      # Test through encoded wrapper.
      assert_select_encoded do
        assert_select &quot;encoded p&quot;, :count=&gt;2, :text=&gt;/Test/
      end
      # Use :root instead (recommended)
      assert_select_encoded do
        assert_select &quot;:root p&quot;, :count=&gt;2, :text=&gt;/Test/
      end
      # Test individually.
      assert_select &quot;description&quot; do |elements|
        assert_select_encoded elements[0] do
          assert_select &quot;p&quot;, &quot;Test 1&quot;
        end
        assert_select_encoded elements[1] do
          assert_select &quot;p&quot;, &quot;Test 2&quot;
        end
      end
    end

    # Test that we only un-encode element itself.
    assert_select &quot;channel item&quot; do
      assert_select_encoded do
        assert_select &quot;p&quot;, 0
      end
    end
  end

  #
  # Test assert_select_email
  #

  def test_assert_select_email
    assert_raise(Assertion) { assert_select_email {} }
    AssertSelectMailer.deliver_test &quot;&lt;div&gt;&lt;p&gt;foo&lt;/p&gt;&lt;p&gt;bar&lt;/p&gt;&lt;/div&gt;&quot;
    assert_select_email do
      assert_select &quot;div:root&quot; do
        assert_select &quot;p:first-child&quot;, &quot;foo&quot;
        assert_select &quot;p:last-child&quot;, &quot;bar&quot;
      end
    end
  end

  protected
    def render_html(html)
      @controller.response_with = html
      get :html
    end

    def render_rjs(&amp;block)
      @controller.response_with &amp;block
      get :rjs
    end

    def render_xml(xml)
      @controller.response_with = xml
      get :xml
    end
end
</pre>
    </div>