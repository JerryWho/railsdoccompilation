  <div id="fileHeader">
    <h1>resources_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/test/controller/resources_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Oct 12 19:55:10 +0200 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

class ResourcesController &lt; ActionController::Base
  def index() render :nothing =&gt; true end
  alias_method :show, :index
  def rescue_action(e) raise e end
end

class ThreadsController  &lt; ResourcesController; end
class MessagesController &lt; ResourcesController; end
class CommentsController &lt; ResourcesController; end
class AuthorsController &lt; ResourcesController; end
class LogosController &lt; ResourcesController; end

class AccountsController &lt;  ResourcesController; end
class AdminController   &lt;  ResourcesController; end
class ProductsController &lt; ResourcesController; end
class ImagesController &lt; ResourcesController; end

module Backoffice
  class ProductsController &lt; ResourcesController; end
  class TagsController &lt; ResourcesController; end
  class ManufacturersController &lt; ResourcesController; end
  class ImagesController &lt; ResourcesController; end

  module Admin
    class ProductsController &lt; ResourcesController; end
    class ImagesController &lt; ResourcesController; end
  end
end

class ResourcesTest &lt; ActionController::TestCase
  # The assertions in these tests are incompatible with the hash method
  # optimisation.  This could indicate user level problems
  def setup
    ActionController::Base.optimise_named_routes = false
  end

  def teardown
    ActionController::Base.optimise_named_routes = true
  end

  def test_should_arrange_actions
    resource = ActionController::Resources::Resource.new(:messages,
      :collection =&gt; { :rss =&gt; :get, :reorder =&gt; :post, :csv =&gt; :post },
      :member     =&gt; { :rss =&gt; :get, :atom =&gt; :get, :upload =&gt; :post, :fix =&gt; :post },
      :new        =&gt; { :preview =&gt; :get, :draft =&gt; :get })

    assert_resource_methods [:rss],                   resource, :collection, :get
    assert_resource_methods [:csv, :reorder],         resource, :collection, :post
    assert_resource_methods [:edit, :rss, :atom],     resource, :member,     :get
    assert_resource_methods [:upload, :fix],          resource, :member,     :post
    assert_resource_methods [:new, :preview, :draft], resource, :new,        :get
  end

  def test_should_resource_controller_name_equal_resource_name_by_default
    resource = ActionController::Resources::Resource.new(:messages, {})
    assert_equal 'messages', resource.controller
  end

  def test_should_resource_controller_name_equal_controller_option
    resource = ActionController::Resources::Resource.new(:messages, :controller =&gt; 'posts')
    assert_equal 'posts', resource.controller
  end

  def test_should_all_singleton_paths_be_the_same
    [ :path, :nesting_path_prefix, :member_path ].each do |method|
      resource = ActionController::Resources::SingletonResource.new(:messages, :path_prefix =&gt; 'admin')
      assert_equal 'admin/messages', resource.send(method)
    end
  end

  def test_default_restful_routes
    with_restful_routing :messages do
      assert_simply_restful_for :messages
    end
  end

  def test_override_paths_for_member_and_collection_methods
    collection_methods = { 'rss' =&gt; :get, 'reorder' =&gt; :post, 'csv' =&gt; :post }
    member_methods    = { 'rss' =&gt; :get, :atom =&gt; :get, :upload =&gt; :post, :fix =&gt; :post }
    path_names = {:new =&gt; 'nuevo', 'rss' =&gt; 'canal', :fix =&gt; 'corrigir' }

    with_restful_routing :messages,
        :collection =&gt; collection_methods,
        :member =&gt; member_methods,
        :path_names =&gt; path_names do

      assert_restful_routes_for :messages,
          :collection =&gt; collection_methods,
          :member =&gt; member_methods,
          :path_names =&gt; path_names do |options|
        member_methods.each do |action, method|
          assert_recognizes(options.merge(:action =&gt; action.to_s, :id =&gt; '1'),
            :path =&gt; &quot;/messages/1/#{path_names[action] || action}&quot;,
            :method =&gt; method)
        end

        collection_methods.each do |action, method|
          assert_recognizes(options.merge(:action =&gt; action),
            :path =&gt; &quot;/messages/#{path_names[action] || action}&quot;,
            :method =&gt; method)
        end
      end

      assert_restful_named_routes_for :messages,
          :collection =&gt; collection_methods,
          :member =&gt; member_methods,
          :path_names =&gt; path_names do |options|

        collection_methods.keys.each do |action|
          assert_named_route &quot;/messages/#{path_names[action] || action}&quot;, &quot;#{action}_messages_path&quot;, :action =&gt; action
        end

        member_methods.keys.each do |action|
          assert_named_route &quot;/messages/1/#{path_names[action] || action}&quot;, &quot;#{action}_message_path&quot;, :action =&gt; action, :id =&gt; &quot;1&quot;
        end

      end
    end
  end

  def test_override_paths_for_default_restful_actions
    resource = ActionController::Resources::Resource.new(:messages,
      :path_names =&gt; {:new =&gt; 'nuevo', :edit =&gt; 'editar'})
    assert_equal resource.new_path, &quot;#{resource.path}/nuevo&quot;
  end

  def test_multiple_default_restful_routes
    with_restful_routing :messages, :comments do
      assert_simply_restful_for :messages
      assert_simply_restful_for :comments
    end
  end

  def test_with_custom_conditions
    with_restful_routing :messages, :conditions =&gt; { :subdomain =&gt; 'app' } do
      assert_equal 'app', ActionController::Routing::Routes.named_routes.routes[:messages].conditions[:subdomain]
    end
  end

  def test_irregular_id_with_no_requirements_should_raise_error
    expected_options = {:controller =&gt; 'messages', :action =&gt; 'show', :id =&gt; '1.1.1'}

    with_restful_routing :messages do
      assert_raise(ActionController::RoutingError) do
        assert_recognizes(expected_options, :path =&gt; 'messages/1.1.1', :method =&gt; :get)
      end
    end
  end

  def test_irregular_id_with_requirements_should_pass
    expected_options = {:controller =&gt; 'messages', :action =&gt; 'show', :id =&gt; '1.1.1'}

    with_restful_routing(:messages, :requirements =&gt; {:id =&gt; /[0-9]\.[0-9]\.[0-9]/}) do
      assert_recognizes(expected_options, :path =&gt; 'messages/1.1.1', :method =&gt; :get)
    end
  end

  def test_with_path_prefix_requirements
    expected_options = {:controller =&gt; 'messages', :action =&gt; 'show', :thread_id =&gt; '1.1.1', :id =&gt; '1'}
    with_restful_routing :messages, :path_prefix =&gt; '/thread/:thread_id', :requirements =&gt; {:thread_id =&gt; /[0-9]\.[0-9]\.[0-9]/} do
      assert_recognizes(expected_options, :path =&gt; 'thread/1.1.1/messages/1', :method =&gt; :get)
    end
  end

  def test_irregular_id_requirements_should_get_passed_to_member_actions
    expected_options = {:controller =&gt; 'messages', :action =&gt; 'custom', :id =&gt; '1.1.1'}

    with_restful_routing(:messages, :member =&gt; {:custom =&gt; :get}, :requirements =&gt; {:id =&gt; /[0-9]\.[0-9]\.[0-9]/}) do
      assert_recognizes(expected_options, :path =&gt; 'messages/1.1.1/custom', :method =&gt; :get)
    end
  end

  def test_with_path_prefix
    with_restful_routing :messages, :path_prefix =&gt; '/thread/:thread_id' do
      assert_simply_restful_for :messages, :path_prefix =&gt; 'thread/5/', :options =&gt; { :thread_id =&gt; '5' }
    end
  end

  def test_multiple_with_path_prefix
    with_restful_routing :messages, :comments, :path_prefix =&gt; '/thread/:thread_id' do
      assert_simply_restful_for :messages, :path_prefix =&gt; 'thread/5/', :options =&gt; { :thread_id =&gt; '5' }
      assert_simply_restful_for :comments, :path_prefix =&gt; 'thread/5/', :options =&gt; { :thread_id =&gt; '5' }
    end
  end

  def test_with_name_prefix
    with_restful_routing :messages, :name_prefix =&gt; 'post_' do
      assert_simply_restful_for :messages, :name_prefix =&gt; 'post_'
    end
  end

  def test_with_collection_actions
    actions = { 'a' =&gt; :get, 'b' =&gt; :put, 'c' =&gt; :post, 'd' =&gt; :delete }

    with_restful_routing :messages, :collection =&gt; actions do
      assert_restful_routes_for :messages do |options|
        actions.each do |action, method|
          assert_recognizes(options.merge(:action =&gt; action), :path =&gt; &quot;/messages/#{action}&quot;, :method =&gt; method)
        end
      end

      assert_restful_named_routes_for :messages do |options|
        actions.keys.each do |action|
          assert_named_route &quot;/messages/#{action}&quot;, &quot;#{action}_messages_path&quot;, :action =&gt; action
        end
      end
    end
  end

  def test_with_collection_actions_and_name_prefix
    actions = { 'a' =&gt; :get, 'b' =&gt; :put, 'c' =&gt; :post, 'd' =&gt; :delete }

    with_restful_routing :messages, :path_prefix =&gt; '/threads/:thread_id', :name_prefix =&gt; &quot;thread_&quot;, :collection =&gt; actions do
      assert_restful_routes_for :messages, :path_prefix =&gt; 'threads/1/', :name_prefix =&gt; 'thread_', :options =&gt; { :thread_id =&gt; '1' } do |options|
        actions.each do |action, method|
          assert_recognizes(options.merge(:action =&gt; action), :path =&gt; &quot;/threads/1/messages/#{action}&quot;, :method =&gt; method)
        end
      end

      assert_restful_named_routes_for :messages, :path_prefix =&gt; 'threads/1/', :name_prefix =&gt; 'thread_', :options =&gt; { :thread_id =&gt; '1' } do |options|
        actions.keys.each do |action|
          assert_named_route &quot;/threads/1/messages/#{action}&quot;, &quot;#{action}_thread_messages_path&quot;, :action =&gt; action
        end
      end
    end
  end

  def test_with_collection_actions_and_name_prefix_and_member_action_with_same_name
    actions = { 'a' =&gt; :get }

    with_restful_routing :messages, :path_prefix =&gt; '/threads/:thread_id', :name_prefix =&gt; &quot;thread_&quot;, :collection =&gt; actions, :member =&gt; actions do
      assert_restful_routes_for :messages, :path_prefix =&gt; 'threads/1/', :name_prefix =&gt; 'thread_', :options =&gt; { :thread_id =&gt; '1' } do |options|
        actions.each do |action, method|
          assert_recognizes(options.merge(:action =&gt; action), :path =&gt; &quot;/threads/1/messages/#{action}&quot;, :method =&gt; method)
        end
      end

      assert_restful_named_routes_for :messages, :path_prefix =&gt; 'threads/1/', :name_prefix =&gt; 'thread_', :options =&gt; { :thread_id =&gt; '1' } do |options|
        actions.keys.each do |action|
          assert_named_route &quot;/threads/1/messages/#{action}&quot;, &quot;#{action}_thread_messages_path&quot;, :action =&gt; action
        end
      end
    end
  end

  def test_with_collection_action_and_name_prefix_and_formatted
    actions = { 'a' =&gt; :get, 'b' =&gt; :put, 'c' =&gt; :post, 'd' =&gt; :delete }

    with_restful_routing :messages, :path_prefix =&gt; '/threads/:thread_id', :name_prefix =&gt; &quot;thread_&quot;, :collection =&gt; actions do
      assert_restful_routes_for :messages, :path_prefix =&gt; 'threads/1/', :name_prefix =&gt; 'thread_', :options =&gt; { :thread_id =&gt; '1' } do |options|
        actions.each do |action, method|
          assert_recognizes(options.merge(:action =&gt; action, :format =&gt; 'xml'), :path =&gt; &quot;/threads/1/messages/#{action}.xml&quot;, :method =&gt; method)
        end
      end

      assert_restful_named_routes_for :messages, :path_prefix =&gt; 'threads/1/', :name_prefix =&gt; 'thread_', :options =&gt; { :thread_id =&gt; '1' } do |options|
        actions.keys.each do |action|
          assert_named_route &quot;/threads/1/messages/#{action}.xml&quot;, &quot;#{action}_thread_messages_path&quot;, :action =&gt; action, :format =&gt; 'xml'
        end
      end
    end
  end

  def test_with_member_action
    [:put, :post].each do |method|
      with_restful_routing :messages, :member =&gt; { :mark =&gt; method } do
        mark_options = {:action =&gt; 'mark', :id =&gt; '1'}
        mark_path    = &quot;/messages/1/mark&quot;
        assert_restful_routes_for :messages do |options|
          assert_recognizes(options.merge(mark_options), :path =&gt; mark_path, :method =&gt; method)
        end

        assert_restful_named_routes_for :messages do |options|
          assert_named_route mark_path, :mark_message_path, mark_options
        end
      end
    end
  end

  def test_with_member_action_and_requirement
    expected_options = {:controller =&gt; 'messages', :action =&gt; 'mark', :id =&gt; '1.1.1'}
  
    with_restful_routing(:messages, :requirements =&gt; {:id =&gt; /[0-9]\.[0-9]\.[0-9]/}, :member =&gt; { :mark =&gt; :get }) do
      assert_recognizes(expected_options, :path =&gt; 'messages/1.1.1/mark', :method =&gt; :get)
    end
  end

  def test_member_when_override_paths_for_default_restful_actions_with
    [:put, :post].each do |method|
      with_restful_routing :messages, :member =&gt; { :mark =&gt; method }, :path_names =&gt; {:new =&gt; 'nuevo'} do
        mark_options = {:action =&gt; 'mark', :id =&gt; '1', :controller =&gt; &quot;messages&quot;}
        mark_path    = &quot;/messages/1/mark&quot;

        assert_restful_routes_for :messages, :path_names =&gt; {:new =&gt; 'nuevo'} do |options|
          assert_recognizes(options.merge(mark_options), :path =&gt; mark_path, :method =&gt; method)
        end

        assert_restful_named_routes_for :messages, :path_names =&gt; {:new =&gt; 'nuevo'} do |options|
          assert_named_route mark_path, :mark_message_path, mark_options
        end
      end
    end
  end

  def test_member_when_changed_default_restful_actions_and_path_names_not_specified
    default_path_names = ActionController::Base.resources_path_names
    ActionController::Base.resources_path_names = {:new =&gt; 'nuevo', :edit =&gt; 'editar'}

    with_restful_routing :messages do
      new_options = { :action =&gt; 'new', :controller =&gt; 'messages' }
      new_path = &quot;/messages/nuevo&quot;
      edit_options = { :action =&gt; 'edit', :id =&gt; '1', :controller =&gt; 'messages' }
      edit_path = &quot;/messages/1/editar&quot;

      assert_restful_routes_for :messages do |options|
        assert_recognizes(options.merge(new_options), :path =&gt; new_path, :method =&gt; :get)
      end

      assert_restful_routes_for :messages do |options|
        assert_recognizes(options.merge(edit_options), :path =&gt; edit_path, :method =&gt; :get)
      end
    end
  ensure
    ActionController::Base.resources_path_names = default_path_names
  end

  def test_with_two_member_actions_with_same_method
    [:put, :post].each do |method|
      with_restful_routing :messages, :member =&gt; { :mark =&gt; method, :unmark =&gt; method } do
        %w(mark unmark).each do |action|
          action_options = {:action =&gt; action, :id =&gt; '1'}
          action_path    = &quot;/messages/1/#{action}&quot;
          assert_restful_routes_for :messages do |options|
            assert_recognizes(options.merge(action_options), :path =&gt; action_path, :method =&gt; method)
          end

          assert_restful_named_routes_for :messages do |options|
            assert_named_route action_path, &quot;#{action}_message_path&quot;.to_sym, action_options
          end
        end
      end
    end
  end

  def test_array_as_collection_or_member_method_value
    with_restful_routing :messages, :collection =&gt; { :search =&gt; [:get, :post] }, :member =&gt; { :toggle =&gt; [:get, :post] } do
      assert_restful_routes_for :messages do |options|
        [:get, :post].each do |method|
          assert_recognizes(options.merge(:action =&gt; 'search'), :path =&gt; &quot;/messages/search&quot;, :method =&gt; method)
        end
        [:get, :post].each do |method|
          assert_recognizes(options.merge(:action =&gt; 'toggle', :id =&gt; '1'), :path =&gt; '/messages/1/toggle', :method =&gt; method)
        end
      end
    end
  end

  def test_with_new_action
    with_restful_routing :messages, :new =&gt; { :preview =&gt; :post } do
      preview_options = {:action =&gt; 'preview'}
      preview_path    = &quot;/messages/new/preview&quot;
      assert_restful_routes_for :messages do |options|
        assert_recognizes(options.merge(preview_options), :path =&gt; preview_path, :method =&gt; :post)
      end

      assert_restful_named_routes_for :messages do |options|
        assert_named_route preview_path, :preview_new_message_path, preview_options
      end
    end
  end

  def test_with_new_action_with_name_prefix
    with_restful_routing :messages, :new =&gt; { :preview =&gt; :post }, :path_prefix =&gt; '/threads/:thread_id', :name_prefix =&gt; 'thread_' do
      preview_options = {:action =&gt; 'preview', :thread_id =&gt; '1'}
      preview_path    = &quot;/threads/1/messages/new/preview&quot;
      assert_restful_routes_for :messages, :path_prefix =&gt; 'threads/1/', :name_prefix =&gt; 'thread_', :options =&gt; { :thread_id =&gt; '1' } do |options|
        assert_recognizes(options.merge(preview_options), :path =&gt; preview_path, :method =&gt; :post)
      end

      assert_restful_named_routes_for :messages, :path_prefix =&gt; 'threads/1/', :name_prefix =&gt; 'thread_', :options =&gt; { :thread_id =&gt; '1' } do |options|
        assert_named_route preview_path, :preview_new_thread_message_path, preview_options
      end
    end
  end

  def test_with_formatted_new_action_with_name_prefix
    with_restful_routing :messages, :new =&gt; { :preview =&gt; :post }, :path_prefix =&gt; '/threads/:thread_id', :name_prefix =&gt; 'thread_' do
      preview_options = {:action =&gt; 'preview', :thread_id =&gt; '1', :format =&gt; 'xml'}
      preview_path    = &quot;/threads/1/messages/new/preview.xml&quot;
      assert_restful_routes_for :messages, :path_prefix =&gt; 'threads/1/', :name_prefix =&gt; 'thread_', :options =&gt; { :thread_id =&gt; '1' } do |options|
        assert_recognizes(options.merge(preview_options), :path =&gt; preview_path, :method =&gt; :post)
      end

      assert_restful_named_routes_for :messages, :path_prefix =&gt; 'threads/1/', :name_prefix =&gt; 'thread_', :options =&gt; { :thread_id =&gt; '1' } do |options|
        assert_named_route preview_path, :preview_new_thread_message_path, preview_options
      end
    end
  end

  def test_override_new_method
    with_restful_routing :messages do
      assert_restful_routes_for :messages do |options|
        assert_recognizes(options.merge(:action =&gt; &quot;new&quot;), :path =&gt; &quot;/messages/new&quot;, :method =&gt; :get)
        assert_raise(ActionController::MethodNotAllowed) do
          ActionController::Routing::Routes.recognize_path(&quot;/messages/new&quot;, :method =&gt; :post)
        end
      end
    end

    with_restful_routing :messages, :new =&gt; { :new =&gt; :any } do
      assert_restful_routes_for :messages do |options|
        assert_recognizes(options.merge(:action =&gt; &quot;new&quot;), :path =&gt; &quot;/messages/new&quot;, :method =&gt; :post)
        assert_recognizes(options.merge(:action =&gt; &quot;new&quot;), :path =&gt; &quot;/messages/new&quot;, :method =&gt; :get)
      end
    end
  end

  def test_nested_restful_routes
    with_routing do |set|
      set.draw do |map|
        map.resources :threads do |map|
          map.resources :messages do |map|
            map.resources :comments
          end
        end
      end

      assert_simply_restful_for :threads
      assert_simply_restful_for :messages,
        :name_prefix =&gt; 'thread_',
        :path_prefix =&gt; 'threads/1/',
        :options =&gt; { :thread_id =&gt; '1' }
      assert_simply_restful_for :comments,
        :name_prefix =&gt; 'thread_message_',
        :path_prefix =&gt; 'threads/1/messages/2/',
        :options =&gt; { :thread_id =&gt; '1', :message_id =&gt; '2' }
    end
  end

  def test_nested_restful_routes_with_overwritten_defaults
    with_routing do |set|
      set.draw do |map|
        map.resources :threads do |map|
          map.resources :messages, :name_prefix =&gt; nil do |map|
            map.resources :comments, :name_prefix =&gt; nil
          end
        end
      end

      assert_simply_restful_for :threads
      assert_simply_restful_for :messages,
        :path_prefix =&gt; 'threads/1/',
        :options =&gt; { :thread_id =&gt; '1' }
      assert_simply_restful_for :comments,
        :path_prefix =&gt; 'threads/1/messages/2/',
        :options =&gt; { :thread_id =&gt; '1', :message_id =&gt; '2' }
    end
  end

  def test_shallow_nested_restful_routes
    with_routing do |set|
      set.draw do |map|
        map.resources :threads, :shallow =&gt; true do |map|
          map.resources :messages do |map|
            map.resources :comments
          end
        end
      end

      assert_simply_restful_for :threads,
        :shallow =&gt; true
      assert_simply_restful_for :messages,
        :name_prefix =&gt; 'thread_',
        :path_prefix =&gt; 'threads/1/',
        :shallow =&gt; true,
        :options =&gt; { :thread_id =&gt; '1' }
      assert_simply_restful_for :comments,
        :name_prefix =&gt; 'message_',
        :path_prefix =&gt; 'messages/2/',
        :shallow =&gt; true,
        :options =&gt; { :message_id =&gt; '2' }
    end
  end

  def test_shallow_nested_restful_routes_with_namespaces
    with_routing do |set|
      set.draw do |map|
        map.namespace :backoffice do |map|
          map.namespace :admin do |map|
            map.resources :products, :shallow =&gt; true do |map|
              map.resources :images
            end
          end
        end
      end

      assert_simply_restful_for :products,
        :controller =&gt; 'backoffice/admin/products',
        :namespace =&gt; 'backoffice/admin/',
        :name_prefix =&gt; 'backoffice_admin_',
        :path_prefix =&gt; 'backoffice/admin/',
        :shallow =&gt; true
      assert_simply_restful_for :images,
        :controller =&gt; 'backoffice/admin/images',
        :namespace =&gt; 'backoffice/admin/',
        :name_prefix =&gt; 'backoffice_admin_product_',
        :path_prefix =&gt; 'backoffice/admin/products/1/',
        :shallow =&gt; true,
        :options =&gt; { :product_id =&gt; '1' }
    end
  end

  def test_restful_routes_dont_generate_duplicates
    with_restful_routing :messages do
      routes = ActionController::Routing::Routes.routes
      routes.each do |route|
        routes.each do |r|
          next if route === r # skip the comparison instance
          assert distinct_routes?(route, r), &quot;Duplicate Route: #{route}&quot;
        end
      end
    end
  end

  def test_should_create_singleton_resource_routes
    with_singleton_resources :account do
      assert_singleton_restful_for :account
    end
  end

  def test_should_create_multiple_singleton_resource_routes
    with_singleton_resources :account, :logo do
      assert_singleton_restful_for :account
      assert_singleton_restful_for :logo
    end
  end

  def test_should_create_nested_singleton_resource_routes
    with_routing do |set|
      set.draw do |map|
        map.resource :admin, :controller =&gt; 'admin' do |admin|
          admin.resource :account
        end
      end

      assert_singleton_restful_for :admin, :controller =&gt; 'admin'
      assert_singleton_restful_for :account, :name_prefix =&gt; &quot;admin_&quot;, :path_prefix =&gt; 'admin/'
    end
  end

  def test_resource_has_many_should_become_nested_resources
    with_routing do |set|
      set.draw do |map|
        map.resources :messages, :has_many =&gt; [ :comments, :authors ]
      end

      assert_simply_restful_for :messages
      assert_simply_restful_for :comments, :name_prefix =&gt; &quot;message_&quot;, :path_prefix =&gt; 'messages/1/', :options =&gt; { :message_id =&gt; '1' }
      assert_simply_restful_for :authors,  :name_prefix =&gt; &quot;message_&quot;, :path_prefix =&gt; 'messages/1/', :options =&gt; { :message_id =&gt; '1' }
    end
  end

  def test_resources_has_many_hash_should_become_nested_resources
    with_routing do |set|
      set.draw do |map|
        map.resources :threads, :has_many =&gt; { :messages =&gt; [ :comments, { :authors =&gt; :threads } ] }
      end

      assert_simply_restful_for :threads
      assert_simply_restful_for :messages, :name_prefix =&gt; &quot;thread_&quot;, :path_prefix =&gt; 'threads/1/', :options =&gt; { :thread_id =&gt; '1' }
      assert_simply_restful_for :comments, :name_prefix =&gt; &quot;thread_message_&quot;, :path_prefix =&gt; 'threads/1/messages/1/', :options =&gt; { :thread_id =&gt; '1', :message_id =&gt; '1' }
      assert_simply_restful_for :authors,  :name_prefix =&gt; &quot;thread_message_&quot;, :path_prefix =&gt; 'threads/1/messages/1/', :options =&gt; { :thread_id =&gt; '1', :message_id =&gt; '1' }
      assert_simply_restful_for :threads,  :name_prefix =&gt; &quot;thread_message_author_&quot;, :path_prefix =&gt; 'threads/1/messages/1/authors/1/', :options =&gt; { :thread_id =&gt; '1', :message_id =&gt; '1', :author_id =&gt; '1' }
    end
  end

  def test_shallow_resource_has_many_should_become_shallow_nested_resources
    with_routing do |set|
      set.draw do |map|
        map.resources :messages, :has_many =&gt; [ :comments, :authors ], :shallow =&gt; true
      end

      assert_simply_restful_for :messages, :shallow =&gt; true
      assert_simply_restful_for :comments, :name_prefix =&gt; &quot;message_&quot;, :path_prefix =&gt; 'messages/1/', :shallow =&gt; true, :options =&gt; { :message_id =&gt; '1' }
      assert_simply_restful_for :authors,  :name_prefix =&gt; &quot;message_&quot;, :path_prefix =&gt; 'messages/1/', :shallow =&gt; true, :options =&gt; { :message_id =&gt; '1' }
    end
  end

  def test_resource_has_one_should_become_nested_resources
    with_routing do |set|
      set.draw do |map|
        map.resources :messages, :has_one =&gt; :logo
      end

      assert_simply_restful_for :messages
      assert_singleton_restful_for :logo, :name_prefix =&gt; 'message_', :path_prefix =&gt; 'messages/1/', :options =&gt; { :message_id =&gt; '1' }
    end
  end

  def test_shallow_resource_has_one_should_become_shallow_nested_resources
    with_routing do |set|
      set.draw do |map|
        map.resources :messages, :has_one =&gt; :logo, :shallow =&gt; true
      end

      assert_simply_restful_for :messages, :shallow =&gt; true
      assert_singleton_restful_for :logo, :name_prefix =&gt; 'message_', :path_prefix =&gt; 'messages/1/', :shallow =&gt; true, :options =&gt; { :message_id =&gt; '1' }
    end
  end

  def test_singleton_resource_with_member_action
    [:put, :post].each do |method|
      with_singleton_resources :account, :member =&gt; { :reset =&gt; method } do
        reset_options = {:action =&gt; 'reset'}
        reset_path    = &quot;/account/reset&quot;
        assert_singleton_routes_for :account do |options|
          assert_recognizes(options.merge(reset_options), :path =&gt; reset_path, :method =&gt; method)
        end

        assert_singleton_named_routes_for :account do |options|
          assert_named_route reset_path, :reset_account_path, reset_options
        end
      end
    end
  end

  def test_singleton_resource_with_two_member_actions_with_same_method
    [:put, :post].each do |method|
      with_singleton_resources :account, :member =&gt; { :reset =&gt; method, :disable =&gt; method } do
        %w(reset disable).each do |action|
          action_options = {:action =&gt; action}
          action_path    = &quot;/account/#{action}&quot;
          assert_singleton_routes_for :account do |options|
            assert_recognizes(options.merge(action_options), :path =&gt; action_path, :method =&gt; method)
          end

          assert_singleton_named_routes_for :account do |options|
            assert_named_route action_path, &quot;#{action}_account_path&quot;.to_sym, action_options
          end
        end
      end
    end
  end

  def test_should_nest_resources_in_singleton_resource
    with_routing do |set|
      set.draw do |map|
        map.resource :account do |account|
          account.resources :messages
        end
      end

      assert_singleton_restful_for :account
      assert_simply_restful_for :messages, :name_prefix =&gt; &quot;account_&quot;, :path_prefix =&gt; 'account/'
    end
  end

  def test_should_nest_resources_in_singleton_resource_with_path_prefix
    with_routing do |set|
      set.draw do |map|
        map.resource(:account, :path_prefix =&gt; ':site_id') do |account|
          account.resources :messages
        end
      end

      assert_singleton_restful_for :account, :path_prefix =&gt; '7/', :options =&gt; { :site_id =&gt; '7' }
      assert_simply_restful_for :messages, :name_prefix =&gt; &quot;account_&quot;, :path_prefix =&gt; '7/account/', :options =&gt; { :site_id =&gt; '7' }
    end
  end

  def test_should_nest_singleton_resource_in_resources
    with_routing do |set|
      set.draw do |map|
        map.resources :threads do |thread|
          thread.resource :admin, :controller =&gt; 'admin'
        end
      end

      assert_simply_restful_for :threads
      assert_singleton_restful_for :admin, :controller =&gt; 'admin', :name_prefix =&gt; 'thread_', :path_prefix =&gt; 'threads/5/', :options =&gt; { :thread_id =&gt; '5' }
    end
  end

  def test_should_not_allow_delete_or_put_on_collection_path
    controller_name = :messages
    with_restful_routing controller_name do
      options = { :controller =&gt; controller_name.to_s }
      collection_path = &quot;/#{controller_name}&quot;

      assert_raise(ActionController::MethodNotAllowed) do
        assert_recognizes(options.merge(:action =&gt; 'update'), :path =&gt; collection_path, :method =&gt; :put)
      end

      assert_raise(ActionController::MethodNotAllowed) do
        assert_recognizes(options.merge(:action =&gt; 'destroy'), :path =&gt; collection_path, :method =&gt; :delete)
      end
    end
  end

  def test_should_not_allow_invalid_head_method_for_member_routes
    with_routing do |set|
      set.draw do |map|
        assert_raise(ArgumentError) do
          map.resources :messages, :member =&gt; {:something =&gt; :head}
        end
      end
    end
  end

  def test_should_not_allow_invalid_http_methods_for_member_routes
    with_routing do |set|
      set.draw do |map|
        assert_raise(ArgumentError) do
          map.resources :messages, :member =&gt; {:something =&gt; :invalid}
        end
      end
    end
  end

  def test_resource_action_separator
    with_routing do |set|
      set.draw do |map|
        map.resources :messages, :collection =&gt; {:search =&gt; :get}, :new =&gt; {:preview =&gt; :any}, :name_prefix =&gt; 'thread_', :path_prefix =&gt; '/threads/:thread_id'
        map.resource :account, :member =&gt; {:login =&gt; :get}, :new =&gt; {:preview =&gt; :any}, :name_prefix =&gt; 'admin_', :path_prefix =&gt; '/admin'
      end

      action_separator = ActionController::Base.resource_action_separator

      assert_simply_restful_for :messages, :name_prefix =&gt; 'thread_', :path_prefix =&gt; 'threads/1/', :options =&gt; { :thread_id =&gt; '1' }
      assert_named_route &quot;/threads/1/messages#{action_separator}search&quot;, &quot;search_thread_messages_path&quot;, {}
      assert_named_route &quot;/threads/1/messages/new&quot;, &quot;new_thread_message_path&quot;, {}
      assert_named_route &quot;/threads/1/messages/new#{action_separator}preview&quot;, &quot;preview_new_thread_message_path&quot;, {}
      assert_singleton_restful_for :account, :name_prefix =&gt; 'admin_', :path_prefix =&gt; 'admin/'
      assert_named_route &quot;/admin/account#{action_separator}login&quot;, &quot;login_admin_account_path&quot;, {}
      assert_named_route &quot;/admin/account/new&quot;, &quot;new_admin_account_path&quot;, {}
      assert_named_route &quot;/admin/account/new#{action_separator}preview&quot;, &quot;preview_new_admin_account_path&quot;, {}
    end
  end

  def test_new_style_named_routes_for_resource
    with_routing do |set|
      set.draw do |map|
        map.resources :messages, :collection =&gt; {:search =&gt; :get}, :new =&gt; {:preview =&gt; :any}, :name_prefix =&gt; 'thread_', :path_prefix =&gt; '/threads/:thread_id'
      end
      assert_simply_restful_for :messages, :name_prefix =&gt; 'thread_', :path_prefix =&gt; 'threads/1/', :options =&gt; { :thread_id =&gt; '1' }
      assert_named_route &quot;/threads/1/messages/search&quot;, &quot;search_thread_messages_path&quot;, {}
      assert_named_route &quot;/threads/1/messages/new&quot;, &quot;new_thread_message_path&quot;, {}
      assert_named_route &quot;/threads/1/messages/new/preview&quot;, &quot;preview_new_thread_message_path&quot;, {}
    end
  end

  def test_new_style_named_routes_for_singleton_resource
    with_routing do |set|
      set.draw do |map|
        map.resource :account, :member =&gt; {:login =&gt; :get}, :new =&gt; {:preview =&gt; :any}, :name_prefix =&gt; 'admin_', :path_prefix =&gt; '/admin'
      end
      assert_singleton_restful_for :account, :name_prefix =&gt; 'admin_', :path_prefix =&gt; 'admin/'
      assert_named_route &quot;/admin/account/login&quot;, &quot;login_admin_account_path&quot;, {}
      assert_named_route &quot;/admin/account/new&quot;, &quot;new_admin_account_path&quot;, {}
      assert_named_route &quot;/admin/account/new/preview&quot;, &quot;preview_new_admin_account_path&quot;, {}
    end
  end

  def test_resources_in_namespace
    with_routing do |set|
      set.draw do |map|
        map.namespace :backoffice do |backoffice|
          backoffice.resources :products
        end
      end

      assert_simply_restful_for :products, :controller =&gt; &quot;backoffice/products&quot;, :name_prefix =&gt; 'backoffice_', :path_prefix =&gt; 'backoffice/'
    end
  end

  def test_resource_has_many_in_namespace
    with_routing do |set|
      set.draw do |map|
        map.namespace :backoffice do |backoffice|
          backoffice.resources :products, :has_many =&gt; :tags
        end
      end

      assert_simply_restful_for :products,  :controller =&gt; &quot;backoffice/products&quot;, :name_prefix =&gt; 'backoffice_',          :path_prefix =&gt; 'backoffice/'
      assert_simply_restful_for :tags,      :controller =&gt; &quot;backoffice/tags&quot;,     :name_prefix =&gt; &quot;backoffice_product_&quot;,  :path_prefix =&gt; 'backoffice/products/1/', :options =&gt; { :product_id =&gt; '1' }
    end
  end

  def test_resource_has_one_in_namespace
    with_routing do |set|
      set.draw do |map|
        map.namespace :backoffice do |backoffice|
          backoffice.resources :products, :has_one =&gt; :manufacturer
        end
      end

      assert_simply_restful_for :products, :controller =&gt; &quot;backoffice/products&quot;, :name_prefix =&gt; 'backoffice_', :path_prefix =&gt; 'backoffice/'
      assert_singleton_restful_for :manufacturer, :controller =&gt; &quot;backoffice/manufacturers&quot;, :name_prefix =&gt; 'backoffice_product_', :path_prefix =&gt; 'backoffice/products/1/', :options =&gt; { :product_id =&gt; '1' }
    end
  end

  def test_resources_in_nested_namespace
    with_routing do |set|
      set.draw do |map|
        map.namespace :backoffice do |backoffice|
          backoffice.namespace :admin do |admin|
            admin.resources :products
          end
        end
      end

      assert_simply_restful_for :products, :controller =&gt; &quot;backoffice/admin/products&quot;, :name_prefix =&gt; 'backoffice_admin_', :path_prefix =&gt; 'backoffice/admin/'
    end
  end

  def test_resources_using_namespace
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :namespace =&gt; &quot;backoffice/&quot;
      end

      assert_simply_restful_for :products, :controller =&gt; &quot;backoffice/products&quot;
    end
  end

  def test_nested_resources_using_namespace
    with_routing do |set|
      set.draw do |map|
        map.namespace :backoffice do |backoffice|
          backoffice.resources :products do |products|
            products.resources :images
          end
        end
      end

      assert_simply_restful_for :images, :controller =&gt; &quot;backoffice/images&quot;, :name_prefix =&gt; 'backoffice_product_', :path_prefix =&gt; 'backoffice/products/1/', :options =&gt; {:product_id =&gt; '1'}
    end
  end

  def test_nested_resources_in_nested_namespace
    with_routing do |set|
      set.draw do |map|
        map.namespace :backoffice do |backoffice|
          backoffice.namespace :admin do |admin|
            admin.resources :products do |products|
              products.resources :images
            end
          end
        end
      end

      assert_simply_restful_for :images, :controller =&gt; &quot;backoffice/admin/images&quot;, :name_prefix =&gt; 'backoffice_admin_product_', :path_prefix =&gt; 'backoffice/admin/products/1/', :options =&gt; {:product_id =&gt; '1'}
    end
  end

  def test_with_path_segment
    with_restful_routing :messages do
      assert_simply_restful_for :messages
      assert_recognizes({:controller =&gt; &quot;messages&quot;, :action =&gt; &quot;index&quot;}, &quot;/messages&quot;)
      assert_recognizes({:controller =&gt; &quot;messages&quot;, :action =&gt; &quot;index&quot;}, &quot;/messages/&quot;)
    end

     with_restful_routing :messages, :as =&gt; 'reviews' do
       assert_simply_restful_for :messages, :as =&gt; 'reviews'
      assert_recognizes({:controller =&gt; &quot;messages&quot;, :action =&gt; &quot;index&quot;}, &quot;/reviews&quot;)
      assert_recognizes({:controller =&gt; &quot;messages&quot;, :action =&gt; &quot;index&quot;}, &quot;/reviews/&quot;)
     end
  end

  def test_multiple_with_path_segment_and_controller
    with_routing do |set|
      set.draw do |map|
        map.resources :products do |products|
          products.resources :product_reviews, :as =&gt; 'reviews', :controller =&gt; 'messages'
        end
        map.resources :tutors do |tutors|
          tutors.resources :tutor_reviews, :as =&gt; 'reviews', :controller =&gt; 'comments'
        end
      end

      assert_simply_restful_for :product_reviews, :controller=&gt;'messages', :as =&gt; 'reviews', :name_prefix =&gt; 'product_', :path_prefix =&gt; 'products/1/', :options =&gt; {:product_id =&gt; '1'}
      assert_simply_restful_for :tutor_reviews,:controller=&gt;'comments', :as =&gt; 'reviews', :name_prefix =&gt; 'tutor_', :path_prefix =&gt; 'tutors/1/', :options =&gt; {:tutor_id =&gt; '1'}
    end
  end

  def test_with_path_segment_path_prefix_requirements
    expected_options = {:controller =&gt; 'messages', :action =&gt; 'show', :thread_id =&gt; '1.1.1', :id =&gt; '1'}
    with_restful_routing :messages, :as =&gt; 'comments',:path_prefix =&gt; '/thread/:thread_id', :requirements =&gt; { :thread_id =&gt; /[0-9]\.[0-9]\.[0-9]/ } do
      assert_recognizes(expected_options, :path =&gt; 'thread/1.1.1/comments/1', :method =&gt; :get)
    end
  end

  def test_resource_has_only_show_action
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :only =&gt; :show
      end

      assert_resource_allowed_routes('products', {},                    { :id =&gt; '1' }, :show, [:index, :new, :create, :edit, :update, :destroy])
      assert_resource_allowed_routes('products', { :format =&gt; 'xml' },  { :id =&gt; '1' }, :show, [:index, :new, :create, :edit, :update, :destroy])
    end
  end

  def test_singleton_resource_has_only_show_action
    with_routing do |set|
      set.draw do |map|
        map.resource :account, :only =&gt; :show
      end

      assert_singleton_resource_allowed_routes('accounts', {},                    :show, [:index, :new, :create, :edit, :update, :destroy])
      assert_singleton_resource_allowed_routes('accounts', { :format =&gt; 'xml' },  :show, [:index, :new, :create, :edit, :update, :destroy])
    end
  end

  def test_resource_does_not_have_destroy_action
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :except =&gt; :destroy
      end

      assert_resource_allowed_routes('products', {},                    { :id =&gt; '1' }, [:index, :new, :create, :show, :edit, :update], :destroy)
      assert_resource_allowed_routes('products', { :format =&gt; 'xml' },  { :id =&gt; '1' }, [:index, :new, :create, :show, :edit, :update], :destroy)
    end
  end

  def test_singleton_resource_does_not_have_destroy_action
    with_routing do |set|
      set.draw do |map|
        map.resource :account, :except =&gt; :destroy
      end

      assert_singleton_resource_allowed_routes('accounts', {},                    [:new, :create, :show, :edit, :update], :destroy)
      assert_singleton_resource_allowed_routes('accounts', { :format =&gt; 'xml' },  [:new, :create, :show, :edit, :update], :destroy)
    end
  end

  def test_resource_has_only_create_action_and_named_route
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :only =&gt; :create
      end

      assert_resource_allowed_routes('products', {},                    { :id =&gt; '1' }, :create, [:index, :new, :show, :edit, :update, :destroy])
      assert_resource_allowed_routes('products', { :format =&gt; 'xml' },  { :id =&gt; '1' }, :create, [:index, :new, :show, :edit, :update, :destroy])

      assert_not_nil set.named_routes[:products]
    end
  end

  def test_resource_has_only_update_action_and_named_route
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :only =&gt; :update
      end

      assert_resource_allowed_routes('products', {},                    { :id =&gt; '1' }, :update, [:index, :new, :create, :show, :edit, :destroy])
      assert_resource_allowed_routes('products', { :format =&gt; 'xml' },  { :id =&gt; '1' }, :update, [:index, :new, :create, :show, :edit, :destroy])

      assert_not_nil set.named_routes[:product]
    end
  end

  def test_resource_has_only_destroy_action_and_named_route
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :only =&gt; :destroy
      end

      assert_resource_allowed_routes('products', {},                    { :id =&gt; '1' }, :destroy, [:index, :new, :create, :show, :edit, :update])
      assert_resource_allowed_routes('products', { :format =&gt; 'xml' },  { :id =&gt; '1' }, :destroy, [:index, :new, :create, :show, :edit, :update])

      assert_not_nil set.named_routes[:product]
    end
  end

  def test_singleton_resource_has_only_create_action_and_named_route
    with_routing do |set|
      set.draw do |map|
        map.resource :account, :only =&gt; :create
      end

      assert_singleton_resource_allowed_routes('accounts', {},                    :create, [:new, :show, :edit, :update, :destroy])
      assert_singleton_resource_allowed_routes('accounts', { :format =&gt; 'xml' },  :create, [:new, :show, :edit, :update, :destroy])

      assert_not_nil set.named_routes[:account]
    end
  end

  def test_singleton_resource_has_only_update_action_and_named_route
    with_routing do |set|
      set.draw do |map|
        map.resource :account, :only =&gt; :update
      end

      assert_singleton_resource_allowed_routes('accounts', {},                    :update, [:new, :create, :show, :edit, :destroy])
      assert_singleton_resource_allowed_routes('accounts', { :format =&gt; 'xml' },  :update, [:new, :create, :show, :edit, :destroy])

      assert_not_nil set.named_routes[:account]
    end
  end

  def test_singleton_resource_has_only_destroy_action_and_named_route
    with_routing do |set|
      set.draw do |map|
        map.resource :account, :only =&gt; :destroy
      end

      assert_singleton_resource_allowed_routes('accounts', {},                    :destroy, [:new, :create, :show, :edit, :update])
      assert_singleton_resource_allowed_routes('accounts', { :format =&gt; 'xml' },  :destroy, [:new, :create, :show, :edit, :update])

      assert_not_nil set.named_routes[:account]
    end
  end

  def test_resource_has_only_collection_action
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :except =&gt; :all, :collection =&gt; { :sale =&gt; :get }
      end

      assert_resource_allowed_routes('products', {},                    { :id =&gt; '1' }, [], [:index, :new, :create, :show, :edit, :update, :destroy])
      assert_resource_allowed_routes('products', { :format =&gt; 'xml' },  { :id =&gt; '1' }, [], [:index, :new, :create, :show, :edit, :update, :destroy])

      assert_recognizes({ :controller =&gt; 'products', :action =&gt; 'sale' },                   :path =&gt; 'products/sale',     :method =&gt; :get)
      assert_recognizes({ :controller =&gt; 'products', :action =&gt; 'sale', :format =&gt; 'xml' }, :path =&gt; 'products/sale.xml', :method =&gt; :get)
    end
  end

  def test_resource_has_only_member_action
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :except =&gt; :all, :member =&gt; { :preview =&gt; :get }
      end

      assert_resource_allowed_routes('products', {},                    { :id =&gt; '1' }, [], [:index, :new, :create, :show, :edit, :update, :destroy])
      assert_resource_allowed_routes('products', { :format =&gt; 'xml' },  { :id =&gt; '1' }, [], [:index, :new, :create, :show, :edit, :update, :destroy])

      assert_recognizes({ :controller =&gt; 'products', :action =&gt; 'preview', :id =&gt; '1' },                    :path =&gt; 'products/1/preview',      :method =&gt; :get)
      assert_recognizes({ :controller =&gt; 'products', :action =&gt; 'preview', :id =&gt; '1', :format =&gt; 'xml' },  :path =&gt; 'products/1/preview.xml',  :method =&gt; :get)
    end
  end

  def test_singleton_resource_has_only_member_action
    with_routing do |set|
      set.draw do |map|
        map.resource :account, :except =&gt; :all, :member =&gt; { :signup =&gt; :get }
      end

      assert_singleton_resource_allowed_routes('accounts', {},                    [], [:new, :create, :show, :edit, :update, :destroy])
      assert_singleton_resource_allowed_routes('accounts', { :format =&gt; 'xml' },  [], [:new, :create, :show, :edit, :update, :destroy])

      assert_recognizes({ :controller =&gt; 'accounts', :action =&gt; 'signup' },                   :path =&gt; 'account/signup',      :method =&gt; :get)
      assert_recognizes({ :controller =&gt; 'accounts', :action =&gt; 'signup', :format =&gt; 'xml' }, :path =&gt; 'account/signup.xml',  :method =&gt; :get)
    end
  end

  def test_nested_resource_has_only_show_and_member_action
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :only =&gt; [:index, :show] do |product|
          product.resources :images, :member =&gt; { :thumbnail =&gt; :get }, :only =&gt; :show
        end
      end

      assert_resource_allowed_routes('images', { :product_id =&gt; '1' },                    { :id =&gt; '2' }, :show, [:index, :new, :create, :edit, :update, :destroy], 'products/1/images')
      assert_resource_allowed_routes('images', { :product_id =&gt; '1', :format =&gt; 'xml' },  { :id =&gt; '2' }, :show, [:index, :new, :create, :edit, :update, :destroy], 'products/1/images')

      assert_recognizes({ :controller =&gt; 'images', :action =&gt; 'thumbnail', :product_id =&gt; '1', :id =&gt; '2' },                    :path =&gt; 'products/1/images/2/thumbnail', :method =&gt; :get)
      assert_recognizes({ :controller =&gt; 'images', :action =&gt; 'thumbnail', :product_id =&gt; '1', :id =&gt; '2', :format =&gt; 'jpg' },  :path =&gt; 'products/1/images/2/thumbnail.jpg', :method =&gt; :get)
    end
  end

  def test_nested_resource_does_not_inherit_only_option
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :only =&gt; :show do |product|
          product.resources :images, :except =&gt; :destroy
        end
      end

      assert_resource_allowed_routes('images', { :product_id =&gt; '1' },                    { :id =&gt; '2' }, [:index, :new, :create, :show, :edit, :update], :destroy, 'products/1/images')
      assert_resource_allowed_routes('images', { :product_id =&gt; '1', :format =&gt; 'xml' },  { :id =&gt; '2' }, [:index, :new, :create, :show, :edit, :update], :destroy, 'products/1/images')
    end
  end

  def test_nested_resource_does_not_inherit_only_option_by_default
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :only =&gt; :show do |product|
          product.resources :images
        end
      end

      assert_resource_allowed_routes('images', { :product_id =&gt; '1' },                    { :id =&gt; '2' }, [:index, :new, :create, :show, :edit, :update, :destory], [], 'products/1/images')
      assert_resource_allowed_routes('images', { :product_id =&gt; '1', :format =&gt; 'xml' },  { :id =&gt; '2' }, [:index, :new, :create, :show, :edit, :update, :destroy], [], 'products/1/images')
    end
  end

  def test_nested_resource_does_not_inherit_except_option
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :except =&gt; :show do |product|
          product.resources :images, :only =&gt; :destroy
        end
      end

      assert_resource_allowed_routes('images', { :product_id =&gt; '1' },                    { :id =&gt; '2' }, :destroy, [:index, :new, :create, :show, :edit, :update], 'products/1/images')
      assert_resource_allowed_routes('images', { :product_id =&gt; '1', :format =&gt; 'xml' },  { :id =&gt; '2' }, :destroy, [:index, :new, :create, :show, :edit, :update], 'products/1/images')
    end
  end

  def test_nested_resource_does_not_inherit_except_option_by_default
    with_routing do |set|
      set.draw do |map|
        map.resources :products, :except =&gt; :show do |product|
          product.resources :images
        end
      end

      assert_resource_allowed_routes('images', { :product_id =&gt; '1' },                    { :id =&gt; '2' }, [:index, :new, :create, :show, :edit, :update, :destroy], [], 'products/1/images')
      assert_resource_allowed_routes('images', { :product_id =&gt; '1', :format =&gt; 'xml' },  { :id =&gt; '2' }, [:index, :new, :create, :show, :edit, :update, :destroy], [], 'products/1/images')
    end
  end

  def test_default_singleton_restful_route_uses_get
    with_routing do |set|
      set.draw do |map|
        map.resource :product
      end

      assert_equal :get, set.named_routes.routes[:product].conditions[:method]
    end
  end

  protected
    def with_restful_routing(*args)
      with_routing do |set|
        set.draw { |map| map.resources(*args) }
        yield
      end
    end

    def with_singleton_resources(*args)
      with_routing do |set|
        set.draw { |map| map.resource(*args) }
        yield
      end
    end

    # runs assert_restful_routes_for and assert_restful_named_routes for on the controller_name and options, without passing a block.
    def assert_simply_restful_for(controller_name, options = {})
      assert_restful_routes_for       controller_name, options
      assert_restful_named_routes_for controller_name, nil, options
    end

    def assert_singleton_restful_for(singleton_name, options = {})
      assert_singleton_routes_for       singleton_name, options
      assert_singleton_named_routes_for singleton_name, options
    end

    def assert_restful_routes_for(controller_name, options = {})
      options[:options] ||= {}
      options[:options][:controller] = options[:controller] || controller_name.to_s

      if options[:shallow]
        options[:shallow_options] ||= {}
        options[:shallow_options][:controller] = options[:options][:controller]
      else
        options[:shallow_options] = options[:options]
      end

      new_action    = ActionController::Base.resources_path_names[:new] || &quot;new&quot;
      edit_action   = ActionController::Base.resources_path_names[:edit] || &quot;edit&quot;
      if options[:path_names]
        new_action  = options[:path_names][:new] if options[:path_names][:new]
        edit_action = options[:path_names][:edit] if options[:path_names][:edit]
      end

      path                       = &quot;#{options[:as] || controller_name}&quot;
      collection_path            = &quot;/#{options[:path_prefix]}#{path}&quot;
      shallow_path               = &quot;/#{options[:shallow] ? options[:namespace] : options[:path_prefix]}#{path}&quot;
      member_path                = &quot;#{shallow_path}/1&quot;
      new_path                   = &quot;#{collection_path}/#{new_action}&quot;
      edit_member_path           = &quot;#{member_path}/#{edit_action}&quot;
      formatted_edit_member_path = &quot;#{member_path}/#{edit_action}.xml&quot;

      with_options(options[:options]) do |controller|
        controller.assert_routing collection_path,            :action =&gt; 'index'
        controller.assert_routing new_path,                   :action =&gt; 'new'
        controller.assert_routing &quot;#{collection_path}.xml&quot;,   :action =&gt; 'index',            :format =&gt; 'xml'
        controller.assert_routing &quot;#{new_path}.xml&quot;,          :action =&gt; 'new',              :format =&gt; 'xml'
      end

      with_options(options[:shallow_options]) do |controller|
        controller.assert_routing member_path,                :action =&gt; 'show', :id =&gt; '1'
        controller.assert_routing edit_member_path,           :action =&gt; 'edit', :id =&gt; '1'
        controller.assert_routing &quot;#{member_path}.xml&quot;,       :action =&gt; 'show', :id =&gt; '1', :format =&gt; 'xml'
        controller.assert_routing formatted_edit_member_path, :action =&gt; 'edit', :id =&gt; '1', :format =&gt; 'xml'
      end

      assert_recognizes(options[:options].merge(:action =&gt; 'index'),               :path =&gt; collection_path,  :method =&gt; :get)
      assert_recognizes(options[:options].merge(:action =&gt; 'new'),                 :path =&gt; new_path,         :method =&gt; :get)
      assert_recognizes(options[:options].merge(:action =&gt; 'create'),              :path =&gt; collection_path,  :method =&gt; :post)
      assert_recognizes(options[:shallow_options].merge(:action =&gt; 'show',    :id =&gt; '1'), :path =&gt; member_path,      :method =&gt; :get)
      assert_recognizes(options[:shallow_options].merge(:action =&gt; 'edit',    :id =&gt; '1'), :path =&gt; edit_member_path, :method =&gt; :get)
      assert_recognizes(options[:shallow_options].merge(:action =&gt; 'update',  :id =&gt; '1'), :path =&gt; member_path,      :method =&gt; :put)
      assert_recognizes(options[:shallow_options].merge(:action =&gt; 'destroy', :id =&gt; '1'), :path =&gt; member_path,      :method =&gt; :delete)

      assert_recognizes(options[:options].merge(:action =&gt; 'index',  :format =&gt; 'xml'), :path =&gt; &quot;#{collection_path}.xml&quot;,   :method =&gt; :get)
      assert_recognizes(options[:options].merge(:action =&gt; 'new',    :format =&gt; 'xml'), :path =&gt; &quot;#{new_path}.xml&quot;,          :method =&gt; :get)
      assert_recognizes(options[:options].merge(:action =&gt; 'create', :format =&gt; 'xml'), :path =&gt; &quot;#{collection_path}.xml&quot;,   :method =&gt; :post)
      assert_recognizes(options[:shallow_options].merge(:action =&gt; 'show',    :id =&gt; '1', :format =&gt; 'xml'), :path =&gt; &quot;#{member_path}.xml&quot;,       :method =&gt; :get)
      assert_recognizes(options[:shallow_options].merge(:action =&gt; 'edit',    :id =&gt; '1', :format =&gt; 'xml'), :path =&gt; formatted_edit_member_path, :method =&gt; :get)
      assert_recognizes(options[:shallow_options].merge(:action =&gt; 'update',  :id =&gt; '1', :format =&gt; 'xml'), :path =&gt; &quot;#{member_path}.xml&quot;,       :method =&gt; :put)
      assert_recognizes(options[:shallow_options].merge(:action =&gt; 'destroy', :id =&gt; '1', :format =&gt; 'xml'), :path =&gt; &quot;#{member_path}.xml&quot;,       :method =&gt; :delete)

      yield options[:options] if block_given?
    end

    # test named routes like foo_path and foos_path map to the correct options.
    def assert_restful_named_routes_for(controller_name, singular_name = nil, options = {})
      if singular_name.is_a?(Hash)
        options       = singular_name
        singular_name = nil
      end
      singular_name ||= controller_name.to_s.singularize

      options[:options] ||= {}
      options[:options][:controller] = options[:controller] || controller_name.to_s

      if options[:shallow]
        options[:shallow_options] ||= {}
        options[:shallow_options][:controller] = options[:options][:controller]
      else
        options[:shallow_options] = options[:options]
      end

      @controller = &quot;#{options[:options][:controller].camelize}Controller&quot;.constantize.new
      @request    = ActionController::TestRequest.new
      @response   = ActionController::TestResponse.new
      get :index, options[:options]
      options[:options].delete :action

      path = &quot;#{options[:as] || controller_name}&quot;
      shallow_path = &quot;/#{options[:shallow] ? options[:namespace] : options[:path_prefix]}#{path}&quot;
      full_path = &quot;/#{options[:path_prefix]}#{path}&quot;
      name_prefix = options[:name_prefix]
      shallow_prefix = options[:shallow] ? options[:namespace].try(:gsub, /\//, '_') : options[:name_prefix]

      new_action  = &quot;new&quot;
      edit_action = &quot;edit&quot;
      if options[:path_names]
        new_action  = options[:path_names][:new]  || &quot;new&quot;
        edit_action = options[:path_names][:edit] || &quot;edit&quot;
      end

      assert_named_route &quot;#{full_path}&quot;, &quot;#{name_prefix}#{controller_name}_path&quot;, options[:options]
      assert_named_route &quot;#{full_path}.xml&quot;, &quot;#{name_prefix}#{controller_name}_path&quot;, options[:options].merge(:format =&gt; 'xml')
      assert_named_route &quot;#{shallow_path}/1&quot;, &quot;#{shallow_prefix}#{singular_name}_path&quot;, options[:shallow_options].merge(:id =&gt; '1')
      assert_named_route &quot;#{shallow_path}/1.xml&quot;, &quot;#{shallow_prefix}#{singular_name}_path&quot;, options[:shallow_options].merge(:id =&gt; '1', :format =&gt; 'xml')

      assert_named_route &quot;#{full_path}/#{new_action}&quot;, &quot;new_#{name_prefix}#{singular_name}_path&quot;, options[:options]
      assert_named_route &quot;#{full_path}/#{new_action}.xml&quot;, &quot;new_#{name_prefix}#{singular_name}_path&quot;, options[:options].merge(:format =&gt; 'xml')
      assert_named_route &quot;#{shallow_path}/1/#{edit_action}&quot;, &quot;edit_#{shallow_prefix}#{singular_name}_path&quot;, options[:shallow_options].merge(:id =&gt; '1')
      assert_named_route &quot;#{shallow_path}/1/#{edit_action}.xml&quot;, &quot;edit_#{shallow_prefix}#{singular_name}_path&quot;, options[:shallow_options].merge(:id =&gt; '1', :format =&gt; 'xml')

      yield options[:options] if block_given?
    end

    def assert_singleton_routes_for(singleton_name, options = {})
      options[:options] ||= {}
      options[:options][:controller] = options[:controller] || singleton_name.to_s.pluralize

      full_path           = &quot;/#{options[:path_prefix]}#{options[:as] || singleton_name}&quot;
      new_path            = &quot;#{full_path}/new&quot;
      edit_path           = &quot;#{full_path}/edit&quot;
      formatted_edit_path = &quot;#{full_path}/edit.xml&quot;

      with_options options[:options] do |controller|
        controller.assert_routing full_path,           :action =&gt; 'show'
        controller.assert_routing new_path,            :action =&gt; 'new'
        controller.assert_routing edit_path,           :action =&gt; 'edit'
        controller.assert_routing &quot;#{full_path}.xml&quot;,  :action =&gt; 'show', :format =&gt; 'xml'
        controller.assert_routing &quot;#{new_path}.xml&quot;,   :action =&gt; 'new',  :format =&gt; 'xml'
        controller.assert_routing formatted_edit_path, :action =&gt; 'edit', :format =&gt; 'xml'
      end

      assert_recognizes(options[:options].merge(:action =&gt; 'show'),    :path =&gt; full_path, :method =&gt; :get)
      assert_recognizes(options[:options].merge(:action =&gt; 'new'),     :path =&gt; new_path,  :method =&gt; :get)
      assert_recognizes(options[:options].merge(:action =&gt; 'edit'),    :path =&gt; edit_path, :method =&gt; :get)
      assert_recognizes(options[:options].merge(:action =&gt; 'create'),  :path =&gt; full_path, :method =&gt; :post)
      assert_recognizes(options[:options].merge(:action =&gt; 'update'),  :path =&gt; full_path, :method =&gt; :put)
      assert_recognizes(options[:options].merge(:action =&gt; 'destroy'), :path =&gt; full_path, :method =&gt; :delete)

      assert_recognizes(options[:options].merge(:action =&gt; 'show',    :format =&gt; 'xml'), :path =&gt; &quot;#{full_path}.xml&quot;,  :method =&gt; :get)
      assert_recognizes(options[:options].merge(:action =&gt; 'new',     :format =&gt; 'xml'), :path =&gt; &quot;#{new_path}.xml&quot;,   :method =&gt; :get)
      assert_recognizes(options[:options].merge(:action =&gt; 'edit',    :format =&gt; 'xml'), :path =&gt; formatted_edit_path, :method =&gt; :get)
      assert_recognizes(options[:options].merge(:action =&gt; 'create',  :format =&gt; 'xml'), :path =&gt; &quot;#{full_path}.xml&quot;,  :method =&gt; :post)
      assert_recognizes(options[:options].merge(:action =&gt; 'update',  :format =&gt; 'xml'), :path =&gt; &quot;#{full_path}.xml&quot;,  :method =&gt; :put)
      assert_recognizes(options[:options].merge(:action =&gt; 'destroy', :format =&gt; 'xml'), :path =&gt; &quot;#{full_path}.xml&quot;,  :method =&gt; :delete)

      yield options[:options] if block_given?
    end

    def assert_singleton_named_routes_for(singleton_name, options = {})
      (options[:options] ||= {})[:controller] ||= singleton_name.to_s.pluralize
      @controller = &quot;#{options[:options][:controller].camelize}Controller&quot;.constantize.new
      @request    = ActionController::TestRequest.new
      @response   = ActionController::TestResponse.new
      get :show, options[:options]
      options[:options].delete :action

      full_path = &quot;/#{options[:path_prefix]}#{options[:as] || singleton_name}&quot;
      name_prefix = options[:name_prefix]

      assert_named_route &quot;#{full_path}&quot;,          &quot;#{name_prefix}#{singleton_name}_path&quot;,                options[:options]
      assert_named_route &quot;#{full_path}.xml&quot;,      &quot;#{name_prefix}#{singleton_name}_path&quot;,      options[:options].merge(:format =&gt; 'xml')

      assert_named_route &quot;#{full_path}/new&quot;,      &quot;new_#{name_prefix}#{singleton_name}_path&quot;,            options[:options]
      assert_named_route &quot;#{full_path}/new.xml&quot;,  &quot;new_#{name_prefix}#{singleton_name}_path&quot;,  options[:options].merge(:format =&gt; 'xml')
      assert_named_route &quot;#{full_path}/edit&quot;,     &quot;edit_#{name_prefix}#{singleton_name}_path&quot;,           options[:options]
      assert_named_route &quot;#{full_path}/edit.xml&quot;, &quot;edit_#{name_prefix}#{singleton_name}_path&quot;, options[:options].merge(:format =&gt; 'xml')
    end

    def assert_named_route(expected, route, options)
      actual =  @controller.send(route, options) rescue $!.class.name
      assert_equal expected, actual, &quot;Error on route: #{route}(#{options.inspect})&quot;
    end

    def assert_resource_methods(expected, resource, action_method, method)
      assert_equal expected.length, resource.send(&quot;#{action_method}_methods&quot;)[method].size, &quot;#{resource.send(&quot;#{action_method}_methods&quot;)[method].inspect}&quot;
      expected.each do |action|
        assert resource.send(&quot;#{action_method}_methods&quot;)[method].include?(action),
          &quot;#{method} not in #{action_method} methods: #{resource.send(&quot;#{action_method}_methods&quot;)[method].inspect}&quot;
      end
    end

    def assert_resource_allowed_routes(controller, options, shallow_options, allowed, not_allowed, path = controller)
      shallow_path = &quot;#{path}/#{shallow_options[:id]}&quot;
      format = options[:format] &amp;&amp; &quot;.#{options[:format]}&quot;
      options.merge!(:controller =&gt; controller)
      shallow_options.merge!(options)

      assert_whether_allowed(allowed, not_allowed, options,         'index',    &quot;#{path}#{format}&quot;,               :get)
      assert_whether_allowed(allowed, not_allowed, options,         'new',      &quot;#{path}/new#{format}&quot;,           :get)
      assert_whether_allowed(allowed, not_allowed, options,         'create',   &quot;#{path}#{format}&quot;,               :post)
      assert_whether_allowed(allowed, not_allowed, shallow_options, 'show',     &quot;#{shallow_path}#{format}&quot;,       :get)
      assert_whether_allowed(allowed, not_allowed, shallow_options, 'edit',     &quot;#{shallow_path}/edit#{format}&quot;,  :get)
      assert_whether_allowed(allowed, not_allowed, shallow_options, 'update',   &quot;#{shallow_path}#{format}&quot;,       :put)
      assert_whether_allowed(allowed, not_allowed, shallow_options, 'destroy',  &quot;#{shallow_path}#{format}&quot;,       :delete)
    end

    def assert_singleton_resource_allowed_routes(controller, options, allowed, not_allowed, path = controller.singularize)
      format = options[:format] &amp;&amp; &quot;.#{options[:format]}&quot;
      options.merge!(:controller =&gt; controller)

      assert_whether_allowed(allowed, not_allowed, options, 'new',      &quot;#{path}/new#{format}&quot;,   :get)
      assert_whether_allowed(allowed, not_allowed, options, 'create',   &quot;#{path}#{format}&quot;,       :post)
      assert_whether_allowed(allowed, not_allowed, options, 'show',     &quot;#{path}#{format}&quot;,       :get)
      assert_whether_allowed(allowed, not_allowed, options, 'edit',     &quot;#{path}/edit#{format}&quot;,  :get)
      assert_whether_allowed(allowed, not_allowed, options, 'update',   &quot;#{path}#{format}&quot;,       :put)
      assert_whether_allowed(allowed, not_allowed, options, 'destroy',  &quot;#{path}#{format}&quot;,       :delete)
    end

    def assert_whether_allowed(allowed, not_allowed, options, action, path, method)
      action = action.to_sym
      options = options.merge(:action =&gt; action.to_s)
      path_options = { :path =&gt; path, :method =&gt; method }

      if Array(allowed).include?(action)
        assert_recognizes options, path_options
      elsif Array(not_allowed).include?(action)
        assert_not_recognizes options, path_options
      end
    end

    def assert_not_recognizes(expected_options, path)
      assert_raise ActionController::RoutingError, ActionController::MethodNotAllowed, Assertion do
        assert_recognizes(expected_options, path)
      end
    end

    def distinct_routes? (r1, r2)
      if r1.conditions == r2.conditions and r1.requirements == r2.requirements then
        if r1.segments.collect(&amp;:to_s) == r2.segments.collect(&amp;:to_s) then
          return false
        end
      end
      true
    end
end
</pre>
    </div>