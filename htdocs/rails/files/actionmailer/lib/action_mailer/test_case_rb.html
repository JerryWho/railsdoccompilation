  <div id="fileHeader">
    <h1>test_case.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionmailer/lib/action_mailer/test_case.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Jul 25 11:32:52 +0200 2010</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'active_support/test_case'

module ActionMailer
  class NonInferrableMailerError &lt; ::StandardError
    def initialize(name)
      super &quot;Unable to determine the mailer to test from #{name}. &quot; +
        &quot;You'll need to specify it using tests YourMailer in your &quot; +
        &quot;test case definition&quot;
    end
  end

  class TestCase &lt; ActiveSupport::TestCase
    include Quoting, TestHelper

    setup :initialize_test_deliveries
    setup :set_expected_mail

    class &lt;&lt; self
      def tests(mailer)
        write_inheritable_attribute(:mailer_class, mailer)
      end

      def mailer_class
        if mailer = read_inheritable_attribute(:mailer_class)
          mailer
        else
          tests determine_default_mailer(name)
        end
      end

      def determine_default_mailer(name)
        name.sub(/Test$/, '').constantize
      rescue NameError =&gt; e
        raise NonInferrableMailerError.new(name)
      end
    end

    protected
      def initialize_test_deliveries
        ActionMailer::Base.delivery_method = :test
        ActionMailer::Base.perform_deliveries = true
        ActionMailer::Base.deliveries = []
      end

      def set_expected_mail
        @expected = TMail::Mail.new
        @expected.set_content_type &quot;text&quot;, &quot;plain&quot;, { &quot;charset&quot; =&gt; charset }
        @expected.mime_version = '1.0'
      end

    private
      def charset
        &quot;utf-8&quot;
      end

      def encode(subject)
        quoted_printable(subject, charset)
      end

      def read_fixture(action)
        IO.readlines(File.join(RAILS_ROOT, 'test', 'fixtures', self.class.mailer_class.name.underscore, action))
      end
  end
end
</pre>
    </div>