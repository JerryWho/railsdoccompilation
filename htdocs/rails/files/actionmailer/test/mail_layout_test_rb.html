  <div id="fileHeader">
    <h1>mail_layout_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionmailer/test/mail_layout_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Nov 27 16:38:15 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'abstract_unit'

class AutoLayoutMailer &lt; ActionMailer::Base
  def hello(recipient)
    recipients recipient
    subject    &quot;You have a mail&quot;
    from       &quot;tester@example.com&quot;
  end

  def spam(recipient)
    recipients recipient
    subject    &quot;You have a mail&quot;
    from       &quot;tester@example.com&quot;
    body       render(:inline =&gt; &quot;Hello, &lt;%= @world %&gt;&quot;, :layout =&gt; 'spam', :body =&gt; { :world =&gt; &quot;Earth&quot; })
  end

  def nolayout(recipient)
    recipients recipient
    subject    &quot;You have a mail&quot;
    from       &quot;tester@example.com&quot;
    body       render(:inline =&gt; &quot;Hello, &lt;%= @world %&gt;&quot;, :layout =&gt; false, :body =&gt; { :world =&gt; &quot;Earth&quot; })
  end

  def multipart(recipient, type = nil)
    recipients recipient
    subject    &quot;You have a mail&quot;
    from       &quot;tester@example.com&quot;

    content_type(type) if type
  end
end

class ExplicitLayoutMailer &lt; ActionMailer::Base
  layout 'spam', :except =&gt; [:logout]

  def signup(recipient)
    recipients recipient
    subject    &quot;You have a mail&quot;
    from       &quot;tester@example.com&quot;
  end

  def logout(recipient)
    recipients recipient
    subject    &quot;You have a mail&quot;
    from       &quot;tester@example.com&quot;
  end
end

class LayoutMailerTest &lt; Test::Unit::TestCase
  def setup
    set_delivery_method :test
    ActionMailer::Base.perform_deliveries = true
    ActionMailer::Base.deliveries = []

    @recipient = 'test@localhost'
  end

  def teardown
    restore_delivery_method
  end

  def test_should_pickup_default_layout
    mail = AutoLayoutMailer.create_hello(@recipient)
    assert_equal &quot;Hello from layout Inside&quot;, mail.body.strip
  end

  def test_should_pickup_multipart_layout
    mail = AutoLayoutMailer.create_multipart(@recipient)
    assert_equal &quot;multipart/alternative&quot;, mail.content_type
    assert_equal 2, mail.parts.size

    assert_equal 'text/plain', mail.parts.first.content_type
    assert_equal &quot;text/plain layout - text/plain multipart&quot;, mail.parts.first.body

    assert_equal 'text/html', mail.parts.last.content_type
    assert_equal &quot;Hello from layout text/html multipart&quot;, mail.parts.last.body
  end

  def test_should_pickup_multipartmixed_layout
    mail = AutoLayoutMailer.create_multipart(@recipient, &quot;multipart/mixed&quot;)
    assert_equal &quot;multipart/mixed&quot;, mail.content_type
    assert_equal 2, mail.parts.size

    assert_equal 'text/plain', mail.parts.first.content_type
    assert_equal &quot;text/plain layout - text/plain multipart&quot;, mail.parts.first.body

    assert_equal 'text/html', mail.parts.last.content_type
    assert_equal &quot;Hello from layout text/html multipart&quot;, mail.parts.last.body
  end

  def test_should_fix_multipart_layout
    mail = AutoLayoutMailer.create_multipart(@recipient, &quot;text/plain&quot;)
    assert_equal &quot;multipart/alternative&quot;, mail.content_type
    assert_equal 2, mail.parts.size

    assert_equal 'text/plain', mail.parts.first.content_type
    assert_equal &quot;text/plain layout - text/plain multipart&quot;, mail.parts.first.body

    assert_equal 'text/html', mail.parts.last.content_type
    assert_equal &quot;Hello from layout text/html multipart&quot;, mail.parts.last.body
  end


  def test_should_pickup_layout_given_to_render
    mail = AutoLayoutMailer.create_spam(@recipient)
    assert_equal &quot;Spammer layout Hello, Earth&quot;, mail.body.strip
  end

  def test_should_respect_layout_false
    mail = AutoLayoutMailer.create_nolayout(@recipient)
    assert_equal &quot;Hello, Earth&quot;, mail.body.strip
  end

  def test_explicit_class_layout
    mail = ExplicitLayoutMailer.create_signup(@recipient)
    assert_equal &quot;Spammer layout We do not spam&quot;, mail.body.strip
  end

  def test_explicit_layout_exceptions
    mail = ExplicitLayoutMailer.create_logout(@recipient)
    assert_equal &quot;You logged out&quot;, mail.body.strip
  end
end
</pre>
    </div>