  <div id="fileHeader">
    <h1>mail_service_test.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionmailer/test/mail_service_test.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Fri Nov 27 16:38:15 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre># encoding: utf-8
require 'abstract_unit'

class FunkyPathMailer &lt; ActionMailer::Base
  self.template_root = &quot;#{File.dirname(__FILE__)}/fixtures/path.with.dots&quot;

  def multipart_with_template_path_with_dots(recipient)
    recipients recipient
    subject    &quot;Have a lovely picture&quot;
    from       &quot;Chad Fowler &lt;chad@chadfowler.com&gt;&quot;
    attachment :content_type =&gt; &quot;image/jpeg&quot;,
      :body =&gt; &quot;not really a jpeg, we're only testing, after all&quot;
  end
end

class TestMailer &lt; ActionMailer::Base
  def signed_up(recipient)
    @recipients   = recipient
    @subject      = &quot;[Signed up] Welcome #{recipient}&quot;
    @from         = &quot;system@loudthinking.com&quot;
    @body[&quot;recipient&quot;] = recipient
  end

  def cancelled_account(recipient)
    self.recipients = recipient
    self.subject    = &quot;[Cancelled] Goodbye #{recipient}&quot;
    self.from       = &quot;system@loudthinking.com&quot;
    self.sent_on    = Time.local(2004, 12, 12)
    self.body       = &quot;Goodbye, Mr. #{recipient}&quot;
  end

  def cc_bcc(recipient)
    recipients recipient
    subject    &quot;testing bcc/cc&quot;
    from       &quot;system@loudthinking.com&quot;
    sent_on    Time.local(2004, 12, 12)
    cc         &quot;nobody@loudthinking.com&quot;
    bcc        &quot;root@loudthinking.com&quot;
    body       &quot;Nothing to see here.&quot;
  end

  def different_reply_to(recipient)
    recipients recipient
    subject    &quot;testing reply_to&quot;
    from       &quot;system@loudthinking.com&quot;
    sent_on    Time.local(2008, 5, 23)
    reply_to   &quot;atraver@gmail.com&quot;
    body       &quot;Nothing to see here.&quot;
  end

  def iso_charset(recipient)
    @recipients = recipient
    @subject    = &quot;testing isø charsets&quot;
    @from       = &quot;system@loudthinking.com&quot;
    @sent_on    = Time.local 2004, 12, 12
    @cc         = &quot;nobody@loudthinking.com&quot;
    @bcc        = &quot;root@loudthinking.com&quot;
    @body       = &quot;Nothing to see here.&quot;
    @charset    = &quot;iso-8859-1&quot;
  end

  def unencoded_subject(recipient)
    @recipients = recipient
    @subject    = &quot;testing unencoded subject&quot;
    @from       = &quot;system@loudthinking.com&quot;
    @sent_on    = Time.local 2004, 12, 12
    @cc         = &quot;nobody@loudthinking.com&quot;
    @bcc        = &quot;root@loudthinking.com&quot;
    @body       = &quot;Nothing to see here.&quot;
  end

  def extended_headers(recipient)
    @recipients = recipient
    @subject    = &quot;testing extended headers&quot;
    @from       = &quot;Grytøyr &lt;stian1@example.net&gt;&quot;
    @sent_on    = Time.local 2004, 12, 12
    @cc         = &quot;Grytøyr &lt;stian2@example.net&gt;&quot;
    @bcc        = &quot;Grytøyr &lt;stian3@example.net&gt;&quot;
    @body       = &quot;Nothing to see here.&quot;
    @charset    = &quot;iso-8859-1&quot;
  end

  def utf8_body(recipient)
    @recipients = recipient
    @subject    = &quot;testing utf-8 body&quot;
    @from       = &quot;Foo áëô îü &lt;extended@example.net&gt;&quot;
    @sent_on    = Time.local 2004, 12, 12
    @cc         = &quot;Foo áëô îü &lt;extended@example.net&gt;&quot;
    @bcc        = &quot;Foo áëô îü &lt;extended@example.net&gt;&quot;
    @body       = &quot;åœö blah&quot;
    @charset    = &quot;utf-8&quot;
  end

  def multipart_with_mime_version(recipient)
    recipients   recipient
    subject      &quot;multipart with mime_version&quot;
    from         &quot;test@example.com&quot;
    sent_on      Time.local(2004, 12, 12)
    mime_version &quot;1.1&quot;
    content_type &quot;multipart/alternative&quot;

    part &quot;text/plain&quot; do |p|
      p.body = &quot;blah&quot;
    end

    part &quot;text/html&quot; do |p|
      p.body = &quot;&lt;b&gt;blah&lt;/b&gt;&quot;
    end
  end

  def multipart_with_utf8_subject(recipient)
    recipients   recipient
    subject      &quot;Foo áëô îü&quot;
    from         &quot;test@example.com&quot;
    charset      &quot;utf-8&quot;

    part &quot;text/plain&quot; do |p|
      p.body = &quot;blah&quot;
    end

    part &quot;text/html&quot; do |p|
      p.body = &quot;&lt;b&gt;blah&lt;/b&gt;&quot;
    end
  end

  def explicitly_multipart_example(recipient, ct=nil)
    recipients   recipient
    subject      &quot;multipart example&quot;
    from         &quot;test@example.com&quot;
    sent_on      Time.local(2004, 12, 12)
    body         &quot;plain text default&quot;
    content_type ct if ct

    part &quot;text/html&quot; do |p|
      p.charset = &quot;iso-8859-1&quot;
      p.body = &quot;blah&quot;
    end

    attachment :content_type =&gt; &quot;image/jpeg&quot;, :filename =&gt; &quot;foo.jpg&quot;,
      :body =&gt; &quot;123456789&quot;
  end

  def implicitly_multipart_example(recipient, cs = nil, order = nil)
    @recipients = recipient
    @subject    = &quot;multipart example&quot;
    @from       = &quot;test@example.com&quot;
    @sent_on    = Time.local 2004, 12, 12
    @body       = { &quot;recipient&quot; =&gt; recipient }
    @charset    = cs if cs
    @implicit_parts_order = order if order
  end

  def implicitly_multipart_with_utf8
    recipients &quot;no.one@nowhere.test&quot;
    subject    &quot;Foo áëô îü&quot;
    from       &quot;some.one@somewhere.test&quot;
    template   &quot;implicitly_multipart_example&quot;
    body       ({ &quot;recipient&quot; =&gt; &quot;no.one@nowhere.test&quot; })
  end

  def html_mail(recipient)
    recipients   recipient
    subject      &quot;html mail&quot;
    from         &quot;test@example.com&quot;
    body         &quot;&lt;em&gt;Emphasize&lt;/em&gt; &lt;strong&gt;this&lt;/strong&gt;&quot;
    content_type &quot;text/html&quot;
  end

  def html_mail_with_underscores(recipient)
    subject      &quot;html mail with underscores&quot;
    body         %{&lt;a href=&quot;http://google.com&quot; target=&quot;_blank&quot;&gt;_Google&lt;/a&gt;}
  end

  def custom_template(recipient)
    recipients recipient
    subject    &quot;[Signed up] Welcome #{recipient}&quot;
    from       &quot;system@loudthinking.com&quot;
    sent_on    Time.local(2004, 12, 12)
    template   &quot;signed_up&quot;

    body[&quot;recipient&quot;] = recipient
  end

  def custom_templating_extension(recipient)
    recipients recipient
    subject    &quot;[Signed up] Welcome #{recipient}&quot;
    from       &quot;system@loudthinking.com&quot;
    sent_on    Time.local(2004, 12, 12)

    body[&quot;recipient&quot;] = recipient
  end

  def various_newlines(recipient)
    recipients   recipient
    subject      &quot;various newlines&quot;
    from         &quot;test@example.com&quot;
    body         &quot;line #1\nline #2\rline #3\r\nline #4\r\r&quot; +
                 &quot;line #5\n\nline#6\r\n\r\nline #7&quot;
  end

  def various_newlines_multipart(recipient)
    recipients   recipient
    subject      &quot;various newlines multipart&quot;
    from         &quot;test@example.com&quot;
    content_type &quot;multipart/alternative&quot;
    part :content_type =&gt; &quot;text/plain&quot;, :body =&gt; &quot;line #1\nline #2\rline #3\r\nline #4\r\r&quot;
    part :content_type =&gt; &quot;text/html&quot;, :body =&gt; &quot;&lt;p&gt;line #1&lt;/p&gt;\n&lt;p&gt;line #2&lt;/p&gt;\r&lt;p&gt;line #3&lt;/p&gt;\r\n&lt;p&gt;line #4&lt;/p&gt;\r\r&quot;
  end

  def nested_multipart(recipient)
    recipients   recipient
    subject      &quot;nested multipart&quot;
    from         &quot;test@example.com&quot;
    content_type &quot;multipart/mixed&quot;
    part :content_type =&gt; &quot;multipart/alternative&quot;, :content_disposition =&gt; &quot;inline&quot;, :headers =&gt; { &quot;foo&quot; =&gt; &quot;bar&quot; } do |p|
      p.part :content_type =&gt; &quot;text/plain&quot;, :body =&gt; &quot;test text\nline #2&quot;
      p.part :content_type =&gt; &quot;text/html&quot;, :body =&gt; &quot;&lt;b&gt;test&lt;/b&gt; HTML&lt;br/&gt;\nline #2&quot;
    end
    attachment :content_type =&gt; &quot;application/octet-stream&quot;,:filename =&gt; &quot;test.txt&quot;, :body =&gt; &quot;test abcdefghijklmnopqstuvwxyz&quot;
  end

  def nested_multipart_with_body(recipient)
    recipients   recipient
    subject      &quot;nested multipart with body&quot;
    from         &quot;test@example.com&quot;
    content_type &quot;multipart/mixed&quot;
    part :content_type =&gt; &quot;multipart/alternative&quot;, :content_disposition =&gt; &quot;inline&quot;, :body =&gt; &quot;Nothing to see here.&quot; do |p|
      p.part :content_type =&gt; &quot;text/html&quot;, :body =&gt; &quot;&lt;b&gt;test&lt;/b&gt; HTML&lt;br/&gt;&quot;
    end
  end

  def attachment_with_custom_header(recipient)
    recipients   recipient
    subject      &quot;custom header in attachment&quot;
    from         &quot;test@example.com&quot;
    content_type &quot;multipart/related&quot;
    part :content_type =&gt; &quot;text/html&quot;, :body =&gt; 'yo'
    attachment :content_type =&gt; &quot;image/jpeg&quot;,:filename =&gt; &quot;test.jpeg&quot;, :body =&gt; &quot;i am not a real picture&quot;, :headers =&gt; { 'Content-ID' =&gt; '&lt;test@test.com&gt;' }
  end

  def unnamed_attachment(recipient)
    recipients   recipient
    subject      &quot;nested multipart&quot;
    from         &quot;test@example.com&quot;
    content_type &quot;multipart/mixed&quot;
    part :content_type =&gt; &quot;text/plain&quot;, :body =&gt; &quot;hullo&quot;
    attachment :content_type =&gt; &quot;application/octet-stream&quot;, :body =&gt; &quot;test abcdefghijklmnopqstuvwxyz&quot;
  end

  def headers_with_nonalpha_chars(recipient)
    recipients   recipient
    subject      &quot;nonalpha chars&quot;
    from         &quot;One: Two &lt;test@example.com&gt;&quot;
    cc           &quot;Three: Four &lt;test@example.com&gt;&quot;
    bcc          &quot;Five: Six &lt;test@example.com&gt;&quot;
    body         &quot;testing&quot;
  end

  def custom_content_type_attributes
    recipients   &quot;no.one@nowhere.test&quot;
    subject      &quot;custom content types&quot;
    from         &quot;some.one@somewhere.test&quot;
    content_type &quot;text/plain; format=flowed&quot;
    body         &quot;testing&quot;
  end

  def return_path
    recipients   &quot;no.one@nowhere.test&quot;
    subject      &quot;return path test&quot;
    from         &quot;some.one@somewhere.test&quot;
    body         &quot;testing&quot;
    headers      &quot;return-path&quot; =&gt; &quot;another@somewhere.test&quot;
  end

  def body_ivar(recipient)
    recipients   recipient
    subject      &quot;Body as a local variable&quot;
    from         &quot;test@example.com&quot;
    body         :body =&gt; &quot;foo&quot;, :bar =&gt; &quot;baz&quot;
  end

  class &lt;&lt;self
    attr_accessor :received_body
  end

  def receive(mail)
    self.class.received_body = mail.body
  end
end

class ActionMailerTest &lt; Test::Unit::TestCase
  include ActionMailer::Quoting

  def encode( text, charset=&quot;utf-8&quot; )
    quoted_printable( text, charset )
  end

  def new_mail( charset=&quot;utf-8&quot; )
    mail = TMail::Mail.new
    mail.mime_version = &quot;1.0&quot;
    if charset
      mail.set_content_type &quot;text&quot;, &quot;plain&quot;, { &quot;charset&quot; =&gt; charset }
    end
    mail
  end

  # Replacing logger work around for mocha bug. Should be fixed in mocha 0.3.3
  def setup
    set_delivery_method :test
    ActionMailer::Base.perform_deliveries = true
    ActionMailer::Base.raise_delivery_errors = true
    ActionMailer::Base.deliveries = []

    @original_logger = TestMailer.logger
    @recipient = 'test@localhost'
  end

  def teardown
    TestMailer.logger = @original_logger
    restore_delivery_method
  end

  def test_nested_parts
    created = nil
    assert_nothing_raised { created = TestMailer.create_nested_multipart(@recipient)}
    assert_equal 2,created.parts.size
    assert_equal 2,created.parts.first.parts.size

    assert_equal &quot;multipart/mixed&quot;, created.content_type
    assert_equal &quot;multipart/alternative&quot;, created.parts.first.content_type
    assert_equal &quot;bar&quot;, created.parts.first.header['foo'].to_s
    assert_nil created.parts.first.charset
    assert_equal &quot;text/plain&quot;, created.parts.first.parts.first.content_type
    assert_equal &quot;text/html&quot;, created.parts.first.parts[1].content_type
    assert_equal &quot;application/octet-stream&quot;, created.parts[1].content_type
  end

  def test_nested_parts_with_body
    created = nil
    assert_nothing_raised { created = TestMailer.create_nested_multipart_with_body(@recipient)}
    assert_equal 1,created.parts.size
    assert_equal 2,created.parts.first.parts.size

    assert_equal &quot;multipart/mixed&quot;, created.content_type
    assert_equal &quot;multipart/alternative&quot;, created.parts.first.content_type
    assert_equal &quot;Nothing to see here.&quot;, created.parts.first.parts.first.body
    assert_equal &quot;text/plain&quot;, created.parts.first.parts.first.content_type
    assert_equal &quot;text/html&quot;, created.parts.first.parts[1].content_type
  end

  def test_attachment_with_custom_header
    created = nil
    assert_nothing_raised { created = TestMailer.create_attachment_with_custom_header(@recipient)}
    assert_equal &quot;&lt;test@test.com&gt;&quot;, created.parts[1].header['content-id'].to_s
  end

  def test_signed_up
    Time.stubs(:now =&gt; Time.now)

    expected = new_mail
    expected.to      = @recipient
    expected.subject = &quot;[Signed up] Welcome #{@recipient}&quot;
    expected.body    = &quot;Hello there, \n\nMr. #{@recipient}&quot;
    expected.from    = &quot;system@loudthinking.com&quot;
    expected.date    = Time.now

    created = nil
    assert_nothing_raised { created = TestMailer.create_signed_up(@recipient) }
    assert_not_nil created
    assert_equal expected.encoded, created.encoded

    assert_nothing_raised { TestMailer.deliver_signed_up(@recipient) }
    assert_not_nil ActionMailer::Base.deliveries.first
    assert_equal expected.encoded, ActionMailer::Base.deliveries.first.encoded
  end

  def test_custom_template
    expected = new_mail
    expected.to      = @recipient
    expected.subject = &quot;[Signed up] Welcome #{@recipient}&quot;
    expected.body    = &quot;Hello there, \n\nMr. #{@recipient}&quot;
    expected.from    = &quot;system@loudthinking.com&quot;
    expected.date    = Time.local(2004, 12, 12)

    created = nil
    assert_nothing_raised { created = TestMailer.create_custom_template(@recipient) }
    assert_not_nil created
    assert_equal expected.encoded, created.encoded
  end

  def test_custom_templating_extension
    assert ActionView::Template.template_handler_extensions.include?(&quot;haml&quot;), &quot;haml extension was not registered&quot;

    # N.b., custom_templating_extension.text.plain.haml is expected to be in fixtures/test_mailer directory
    expected = new_mail
    expected.to      = @recipient
    expected.subject = &quot;[Signed up] Welcome #{@recipient}&quot;
    expected.body    = &quot;Hello there, \n\nMr. #{@recipient}&quot;
    expected.from    = &quot;system@loudthinking.com&quot;
    expected.date    = Time.local(2004, 12, 12)

    # Stub the render method so no alternative renderers need be present.
    ActionView::Base.any_instance.stubs(:render).returns(&quot;Hello there, \n\nMr. #{@recipient}&quot;)

    # Now that the template is registered, there should be one part. The text/plain part.
    created = nil
    assert_nothing_raised { created = TestMailer.create_custom_templating_extension(@recipient) }
    assert_not_nil created
    assert_equal 2, created.parts.length
    assert_equal 'text/plain', created.parts[0].content_type
    assert_equal 'text/html', created.parts[1].content_type
  end

  def test_cancelled_account
    expected = new_mail
    expected.to      = @recipient
    expected.subject = &quot;[Cancelled] Goodbye #{@recipient}&quot;
    expected.body    = &quot;Goodbye, Mr. #{@recipient}&quot;
    expected.from    = &quot;system@loudthinking.com&quot;
    expected.date    = Time.local(2004, 12, 12)

    created = nil
    assert_nothing_raised { created = TestMailer.create_cancelled_account(@recipient) }
    assert_not_nil created
    assert_equal expected.encoded, created.encoded

    assert_nothing_raised { TestMailer.deliver_cancelled_account(@recipient) }
    assert_not_nil ActionMailer::Base.deliveries.first
    assert_equal expected.encoded, ActionMailer::Base.deliveries.first.encoded
  end

  def test_cc_bcc
    expected = new_mail
    expected.to      = @recipient
    expected.subject = &quot;testing bcc/cc&quot;
    expected.body    = &quot;Nothing to see here.&quot;
    expected.from    = &quot;system@loudthinking.com&quot;
    expected.cc      = &quot;nobody@loudthinking.com&quot;
    expected.bcc     = &quot;root@loudthinking.com&quot;
    expected.date    = Time.local 2004, 12, 12

    created = nil
    assert_nothing_raised do
      created = TestMailer.create_cc_bcc @recipient
    end
    assert_not_nil created
    assert_equal expected.encoded, created.encoded

    assert_nothing_raised do
      TestMailer.deliver_cc_bcc @recipient
    end

    assert_not_nil ActionMailer::Base.deliveries.first
    assert_equal expected.encoded, ActionMailer::Base.deliveries.first.encoded
  end

  def test_reply_to
    expected = new_mail

    expected.to       = @recipient
    expected.subject  = &quot;testing reply_to&quot;
    expected.body     = &quot;Nothing to see here.&quot;
    expected.from     = &quot;system@loudthinking.com&quot;
    expected.reply_to = &quot;atraver@gmail.com&quot;
    expected.date     = Time.local 2008, 5, 23

    created = nil
    assert_nothing_raised do
      created = TestMailer.create_different_reply_to @recipient
    end
    assert_not_nil created
    assert_equal expected.encoded, created.encoded

    assert_nothing_raised do
      TestMailer.deliver_different_reply_to @recipient
    end

    assert_not_nil ActionMailer::Base.deliveries.first
    assert_equal expected.encoded, ActionMailer::Base.deliveries.first.encoded
  end

  def test_iso_charset
    expected = new_mail( &quot;iso-8859-1&quot; )
    expected.to      = @recipient
    expected.subject = encode &quot;testing isø charsets&quot;, &quot;iso-8859-1&quot;
    expected.body    = &quot;Nothing to see here.&quot;
    expected.from    = &quot;system@loudthinking.com&quot;
    expected.cc      = &quot;nobody@loudthinking.com&quot;
    expected.bcc     = &quot;root@loudthinking.com&quot;
    expected.date    = Time.local 2004, 12, 12

    created = nil
    assert_nothing_raised do
      created = TestMailer.create_iso_charset @recipient
    end
    assert_not_nil created
    assert_equal expected.encoded, created.encoded

    assert_nothing_raised do
      TestMailer.deliver_iso_charset @recipient
    end

    assert_not_nil ActionMailer::Base.deliveries.first
    assert_equal expected.encoded, ActionMailer::Base.deliveries.first.encoded
  end

  def test_unencoded_subject
    expected = new_mail
    expected.to      = @recipient
    expected.subject = &quot;testing unencoded subject&quot;
    expected.body    = &quot;Nothing to see here.&quot;
    expected.from    = &quot;system@loudthinking.com&quot;
    expected.cc      = &quot;nobody@loudthinking.com&quot;
    expected.bcc     = &quot;root@loudthinking.com&quot;
    expected.date    = Time.local 2004, 12, 12

    created = nil
    assert_nothing_raised do
      created = TestMailer.create_unencoded_subject @recipient
    end
    assert_not_nil created
    assert_equal expected.encoded, created.encoded

    assert_nothing_raised do
      TestMailer.deliver_unencoded_subject @recipient
    end

    assert_not_nil ActionMailer::Base.deliveries.first
    assert_equal expected.encoded, ActionMailer::Base.deliveries.first.encoded
  end

  def test_instances_are_nil
    assert_nil ActionMailer::Base.new
    assert_nil TestMailer.new
  end

  def test_deliveries_array
    assert_not_nil ActionMailer::Base.deliveries
    assert_equal 0, ActionMailer::Base.deliveries.size
    TestMailer.deliver_signed_up(@recipient)
    assert_equal 1, ActionMailer::Base.deliveries.size
    assert_not_nil ActionMailer::Base.deliveries.first
  end

  def test_perform_deliveries_flag
    ActionMailer::Base.perform_deliveries = false
    TestMailer.deliver_signed_up(@recipient)
    assert_equal 0, ActionMailer::Base.deliveries.size
    ActionMailer::Base.perform_deliveries = true
    TestMailer.deliver_signed_up(@recipient)
    assert_equal 1, ActionMailer::Base.deliveries.size
  end

  def test_doesnt_raise_errors_when_raise_delivery_errors_is_false
    ActionMailer::Base.raise_delivery_errors = false
    TestMailer.any_instance.expects(:perform_delivery_test).raises(Exception)
    assert_nothing_raised { TestMailer.deliver_signed_up(@recipient) }
  end

  def test_performs_delivery_via_sendmail
    sm = mock()
    sm.expects(:print).with(anything)
    sm.expects(:flush)
    IO.expects(:popen).once.with('/usr/sbin/sendmail -i -t', 'w+').yields(sm)
    ActionMailer::Base.delivery_method = :sendmail
    TestMailer.deliver_signed_up(@recipient)
  end

  def test_delivery_logs_sent_mail
    mail = TestMailer.create_signed_up(@recipient)
    logger = mock()
    logger.expects(:info).with(&quot;Sent mail to #{@recipient}&quot;)
    logger.expects(:debug).with() do |logged_text|
      logged_text =~ /\[Signed up\] Welcome/
    end
    TestMailer.logger = logger
    TestMailer.deliver_signed_up(@recipient)
  end

  def test_unquote_quoted_printable_subject
    msg = &lt;&lt;EOF
From: me@example.com
Subject: =?utf-8?Q?testing_testing_=D6=A4?=
Content-Type: text/plain; charset=iso-8859-1

The body
EOF
    mail = TMail::Mail.parse(msg)
    assert_equal &quot;testing testing \326\244&quot;, mail.subject
    assert_equal &quot;=?utf-8?Q?testing_testing_=D6=A4?=&quot;, mail.quoted_subject
  end

  def test_unquote_7bit_subject
    msg = &lt;&lt;EOF
From: me@example.com
Subject: this == working?
Content-Type: text/plain; charset=iso-8859-1

The body
EOF
    mail = TMail::Mail.parse(msg)
    assert_equal &quot;this == working?&quot;, mail.subject
    assert_equal &quot;this == working?&quot;, mail.quoted_subject
  end

  def test_unquote_7bit_body
    msg = &lt;&lt;EOF
From: me@example.com
Subject: subject
Content-Type: text/plain; charset=iso-8859-1
Content-Transfer-Encoding: 7bit

The=3Dbody
EOF
    mail = TMail::Mail.parse(msg)
    assert_equal &quot;The=3Dbody&quot;, mail.body.strip
    assert_equal &quot;The=3Dbody&quot;, mail.quoted_body.strip
  end

  def test_unquote_quoted_printable_body
    msg = &lt;&lt;EOF
From: me@example.com
Subject: subject
Content-Type: text/plain; charset=iso-8859-1
Content-Transfer-Encoding: quoted-printable

The=3Dbody
EOF
    mail = TMail::Mail.parse(msg)
    assert_equal &quot;The=body&quot;, mail.body.strip
    assert_equal &quot;The=3Dbody&quot;, mail.quoted_body.strip
  end

  def test_unquote_base64_body
    msg = &lt;&lt;EOF
From: me@example.com
Subject: subject
Content-Type: text/plain; charset=iso-8859-1
Content-Transfer-Encoding: base64

VGhlIGJvZHk=
EOF
    mail = TMail::Mail.parse(msg)
    assert_equal &quot;The body&quot;, mail.body.strip
    assert_equal &quot;VGhlIGJvZHk=&quot;, mail.quoted_body.strip
  end

  def test_extended_headers
    @recipient = &quot;Grytøyr &lt;test@localhost&gt;&quot;

    expected = new_mail &quot;iso-8859-1&quot;
    expected.to      = quote_address_if_necessary @recipient, &quot;iso-8859-1&quot;
    expected.subject = &quot;testing extended headers&quot;
    expected.body    = &quot;Nothing to see here.&quot;
    expected.from    = quote_address_if_necessary &quot;Grytøyr &lt;stian1@example.net&gt;&quot;, &quot;iso-8859-1&quot;
    expected.cc      = quote_address_if_necessary &quot;Grytøyr &lt;stian2@example.net&gt;&quot;, &quot;iso-8859-1&quot;
    expected.bcc     = quote_address_if_necessary &quot;Grytøyr &lt;stian3@example.net&gt;&quot;, &quot;iso-8859-1&quot;
    expected.date    = Time.local 2004, 12, 12

    created = nil
    assert_nothing_raised do
      created = TestMailer.create_extended_headers @recipient
    end

    assert_not_nil created
    assert_equal expected.encoded, created.encoded

    assert_nothing_raised do
      TestMailer.deliver_extended_headers @recipient
    end

    assert_not_nil ActionMailer::Base.deliveries.first
    assert_equal expected.encoded, ActionMailer::Base.deliveries.first.encoded
  end

  def test_utf8_body_is_not_quoted
    @recipient = &quot;Foo áëô îü &lt;extended@example.net&gt;&quot;
    expected = new_mail &quot;utf-8&quot;
    expected.to      = quote_address_if_necessary @recipient, &quot;utf-8&quot;
    expected.subject = &quot;testing utf-8 body&quot;
    expected.body    = &quot;åœö blah&quot;
    expected.from    = quote_address_if_necessary @recipient, &quot;utf-8&quot;
    expected.cc      = quote_address_if_necessary @recipient, &quot;utf-8&quot;
    expected.bcc     = quote_address_if_necessary @recipient, &quot;utf-8&quot;
    expected.date    = Time.local 2004, 12, 12

    created = TestMailer.create_utf8_body @recipient
    assert_match(/åœö blah/, created.encoded)
  end

  def test_multiple_utf8_recipients
    @recipient = [&quot;\&quot;Foo áëô îü\&quot; &lt;extended@example.net&gt;&quot;, &quot;\&quot;Example Recipient\&quot; &lt;me@example.com&gt;&quot;]
    expected = new_mail &quot;utf-8&quot;
    expected.to      = quote_address_if_necessary @recipient, &quot;utf-8&quot;
    expected.subject = &quot;testing utf-8 body&quot;
    expected.body    = &quot;åœö blah&quot;
    expected.from    = quote_address_if_necessary @recipient.first, &quot;utf-8&quot;
    expected.cc      = quote_address_if_necessary @recipient, &quot;utf-8&quot;
    expected.bcc     = quote_address_if_necessary @recipient, &quot;utf-8&quot;
    expected.date    = Time.local 2004, 12, 12

    created = TestMailer.create_utf8_body @recipient
    assert_match(/\nFrom: =\?utf-8\?Q\?Foo_.*?\?= &lt;extended@example.net&gt;\r/, created.encoded)
    assert_match(/\nTo: =\?utf-8\?Q\?Foo_.*?\?= &lt;extended@example.net&gt;, Example Recipient &lt;me/, created.encoded)
  end

  def test_receive_decodes_base64_encoded_mail
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email&quot;)
    TestMailer.receive(fixture)
    assert_match(/Jamis/, TestMailer.received_body)
  end

  def test_receive_attachments
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email2&quot;)
    mail = TMail::Mail.parse(fixture)
    attachment = mail.attachments.last
    assert_equal &quot;smime.p7s&quot;, attachment.original_filename
    assert_equal &quot;application/pkcs7-signature&quot;, attachment.content_type
  end

  def test_decode_attachment_without_charset
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email3&quot;)
    mail = TMail::Mail.parse(fixture)
    attachment = mail.attachments.last
    assert_equal 1026, attachment.read.length
  end

  def test_attachment_using_content_location
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email12&quot;)
    mail = TMail::Mail.parse(fixture)
    assert_equal 1, mail.attachments.length
    assert_equal &quot;Photo25.jpg&quot;, mail.attachments.first.original_filename
  end

  def test_attachment_with_text_type
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email13&quot;)
    mail = TMail::Mail.parse(fixture)
    assert mail.has_attachments?
    assert_equal 1, mail.attachments.length
    assert_equal &quot;hello.rb&quot;, mail.attachments.first.original_filename
  end

  def test_decode_part_without_content_type
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email4&quot;)
    mail = TMail::Mail.parse(fixture)
    assert_nothing_raised { mail.body }
  end

  def test_decode_message_without_content_type
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email5&quot;)
    mail = TMail::Mail.parse(fixture)
    assert_nothing_raised { mail.body }
  end

  def test_decode_message_with_incorrect_charset
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email6&quot;)
    mail = TMail::Mail.parse(fixture)
    assert_nothing_raised { mail.body }
  end

  def test_multipart_with_mime_version
    mail = TestMailer.create_multipart_with_mime_version(@recipient)
    assert_equal &quot;1.1&quot;, mail.mime_version
  end

  def test_multipart_with_utf8_subject
    mail = TestMailer.create_multipart_with_utf8_subject(@recipient)
    assert_match(/\nSubject: =\?utf-8\?Q\?Foo_.*?\?=/, mail.encoded)
  end

  def test_implicitly_multipart_with_utf8
    mail = TestMailer.create_implicitly_multipart_with_utf8
    assert_match(/\nSubject: =\?utf-8\?Q\?Foo_.*?\?=/, mail.encoded)
  end

  def test_explicitly_multipart_messages
    mail = TestMailer.create_explicitly_multipart_example(@recipient)
    assert_equal 3, mail.parts.length
    assert_nil mail.content_type
    assert_equal &quot;text/plain&quot;, mail.parts[0].content_type

    assert_equal &quot;text/html&quot;, mail.parts[1].content_type
    assert_equal &quot;iso-8859-1&quot;, mail.parts[1].sub_header(&quot;content-type&quot;, &quot;charset&quot;)
    assert_equal &quot;inline&quot;, mail.parts[1].content_disposition

    assert_equal &quot;image/jpeg&quot;, mail.parts[2].content_type
    assert_equal &quot;attachment&quot;, mail.parts[2].content_disposition
    assert_equal &quot;foo.jpg&quot;, mail.parts[2].sub_header(&quot;content-disposition&quot;, &quot;filename&quot;)
    assert_equal &quot;foo.jpg&quot;, mail.parts[2].sub_header(&quot;content-type&quot;, &quot;name&quot;)
    assert_nil mail.parts[2].sub_header(&quot;content-type&quot;, &quot;charset&quot;)
  end

  def test_explicitly_multipart_with_content_type
    mail = TestMailer.create_explicitly_multipart_example(@recipient, &quot;multipart/alternative&quot;)
    assert_equal 3, mail.parts.length
    assert_equal &quot;multipart/alternative&quot;, mail.content_type
  end

  def test_explicitly_multipart_with_invalid_content_type
    mail = TestMailer.create_explicitly_multipart_example(@recipient, &quot;text/xml&quot;)
    assert_equal 3, mail.parts.length
    assert_nil mail.content_type
  end

  def test_implicitly_multipart_messages
    assert ActionView::Template.template_handler_extensions.include?(&quot;bak&quot;), &quot;bak extension was not registered&quot;

    mail = TestMailer.create_implicitly_multipart_example(@recipient)
    assert_equal 3, mail.parts.length
    assert_equal &quot;1.0&quot;, mail.mime_version
    assert_equal &quot;multipart/alternative&quot;, mail.content_type
    assert_equal &quot;text/yaml&quot;, mail.parts[0].content_type
    assert_equal &quot;utf-8&quot;, mail.parts[0].sub_header(&quot;content-type&quot;, &quot;charset&quot;)
    assert_equal &quot;text/plain&quot;, mail.parts[1].content_type
    assert_equal &quot;utf-8&quot;, mail.parts[1].sub_header(&quot;content-type&quot;, &quot;charset&quot;)
    assert_equal &quot;text/html&quot;, mail.parts[2].content_type
    assert_equal &quot;utf-8&quot;, mail.parts[2].sub_header(&quot;content-type&quot;, &quot;charset&quot;)
  end

  def test_implicitly_multipart_messages_with_custom_order
    assert ActionView::Template.template_handler_extensions.include?(&quot;bak&quot;), &quot;bak extension was not registered&quot;

    mail = TestMailer.create_implicitly_multipart_example(@recipient, nil, [&quot;text/yaml&quot;, &quot;text/plain&quot;])
    assert_equal 3, mail.parts.length
    assert_equal &quot;text/html&quot;, mail.parts[0].content_type
    assert_equal &quot;text/plain&quot;, mail.parts[1].content_type
    assert_equal &quot;text/yaml&quot;, mail.parts[2].content_type
  end

  def test_implicitly_multipart_messages_with_charset
    mail = TestMailer.create_implicitly_multipart_example(@recipient, 'iso-8859-1')

    assert_equal &quot;multipart/alternative&quot;, mail.header['content-type'].body

    assert_equal 'iso-8859-1', mail.parts[0].sub_header(&quot;content-type&quot;, &quot;charset&quot;)
    assert_equal 'iso-8859-1', mail.parts[1].sub_header(&quot;content-type&quot;, &quot;charset&quot;)
    assert_equal 'iso-8859-1', mail.parts[2].sub_header(&quot;content-type&quot;, &quot;charset&quot;)
  end

  def test_html_mail
    mail = TestMailer.create_html_mail(@recipient)
    assert_equal &quot;text/html&quot;, mail.content_type
  end

  def test_html_mail_with_underscores
    mail = TestMailer.create_html_mail_with_underscores(@recipient)
    assert_equal %{&lt;a href=&quot;http://google.com&quot; target=&quot;_blank&quot;&gt;_Google&lt;/a&gt;}, mail.body
  end

  def test_various_newlines
    mail = TestMailer.create_various_newlines(@recipient)
    assert_equal(&quot;line #1\nline #2\nline #3\nline #4\n\n&quot; +
                 &quot;line #5\n\nline#6\n\nline #7&quot;, mail.body)
  end

  def test_various_newlines_multipart
    mail = TestMailer.create_various_newlines_multipart(@recipient)
    assert_equal &quot;line #1\nline #2\nline #3\nline #4\n\n&quot;, mail.parts[0].body
    assert_equal &quot;&lt;p&gt;line #1&lt;/p&gt;\n&lt;p&gt;line #2&lt;/p&gt;\n&lt;p&gt;line #3&lt;/p&gt;\n&lt;p&gt;line #4&lt;/p&gt;\n\n&quot;, mail.parts[1].body
  end

  def test_headers_removed_on_smtp_delivery
    ActionMailer::Base.delivery_method = :smtp
    TestMailer.deliver_cc_bcc(@recipient)
    assert MockSMTP.deliveries[0][2].include?(&quot;root@loudthinking.com&quot;)
    assert MockSMTP.deliveries[0][2].include?(&quot;nobody@loudthinking.com&quot;)
    assert MockSMTP.deliveries[0][2].include?(@recipient)
    assert_match %r{^Cc: nobody@loudthinking.com}, MockSMTP.deliveries[0][0]
    assert_match %r{^To: #{@recipient}}, MockSMTP.deliveries[0][0]
    assert_no_match %r{^Bcc: root@loudthinking.com}, MockSMTP.deliveries[0][0]
  end

  def test_recursive_multipart_processing
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email7&quot;)
    mail = TMail::Mail.parse(fixture)
    assert_equal &quot;This is the first part.\n\nAttachment: test.rb\nAttachment: test.pdf\n\n\nAttachment: smime.p7s\n&quot;, mail.body
  end

  def test_decode_encoded_attachment_filename
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email8&quot;)
    mail = TMail::Mail.parse(fixture)
    attachment = mail.attachments.last

    expected = &quot;01 Quien Te Dij\212at. Pitbull.mp3&quot;
    expected.force_encoding(Encoding::ASCII_8BIT) if expected.respond_to?(:force_encoding)

    assert_equal expected, attachment.original_filename
  end

  def test_wrong_mail_header
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email9&quot;)
    assert_raise(TMail::SyntaxError) { TMail::Mail.parse(fixture) }
  end

  def test_decode_message_with_unknown_charset
    fixture = File.read(File.dirname(__FILE__) + &quot;/fixtures/raw_email10&quot;)
    mail = TMail::Mail.parse(fixture)
    assert_nothing_raised { mail.body }
  end

  def test_empty_header_values_omitted
    result = TestMailer.create_unnamed_attachment(@recipient).encoded
    assert_match %r{Content-Type: application/octet-stream[^;]}, result
    assert_match %r{Content-Disposition: attachment[^;]}, result
  end

  def test_headers_with_nonalpha_chars
    mail = TestMailer.create_headers_with_nonalpha_chars(@recipient)
    assert !mail.from_addrs.empty?
    assert !mail.cc_addrs.empty?
    assert !mail.bcc_addrs.empty?
    assert_match(/:/, mail.from_addrs.to_s)
    assert_match(/:/, mail.cc_addrs.to_s)
    assert_match(/:/, mail.bcc_addrs.to_s)
  end

  def test_deliver_with_mail_object
    mail = TestMailer.create_headers_with_nonalpha_chars(@recipient)
    assert_nothing_raised { TestMailer.deliver(mail) }
    assert_equal 1, TestMailer.deliveries.length
  end

  def test_multipart_with_template_path_with_dots
    mail = FunkyPathMailer.create_multipart_with_template_path_with_dots(@recipient)
    assert_equal 2, mail.parts.length
    assert_equal 'text/plain', mail.parts[0].content_type
    assert_equal 'utf-8', mail.parts[0].charset
  end

  def test_custom_content_type_attributes
    mail = TestMailer.create_custom_content_type_attributes
    assert_match %r{format=flowed}, mail['content-type'].to_s
    assert_match %r{charset=utf-8}, mail['content-type'].to_s
  end

  def test_return_path_with_create
    mail = TestMailer.create_return_path
    assert_equal &quot;&lt;another@somewhere.test&gt;&quot;, mail['return-path'].to_s
  end

  def test_return_path_with_deliver
    ActionMailer::Base.delivery_method = :smtp
    TestMailer.deliver_return_path
    assert_match %r{^Return-Path: &lt;another@somewhere.test&gt;}, MockSMTP.deliveries[0][0]
    assert_equal &quot;another@somewhere.test&quot;, MockSMTP.deliveries[0][1].to_s
  end

  def test_body_is_stored_as_an_ivar
    mail = TestMailer.create_body_ivar(@recipient)
    assert_equal &quot;body: foo\nbar: baz&quot;, mail.body
  end

  def test_starttls_is_enabled_if_supported
    ActionMailer::Base.smtp_settings[:enable_starttls_auto] = true
    MockSMTP.any_instance.expects(:respond_to?).with(:enable_starttls_auto).returns(true)
    MockSMTP.any_instance.expects(:enable_starttls_auto)
    ActionMailer::Base.delivery_method = :smtp
    TestMailer.deliver_signed_up(@recipient)
  end

  def test_starttls_is_disabled_if_not_supported
    ActionMailer::Base.smtp_settings[:enable_starttls_auto] = true
    MockSMTP.any_instance.expects(:respond_to?).with(:enable_starttls_auto).returns(false)
    MockSMTP.any_instance.expects(:enable_starttls_auto).never
    ActionMailer::Base.delivery_method = :smtp
    TestMailer.deliver_signed_up(@recipient)
  end

  def test_starttls_is_not_enabled
    ActionMailer::Base.smtp_settings[:enable_starttls_auto] = false
    MockSMTP.any_instance.expects(:respond_to?).never
    MockSMTP.any_instance.expects(:enable_starttls_auto).never
    ActionMailer::Base.delivery_method = :smtp
    TestMailer.deliver_signed_up(@recipient)
  ensure
    ActionMailer::Base.smtp_settings[:enable_starttls_auto] = true
  end
end

class InheritableTemplateRootTest &lt; Test::Unit::TestCase
  def test_attr
    expected = &quot;#{File.dirname(__FILE__)}/fixtures/path.with.dots&quot;
    assert_equal expected, FunkyPathMailer.template_root.to_s

    sub = Class.new(FunkyPathMailer)
    sub.template_root = 'test/path'

    assert_equal 'test/path', sub.template_root.to_s
    assert_equal expected, FunkyPathMailer.template_root.to_s
  end
end

class MethodNamingTest &lt; Test::Unit::TestCase
  class TestMailer &lt; ActionMailer::Base
    def send
      body 'foo'
    end
  end

  def setup
    set_delivery_method :test
    ActionMailer::Base.perform_deliveries = true
    ActionMailer::Base.deliveries = []
  end

  def teardown
    restore_delivery_method
  end

  def test_send_method
    assert_nothing_raised do
      assert_emails 1 do
        TestMailer.deliver_send
      end
    end
  end
end

class RespondToTest &lt; Test::Unit::TestCase
  class RespondToMailer &lt; ActionMailer::Base; end

  def setup
    set_delivery_method :test
  end

  def teardown
    restore_delivery_method
  end

  def test_should_respond_to_new
    assert RespondToMailer.respond_to?(:new)
  end

  def test_should_respond_to_create_with_template_suffix
    assert RespondToMailer.respond_to?(:create_any_old_template)
  end

  def test_should_respond_to_deliver_with_template_suffix
    assert RespondToMailer.respond_to?(:deliver_any_old_template)
  end

  def test_should_not_respond_to_new_with_template_suffix
    assert !RespondToMailer.respond_to?(:new_any_old_template)
  end

  def test_should_not_respond_to_create_with_template_suffix_unless_it_is_separated_by_an_underscore
    assert !RespondToMailer.respond_to?(:createany_old_template)
  end

  def test_should_not_respond_to_deliver_with_template_suffix_unless_it_is_separated_by_an_underscore
    assert !RespondToMailer.respond_to?(:deliverany_old_template)
  end

  def test_should_not_respond_to_create_with_template_suffix_if_it_begins_with_a_uppercase_letter
    assert !RespondToMailer.respond_to?(:create_Any_old_template)
  end

  def test_should_not_respond_to_deliver_with_template_suffix_if_it_begins_with_a_uppercase_letter
    assert !RespondToMailer.respond_to?(:deliver_Any_old_template)
  end

  def test_should_not_respond_to_create_with_template_suffix_if_it_begins_with_a_digit
    assert !RespondToMailer.respond_to?(:create_1_template)
  end

  def test_should_not_respond_to_deliver_with_template_suffix_if_it_begins_with_a_digit
    assert !RespondToMailer.respond_to?(:deliver_1_template)
  end

  def test_should_not_respond_to_method_where_deliver_is_not_a_suffix
    assert !RespondToMailer.respond_to?(:foo_deliver_template)
  end

  def test_should_still_raise_exception_with_expected_message_when_calling_an_undefined_method
    error = assert_raise NoMethodError do
      RespondToMailer.not_a_method
    end

    assert_match /undefined method.*not_a_method/, error.message
  end
end
</pre>
    </div>