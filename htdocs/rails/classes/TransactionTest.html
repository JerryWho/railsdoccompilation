  <div id="C00000797">
<div class='banner'>
  <span class="file-title-prefix">Class</span><br />TransactionTest<br/>
  In:
<a href="#" onclick="jsHref('files/activerecord/test/cases/transactions_test_rb.html');">activerecord/test/cases/transactions_test.rb</a>

Parent:&nbsp;
ActiveRecord::TestCase
</div>
 <!-- banner header -->

  <div id="bodyContent" >
      <div id="content">




  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="index.html?a=M005330&name=setup" >setup</a></li>
  <li><a href="index.html?a=M005340&name=test_callback_rollback_in_create" >test_callback_rollback_in_create</a></li>
  <li><a href="index.html?a=M005337&name=test_cancellation_from_before_destroy_rollbacks_in_destroy" >test_cancellation_from_before_destroy_rollbacks_in_destroy</a></li>
  <li><a href="index.html?a=M005338&name=test_cancellation_from_before_filters_rollbacks_in_save" >test_cancellation_from_before_filters_rollbacks_in_save</a></li>
  <li><a href="index.html?a=M005339&name=test_cancellation_from_before_filters_rollbacks_in_save!" >test_cancellation_from_before_filters_rollbacks_in_save!</a></li>
  <li><a href="index.html?a=M005335&name=test_failing_on_exception" >test_failing_on_exception</a></li>
  <li><a href="index.html?a=M005344&name=test_force_savepoint_in_nested_transaction" >test_force_savepoint_in_nested_transaction</a></li>
  <li><a href="index.html?a=M005343&name=test_invalid_keys_for_transaction" >test_invalid_keys_for_transaction</a></li>
  <li><a href="index.html?a=M005342&name=test_manually_rolling_back_a_transaction" >test_manually_rolling_back_a_transaction</a></li>
  <li><a href="index.html?a=M005346&name=test_many_savepoints" >test_many_savepoints</a></li>
  <li><a href="index.html?a=M005341&name=test_nested_explicit_transactions" >test_nested_explicit_transactions</a></li>
  <li><a href="index.html?a=M005345&name=test_no_savepoint_in_nested_transaction_without_force" >test_no_savepoint_in_nested_transaction_without_force</a></li>
  <li><a href="index.html?a=M005350&name=test_open_transactions_count_is_reset_to_zero_if_no_transaction_active" >test_open_transactions_count_is_reset_to_zero_if_no_transaction_active</a></li>
  <li><a href="index.html?a=M005348&name=test_outside_transaction_works" >test_outside_transaction_works</a></li>
  <li><a href="index.html?a=M005336&name=test_raising_exception_in_callback_rollbacks_in_save" >test_raising_exception_in_callback_rollbacks_in_save</a></li>
  <li><a href="index.html?a=M005347&name=test_rollback_when_commit_raises" >test_rollback_when_commit_raises</a></li>
  <li><a href="index.html?a=M005349&name=test_rollback_wont_be_executed_if_no_transaction_active" >test_rollback_wont_be_executed_if_no_transaction_active</a></li>
  <li><a href="index.html?a=M005351&name=test_sqlite_add_column_in_transaction" >test_sqlite_add_column_in_transaction</a></li>
  <li><a href="index.html?a=M005331&name=test_successful" >test_successful</a></li>
  <li><a href="index.html?a=M005334&name=test_successful_with_instance_method" >test_successful_with_instance_method</a></li>
  <li><a href="index.html?a=M005333&name=test_successful_with_return" >test_successful_with_return</a></li>
  <li><a href="index.html?a=M005332&name=transaction_with_return" >transaction_with_return</a></li>
  </ul>






<div class="sectiontitle">Public Instance methods</div>
<div id="M005330" class="method">
  <div id="M005330_title" class="title">
    <b>setup</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005330_source')" id="l_M005330_source">show source</a> ]</p>
  <div id="M005330_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 11</span>
11:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">setup</span>
12:     <span class="ruby-ivar">@first</span>, <span class="ruby-ivar">@second</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>, <span class="ruby-value">2</span>).<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> }
13:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005340" class="method">
  <div id="M005340_title" class="title">
    <b>test_callback_rollback_in_create</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005340_source')" id="l_M005340_source">show source</a> ]</p>
  <div id="M005340_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 153</span>
153:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_callback_rollback_in_create</span>
154:     <span class="ruby-identifier">new_topic</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">new</span>(
155:       <span class="ruby-identifier">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;A new topic&quot;</span>,
156:       <span class="ruby-identifier">:author_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;Ben&quot;</span>,
157:       <span class="ruby-identifier">:author_email_address</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;ben@example.com&quot;</span>,
158:       <span class="ruby-identifier">:written_on</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;2003-07-16t15:28:11.2233+01:00&quot;</span>,
159:       <span class="ruby-identifier">:last_read</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;2004-04-15&quot;</span>,
160:       <span class="ruby-identifier">:bonus_time</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;2005-01-30t15:28:00.00+01:00&quot;</span>,
161:       <span class="ruby-identifier">:content</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;Have a nice day&quot;</span>,
162:       <span class="ruby-identifier">:approved</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>)
163:     <span class="ruby-identifier">new_record_snapshot</span> = <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">new_record?</span>
164:     <span class="ruby-identifier">id_present</span> = <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">has_attribute?</span>(<span class="ruby-constant">Topic</span>.<span class="ruby-identifier">primary_key</span>)
165:     <span class="ruby-identifier">id_snapshot</span> = <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">id</span>
166: 
167:     <span class="ruby-comment cmt"># Make sure the second save gets the after_create callback called.</span>
168:     <span class="ruby-value">2</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span>
169:       <span class="ruby-keyword kw">begin</span>
170:         <span class="ruby-identifier">add_exception_raising_after_create_callback_to_topic</span>
171:         <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">true</span>
172:         <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">save</span>
173:         <span class="ruby-identifier">flunk</span>
174:       <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
175:         <span class="ruby-identifier">assert_equal</span> <span class="ruby-value str">&quot;Make the transaction rollback&quot;</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
176:         <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">new_record_snapshot</span>, <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">new_record?</span>, <span class="ruby-value str">&quot;The topic should have its old new_record value&quot;</span>
177:         <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">id_snapshot</span>, <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value str">&quot;The topic should have its old id&quot;</span>
178:         <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">id_present</span>, <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">has_attribute?</span>(<span class="ruby-constant">Topic</span>.<span class="ruby-identifier">primary_key</span>)
179:       <span class="ruby-keyword kw">ensure</span>
180:         <span class="ruby-identifier">remove_exception_raising_after_create_callback_to_topic</span>
181:       <span class="ruby-keyword kw">end</span>
182:     <span class="ruby-keyword kw">end</span>
183:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005337" class="method">
  <div id="M005337_title" class="title">
    <b>test_cancellation_from_before_destroy_rollbacks_in_destroy</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005337_source')" id="l_M005337_source">show source</a> ]</p>
  <div id="M005337_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 105</span>
105:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_cancellation_from_before_destroy_rollbacks_in_destroy</span>
106:     <span class="ruby-identifier">add_cancelling_before_destroy_with_db_side_effect_to_topic</span>
107:     <span class="ruby-keyword kw">begin</span>
108:       <span class="ruby-identifier">nbooks_before_destroy</span> = <span class="ruby-constant">Book</span>.<span class="ruby-identifier">count</span>
109:       <span class="ruby-identifier">status</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">destroy</span>
110:       <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">status</span>
111:       <span class="ruby-identifier">assert_nothing_raised</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>) { <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span> }
112:       <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">nbooks_before_destroy</span>, <span class="ruby-constant">Book</span>.<span class="ruby-identifier">count</span>
113:     <span class="ruby-keyword kw">ensure</span>
114:       <span class="ruby-identifier">remove_cancelling_before_destroy_with_db_side_effect_to_topic</span>
115:     <span class="ruby-keyword kw">end</span>
116:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005338" class="method">
  <div id="M005338_title" class="title">
    <b>test_cancellation_from_before_filters_rollbacks_in_save</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005338_source')" id="l_M005338_source">show source</a> ]</p>
  <div id="M005338_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 118</span>
118:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_cancellation_from_before_filters_rollbacks_in_save</span>
119:     <span class="ruby-node">%w(validation save)</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span>
120:       <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;add_cancelling_before_#{filter}_with_db_side_effect_to_topic&quot;</span>)
121:       <span class="ruby-keyword kw">begin</span>
122:         <span class="ruby-identifier">nbooks_before_save</span> = <span class="ruby-constant">Book</span>.<span class="ruby-identifier">count</span>
123:         <span class="ruby-identifier">original_author_name</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">author_name</span>
124:         <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">author_name</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">'_this_should_not_end_up_in_the_db'</span>
125:         <span class="ruby-identifier">status</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
126:         <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">status</span>
127:         <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">original_author_name</span>, <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">author_name</span>
128:         <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">nbooks_before_save</span>, <span class="ruby-constant">Book</span>.<span class="ruby-identifier">count</span>
129:       <span class="ruby-keyword kw">ensure</span>
130:         <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;remove_cancelling_before_#{filter}_with_db_side_effect_to_topic&quot;</span>)
131:       <span class="ruby-keyword kw">end</span>
132:     <span class="ruby-keyword kw">end</span>
133:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005339" class="method">
  <div id="M005339_title" class="title">
    <b>test_cancellation_from_before_filters_rollbacks_in_save!</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005339_source')" id="l_M005339_source">show source</a> ]</p>
  <div id="M005339_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 135</span>
135:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_cancellation_from_before_filters_rollbacks_in_save!</span>
136:     <span class="ruby-node">%w(validation save)</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span>
137:       <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;add_cancelling_before_#{filter}_with_db_side_effect_to_topic&quot;</span>)
138:       <span class="ruby-keyword kw">begin</span>
139:         <span class="ruby-identifier">nbooks_before_save</span> = <span class="ruby-constant">Book</span>.<span class="ruby-identifier">count</span>
140:         <span class="ruby-identifier">original_author_name</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">author_name</span>
141:         <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">author_name</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">'_this_should_not_end_up_in_the_db'</span>
142:         <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
143:         <span class="ruby-identifier">flunk</span>
144:       <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
145:         <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">original_author_name</span>, <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">author_name</span>
146:         <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">nbooks_before_save</span>, <span class="ruby-constant">Book</span>.<span class="ruby-identifier">count</span>
147:       <span class="ruby-keyword kw">ensure</span>
148:         <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;remove_cancelling_before_#{filter}_with_db_side_effect_to_topic&quot;</span>)
149:       <span class="ruby-keyword kw">end</span>
150:     <span class="ruby-keyword kw">end</span>
151:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005335" class="method">
  <div id="M005335_title" class="title">
    <b>test_failing_on_exception</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005335_source')" id="l_M005335_source">show source</a> ]</p>
  <div id="M005335_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 70</span>
70:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_failing_on_exception</span>
71:     <span class="ruby-keyword kw">begin</span>
72:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
73:         <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword kw">true</span>
74:         <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">false</span>
75:         <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
76:         <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
77:         <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Bad things!&quot;</span>
78:       <span class="ruby-keyword kw">end</span>
79:     <span class="ruby-keyword kw">rescue</span>
80:       <span class="ruby-comment cmt"># caught it</span>
81:     <span class="ruby-keyword kw">end</span>
82: 
83:     <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;First should still be changed in the objects&quot;</span>
84:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;Second should still be changed in the objects&quot;</span>
85: 
86:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;First shouldn't have been approved&quot;</span>
87:     <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;Second should still be approved&quot;</span>
88:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005344" class="method">
  <div id="M005344_title" class="title">
    <b>test_force_savepoint_in_nested_transaction</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005344_source')" id="l_M005344_source">show source</a> ]</p>
  <div id="M005344_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 223</span>
223:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_force_savepoint_in_nested_transaction</span>
224:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
225:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">true</span>
226:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">false</span>
227:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
228:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save!</span>
229: 
230:       <span class="ruby-keyword kw">begin</span>
231:         <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-identifier">:requires_new</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">do</span>
232:           <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">happy</span> = <span class="ruby-keyword kw">false</span>
233:           <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
234:           <span class="ruby-identifier">raise</span>
235:         <span class="ruby-keyword kw">end</span>
236:       <span class="ruby-keyword kw">rescue</span>
237:       <span class="ruby-keyword kw">end</span>
238:     <span class="ruby-keyword kw">end</span>
239: 
240:     <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
241:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
242:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005343" class="method">
  <div id="M005343_title" class="title">
    <b>test_invalid_keys_for_transaction</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005343_source')" id="l_M005343_source">show source</a> ]</p>
  <div id="M005343_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 216</span>
216:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_invalid_keys_for_transaction</span>
217:     <span class="ruby-identifier">assert_raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword kw">do</span>
218:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-identifier">:nested</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">do</span>
219:       <span class="ruby-keyword kw">end</span>
220:     <span class="ruby-keyword kw">end</span>
221:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005342" class="method">
  <div id="M005342_title" class="title">
    <b>test_manually_rolling_back_a_transaction</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005342_source')" id="l_M005342_source">show source</a> ]</p>
  <div id="M005342_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 199</span>
199:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_manually_rolling_back_a_transaction</span>
200:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
201:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword kw">true</span>
202:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">false</span>
203:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
204:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
205: 
206:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
207:     <span class="ruby-keyword kw">end</span>
208: 
209:     <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;First should still be changed in the objects&quot;</span>
210:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;Second should still be changed in the objects&quot;</span>
211: 
212:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;First shouldn't have been approved&quot;</span>
213:     <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;Second should still be approved&quot;</span>
214:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005346" class="method">
  <div id="M005346_title" class="title">
    <b>test_many_savepoints</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005346_source')" id="l_M005346_source">show source</a> ]</p>
  <div id="M005346_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 265</span>
265:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_many_savepoints</span>
266:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
267:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">content</span> = <span class="ruby-value str">&quot;One&quot;</span>
268:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
269:       
270:       <span class="ruby-keyword kw">begin</span>
271:         <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-identifier">:requires_new</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">do</span>
272:           <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">content</span> = <span class="ruby-value str">&quot;Two&quot;</span>
273:           <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
274:           
275:           <span class="ruby-keyword kw">begin</span>
276:             <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-identifier">:requires_new</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">do</span>
277:               <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">content</span> = <span class="ruby-value str">&quot;Three&quot;</span>
278:               <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
279:               
280:               <span class="ruby-keyword kw">begin</span>
281:                 <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-identifier">:requires_new</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">do</span>
282:                   <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">content</span> = <span class="ruby-value str">&quot;Four&quot;</span>
283:                   <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
284:                   <span class="ruby-identifier">raise</span>
285:                 <span class="ruby-keyword kw">end</span>
286:               <span class="ruby-keyword kw">rescue</span>
287:               <span class="ruby-keyword kw">end</span>
288:               
289:               <span class="ruby-ivar">@three</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">content</span>
290:               <span class="ruby-identifier">raise</span>
291:             <span class="ruby-keyword kw">end</span>
292:           <span class="ruby-keyword kw">rescue</span>
293:           <span class="ruby-keyword kw">end</span>
294:           
295:           <span class="ruby-ivar">@two</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">content</span>
296:           <span class="ruby-identifier">raise</span>
297:         <span class="ruby-keyword kw">end</span>
298:       <span class="ruby-keyword kw">rescue</span>
299:       <span class="ruby-keyword kw">end</span>
300:       
301:       <span class="ruby-ivar">@one</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">content</span>
302:     <span class="ruby-keyword kw">end</span>
303:     
304:     <span class="ruby-identifier">assert_equal</span> <span class="ruby-value str">&quot;One&quot;</span>, <span class="ruby-ivar">@one</span>
305:     <span class="ruby-identifier">assert_equal</span> <span class="ruby-value str">&quot;Two&quot;</span>, <span class="ruby-ivar">@two</span>
306:     <span class="ruby-identifier">assert_equal</span> <span class="ruby-value str">&quot;Three&quot;</span>, <span class="ruby-ivar">@three</span>
307:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005341" class="method">
  <div id="M005341_title" class="title">
    <b>test_nested_explicit_transactions</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005341_source')" id="l_M005341_source">show source</a> ]</p>
  <div id="M005341_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 185</span>
185:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_nested_explicit_transactions</span>
186:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
187:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
188:         <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword kw">true</span>
189:         <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">false</span>
190:         <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
191:         <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
192:       <span class="ruby-keyword kw">end</span>
193:     <span class="ruby-keyword kw">end</span>
194: 
195:     <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;First should have been approved&quot;</span>
196:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;Second should have been unapproved&quot;</span>
197:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005345" class="method">
  <div id="M005345_title" class="title">
    <b>test_no_savepoint_in_nested_transaction_without_force</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005345_source')" id="l_M005345_source">show source</a> ]</p>
  <div id="M005345_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 244</span>
244:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_no_savepoint_in_nested_transaction_without_force</span>
245:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
246:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">true</span>
247:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">false</span>
248:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
249:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save!</span>
250: 
251:       <span class="ruby-keyword kw">begin</span>
252:         <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
253:           <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">false</span>
254:           <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
255:           <span class="ruby-identifier">raise</span>
256:         <span class="ruby-keyword kw">end</span>
257:       <span class="ruby-keyword kw">rescue</span>
258:       <span class="ruby-keyword kw">end</span>
259:     <span class="ruby-keyword kw">end</span>
260: 
261:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
262:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
263:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005350" class="method">
  <div id="M005350_title" class="title">
    <b>test_open_transactions_count_is_reset_to_zero_if_no_transaction_active</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005350_source')" id="l_M005350_source">show source</a> ]</p>
  <div id="M005350_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 341</span>
341:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_open_transactions_count_is_reset_to_zero_if_no_transaction_active</span>
342:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
343:         <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
344:           <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">rollback_db_transaction</span>
345:         <span class="ruby-keyword kw">end</span>
346:         <span class="ruby-identifier">assert_equal</span> <span class="ruby-value">0</span>, <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">open_transactions</span>
347:       <span class="ruby-keyword kw">end</span>
348:       <span class="ruby-identifier">assert_equal</span> <span class="ruby-value">0</span>, <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">open_transactions</span>
349:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005348" class="method">
  <div id="M005348_title" class="title">
    <b>test_outside_transaction_works</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005348_source')" id="l_M005348_source">show source</a> ]</p>
  <div id="M005348_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 323</span>
323:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_outside_transaction_works</span>
324:       <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">outside_transaction?</span>
325:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">begin_db_transaction</span>
326:       <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">outside_transaction?</span>
327:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">rollback_db_transaction</span>
328:       <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">outside_transaction?</span>
329:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005336" class="method">
  <div id="M005336_title" class="title">
    <b>test_raising_exception_in_callback_rollbacks_in_save</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005336_source')" id="l_M005336_source">show source</a> ]</p>
  <div id="M005336_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 90</span>
 90:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_raising_exception_in_callback_rollbacks_in_save</span>
 91:     <span class="ruby-identifier">add_exception_raising_after_save_callback_to_topic</span>
 92: 
 93:     <span class="ruby-keyword kw">begin</span>
 94:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">true</span>
 95:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
 96:       <span class="ruby-identifier">flunk</span>
 97:     <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
 98:       <span class="ruby-identifier">assert_equal</span> <span class="ruby-value str">&quot;Make the transaction rollback&quot;</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
 99:       <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">approved?</span>
100:     <span class="ruby-keyword kw">ensure</span>
101:       <span class="ruby-identifier">remove_exception_raising_after_save_callback_to_topic</span>
102:     <span class="ruby-keyword kw">end</span>
103:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005347" class="method">
  <div id="M005347_title" class="title">
    <b>test_rollback_when_commit_raises</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005347_source')" id="l_M005347_source">show source</a> ]</p>
  <div id="M005347_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 309</span>
309:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_rollback_when_commit_raises</span>
310:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:begin_db_transaction</span>)
311:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:commit_db_transaction</span>).<span class="ruby-identifier">raises</span>(<span class="ruby-value str">'OH NOES'</span>)
312:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:outside_transaction?</span>).<span class="ruby-identifier">returns</span>(<span class="ruby-keyword kw">false</span>)
313:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:rollback_db_transaction</span>)
314: 
315:     <span class="ruby-identifier">assert_raise</span> <span class="ruby-constant">RuntimeError</span> <span class="ruby-keyword kw">do</span>
316:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
317:         <span class="ruby-comment cmt"># do nothing</span>
318:       <span class="ruby-keyword kw">end</span>
319:     <span class="ruby-keyword kw">end</span>
320:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005349" class="method">
  <div id="M005349_title" class="title">
    <b>test_rollback_wont_be_executed_if_no_transaction_active</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005349_source')" id="l_M005349_source">show source</a> ]</p>
  <div id="M005349_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 331</span>
331:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_rollback_wont_be_executed_if_no_transaction_active</span>
332:       <span class="ruby-identifier">assert_raise</span> <span class="ruby-constant">RuntimeError</span> <span class="ruby-keyword kw">do</span>
333:         <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
334:           <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">rollback_db_transaction</span>
335:           <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:rollback_db_transaction</span>).<span class="ruby-identifier">never</span>
336:           <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Rails doesn't scale!&quot;</span>
337:         <span class="ruby-keyword kw">end</span>
338:       <span class="ruby-keyword kw">end</span>
339:     <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005351" class="method">
  <div id="M005351_title" class="title">
    <b>test_sqlite_add_column_in_transaction</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005351_source')" id="l_M005351_source">show source</a> ]</p>
  <div id="M005351_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 352</span>
352:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_sqlite_add_column_in_transaction</span>
353:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_adapter?</span>(<span class="ruby-identifier">:SQLite3Adapter</span>, <span class="ruby-identifier">:SQLiteAdapter</span>)
354: 
355:     <span class="ruby-comment cmt"># Test first if column creation/deletion works correctly when no</span>
356:     <span class="ruby-comment cmt"># transaction is in place.</span>
357:     <span class="ruby-comment cmt">#</span>
358:     <span class="ruby-comment cmt"># We go back to the connection for the column queries because</span>
359:     <span class="ruby-comment cmt"># Topic.columns is cached and won't report changes to the DB</span>
360:     
361:     <span class="ruby-identifier">assert_nothing_raised</span> <span class="ruby-keyword kw">do</span>
362:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">reset_column_information</span>
363:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">add_column</span>(<span class="ruby-value str">'topics'</span>, <span class="ruby-value str">'stuff'</span>, <span class="ruby-identifier">:string</span>)
364:       <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">column_names</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">'stuff'</span>)
365:       
366:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">reset_column_information</span>
367:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">remove_column</span>(<span class="ruby-value str">'topics'</span>, <span class="ruby-value str">'stuff'</span>)
368:       <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">column_names</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">'stuff'</span>)
369:     <span class="ruby-keyword kw">end</span>
370: 
371:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">supports_ddl_transactions?</span>
372:       <span class="ruby-identifier">assert_nothing_raised</span> <span class="ruby-keyword kw">do</span>
373:         <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> { <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">add_column</span>(<span class="ruby-value str">'topics'</span>, <span class="ruby-value str">'stuff'</span>, <span class="ruby-identifier">:string</span>) }
374:       <span class="ruby-keyword kw">end</span>
375:     <span class="ruby-keyword kw">else</span>
376:       <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
377:         <span class="ruby-identifier">assert_raise</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">StatementInvalid</span>) { <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">add_column</span>(<span class="ruby-value str">'topics'</span>, <span class="ruby-value str">'stuff'</span>, <span class="ruby-identifier">:string</span>) }
378:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
379:       <span class="ruby-keyword kw">end</span>
380:     <span class="ruby-keyword kw">end</span>
381:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005331" class="method">
  <div id="M005331_title" class="title">
    <b>test_successful</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005331_source')" id="l_M005331_source">show source</a> ]</p>
  <div id="M005331_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 15</span>
15:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_successful</span>
16:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
17:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword kw">true</span>
18:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">false</span>
19:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
20:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
21:     <span class="ruby-keyword kw">end</span>
22: 
23:     <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;First should have been approved&quot;</span>
24:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;Second should have been unapproved&quot;</span>
25:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005334" class="method">
  <div id="M005334_title" class="title">
    <b>test_successful_with_instance_method</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005334_source')" id="l_M005334_source">show source</a> ]</p>
  <div id="M005334_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 58</span>
58:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_successful_with_instance_method</span>
59:     <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
60:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword kw">true</span>
61:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">false</span>
62:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
63:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
64:     <span class="ruby-keyword kw">end</span>
65: 
66:     <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;First should have been approved&quot;</span>
67:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;Second should have been unapproved&quot;</span>
68:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005333" class="method">
  <div id="M005333_title" class="title">
    <b>test_successful_with_return</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005333_source')" id="l_M005333_source">show source</a> ]</p>
  <div id="M005333_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 37</span>
37:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_successful_with_return</span>
38:     <span class="ruby-keyword kw">class</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>
39:       <span class="ruby-keyword kw">alias</span> <span class="ruby-identifier">:real_commit_db_transaction</span> <span class="ruby-identifier">:commit_db_transaction</span>
40:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">commit_db_transaction</span>
41:         <span class="ruby-identifier">$committed</span> = <span class="ruby-keyword kw">true</span>
42:         <span class="ruby-identifier">real_commit_db_transaction</span>
43:       <span class="ruby-keyword kw">end</span>
44:     <span class="ruby-keyword kw">end</span>
45: 
46:     <span class="ruby-identifier">$committed</span> = <span class="ruby-keyword kw">false</span>
47:     <span class="ruby-identifier">transaction_with_return</span>
48:     <span class="ruby-identifier">assert</span> <span class="ruby-identifier">$committed</span>
49: 
50:     <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;First should have been approved&quot;</span>
51:     <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-value str">&quot;Second should have been unapproved&quot;</span>
52:   <span class="ruby-keyword kw">ensure</span>
53:     <span class="ruby-keyword kw">class</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>
54:       <span class="ruby-keyword kw">alias</span> <span class="ruby-identifier">:commit_db_transaction</span> <span class="ruby-identifier">:real_commit_db_transaction</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
55:     <span class="ruby-keyword kw">end</span>
56:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M005332" class="method">
  <div id="M005332_title" class="title">
    <b>transaction_with_return</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M005332_source')" id="l_M005332_source">show source</a> ]</p>
  <div id="M005332_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File activerecord/test/cases/transactions_test.rb, line 27</span>
27:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">transaction_with_return</span>
28:     <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
29:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword kw">true</span>
30:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword kw">false</span>
31:       <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
32:       <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
33:       <span class="ruby-keyword kw">return</span>
34:     <span class="ruby-keyword kw">end</span>
35:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>