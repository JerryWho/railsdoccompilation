  <div id="C00000438">
<div class='banner'>
  <span class="file-title-prefix">Class</span><br />DispatcherTest<br/>
  In:
<a href="#" onclick="jsHref('files/actionpack/test/controller/dispatcher_test_rb.html');">actionpack/test/controller/dispatcher_test.rb</a>

Parent:&nbsp;
Test::Unit::TestCase
</div>
 <!-- banner header -->

  <div id="bodyContent" >
      <div id="content">




  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="index.html?a=M002658&name=setup" >setup</a></li>
  <li><a href="index.html?a=M002659&name=teardown" >teardown</a></li>
  <li><a href="index.html?a=M002663&name=test_builds_middleware_stack_only_during_initialization_if_not_in_loading_mode" >test_builds_middleware_stack_only_during_initialization_if_not_in_loading_mode</a></li>
  <li><a href="index.html?a=M002660&name=test_clears_dependencies_after_dispatch_if_in_loading_mode" >test_clears_dependencies_after_dispatch_if_in_loading_mode</a></li>
  <li><a href="index.html?a=M002665&name=test_doesnt_wrap_call_in_reloader_if_not_in_loading_mode" >test_doesnt_wrap_call_in_reloader_if_not_in_loading_mode</a></li>
  <li><a href="index.html?a=M002667&name=test_failsafe_response" >test_failsafe_response</a></li>
  <li><a href="index.html?a=M002662&name=test_leaves_dependencies_after_dispatch_if_not_in_loading_mode" >test_leaves_dependencies_after_dispatch_if_not_in_loading_mode</a></li>
  <li><a href="index.html?a=M002668&name=test_prepare_callbacks" >test_prepare_callbacks</a></li>
  <li><a href="index.html?a=M002664&name=test_rebuilds_middleware_stack_on_every_request_if_in_loading_mode" >test_rebuilds_middleware_stack_on_every_request_if_in_loading_mode</a></li>
  <li><a href="index.html?a=M002661&name=test_reloads_routes_before_dispatch_if_in_loading_mode" >test_reloads_routes_before_dispatch_if_in_loading_mode</a></li>
  <li><a href="index.html?a=M002669&name=test_to_prepare_with_identifier_replaces" >test_to_prepare_with_identifier_replaces</a></li>
  <li><a href="index.html?a=M002666&name=test_wraps_call_in_reloader_if_in_loading_mode" >test_wraps_call_in_reloader_if_in_loading_mode</a></li>
  </ul>




  <div class="sectiontitle">Constants</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class="attr-name">Dispatcher</td>
    <td>=</td>
    <td class="attr-value">ActionController::Dispatcher</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">Reloader</td>
    <td>=</td>
    <td class="attr-value">ActionController::Reloader</td>
  </tr>
  </table>


<div class="sectiontitle">Public Instance methods</div>
<div id="M002658" class="method">
  <div id="M002658_title" class="title">
    <b>setup</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002658_source')" id="l_M002658_source">show source</a> ]</p>
  <div id="M002658_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 7</span>
 7:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">setup</span>
 8:     <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'REQUEST_METHOD'</span>] = <span class="ruby-value str">'GET'</span>
 9:     <span class="ruby-identifier">reset_dispatcher</span>
10:     <span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">stubs</span>(<span class="ruby-identifier">:require_dependency</span>)
11:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002659" class="method">
  <div id="M002659_title" class="title">
    <b>teardown</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002659_source')" id="l_M002659_source">show source</a> ]</p>
  <div id="M002659_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 13</span>
13:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">teardown</span>
14:     <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">delete</span> <span class="ruby-value str">'REQUEST_METHOD'</span>
15:     <span class="ruby-identifier">reset_dispatcher</span>
16:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002663" class="method">
  <div id="M002663_title" class="title">
    <b>test_builds_middleware_stack_only_during_initialization_if_not_in_loading_mode</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002663_source')" id="l_M002663_source">show source</a> ]</p>
  <div id="M002663_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 36</span>
36:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_builds_middleware_stack_only_during_initialization_if_not_in_loading_mode</span>
37:     <span class="ruby-identifier">dispatcher</span> = <span class="ruby-identifier">create_dispatcher</span>
38:     <span class="ruby-identifier">assert_not_nil</span> <span class="ruby-identifier">dispatcher</span>.<span class="ruby-identifier">instance_variable_get</span>(<span class="ruby-value str">&quot;@app&quot;</span><span class="ruby-value str">&quot;@app&quot;</span>)
39:     <span class="ruby-identifier">dispatcher</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-value str">&quot;@app&quot;</span><span class="ruby-value str">&quot;@app&quot;</span>, <span class="ruby-identifier">lambda</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">env</span><span class="ruby-operator">|</span> })
40:     <span class="ruby-identifier">dispatcher</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:build_middleware_stack</span>).<span class="ruby-identifier">never</span>
41:     <span class="ruby-identifier">dispatcher</span>.<span class="ruby-identifier">call</span>(<span class="ruby-keyword kw">nil</span>)
42:     <span class="ruby-identifier">dispatcher</span>.<span class="ruby-identifier">call</span>(<span class="ruby-keyword kw">nil</span>)
43:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002660" class="method">
  <div id="M002660_title" class="title">
    <b>test_clears_dependencies_after_dispatch_if_in_loading_mode</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002660_source')" id="l_M002660_source">show source</a> ]</p>
  <div id="M002660_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 18</span>
18:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_clears_dependencies_after_dispatch_if_in_loading_mode</span>
19:     <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Dependencies</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:clear</span>).<span class="ruby-identifier">once</span>
20:     <span class="ruby-comment cmt"># Close the response so dependencies kicks in</span>
21:     <span class="ruby-identifier">dispatch</span>(<span class="ruby-keyword kw">false</span>).<span class="ruby-identifier">last</span>.<span class="ruby-identifier">close</span>
22:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002665" class="method">
  <div id="M002665_title" class="title">
    <b>test_doesnt_wrap_call_in_reloader_if_not_in_loading_mode</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002665_source')" id="l_M002665_source">show source</a> ]</p>
  <div id="M002665_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 54</span>
54:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_doesnt_wrap_call_in_reloader_if_not_in_loading_mode</span>
55:     <span class="ruby-constant">Reloader</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:run</span>).<span class="ruby-identifier">never</span>
56:     <span class="ruby-identifier">dispatch</span>
57:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002667" class="method">
  <div id="M002667_title" class="title">
    <b>test_failsafe_response</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002667_source')" id="l_M002667_source">show source</a> ]</p>
  <div id="M002667_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 69</span>
69:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_failsafe_response</span>
70:     <span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">any_instance</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:dispatch</span>).<span class="ruby-identifier">raises</span>(<span class="ruby-value str">'b00m'</span>)
71:     <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Failsafe</span>.<span class="ruby-identifier">any_instance</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:log_failsafe_exception</span>)
72: 
73:     <span class="ruby-identifier">response</span> = <span class="ruby-keyword kw">nil</span>
74:     <span class="ruby-identifier">assert_nothing_raised</span> <span class="ruby-keyword kw">do</span>
75:       <span class="ruby-identifier">response</span> = <span class="ruby-identifier">dispatch</span>
76:     <span class="ruby-keyword kw">end</span>
77:     <span class="ruby-identifier">assert_equal</span> <span class="ruby-value">3</span>, <span class="ruby-identifier">response</span>.<span class="ruby-identifier">size</span>
78:     <span class="ruby-identifier">assert_equal</span> <span class="ruby-value">500</span>, <span class="ruby-identifier">response</span>[<span class="ruby-value">0</span>]
79:     <span class="ruby-identifier">assert_equal</span>({<span class="ruby-value str">&quot;Content-Type&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;text/html&quot;</span>}, <span class="ruby-identifier">response</span>[<span class="ruby-value">1</span>])
80:     <span class="ruby-identifier">assert_match</span> <span class="ruby-regexp re">/500 Internal Server Error/</span>, <span class="ruby-identifier">response</span>[<span class="ruby-value">2</span>].<span class="ruby-identifier">join</span>
81:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002662" class="method">
  <div id="M002662_title" class="title">
    <b>test_leaves_dependencies_after_dispatch_if_not_in_loading_mode</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002662_source')" id="l_M002662_source">show source</a> ]</p>
  <div id="M002662_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 29</span>
29:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_leaves_dependencies_after_dispatch_if_not_in_loading_mode</span>
30:     <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Routing</span><span class="ruby-operator">::</span><span class="ruby-constant">Routes</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:reload</span>).<span class="ruby-identifier">never</span>
31:     <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Dependencies</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:clear</span>).<span class="ruby-identifier">never</span>
32: 
33:     <span class="ruby-identifier">dispatch</span>
34:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002668" class="method">
  <div id="M002668_title" class="title">
    <b>test_prepare_callbacks</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002668_source')" id="l_M002668_source">show source</a> ]</p>
  <div id="M002668_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 83</span>
 83:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_prepare_callbacks</span>
 84:     <span class="ruby-identifier">a</span> = <span class="ruby-identifier">b</span> = <span class="ruby-identifier">c</span> = <span class="ruby-keyword kw">nil</span>
 85:     <span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">to_prepare</span> { <span class="ruby-operator">|</span><span class="ruby-operator">*</span><span class="ruby-identifier">args</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> = <span class="ruby-identifier">b</span> = <span class="ruby-identifier">c</span> = <span class="ruby-value">1</span> }
 86:     <span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">to_prepare</span> { <span class="ruby-operator">|</span><span class="ruby-operator">*</span><span class="ruby-identifier">args</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span> = <span class="ruby-identifier">c</span> = <span class="ruby-value">2</span> }
 87:     <span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">to_prepare</span> { <span class="ruby-operator">|</span><span class="ruby-operator">*</span><span class="ruby-identifier">args</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span> = <span class="ruby-value">3</span> }
 88: 
 89:     <span class="ruby-comment cmt"># Ensure to_prepare callbacks are not run when defined</span>
 90:     <span class="ruby-identifier">assert_nil</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">b</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">c</span>
 91: 
 92:     <span class="ruby-comment cmt"># Run callbacks</span>
 93:     <span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">run_prepare_callbacks</span>
 94: 
 95:     <span class="ruby-identifier">assert_equal</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">a</span>
 96:     <span class="ruby-identifier">assert_equal</span> <span class="ruby-value">2</span>, <span class="ruby-identifier">b</span>
 97:     <span class="ruby-identifier">assert_equal</span> <span class="ruby-value">3</span>, <span class="ruby-identifier">c</span>
 98: 
 99:     <span class="ruby-comment cmt"># Make sure they are only run once</span>
100:     <span class="ruby-identifier">a</span> = <span class="ruby-identifier">b</span> = <span class="ruby-identifier">c</span> = <span class="ruby-keyword kw">nil</span>
101:     <span class="ruby-identifier">dispatch</span>
102:     <span class="ruby-identifier">assert_nil</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">b</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">c</span>
103:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002664" class="method">
  <div id="M002664_title" class="title">
    <b>test_rebuilds_middleware_stack_on_every_request_if_in_loading_mode</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002664_source')" id="l_M002664_source">show source</a> ]</p>
  <div id="M002664_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 45</span>
45:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_rebuilds_middleware_stack_on_every_request_if_in_loading_mode</span>
46:     <span class="ruby-identifier">dispatcher</span> = <span class="ruby-identifier">create_dispatcher</span>(<span class="ruby-keyword kw">false</span>)
47:     <span class="ruby-identifier">dispatcher</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-value str">&quot;@app&quot;</span><span class="ruby-value str">&quot;@app&quot;</span>, <span class="ruby-identifier">lambda</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">env</span><span class="ruby-operator">|</span> })
48:     <span class="ruby-identifier">dispatcher</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:build_middleware_stack</span>).<span class="ruby-identifier">twice</span>
49:     <span class="ruby-identifier">dispatcher</span>.<span class="ruby-identifier">call</span>(<span class="ruby-keyword kw">nil</span>)
50:     <span class="ruby-constant">Reloader</span>.<span class="ruby-identifier">default_lock</span>.<span class="ruby-identifier">unlock</span>
51:     <span class="ruby-identifier">dispatcher</span>.<span class="ruby-identifier">call</span>(<span class="ruby-keyword kw">nil</span>)
52:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002661" class="method">
  <div id="M002661_title" class="title">
    <b>test_reloads_routes_before_dispatch_if_in_loading_mode</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002661_source')" id="l_M002661_source">show source</a> ]</p>
  <div id="M002661_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 24</span>
24:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_reloads_routes_before_dispatch_if_in_loading_mode</span>
25:     <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Routing</span><span class="ruby-operator">::</span><span class="ruby-constant">Routes</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:reload</span>).<span class="ruby-identifier">once</span>
26:     <span class="ruby-identifier">dispatch</span>(<span class="ruby-keyword kw">false</span>)
27:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002669" class="method">
  <div id="M002669_title" class="title">
    <b>test_to_prepare_with_identifier_replaces</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002669_source')" id="l_M002669_source">show source</a> ]</p>
  <div id="M002669_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 105</span>
105:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_to_prepare_with_identifier_replaces</span>
106:     <span class="ruby-identifier">a</span> = <span class="ruby-identifier">b</span> = <span class="ruby-keyword kw">nil</span>
107:     <span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">to_prepare</span>(<span class="ruby-identifier">:unique_id</span>) { <span class="ruby-operator">|</span><span class="ruby-operator">*</span><span class="ruby-identifier">args</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> = <span class="ruby-identifier">b</span> = <span class="ruby-value">1</span> }
108:     <span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">to_prepare</span>(<span class="ruby-identifier">:unique_id</span>) { <span class="ruby-operator">|</span><span class="ruby-operator">*</span><span class="ruby-identifier">args</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> = <span class="ruby-value">2</span> }
109: 
110:     <span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">run_prepare_callbacks</span>
111:     <span class="ruby-identifier">assert_equal</span> <span class="ruby-value">2</span>, <span class="ruby-identifier">a</span>
112:     <span class="ruby-identifier">assert_equal</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">b</span>
113:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div id="M002666" class="method">
  <div id="M002666_title" class="title">
    <b>test_wraps_call_in_reloader_if_in_loading_mode</b>()
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M002666_source')" id="l_M002666_source">show source</a> ]</p>
  <div id="M002666_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File actionpack/test/controller/dispatcher_test.rb, line 59</span>
59:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">test_wraps_call_in_reloader_if_in_loading_mode</span>
60:     <span class="ruby-constant">Reloader</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-identifier">:run</span>).<span class="ruby-identifier">once</span>
61:     <span class="ruby-identifier">dispatch</span>(<span class="ruby-keyword kw">false</span>)
62:   <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>