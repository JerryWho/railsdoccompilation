  <div id="fileHeader">
    <h1>redirect_to.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>lib/spec/rails/matchers/redirect_to.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sat Mar 28 20:09:13 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>module Spec
  module Rails
    module Matchers

      class RedirectTo  #:nodoc:

        include ActionController::StatusCodes

        def initialize(request, expected)
          @expected = expected
          @request = request
        end

        def matches?(response_or_controller)
          response  = response_or_controller.respond_to?(:response) ?
                      response_or_controller.response :
                      response_or_controller

          @redirected = response.redirect?
          @actual = response.redirect_url
          return false unless @redirected

          if @expected_status
            @actual_status = interpret_status(response.code.to_i)
            @status_matched = @expected_status == @actual_status
          else
            @status_matched = true
          end

          if @expected.instance_of? Hash
            return false unless @actual =~ %r{^\w+://#{@request.host}}
            return false unless actual_redirect_to_valid_route
            return actual_hash == expected_hash &amp;&amp; @status_matched
          else
            return @actual == expected_url &amp;&amp; @status_matched
          end
        end

        def actual_hash
          hash_from_url @actual
        end

        def expected_hash
          hash_from_url expected_url
        end

        def actual_redirect_to_valid_route
          actual_hash
        end

        def hash_from_url(url)
          query_hash(url).merge(path_hash(url)).with_indifferent_access
        end

        def path_hash(url)
          path = url.sub(%r{^\w+://#{@request.host}(?::\d+)?}, &quot;&quot;).split(&quot;?&quot;, 2)[0]
          ActionController::Routing::Routes.recognize_path path, { :method =&gt; :get }
        end

        def query_hash(url)
          query = url.split(&quot;?&quot;, 2)[1] || &quot;&quot;
          Rack::Utils.parse_query(query)
        end

        def with(options)
          @expected_status = interpret_status(options[:status])
          self
        end
        
       def expected_url
          case @expected
            when Hash
              return ActionController::UrlRewriter.new(@request, {}).rewrite(@expected)
            when :back
              return @request.env['HTTP_REFERER']
            when %r{^\w+://.*}
              return @expected
            else
              return &quot;http://#{@request.host}&quot; + (@expected.split('')[0] == '/' ? '' : '/') + @expected
          end
        end

        def failure_message_for_should
          if @redirected
            if @status_matched
              return %Q{expected redirect to #{@expected.inspect}, got redirect to #{@actual.inspect}}
            else
              return %Q{expected redirect to #{@expected.inspect} with status #{@expected_status}, got #{@actual_status}}
            end
          else
            return %Q{expected redirect to #{@expected.inspect}, got no redirect}
          end
        end

        def failure_message_for_should_not
            return %Q{expected not to be redirected to #{@expected.inspect}, but was} if @redirected
        end

        def description
          &quot;redirect to #{@expected.inspect}&quot;
        end
      end

      # :call-seq:
      #   response.should redirect_to(url)
      #   response.should redirect_to(:action =&gt; action_name)
      #   response.should redirect_to(:controller =&gt; controller_name, :action =&gt; action_name)
      #   response.should_not redirect_to(url)
      #   response.should_not redirect_to(:action =&gt; action_name)
      #   response.should_not redirect_to(:controller =&gt; controller_name, :action =&gt; action_name)
      #
      # Passes if the response is a redirect to the url, action or controller/action.
      # Useful in controller specs (integration or isolation mode).
      #
      # == Examples
      #
      #   response.should redirect_to(&quot;path/to/action&quot;)
      #   response.should redirect_to(&quot;http://test.host/path/to/action&quot;)
      #   response.should redirect_to(:action =&gt; 'list')
      def redirect_to(opts)
        RedirectTo.new(request, opts)
      end
    end

  end
end
</pre>
    </div>