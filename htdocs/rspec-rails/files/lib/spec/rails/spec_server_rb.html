  <div id="fileHeader">
    <h1>spec_server.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>lib/spec/rails/spec_server.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sat Mar 28 20:09:13 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>if Rails::VERSION::STRING &gt;= '2.2' &amp;&amp; Rails.configuration.cache_classes
  raise &lt;&lt;-MESSAGE

#{'*'*65}

  Rails.configuration.cache_classes == true
  
  This means that spec_server won't reload your classes when
  you change them, which defeats the purpose of spec_server.
  
  Please set 'config.cache_classes = false' (it's probably
  set to true in config/environments/test.rb) and give it
  another try.

#{'*'*65}
MESSAGE
end

require 'drb/drb'
require 'rbconfig'

# This is based on Florian Weber's TDDMate
module Spec
  module Rails
    class SpecServer
      class &lt;&lt; self
        def restart_test_server
          puts &quot;restarting&quot;
          config       = ::Config::CONFIG
          ruby         = File::join(config['bindir'], config['ruby_install_name']) + config['EXEEXT']
          command_line = [ruby, $0, ARGV].flatten.join(' ')
          exec(command_line)
        end

        def daemonize(pid_file = nil)
          return yield if $DEBUG
          pid = Process.fork{
            Process.setsid
            Dir.chdir(RAILS_ROOT)
            trap(&quot;SIGINT&quot;){ exit! 0 }
            trap(&quot;SIGTERM&quot;){ exit! 0 }
            trap(&quot;SIGHUP&quot;){ restart_test_server }
            File.open(&quot;/dev/null&quot;){|f|
              STDERR.reopen f
              STDIN.reopen  f
              STDOUT.reopen f
            }
            run
          }
          puts &quot;spec_server launched (PID: %d)&quot; % pid
          File.open(pid_file,&quot;w&quot;){|f| f.puts pid } if pid_file
          exit! 0
        end

        def run
          trap(&quot;USR2&quot;) { ::Spec::Rails::SpecServer.restart_test_server } if Signal.list.has_key?(&quot;USR2&quot;)
          DRb.start_service(&quot;druby://127.0.0.1:8989&quot;, ::Spec::Rails::SpecServer.new)
          DRb.thread.join
        end
      end
      
      def run(argv, stderr, stdout)
        $stdout = stdout
        $stderr = stderr
        
        ::Rails::Configuration.extend Module.new {def cache_classes; false; end}

        ::ActiveSupport.const_defined?(:Dependencies) ?
          ::ActiveSupport::Dependencies.mechanism = :load :
          ::Dependencies.mechanism = :load
        
        require 'action_controller/dispatcher'
        dispatcher = ::ActionController::Dispatcher.new($stdout)

        if ::ActionController::Dispatcher.respond_to?(:reload_application)
          ::ActionController::Dispatcher.reload_application
        else
          dispatcher.reload_application
        end
        
        if Object.const_defined?(:Fixtures) &amp;&amp; Fixtures.respond_to?(:reset_cache)
          Fixtures.reset_cache
        end

        unless Object.const_defined?(:ApplicationController)
          %w(application_controller.rb application.rb).each do |name|
            require_dependency(name) if File.exists?(&quot;#{RAILS_ROOT}/app/controllers/#{name}&quot;)
          end
        end
        load &quot;#{RAILS_ROOT}/spec/spec_helper.rb&quot;

        if in_memory_database?
          load &quot;#{RAILS_ROOT}/db/schema.rb&quot;
          ActiveRecord::Migrator.up('db/migrate')
        end
        
        ::Spec::Runner::CommandLine.run(
          ::Spec::Runner::OptionParser.parse(
            argv,
            $stderr,
            $stdout
          )
        )

        dispatcher.cleanup_application if dispatcher.respond_to?(:cleanup_application)
      end

      def in_memory_database?
        ENV[&quot;RAILS_ENV&quot;] == &quot;test&quot; and
        ::ActiveRecord::Base.connection.class.to_s == &quot;ActiveRecord::ConnectionAdapters::SQLite3Adapter&quot; and
        ::Rails::Configuration.new.database_configuration['test']['database'] == ':memory:'
      end
    end
  end
end

options = Hash.new
parser = OptionParser.new
parser.on(&quot;-d&quot;, &quot;--daemon&quot;)     {|ignore| options[:daemon] = true }
parser.on(&quot;-p&quot;, &quot;--pid PIDFILE&quot;){|pid|    options[:pid]    = pid  }
parser.parse!(ARGV)

if options[:daemon]
  ::Spec::Rails::SpecServer.daemonize(options[:pid])
else
  ::Spec::Rails::SpecServer.run
end
</pre>
    </div>