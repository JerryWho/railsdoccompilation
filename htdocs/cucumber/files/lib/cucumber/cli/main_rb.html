  <div id="fileHeader">
    <h1>main.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>lib/cucumber/cli/main.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sat Mar 28 20:11:24 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>require 'optparse'
require 'cucumber'
require 'ostruct'
require 'cucumber/parser'
require 'cucumber/formatter'
require 'cucumber/cli/language_help_formatter'
require 'cucumber/cli/configuration'

module Cucumber
  module Cli
    class Main
      class &lt;&lt; self
        def step_mother=(step_mother)
          @step_mother = step_mother
          @step_mother.extend(StepMother)
          @step_mother.snippet_generator = StepDefinition
        end

        def execute(args)
          new(args).execute!(@step_mother)
        end
      end

      def initialize(args, out_stream = STDOUT, error_stream = STDERR)
        @args         = args
        @out_stream   = out_stream == STDOUT ? Formatter::ColorIO.new : out_stream
        @error_stream = error_stream
      end
      
      def execute!(step_mother)
        configuration.load_language
        step_mother.options = configuration.options

        require_files
        enable_diffing
      
        features = load_plain_text_features

        visitor = configuration.build_formatter_broadcaster(step_mother)
        step_mother.visitor = visitor # Needed to support World#announce
        visitor.visit_features(features)

        failure = step_mother.steps(:failed).any? || 
          (configuration.strict? &amp;&amp; step_mother.steps(:undefined).any?)

        Kernel.exit(failure ? 1 : 0)
      end

      def load_plain_text_features
        features = Ast::Features.new
        parser = Parser::FeatureParser.new

        verbose_log(&quot;Features:&quot;)
        configuration.feature_files.each do |f|
          features.add_feature(parser.parse_file(f))
          verbose_log(&quot;  * #{f}&quot;)
        end
        verbose_log(&quot;\n&quot;*2)
        features
      end

      def configuration
        return @configuration if @configuration
      
        @configuration = Configuration.new(@out_stream, @error_stream)
        @configuration.parse!(@args)
        @configuration
      end

      private
    
      def require_files
        verbose_log(&quot;Ruby files required:&quot;)
        configuration.files_to_require.each do |lib|
          begin
            require lib
            verbose_log(&quot;  * #{lib}&quot;)
          rescue LoadError =&gt; e
            e.message &lt;&lt; &quot;\nFailed to load #{lib}&quot;
            raise e
          end
        end
        verbose_log(&quot;\n&quot;)
      end

      def verbose_log(string)
        @out_stream.puts(string) if configuration.verbose?
      end

      def enable_diffing
        if configuration.diff_enabled? &amp;&amp; defined?(::Spec)
          require 'spec/expectations/differs/default'
          options = OpenStruct.new(:diff_format =&gt; :unified, :context_lines =&gt; 3)
          ::Spec::Expectations.differ = ::Spec::Expectations::Differs::Default.new(options)
        end
      end
    
    end
  end
end

Cucumber::Cli::Main.step_mother = self
</pre>
    </div>