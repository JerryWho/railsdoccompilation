  <div id="fileHeader">
    <h1>html.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>lib/cucumber/formatter/html.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sat Mar 28 20:11:24 +0100 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>begin
  require 'builder'
rescue LoadError
  gem 'builder'
  require 'builder'
end

module Cucumber
  module Formatter
    class Html &lt; Ast::Visitor
      def initialize(step_mother, io, options)
        super(step_mother)
        @builder = Builder::XmlMarkup.new(:target =&gt; io, :indent =&gt; 2)
      end
      
      def visit_features(features)
        # &lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;
        @builder.declare!(
          :DOCTYPE,
          :html, 
          :PUBLIC, 
          '-//W3C//DTD XHTML 1.0 Strict//EN', 
          'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'
        )
        @builder.html(:xmlns =&gt; 'http://www.w3.org/1999/xhtml') do
          @builder.head do
            @builder.title 'Cucumber'
            inline_css
          end
          @builder.body do
            @builder.div(:class =&gt; 'cucumber') do
              super
            end
          end
        end
      end

      def visit_feature(feature)
        @builder.div(:class =&gt; 'feature') do
          super
        end
      end

      def visit_feature_name(name)
        lines = name.split(/\r?\n/)
        @builder.h2(lines[0])
        @builder.p do
          lines[1..-1].each do |line|
            @builder.text!(line.strip)
            @builder.br
          end
        end
      end

      def visit_background(background)
        @builder.div(:class =&gt; 'background') do
          super
        end
      end

      def visit_background_name(keyword, name, file_colon_line, source_indent)
        @builder.h3(&quot;#{keyword} #{name}&quot;)
      end

      def visit_feature_element(feature_element)
        @builder.div(:class =&gt; 'scenario') do
          super
        end
        @open_step_list = true
      end
      
      def visit_scenario_name(keyword, name, file_colon_line, source_indent)
        @builder.h3(&quot;#{keyword} #{name}&quot;)
      end

      def visit_outline_table(outline_table)
        @builder.table do
          super(outline_table)
        end
      end

      def visit_examples_name(keyword, name)
        @builder.h4(&quot;#{keyword} #{name}&quot;)
      end

      def visit_steps(steps)
        @builder.ol do
          super
        end
      end

      def visit_step(step)
        @step_id = step.dom_id
        @builder.li(:id =&gt; @step_id) do
          super
        end
      end

      def visit_step_name(keyword, step_match, status, source_indent, background)
        @step_matches ||= []
        @skip_step = @step_matches.index(step_match)
        @step_matches &lt;&lt; step_match

        unless @skip_step
          step_name = step_match.format_args(lambda{|param| &quot;&lt;span&gt;#{param}&lt;/span&gt;&quot;})
          @builder.div(:class =&gt; status) do |div|
            div &lt;&lt; &quot;#{keyword} #{step_name}&quot;
          end
        end
      end

      def visit_exception(exception, status)
        @builder.pre(format_exception(exception), :class =&gt; status)
      end

      def visit_multiline_arg(multiline_arg)
        return if @skip_step
        if Ast::Table === multiline_arg
          @builder.table do
            super
          end
        else
          super
        end
      end

      def visit_py_string(string, status)
        @builder.pre(:class =&gt; status) do |pre|
          pre &lt;&lt; string
        end
      end

      def visit_table_row(table_row)
        @row_id = table_row.dom_id
        @col_index = 0
        @builder.tr(:id =&gt; @row_id) do
          super
        end
        if table_row.exception
          @builder.tr do
            @builder.td(:colspan =&gt; @col_index.to_s, :class =&gt; 'failed') do
              @builder.pre do |pre|
                pre &lt;&lt; format_exception(table_row.exception)
              end
            end
          end
        end
      end

      def visit_table_cell_value(value, width, status)
        @builder.td(value, :class =&gt; status, :id =&gt; &quot;#{@row_id}_#{@col_index}&quot;)
        @col_index += 1
      end

      def announce(announcement)
        @builder.pre(announcement, :class =&gt; 'announcement')
      end

      private

      def inline_css
        @builder.style(:type =&gt; 'text/css') do
          @builder.text!(File.read(File.dirname(__FILE__) + '/cucumber.css'))
        end
      end

      def format_exception(exception)
        ([&quot;#{exception.message} (#{exception.class})&quot;] + exception.backtrace).join(&quot;\n&quot;)
      end
    end
  end
end
</pre>
    </div>